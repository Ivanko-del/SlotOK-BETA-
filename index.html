<script>
    const firebaseConfig = { apiKey: "AIzaSyB0gJDyr8z2SWPV3Tf73ZRNNPuglxHTCZw", authDomain: "slotok-web-server.firebaseapp.com", databaseURL: "https://slotok-web-server-default-rtdb.firebaseio.com", projectId: "slotok-web-server", storageBucket: "slotok-web-server.firebasestorage.app", messagingSenderId: "1086314476940", appId: "1:1086314476940:web:d3629d2d0fe16f7c1f12a9", measurementId: "G-PP32GNBY2R" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null; let userData = {}; let isRegMode = false; let currentRouletteBet = null;
    const MAX_BET = 100000; 
    let audioCtx = null; // –ó–≤—É–∫ —Ç–µ–ø–µ—Ä —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ

    // –ñ–æ—Ä—Å—Ç–∫–∏–π –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫: —Ö–æ–≤–∞—î–º–æ –∑–∞–≥—Ä—É–∑–∫—É –º–∞–∫—Å–∏–º—É–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥–∏ –≤ –±—É–¥—å-—è–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É
    setTimeout(() => { document.getElementById('loading-overlay').classList.add('hidden'); }, 4000);
    
    const savedUser = localStorage.getItem("royal_online_user");
    if(savedUser) { currentUser = savedUser; startDataSync(); }

    function startDataSync() {
        document.getElementById('loading-overlay').classList.remove('hidden');
        
        // –î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ (—è–∫—â–æ Firebase –±–ª–æ–∫—É—î –¥–æ—Å—Ç—É–ø)
        db.ref('users/' + currentUser).on('value', (snapshot) => {
            document.getElementById('loading-overlay').classList.add('hidden');
            const data = snapshot.val();
            if(!data) { logout(); return; }
            userData = data; 
            if(userData.banned) { alert("–í–ê–® –ê–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–û–í–ê–ù–û!"); logout(); return; }
            document.getElementById('auth-screen').classList.add('hidden');
            updateUI(); loadContacts(); checkAdmin();
        }, (error) => {
            // –Ø–∫—â–æ –±–∞–∑–∞ –Ω–µ –ø—É—Å–∫–∞—î
            console.error("Firebase Error:", error);
            document.getElementById('loading-overlay').classList.add('hidden');
            alert("–ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö! –°—Ö–æ–∂–µ, –∑–∞–∫—Ä–∏–≤—Å—è –¥–æ—Å—Ç—É–ø —É Firebase Rules.");
            logout();
        });
        
        db.ref('users').orderByChild('balance').limitToLast(20).on('value', snap => renderTop(snap.val()));
    }

    function updateUI() {
        if(!userData) return;
        document.querySelectorAll('.bal').forEach(e => e.textContent = formatNumber(userData.balance));
        document.getElementById('profileName').textContent = currentUser;
        document.getElementById('profileId').textContent = userData.id || '---';
        document.getElementById('profileEmail').textContent = userData.email || "-";
        document.getElementById('profileTag').textContent = userData.tag || "–ì—Ä–∞–≤–µ—Ü—å";
        const avDiv = document.getElementById('currentAvatar');
        avDiv.innerHTML = (userData.avatar && userData.avatar.length > 20) ? `<img src="${userData.avatar}">` : 'üë§';
    }

    function checkAdmin() {
        if (currentUser.toLowerCase() === 'theivankoo' || userData.isAdmin === true) {
            document.getElementById('adminPanelBtnBox').classList.remove('hidden');
            document.getElementById('adminBadge').classList.remove('hidden');
        } else {
            document.getElementById('adminPanelBtnBox').classList.add('hidden');
            document.getElementById('adminBadge').classList.add('hidden');
        }
    }

    function formatNumber(num) {
        if(num >= 1000000000) return (num/1000000000).toFixed(1) + 'B';
        if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return num.toLocaleString();
    }

    function notify(msg, type='info') { const c = document.getElementById('toast-container'); const d = document.createElement('div'); d.className = `toast ${type}`; d.innerHTML = `<span>${msg}</span>`; c.appendChild(d); setTimeout(() => d.remove(), 3000); }
    
    // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∑–≤—É–∫, —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞–≤ —Å—Ç–∞—Ä—Ç –≥—Ä–∏
    function playSound(type) { 
        if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        if(audioCtx.state==='suspended') audioCtx.resume(); 
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime; 
        if(type==='click'){o.frequency.value=600;g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start(t);o.stop(t+0.1);} 
        else if(type==='win'){o.type='triangle';o.frequency.setValueAtTime(500,t);o.frequency.linearRampToValueAtTime(1000,t+0.5);g.gain.linearRampToValueAtTime(0,t+0.5);o.start(t);o.stop(t+0.5);} 
    }
    
    function validateBet(amount) { const bet = Math.abs(parseInt(amount)); if(isNaN(bet) || bet <= 0 || bet > MAX_BET || userData.balance < bet) { notify("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞–≤–∫–∏", "error"); return false; } return bet; }
    function addToHistory(msg) { db.ref(`users/${currentUser}/history`).push({text: msg, date: Date.now()}); }

    // --- GAMES ---
    // Slots
    function spinSlots() { const b=validateBet(document.getElementById('betAmountSlots').value); if(!b) return; db.ref('users/'+currentUser).update({balance:userData.balance-b}); playSound('spin_start'); const reels = [document.getElementById('r1'), document.getElementById('r2'), document.getElementById('r3')]; const sym = ["üçí", "üçã", "7", "üíé", "üîî"]; let count = 0; let int = setInterval(() => { reels.forEach(r => r.textContent = sym[Math.floor(Math.random()*sym.length)]); count++; if(count > 10) { clearInterval(int); finishSlots(b); } }, 100); }
    function finishSlots(bet) { playSound('reel_stop'); const r = Math.random(); let win = 0; let res = ["üçí","üçã","üîî"]; if(r < 0.01) { res = ["7","7","7"]; win = bet*50; } else if(r < 0.05) { res = ["üíé","üíé","üíé"]; win = bet*20; } else if(r < 0.15) { res = ["üçí","üçí","üçí"]; win = bet*3; } document.getElementById('r1').textContent = res[0]; document.getElementById('r2').textContent = res[1]; document.getElementById('r3').textContent = res[2]; if(win > 0) { db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(win)); playSound('win'); notify(`WIN: ${win}`, "success"); addToHistory(`Slots: +${win}`); } }

    // Roulette
    function selectRouletteBet(c,e){ document.querySelectorAll('.bet-btn').forEach(b=>b.classList.remove('selected')); e.classList.add('selected'); currentRouletteBet=c; playSound('click'); }
    function spinRoulette(){ const b=validateBet(document.getElementById('betAmountRoulette').value); if(!b||!currentRouletteBet) return; db.ref('users/'+currentUser).update({balance:userData.balance-b}); playSound('spin_start'); const wheel=document.getElementById('wheel'); const randDeg = Math.random() * 360; const rot=1800 + (360 - randDeg); wheel.style.transform=`rotate(${rot}deg)`; setTimeout(()=>{ const r=Math.random(); let w=0; let c='black'; if(randDeg<=18) c='green'; else if(randDeg<=189) c='red'; if(c===currentRouletteBet){ w=c==='green'?b*14:b*2; db.ref('users/'+currentUser+'/balance').set(userData.balance+w); notify(`+${w}`); playSound('win'); addToHistory(`Roulette: +${w}`); } else notify("Loss","error"); },4000); }

    // Chests
    function startChests(){ const b=validateBet(document.getElementById('betAmountChests').value); if(!b)return; db.ref('users/'+currentUser).update({balance:userData.balance-b}); const g=document.getElementById('chestsGrid'); g.innerHTML=""; for(let i=0;i<3;i++){ const d=document.createElement('div'); d.className="chest-item"; d.textContent="üì¶"; d.onclick=()=>{ const w=Math.random()>0.5?b*2.5:0; d.textContent=w?"üí∞":"üí®"; if(w){ db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(w)); playSound('win'); notify(`+${w}`); addToHistory(`Chests: +${w}`); } else playSound('error'); }; g.appendChild(d); }}

    // Crash
    let crashInt; let crashMult = 1.00; let isCrashPlaying = false;
    function startCrash() { const b=validateBet(document.getElementById('betAmountCrash').value); if(!b) return; db.ref('users/'+currentUser).update({balance:userData.balance-b}); document.getElementById('crashBtn').classList.add('hidden'); document.getElementById('crashCashoutBtn').classList.remove('hidden'); let m=1.00; let crash=1+Math.random()*5; isCrashPlaying=true; crashInt=setInterval(()=>{ m+=0.05; document.getElementById('crashDisplay').textContent=m.toFixed(2)+'x'; if(m>=crash){ clearInterval(crashInt); isCrashPlaying=false; notify("Boom!","error"); document.getElementById('crashBtn').classList.remove('hidden'); document.getElementById('crashCashoutBtn').classList.add('hidden'); } },100); }
    function cashoutCrash() { if(!isCrashPlaying) return; clearInterval(crashInt); isCrashPlaying=false; const b=parseInt(document.getElementById('betAmountCrash').value); const w=Math.floor(b*parseFloat(document.getElementById('crashDisplay').textContent)); db.ref('users/'+currentUser+'/balance').set(userData.balance+w); notify(`+${w}`); addToHistory(`Crash: +${w}`); document.getElementById('crashBtn').classList.remove('hidden'); document.getElementById('crashCashoutBtn').classList.add('hidden'); }

    // Mines
    let minesGrid = []; let minesCount = 1; let isMinesPlaying = false; let currentMinesProfit = 0; let movesMade = 0;
    function setMinesCount(n, el) { if(isMinesPlaying) return; minesCount = n; document.querySelectorAll('.mine-opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
    function startMines() { const bet = validateBet(document.getElementById('betAmountMines').value); if(!bet) return; db.ref('users/' + currentUser).update({balance: userData.balance - bet}); isMinesPlaying = true; currentMinesProfit = bet; movesMade = 0; document.getElementById('minesBtn').classList.add('hidden'); document.getElementById('minesCashoutBtn').classList.remove('hidden'); minesGrid = new Array(25).fill(0); let placed = 0; while(placed < minesCount) { let idx = Math.floor(Math.random() * 25); if(minesGrid[idx] === 0) { minesGrid[idx] = 1; placed++; } } const container = document.getElementById('minesGrid'); container.innerHTML = ''; for(let i=0; i<25; i++) { const cell = document.createElement('div'); cell.className = 'mine-cell'; cell.textContent = "‚ùì"; cell.onclick = () => clickMineCell(i, cell); container.appendChild(cell); } playSound('click'); }
    function clickMineCell(idx, el) { if(!isMinesPlaying || el.classList.contains('revealed')) return; el.classList.add('revealed'); if(minesGrid[idx] === 1) { el.classList.add('boom'); el.textContent = "üí£"; playSound('error'); gameOverMines(); } else { el.classList.add('gem'); el.textContent = "üíé"; playSound('click'); movesMade++; const multiplier = 1 + (minesCount * 0.10); currentMinesProfit = Math.floor(currentMinesProfit * multiplier); if(movesMade >= 1) { document.getElementById('minesCashoutBtn').textContent = `–ó–ê–ë–†–ê–¢–ò ${currentMinesProfit}`; } } }
    function cashoutMines() { if(!isMinesPlaying) return; db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(currentMinesProfit)); playSound('win'); notify(`+${currentMinesProfit}`, "success"); addToHistory(`Mines: +${currentMinesProfit}`); gameOverMines(); }
    function gameOverMines() { isMinesPlaying = false; document.getElementById('minesBtn').classList.remove('hidden'); document.getElementById('minesCashoutBtn').classList.add('hidden'); }

    // Plinko
    function dropPlinko() { const bet = validateBet(document.getElementById('betAmountPlinko').value); if(!bet) return; db.ref('users/' + currentUser).update({balance: userData.balance - bet}); playSound('click'); const ball = document.getElementById('plinkoBall'); ball.style.display = 'block'; const rand = Math.random(); let bucketIndex = 3; if(rand < 0.05) bucketIndex = 0; else if(rand < 0.20) bucketIndex = 1; else if(rand < 0.50) bucketIndex = 2; else bucketIndex = 3; if(Math.random() > 0.5) bucketIndex = 6 - bucketIndex; const targetLeft = (bucketIndex * 14) + 7; ball.animate([{ top: '0', left: '50%' }, { top: '100%', left: targetLeft + '%' }], { duration: 1500, fill: 'forwards', easing: 'linear' }); setTimeout(() => { playSound('reel_stop'); const multipliers = [5, 2, 0.5, 0.2, 0.5, 2, 5]; const mult = multipliers[bucketIndex]; const win = Math.floor(bet * mult); if(mult >= 1) { db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(win)); playSound('win'); notify(`+${win}`); addToHistory(`Plinko: +${win}`); } else { addToHistory(`Plinko: -${bet}`); } ball.style.display = 'none'; }, 1500); }

    // --- LEADERBOARD ---
    function renderTop(d) {
        if(!d) return;
        let arr = [];
        for(let k in d) arr.push({n:k, ...d[k]});
        arr.sort((a,b) => b.balance - a.balance);
        let h = "";
        arr.forEach((u,i) => {
            const av = u.avatar && u.avatar.length > 20 ? `<img src="${u.avatar}" style="width:20px;height:20px;border-radius:50%">` : 'üë§';
            h += `<tr onclick="openUserProfile('${u.n}')"><td>${i+1}</td><td>${av} ${u.n}</td><td class="rank">${formatNumber(u.balance)}</td></tr>`;
        });
        document.getElementById('topTable').innerHTML = h;
    }

    // --- AUTH & ADMIN ---
    function authLogin() { const n=document.getElementById('loginName').value.trim(); const p=document.getElementById('loginPass').value; if(!n||!p)return notify("Error","error"); db.ref('users/'+n).once('value',s=>{ if(s.exists()&&s.val().pass==p){ currentUser=n; localStorage.setItem("royal_online_user",n); startDataSync(); } else notify("–ù–µ–≤—ñ—Ä–Ω–æ","error"); }); }
    function authRegister() { const e=document.getElementById('regEmail').value.trim(); const n=document.getElementById('regName').value.trim(); const p=document.getElementById('regPass').value; if(!e||!n||!p)return notify("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å–µ","error"); if(p.length<8||p.includes(' ')||p.includes('.'))return notify("–ü–∞—Ä–æ–ª—å: –º—ñ–Ω 8, –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤/—Ç–æ—á–æ–∫","error"); db.ref('users/'+n).once('value',s=>{ if(s.exists()) notify("–ó–∞–π–Ω—è—Ç–æ","error"); else { const id=Math.floor(Math.random()*900000)+100000; db.ref('users/'+n).set({pass:p,email:e,balance:1000,id,tag:"–ù–æ–≤–∞—á–æ–∫"}).then(()=>{ notify("OK"); toggleAuthMode(false); }); } }); }
    function toggleAuthMode(reg) { isRegMode=reg; document.getElementById('loginForm').classList.toggle('hidden', reg); document.getElementById('regForm').classList.toggle('hidden', !reg); }
    function logout(){ localStorage.removeItem("royal_online_user"); location.reload(); }
    
    function loadUserList() { 
        const d = document.getElementById('userList'); 
        d.innerHTML = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..."; 
        db.ref('users').once('value', s => { 
            d.innerHTML = ""; 
            const users = s.val();
            if (!users) { d.innerHTML = "–ù–µ–º–∞—î –≥—Ä–∞–≤—Ü—ñ–≤"; return; }
            for(let n in users) { 
                if(n===currentUser) continue; 
                d.innerHTML += `<div class="admin-user-card" onclick="openAdminManage('${n}')">
                                <b>${n}</b> <span style="color:#4cd964">${formatNumber(users[n].balance)}</span>
                                </div>`; 
            } 
        }); 
    }
    
    let admSelectedUser = null;
    function openAdminManage(n) { admSelectedUser=n; document.getElementById('admin-user-manage').classList.remove('hidden'); document.getElementById('admManageName').textContent=n; }
    function admGiveMoney() { const a=parseInt(document.getElementById('admAmount').value); if(!a)return; db.ref('users/'+admSelectedUser+'/balance').set(firebase.database.ServerValue.increment(a)); notify("Done"); }
    function admSetTag() { const t=document.getElementById('admTag').value; if(t) db.ref('users/'+admSelectedUser).update({tag:t}); notify("Tag set"); }
    function admBanUser() { db.ref('users/'+admSelectedUser).update({banned: true}); notify("BANNED"); }
    function admDeleteUser() { if(confirm("DELETE?")) db.ref('users/'+admSelectedUser).remove().then(()=>{ notify("Deleted"); document.getElementById('admin-user-manage').classList.add('hidden'); loadUserList(); }); }
    function wipeEconomy() { if(confirm("WIPE ALL?")) db.ref('users').once('value',s=>{ for(let k in s.val()) db.ref('users/'+k+'/balance').set(1000); notify("Wiped"); }); }

    // --- OTHER ---
    function switchTab(id,el) { document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); if(el){ document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); } }
    function openGame(g) { switchTab(g); }
    function openTransferModal() { document.getElementById('transfer-modal').classList.remove('hidden'); }
    function openPromoModal() { document.getElementById('promo-modal').classList.remove('hidden'); }
    function openSupportModal() { document.getElementById('support-modal').classList.remove('hidden'); loadSupportChat(); }
    function sendMoney() { const t=document.getElementById('transferTo').value; const a=parseInt(document.getElementById('transferAmount').value); if(userData.balance<a)return notify("Error"); db.ref('users/'+t).once('value',s=>{ if(s.exists()){ db.ref('users/'+currentUser+'/balance').set(userData.balance-a); db.ref('users/'+t+'/balance').set(s.val().balance+Math.floor(a*0.975)); notify("Sent"); document.getElementById('transfer-modal').classList.add('hidden'); } }); }
    function activatePromo() { const c=document.getElementById('promoInput').value.trim(); db.ref('promos/'+c).once('value',s=>{ if(s.exists()){ db.ref('users/'+currentUser+'/balance').set(userData.balance+s.val().value); notify("OK"); } }); }
    function initDeposit(a) { notify("Processing..."); setTimeout(()=>{ db.ref('users/'+currentUser+'/balance').set(userData.balance+a); notify("Added"); },1000); }
    function initDepositManual() { const a=parseInt(document.getElementById('depAmount').value); if(a) initDeposit(a); }
    function addContact() { const i=document.getElementById('addContactInput').value; db.ref('users/'+i).once('value',s=>{ if(s.exists()){ db.ref('users/'+currentUser+'/contacts/'+i).set({avatar:s.val().avatar||'üë§'}); notify("Added"); loadContacts(); } }); }
    function loadContacts() { const l=document.getElementById('contactsList'); if(!userData.contacts){l.innerHTML="Empty";return;} l.innerHTML=""; for(let n in userData.contacts){ l.innerHTML+=`<div class="contact-row"><b>${n}</b> <button class="btn-green" style="width:auto;padding:5px;" onclick="quickSend('${n}')">üí∏</button></div>`; } }
    function quickSend(n) { const a=prompt("Amount:"); if(a){ document.getElementById('transferTo').value=n; document.getElementById('transferAmount').value=a; sendMoney(); } }
    function deleteAccount() { if(confirm("Delete?")) db.ref('users/'+currentUser).remove().then(logout); }
    function updateBio(v) { db.ref('users/'+currentUser).update({tag:v}); notify("Updated"); }
    function handleAvatarUpload(i) { if(i.files[0]){ const r=new FileReader(); r.onload=e=>db.ref('users/'+currentUser).update({avatar:e.target.result}); r.readAsDataURL(i.files[0]); } }
    function openHistoryModal() { document.getElementById('history-modal').classList.remove('hidden'); const c=document.getElementById('historyList'); db.ref('users/'+currentUser+'/history').limitToLast(20).once('value',s=>{ c.innerHTML=""; if(s.val()) Object.values(s.val()).reverse().forEach(i=>c.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #333">${i.text}</div>`); }); }
    function openVisaForm() { document.getElementById('visa-form-modal').classList.remove('hidden'); }
    function processVisaPayment() { document.getElementById('visa-form-modal').classList.add('hidden'); initDeposit(100); }
    function loadSupportChat() { const box=document.getElementById('supportChatBox'); db.ref('support_chats/'+currentUser).limitToLast(20).on('child_added',s=>{ const m=s.val(); box.innerHTML+=`<div style="margin:5px; padding:5px; background:${m.sender==='user'?'#005c4b':'#333'}; border-radius:5px; text-align:${m.sender==='user'?'right':'left'}">${m.text}</div>`; box.scrollTop=box.scrollHeight; }); }
    function sendSupportMsg() { const t=document.getElementById('supportMsg').value; if(t) { db.ref('support_chats/'+currentUser).push({text:t, sender:'user', time:Date.now()}); document.getElementById('supportMsg').value=""; } }
    window.openUserProfile = function(name) { if(name===currentUser) return switchTab('profile'); db.ref('users/'+name).once('value', s=>{ const d=s.val(); if(d) { document.getElementById('viewUserName').textContent=name; document.getElementById('viewUserId').textContent=d.id; document.getElementById('viewUserBal').textContent=formatNumber(d.balance); document.getElementById('viewUserTag').textContent=d.tag||"–ì—Ä–∞–≤–µ—Ü—å"; document.getElementById('viewUserAvatar').innerHTML=(d.avatar&&d.avatar.length>20)?`<img src="${d.avatar}">`:'üë§'; document.getElementById('view-user-modal').classList.remove('hidden'); } }); }
  </script>