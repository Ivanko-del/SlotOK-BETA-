<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>SlotOK | Ultimate v27</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

  <style>
    /* --- CSS –ó–ú–Ü–ù–ù–Ü (–¢–ï–ú–ò) --- */
    :root {
        --bg: #050505; --text: #ffffff; --box: #141414; --border: #2a2a2a; --nav: #0a0a0a; 
        --accent: #d4af37; --input: #1a1a1a; --modal: #000000; --msg-user: #222; --msg-admin: #333;
    }
    
    [data-theme="light"] {
        --bg: #f2f2f2; --text: #111111; --box: #ffffff; --border: #cccccc; --nav: #ffffff; 
        --accent: #d4af37; --input: #e6e6e6; --modal: #ffffff; --msg-user: #e1ffc7; --msg-admin: #f1f1f1;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
    
    .header { padding: 15px; text-align: center; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; display:flex; justify-content:space-between; align-items:center; }
    .header h1 { margin: 0; font-size: 24px; color: var(--accent); letter-spacing: 2px; font-weight: 900; }
    .header-bal { font-size: 14px; background: var(--box); padding: 5px 10px; border: 1px solid var(--accent); border-radius: 6px; font-weight:bold; }

    .container { padding: 20px; padding-top: 10px; } 
    .hidden { display: none !important; }
    
    /* –ï–õ–ï–ú–ï–ù–¢–ò */
    .box { background: var(--box); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    button { padding: 16px; width: 100%; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; background: #333; color: #fff; margin-bottom: 10px; }
    button:active { transform: scale(0.96); }
    .btn-gold { background: linear-gradient(45deg, var(--accent), #ffdb4d); color: #000; } 
    .btn-red { background: #ff3b30; color: #fff; } .btn-green { background: #4cd964; color: #000; } 
    .btn-outline { background: transparent; border: 2px solid #555; color: var(--text); opacity: 0.7; }
    
    input { width: 100%; padding: 16px; margin-bottom: 15px; background: var(--input); border: 2px solid var(--border); color: var(--text); border-radius: 12px; font-size: 18px; outline: none; box-sizing: border-box; text-align: center; font-weight: bold; } 
    input:focus { border-color: var(--accent); }

    /* –Ü–ì–†–ò */
    .game-card { background: var(--box); border: 1px solid var(--border); border-radius: 16px; padding: 25px; margin-bottom: 15px; text-align: center; cursor: pointer; position: relative; }
    .game-icon { font-size: 45px; display: block; margin-bottom: 10px; } 
    .game-title { font-size: 20px; font-weight: bold; } .game-desc { font-size: 13px; opacity: 0.7; }

    /* CHAT SUPPORT */
    .chat-container { height: calc(100vh - 180px); display: flex; flex-direction: column; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: var(--input); border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
    .msg { padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; font-size: 14px; word-wrap: break-word; }
    .msg.me { background: var(--msg-user); align-self: flex-end; margin-left: auto; border: 1px solid var(--accent); color: var(--text); }
    .msg.support { background: var(--msg-admin); align-self: flex-start; margin-right: auto; border: 1px solid var(--border); color: var(--text); }
    .chat-input-area { display: flex; gap: 10px; }
    .chat-input-area input { margin: 0; text-align: left; }
    .chat-input-area button { width: auto; margin: 0; padding: 0 20px; }

    /* CONVERTER */
    .converter-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 5px; }
    .currency-tag { font-size: 12px; background: var(--accent); color:#000; padding: 2px 6px; border-radius: 4px; font-weight:bold; }

    /* TOP TABS */
    .top-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
    .top-tab { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); flex: 1; text-align: center; font-size: 12px; white-space: nowrap; }
    .top-tab.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

    /* GAMES UI (Simplified) */
    .reels-container { background: #000; border: 2px solid var(--accent); border-radius: 12px; padding: 20px; display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; } .reel { font-size: 55px; width: 80px; height: 100px; line-height: 100px; background: #fff; color: #000; border-radius: 8px; text-align: center; }
    .roulette-wheel { width: 260px; height: 260px; border-radius: 50%; border: 8px solid #222; margin: 0 auto 20px; background: conic-gradient(#4cd964 0deg 18deg, #222 18deg 189deg, #b71c1c 189deg 360deg); transition: 4s ease-out; transform: rotate(0deg); }
    .chests-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; } .chest-item { background: #222; border-radius: 12px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
    
    /* NAV */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--nav); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 1000; } 
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #777; font-size: 11px; width: 16%; } 
    .nav-item span.icon { font-size: 26px; margin-bottom: 5px; } 
    .nav-item.active { color: var(--accent); }

    /* MODALS */
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--accent); font-size:24px; flex-direction: column; }
    #auth-screen, #modal-overlay, #transfer-modal, #promo-modal, #history-modal, #tab-admin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal); z-index: 5000; padding: 25px; box-sizing: border-box; overflow-y: auto; }
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 6000; width: 90%; } 
    .toast { background: #333; color: #fff; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid var(--accent); }
    
    /* OTHER */
    .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--accent); } input:checked + .slider:before { transform: translateX(24px); }
    
    /* TABLE */
    table { width: 100%; border-collapse: collapse; } td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
  </style>
</head>
<body data-theme="dark">

  <div id="loading-overlay"><div style="font-size:50px; margin-bottom:20px;">üé∞</div><div>SlotOK v27.0</div></div>
  <div id="toast-container"></div>
  
  <div class="header">
    <h1>SLOT<span>OK</span></h1>
    <div class="header-bal"><span class="bal">0</span> ‚Ç¥</div>
  </div>

  <div class="container">
    
    <div id="tab-lobby" class="screen">
      <div class="game-card" onclick="openGame('slots')"><span class="game-icon">üé∞</span><div class="game-title">Classic 777</div></div>
      <div class="game-card" onclick="openGame('roulette')"><span class="game-icon">üé°</span><div class="game-title">Royal Roulette</div></div>
      <div class="game-card" onclick="openGame('chests')"><span class="game-icon">üì¶</span><div class="game-title">Magic Chests</div></div>
      <div class="game-card" onclick="openGame('mines')"><span class="game-icon">üí£</span><div class="game-title">Mines</div></div>
      <div class="game-card" onclick="openGame('plinko')"><span class="game-icon">üîª</span><div class="game-title">Plinko X</div></div>
    </div>

    <div id="tab-slots" class="screen hidden"><button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button><div class="reels-container"><div class="reel" id="r1">7</div><div class="reel" id="r2">7</div><div class="reel" id="r3">7</div></div><div class="box"><input id="betSlots" type="number" value="100"><button class="btn-gold" onclick="spinSlots()">SPIN</button></div></div>
    <div id="tab-roulette" class="screen hidden"><button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button><div class="roulette-wheel" id="wheel"></div><div class="box"><div style="display:flex; gap:5px; margin-bottom:10px;"><button class="btn-red" onclick="spinRoulette('red')">RED</button><button class="btn-green" onclick="spinRoulette('green')">0</button><button style="background:#222" onclick="spinRoulette('black')">BLACK</button></div><input id="betRoulette" value="100"></div></div>
    <div id="tab-chests" class="screen hidden"><button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button><div class="box"><div class="chests-grid" id="chestsGrid"></div></div><div class="box"><input id="betChests" value="100"><button class="btn-gold" onclick="startChests()">PLAY</button></div></div>
    <div id="tab-mines" class="screen hidden"><button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button><div class="box"><h3>MINES</h3><p>–°–∞–ø–µ—Ä. –í—ñ–¥–∫—Ä–∏–π –ø–æ–ª–µ.</p><input id="betMines" value="100"><button class="btn-gold" onclick="simpleGame('Mines')">–ì–†–ê–¢–ò</button></div></div>
    <div id="tab-plinko" class="screen hidden"><button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button><div class="box"><h3>PLINKO</h3><p>–ö—É–ª—å–∫–∞ –ø–∞–¥–∞—î.</p><input id="betPlinko" value="100"><button class="btn-gold" onclick="simpleGame('Plinko')">–ì–†–ê–¢–ò</button></div></div>

    <div id="tab-cashier" class="screen hidden">
      <h3 style="color:var(--accent)">–ü–û–ü–û–í–ù–ï–ù–ù–Ø</h3>
      <div class="box"><button class="btn-gold" onclick="initDeposit(100)">+100 ‚Ç¥</button><button class="btn-gold" onclick="initDeposit(1000)">+1000 ‚Ç¥</button></div>
      
      <h3 style="color:var(--accent); margin-top:20px;">–û–ë–ú–Ü–ù –í–ê–õ–Æ–¢ (–ö–æ–º—ñ—Å—ñ—è 5%)</h3>
      <div class="box">
          <div class="converter-row">
              <span class="currency-tag">UAH: <span class="bal">0</span></span>
              <span class="currency-tag" style="background:#4caf50;">USD: <span id="balUSD">0</span></span>
              <span class="currency-tag" style="background:#f7931a;">BTC: <span id="balBTC">0</span></span>
          </div>
          <input id="exchAmount" placeholder="–°—É–º–∞ UAH">
          <div style="display:flex; gap:10px;">
              <button class="btn-green" onclick="exchange('UAH_TO_USD')">–ö—É–ø–∏—Ç–∏ USD</button>
              <button class="btn-outline" style="background:#f7931a; color:#000;" onclick="exchange('UAH_TO_BTC')">–ö—É–ø–∏—Ç–∏ BTC</button>
          </div>
          <button class="btn-outline" onclick="exchange('USD_TO_UAH')">–ü—Ä–æ–¥–∞—Ç–∏ USD</button>
      </div>

      <button class="btn-outline" onclick="openTransferModal()">üí∏ –ü–µ—Ä–µ–∫–∞–∑ –î—Ä—É–≥—É</button>
    </div>

    <div id="tab-support" class="screen hidden">
        <h2 style="color:var(--accent);">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</h2>
        <div class="chat-container">
            <div class="chat-messages" id="chatBox">
                <div class="msg support">–í—ñ—Ç–∞—é! –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?</div>
            </div>
            <div class="chat-input-area">
                <input id="chatInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
                <button class="btn-gold" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="tab-top" class="screen hidden">
        <div class="top-tabs">
            <div class="top-tab active" onclick="setTopTab('uah', this)">–ì–†–ò–í–ù–Ø</div>
            <div class="top-tab" onclick="setTopTab('usd', this)">–î–û–õ–ê–†</div>
            <div class="top-tab" onclick="setTopTab('btc', this)">–ö–†–ò–ü–¢–ê</div>
            <div class="top-tab" onclick="setTopTab('time', this)">–°–¢–ê–†–û–ñ–ò–õ–ò</div>
        </div>
        <div class="box"><table id="topTable"></table></div>
    </div>
    
    <div id="tab-profile" class="screen hidden">
      <div class="box">
        <div class="profile-header"><div class="avatar-large" id="currentAvatar">üë§</div><div><div style="font-size:24px; font-weight:bold;"><span id="profileName">...</span></div><div style="font-size:12px; opacity:0.7;">ID: <span id="profileId">...</span></div></div></div>
        <button class="btn-outline" onclick="openHistoryModal()">üìú –Ü—Å—Ç–æ—Ä—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π</button>
      </div>
      <div class="box hidden" id="adminPanelBtnBox" style="border-color: red;"><button class="btn-red" onclick="switchTab('admin')">ADMIN PANEL</button></div>
    </div>

    <div id="tab-more" class="screen hidden">
      <div class="box">
        <div class="menu-item"><span>üåê –ú–æ–≤–∞</span><button class="btn-outline" style="width:auto; padding:5px 10px; margin:0;">UA</button></div>
        <div class="menu-item"><span>üåó –¢–µ–º–∞ (–ë—ñ–ª–∞/–¢–µ–º–Ω–∞)</span><label class="switch"><input type="checkbox" id="themeToggle" onchange="toggleTheme()"><span class="slider"></span></label></div>
        <div class="menu-item"><span>üîä –ó–≤—É–∫</span><label class="switch"><input type="checkbox" id="soundToggle" onchange="toggleSound()"><span class="slider"></span></label></div>
        <button class="btn-outline" onclick="logout()">–í–∏–π—Ç–∏</button>
      </div>
      <div style="text-align:center; opacity:0.5; font-size:12px;">SlotOK v27.0 Ultimate</div>
    </div>

    <div id="tab-admin" class="screen hidden">
       <button class="btn-outline" onclick="switchTab('profile')">‚¨Ö –ù–∞–∑–∞–¥</button>
       <div class="box"><button class="btn-red" onclick="wipeEconomy()">üíÄ WIPE ALL (1000 UAH)</button></div>
       <div class="box"><div id="userList">Loading...</div></div>
    </div>
  </div>

  <div id="auth-screen"><div style="text-align:center; margin-bottom:50px;"><h1 style="color:var(--accent); font-size:50px;">SlotOK</h1></div><input id="authName" placeholder="–ù—ñ–∫–Ω–µ–π–º"><input id="authPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><button class="btn-gold" onclick="authAction()">–í–•–Ü–î / –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button></div>
  <div id="transfer-modal" class="hidden"><button class="btn-outline" onclick="this.parentElement.classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–ü–µ—Ä–µ–∫–∞–∑</h2><input id="transferTo" placeholder="–ù—ñ–∫"><input id="transferAmount" type="number" placeholder="–°—É–º–∞"><button class="btn-gold" onclick="sendMoney()">–ù–ê–î–Ü–°–õ–ê–¢–ò</button></div>
  <div id="history-modal" class="hidden"><button class="btn-outline" onclick="this.parentElement.classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–Ü—Å—Ç–æ—Ä—ñ—è</h2><div id="historyList"></div></div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('lobby', this)"><span>üé∞</span><span>–Ü–≥—Ä–∏</span></div>
    <div class="nav-item" onclick="switchTab('cashier', this)"><span>üí≥</span><span>–ö–∞—Å–∞</span></div>
    <div class="nav-item" onclick="switchTab('top', this)"><span>üèÜ</span><span>–¢–æ–ø</span></div>
    <div class="nav-item" onclick="switchTab('support', this)"><span>üí¨</span><span>–ß–∞—Ç</span></div>
    <div class="nav-item" onclick="switchTab('profile', this)"><span>üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></div>
    <div class="nav-item" onclick="switchTab('more', this)"><span>‚öôÔ∏è</span><span>–©–µ</span></div>
  </nav>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyB0gJDyr8z2SWPV3Tf73ZRNNPuglxHTCZw", authDomain: "slotok-web-server.firebaseapp.com", databaseURL: "https://slotok-web-server-default-rtdb.firebaseio.com", projectId: "slotok-web-server", storageBucket: "slotok-web-server.firebasestorage.app", messagingSenderId: "1086314476940", appId: "1:1086314476940:web:d3629d2d0fe16f7c1f12a9", measurementId: "G-PP32GNBY2R" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null; let userData = {}; 
    let currentTheme = localStorage.getItem('slotok_theme') || 'dark';
    let soundEnabled = localStorage.getItem('slotok_sound') !== 'false';
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // RATES
    const RATE_USD = 40; // 1 USD = 40 UAH
    const RATE_BTC = 1000000; // 1 BTC = 1M UAH

    // INIT
    applyTheme(currentTheme);
    document.getElementById('themeToggle').checked = (currentTheme === 'light');
    document.getElementById('soundToggle').checked = soundEnabled;
    setTimeout(() => { document.getElementById('loading-overlay').classList.add('hidden'); }, 2000);

    const savedUser = localStorage.getItem("royal_online_user");
    if(savedUser) { currentUser = savedUser; startDataSync(); }

    function startDataSync() {
        db.ref('users/' + currentUser).on('value', (s) => {
            const data = s.val();
            if(!data) { logout(); return; }
            userData = data; 
            // Default wallets if undefined
            if(!userData.balanceUSD) userData.balanceUSD = 0;
            if(!userData.balanceBTC) userData.balanceBTC = 0;
            
            document.getElementById('auth-screen').classList.add('hidden');
            updateUI(); loadChat(); checkAdmin();
        });
        db.ref('users').on('value', snap => renderTop(snap.val(), 'uah')); // Default Top
    }

    function updateUI() {
        if(!userData) return;
        document.querySelectorAll('.bal').forEach(e => e.textContent = formatNumber(userData.balance));
        document.getElementById('balUSD').textContent = formatNumber(userData.balanceUSD);
        document.getElementById('balBTC').textContent = userData.balanceBTC.toFixed(6);
        document.getElementById('profileName').textContent = currentUser;
        document.getElementById('profileId').textContent = userData.id || '---';
        document.getElementById('profileEmail').textContent = userData.email || "-";
        const avDiv = document.getElementById('currentAvatar');
        avDiv.innerHTML = (userData.avatar && userData.avatar.length > 20) ? `<img src="${userData.avatar}">` : 'üë§';
    }

    function formatNumber(num) {
        if(num >= 1000000000) return (num/1000000000).toFixed(1) + 'B';
        if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return num.toFixed(0);
    }

    // --- CONVERTER ---
    function exchange(type) {
        const amount = parseFloat(document.getElementById('exchAmount').value);
        if(!amount || amount <= 0) return notify("–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É", "error");
        
        // 5% Commission
        const tax = 0.95; 

        if (type === 'UAH_TO_USD') {
            if (userData.balance < amount) return notify("–ú–∞–ª–æ UAH", "error");
            const usd = (amount / RATE_USD) * tax;
            const updates = {};
            updates['users/'+currentUser+'/balance'] = userData.balance - amount;
            updates['users/'+currentUser+'/balanceUSD'] = userData.balanceUSD + usd;
            db.ref().update(updates).then(() => notify(`–ö—É–ø–ª–µ–Ω–æ ${usd.toFixed(2)} USD`, "success"));
        }
        else if (type === 'UAH_TO_BTC') {
            if (userData.balance < amount) return notify("–ú–∞–ª–æ UAH", "error");
            const btc = (amount / RATE_BTC) * tax;
            const updates = {};
            updates['users/'+currentUser+'/balance'] = userData.balance - amount;
            updates['users/'+currentUser+'/balanceBTC'] = userData.balanceBTC + btc;
            db.ref().update(updates).then(() => notify(`–ö—É–ø–ª–µ–Ω–æ ${btc.toFixed(6)} BTC`, "success"));
        }
        else if (type === 'USD_TO_UAH') {
            if (userData.balanceUSD < amount) return notify("–ú–∞–ª–æ USD", "error");
            const uah = (amount * RATE_USD) * tax;
            const updates = {};
            updates['users/'+currentUser+'/balanceUSD'] = userData.balanceUSD - amount;
            updates['users/'+currentUser+'/balance'] = userData.balance + uah;
            db.ref().update(updates).then(() => notify(`–û—Ç—Ä–∏–º–∞–Ω–æ ${uah.toFixed(0)} UAH`, "success"));
        }
        document.getElementById('exchAmount').value = "";
    }

    // --- TOP LEADERBOARD ---
    let currentTopType = 'uah';
    function setTopTab(type, el) {
        currentTopType = type;
        document.querySelectorAll('.top-tab').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        db.ref('users').once('value', s => renderTop(s.val(), type));
    }

    function renderTop(data, type) {
        if(!data) return;
        let arr = [];
        for(let k in data) arr.push({n:k, ...data[k]});
        
        // Sorting Logic
        if (type === 'uah') arr.sort((a,b) => b.balance - a.balance);
        else if (type === 'usd') arr.sort((a,b) => (b.balanceUSD||0) - (a.balanceUSD||0));
        else if (type === 'btc') arr.sort((a,b) => (b.balanceBTC||0) - (a.balanceBTC||0));
        else if (type === 'time') arr.sort((a,b) => a.id - b.id); // Smaller ID = Older timestamp

        let h = "";
        arr.slice(0, 50).forEach((u,i) => {
            let val = "";
            if (type === 'uah') val = formatNumber(u.balance) + " ‚Ç¥";
            else if (type === 'usd') val = (u.balanceUSD||0).toFixed(2) + " $";
            else if (type === 'btc') val = (u.balanceBTC||0).toFixed(5) + " ‚Çø";
            else if (type === 'time') val = "ID: " + u.id;
            
            h += `<tr><td>${i+1}</td><td>${u.n}</td><td style="text-align:right; color:var(--accent);">${val}</td></tr>`;
        });
        document.getElementById('topTable').innerHTML = h;
    }

    // --- SUPPORT CHAT ---
    function loadChat() {
        const box = document.getElementById('chatBox');
        db.ref('support_chats/' + currentUser).limitToLast(20).on('child_added', s => {
            const m = s.val();
            const div = document.createElement('div');
            div.className = `msg ${m.sender === 'user' ? 'me' : 'support'}`;
            div.textContent = m.text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });
    }
    function sendChatMessage() {
        const txt = document.getElementById('chatInput').value.trim();
        if(!txt) return;
        db.ref('support_chats/' + currentUser).push({ text: txt, sender: 'user', time: Date.now() });
        document.getElementById('chatInput').value = "";
    }

    // --- THEME & SOUND ---
    function toggleTheme() { 
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
        localStorage.setItem('slotok_theme', currentTheme);
    }
    function applyTheme(t) { document.body.setAttribute('data-theme', t); }
    
    function toggleSound() { soundEnabled = !soundEnabled; localStorage.setItem('slotok_sound', soundEnabled); }
    function playSound(type) { 
        if(!soundEnabled) return; 
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); 
        o.connect(g); g.connect(audioCtx.destination); 
        const t=audioCtx.currentTime; 
        if(type==='click'){o.frequency.value=600;g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start(t);o.stop(t+0.1);}
        else if(type==='win'){o.type='triangle';o.frequency.setValueAtTime(500,t);o.frequency.linearRampToValueAtTime(1000,t+0.5);g.gain.linearRampToValueAtTime(0,t+0.5);o.start(t);o.stop(t+0.5);} 
    }

    // --- GAMES (Simulated) ---
    function spinSlots() { 
        const bet = parseInt(document.getElementById('betSlots').value);
        if(userData.balance < bet) return notify("–ú–∞–ª–æ –≥—Ä–æ—à–µ–π", "error");
        db.ref('users/'+currentUser+'/balance').set(userData.balance - bet);
        playSound('spin');
        setTimeout(() => {
            const win = Math.random() < 0.3 ? bet * 2 : 0;
            if(win) { db.ref('users/'+currentUser+'/balance').set(userData.balance + win); playSound('win'); notify(`+${win}`); }
        }, 1000);
    }
    
    function spinRoulette(color) {
        const bet = parseInt(document.getElementById('betRoulette').value);
        if(userData.balance < bet) return notify("–ú–∞–ª–æ –≥—Ä–æ—à–µ–π", "error");
        db.ref('users/'+currentUser+'/balance').set(userData.balance - bet);
        playSound('spin');
        const wheel = document.getElementById('wheel');
        wheel.style.transform = `rotate(${360 * 5 + Math.random() * 360}deg)`;
        setTimeout(() => {
            const res = Math.random();
            let win = 0;
            // Fake logic for demo
            if (res < 0.4 && color === 'black') win = bet * 2;
            else if (res < 0.8 && color === 'red') win = bet * 2;
            else if (res > 0.95 && color === 'green') win = bet * 14;
            
            if(win > 0) { db.ref('users/'+currentUser+'/balance').set(userData.balance + win); playSound('win'); notify(`+${win}`); }
            else notify("Loss", "error");
        }, 4000);
    }
    
    function startChests() {
        const bet = parseInt(document.getElementById('betChests').value);
        if(userData.balance < bet) return notify("–ú–∞–ª–æ –≥—Ä–æ—à–µ–π", "error");
        db.ref('users/'+currentUser+'/balance').set(userData.balance - bet);
        const grid = document.getElementById('chestsGrid'); grid.innerHTML = "";
        for(let i=0; i<3; i++) {
            const d = document.createElement('div'); d.className = "chest-item"; d.textContent = "üì¶";
            d.onclick = () => {
                if(d.textContent !== "üì¶") return;
                const win = Math.random() > 0.5 ? bet * 2.5 : 0;
                d.textContent = win ? "üí∞" : "üí®";
                if(win) { db.ref('users/'+currentUser+'/balance').set(userData.balance + win); playSound('win'); notify(`+${win}`); }
            };
            grid.appendChild(d);
        }
    }
    
    function simpleGame(name) { notify("–ó–∞–ø—É—Å—Ç—ñ—Ç—å –≥—Ä—É –∑ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é", "info"); }

    // --- AUTH & ADMIN ---
    function authAction() {
        const name = document.getElementById('authName').value.trim();
        const pass = document.getElementById('authPass').value;
        if(!name) return;
        db.ref('users/'+name).once('value', s => {
            if(s.exists()) {
                if(s.val().pass == pass) { currentUser=name; localStorage.setItem("royal_online_user",name); startDataSync(); }
                else notify("–ü–∞—Ä–æ–ª—å –Ω–µ–≤—ñ—Ä–Ω–∏–π", "error");
            } else {
                db.ref('users/'+name).set({pass, balance:1000, id:Date.now()}).then(()=> { currentUser=name; localStorage.setItem("royal_online_user",name); startDataSync(); });
            }
        });
    }
    function logout() { localStorage.removeItem("royal_online_user"); location.reload(); }
    
    function checkAdmin() {
        if(['theivankoo', 'admin'].includes(currentUser.toLowerCase()) || userData.isAdmin === true) {
            document.getElementById('adminPanelBtnBox').classList.remove('hidden');
        }
    }
    function switchTab(id, el) { document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); if(el) { document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); } }
    function openGame(g) { switchTab(g); }
    function notify(m,t='info') { const d=document.createElement('div'); d.className=`toast ${t}`; d.textContent=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }
    function initDeposit(a) { notify("–û–±—Ä–æ–±–∫–∞...", "info"); setTimeout(()=>{ db.ref('users/'+currentUser+'/balance').set(userData.balance+a); notify("OK"); }, 1000); }
    function openHistoryModal() { document.getElementById('history-modal').classList.remove('hidden'); }
    function openTransferModal() { document.getElementById('transfer-modal').classList.remove('hidden'); }
    function openPromoModal() { document.getElementById('promo-modal').classList.remove('hidden'); }
    function sendMoney() { 
        const to = document.getElementById('transferTo').value; const amt = parseInt(document.getElementById('transferAmount').value);
        if(userData.balance < amt) return notify("Err");
        db.ref('users/'+to).once('value', s=>{ if(s.exists()){ 
            db.ref('users/'+currentUser+'/balance').set(userData.balance-amt);
            db.ref('users/'+to+'/balance').set(s.val().balance+Math.floor(amt*0.975));
            notify("Sent");
        }});
    }
    function wipeEconomy() { if(confirm("WIPE ALL?")) db.ref('users').once('value', s=>{ for(let k in s.val()) db.ref('users/'+k+'/balance').set(1000); }); }
    function loadUserList() { 
        const d = document.getElementById('userList'); d.innerHTML="Loading..."; 
        db.ref('users').once('value', s=>{ 
            d.innerHTML=""; 
            for(let n in s.val()) d.innerHTML += `<div class="user-row"><b>${n}</b>: ${s.val()[n].balance} <button class="btn-xs btn-red" onclick="db.ref('users/${n}').remove()">DEL</button></div>`; 
        }); 
    }
  </script>
</body>
</html>