<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>SlotOK v46</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root { --bg: #050505; --text: #fff; --box: #141414; --border: #333; --accent: #d4af37; --input: #1a1a1a; --green: #4cd964; --red: #ff3b30; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; }
    
    .header { padding: 15px; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; display:flex; justify-content:space-between; align-items:center; }
    .header h1 { margin: 0; font-size: 24px; color: var(--accent); font-weight: 900; font-style: italic; }

    .container { padding: 15px; } 
    .hidden { display: none !important; }
    .box { background: var(--box); border-radius: 12px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; }
    
    button { padding: 14px; width: 100%; border: none; border-radius: 10px; font-weight: bold; font-size: 15px; cursor: pointer; background: #333; color: #fff; margin-bottom: 8px; transition: 0.2s; }
    button:active { transform: scale(0.98); }
    .btn-gold { background: linear-gradient(45deg, var(--accent), #ffdb4d); color: #000; } 
    .btn-red { background: var(--red); color: #fff; } 
    .btn-green { background: var(--green); color: #000; } 
    .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
    .btn-tg { background: linear-gradient(45deg, #229ED9, #1a7fc4); color: #fff; }
    
    input { width: 100%; padding: 14px; margin-bottom: 12px; background: var(--input); border: 1px solid var(--border); color: #fff; border-radius: 10px; font-size: 16px; box-sizing: border-box; text-align: center; font-weight: bold; } 

    /* –ì–û–õ–û–í–ù–ê */
    .hero-banner { width: 100%; height: 150px; background: linear-gradient(135deg, #1e1e1e, #000); border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
    .hero-title { font-size: 24px; font-weight: 900; color: var(--accent); margin-bottom: 5px; }
    
    .games-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .game-thumb { min-width: 100px; height: 100px; background: var(--box); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; gap: 5px; }
    .game-thumb span.icon { font-size: 35px; }
    .game-thumb span.label { font-size: 10px; color: #777; }

    /* –õ–û–ë–Ü */
    .game-card { background: var(--box); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 10px; display:flex; align-items:center; gap:15px; cursor: pointer; }
    .game-icon { font-size: 35px; } .game-title { font-size: 16px; font-weight: bold; } .game-desc { font-size: 12px; color: #777; }

    /* –Ü–ì–†–ò */
    .reels-container { background: #000; border: 1px solid var(--accent); border-radius: 10px; padding: 15px; display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; } 
    .reel { font-size: 45px; width: 70px; height: 90px; line-height: 90px; background: #fff; color: #000; border-radius: 5px; text-align: center; }
    
    .roulette-wheel { width: 220px; height: 220px; border-radius: 50%; border: 6px solid #222; margin: 0 auto 15px; background: conic-gradient(#4cd964 0deg 18deg, #222 18deg 189deg, #b71c1c 189deg 360deg); transition: 4s ease-out; transform: rotate(0deg); }
    .bet-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; } 
    .bet-btn { padding: 10px; border-radius: 6px; background: #222; color: #888; font-size: 11px; text-align: center; border: 1px solid #333; cursor: pointer; } 
    .bet-btn.selected { border-color: var(--accent); color: #fff; background: #333; }
    
    .chests-grid { display: grid; gap: 8px; margin-bottom: 15px; grid-template-columns: repeat(3, 1fr); } 
    .chest-item { background: #222; border-radius: 8px; height: 70px; display: flex; align-items: center; justify-content: center; font-size: 35px; border:1px solid #333; cursor:pointer;} 
    
    .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; }
    .mine-cell { aspect-ratio: 1; background: #222; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid #333; cursor:pointer;}
    .mine-cell.revealed { background: #111; border-color: #000; }
    
    .plinko-board { position: relative; width: 100%; height: 250px; background: #111; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; overflow: hidden; } 
    .plinko-ball { position: absolute; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; display: none; }
    .plinko-buckets { display: flex; justify-content: space-between; } .bucket { font-size: 10px; background: #222; width: 14%; text-align: center; border-top: 2px solid #444; padding: 3px 0; }

    .crash-screen { background: #111; height: 200px; border-radius: 12px; border: 1px solid #333; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; overflow: hidden; }
    .crash-rocket { font-size: 40px; position: absolute; bottom: 20px; left: 20px; transition: 0.1s linear; } 
    .crash-multiplier { font-size: 40px; font-weight: bold; color: #fff; z-index: 10; }
    .crash-graph { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; }

    /* –ü–û–ö–ï–† */
    .poker-table { background: radial-gradient(ellipse at center, #1a5c2a 0%, #0d3318 100%); border-radius: 12px; border: 3px solid #8B6914; padding: 15px; margin-bottom: 15px; min-height: 200px; }
    .poker-cards { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
    .card { width: 50px; height: 75px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; border: 1px solid #ddd; color: #000; flex-direction: column; line-height: 1.1; box-shadow: 0 2px 6px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s; }
    .card.red-card { color: #cc0000; }
    .card.selected { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 4px 12px rgba(212,175,55,0.5); }
    .card.face-down { background: linear-gradient(135deg, #1a3a6b 0%, #0d1f3d 100%); color: transparent; }
    .card.face-down::after { content: "üÇ†"; font-size: 30px; color: rgba(255,255,255,0.3); }
    .poker-info { text-align: center; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 8px; margin: 8px 0; color: #fff; font-size: 14px; }
    .poker-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    /* –ê–î–ú–Ü–ù–ö–ê & –¢–û–ü */
    .admin-user-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #1a1a1a; margin-bottom: 8px; border-radius: 8px; border: 1px solid #333; color: #fff; cursor: pointer;}
    .rank { color: var(--accent); font-weight: bold; width: 30px; text-align:center; }
    table { width: 100%; border-collapse: collapse; } td { padding: 12px 5px; border-bottom: 1px solid #333; font-size: 14px; } 

    /* NAV & MODALS */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #080808; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); } 
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; font-size: 10px; width: 14%; height: 100%; cursor: pointer;} 
    .nav-item span.icon { font-size: 22px; margin-bottom: 4px; } .nav-item.active { color: var(--accent); }
    
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--accent); font-size:24px; flex-direction: column; transition: opacity 0.5s; }
    #auth-screen, .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 6000; width: 90%; max-width: 400px; pointer-events: none; } 
    .toast { background: #222; color: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; border-left: 4px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 14px; animation: slideIn 0.3s ease; }
    .toast.success { border-left-color: var(--green); }
    .toast.error { border-left-color: var(--red); }
    @keyframes slideIn { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }
    
    .contact-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1a1a1a; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; }
    .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; } 
    .avatar-large { width: 70px; height: 70px; background: #222; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 30px; overflow: hidden; } 
    .avatar-large img { width: 100%; height: 100%; object-fit: cover; }
    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; } 
    .pay-btn { background: var(--input); border: 1px solid var(--border); padding: 10px 2px; border-radius: 8px; text-align: center; font-size: 10px; color: #aaa; cursor: pointer; } 
    .pay-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(212, 175, 55, 0.1); }
    
    /* TELEGRAM –î–ï–ü–û–ó–ò–¢ */
    .tg-deposit-box { background: linear-gradient(135deg, #1a2a3a, #0d1a27); border: 1px solid #229ED9; border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center; }
    .tg-logo { font-size: 50px; margin-bottom: 10px; }
    .tg-title { color: #229ED9; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    .tg-desc { color: #aaa; font-size: 12px; margin-bottom: 15px; line-height: 1.5; }
    .tg-steps { text-align: left; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px; }
    .tg-step { display: flex; gap: 10px; margin-bottom: 8px; font-size: 13px; color: #ccc; }
    .tg-step-num { color: #229ED9; font-weight: bold; min-width: 20px; }
    .amount-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .amount-btn { background: #222; border: 1px solid #333; border-radius: 8px; padding: 10px 5px; text-align: center; font-size: 13px; color: #ccc; cursor: pointer; font-weight: bold; }
    .amount-btn.selected { border-color: #229ED9; color: #229ED9; background: rgba(34, 158, 217, 0.1); }
    
    /* –í–ò–í–Ü–î */
    .withdraw-box { background: linear-gradient(135deg, #1a2a1a, #0d1a0d); border: 1px solid var(--green); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .withdraw-title { color: var(--green); font-size: 16px; font-weight: bold; margin-bottom: 10px; }
    .withdraw-method { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .wm-btn { background: #222; border: 1px solid #333; border-radius: 8px; padding: 8px 12px; font-size: 12px; color: #aaa; cursor: pointer; }
    .wm-btn.selected { border-color: var(--green); color: var(--green); }
    .pending-withdraw { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .pw-status { font-size: 11px; padding: 3px 8px; border-radius: 10px; }
    .pw-pending { background: rgba(212,175,55,0.2); color: var(--accent); }
    .pw-done { background: rgba(76,217,100,0.2); color: var(--green); }

    /* –©–û–î–ï–ù–ù–ò–ô –ë–û–ù–£–° */
    .daily-bonus-modal-content { padding: 20px; text-align: center; }
    .bonus-icon { font-size: 60px; animation: bounce 0.5s ease infinite alternate; }
    @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
    .bonus-amount { font-size: 36px; font-weight: 900; color: var(--accent); margin: 10px 0; }
    .streak-dots { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
    .streak-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .streak-dot.done { background: var(--accent); border-color: var(--accent); color: #000; }
    .streak-dot.today { background: var(--green); border-color: var(--green); color: #000; animation: pulse 1s ease infinite; }
    @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(76,217,100,0.4); } 50% { box-shadow: 0 0 0 8px rgba(76,217,100,0); } }

    /* –°–¢–ê–¢–£–° –ó–ê–Ø–í–ö–ò */
    .request-card { background: #1a1a1a; border-radius: 8px; border: 1px solid #333; padding: 12px; margin-bottom: 8px; }
    .section-header { color: #777; font-size: 12px; margin: 15px 0 8px; text-transform: uppercase; letter-spacing: 1px; border-left: 3px solid var(--accent); padding-left: 8px; }

    /* –ë–õ–ï–ö–î–ñ–ï–ö */
    .bj-table { background: radial-gradient(ellipse, #0d3318 0%, #071a0d 100%); border-radius: 12px; border: 3px solid #8B6914; padding: 15px; margin-bottom: 15px; }
    .bj-area { text-align: center; margin-bottom: 10px; }
    .bj-label { color: #aaa; font-size: 12px; margin-bottom: 5px; }
    .bj-cards { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; min-height: 75px; }
    .bj-card { width: 46px; height: 68px; background: #fff; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 1px solid #ddd; }
    .bj-card.red { color: #cc0000; }
    .bj-score { font-size: 18px; font-weight: bold; color: var(--accent); margin-top: 5px; }
    .bj-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    /* –ö–ï–ù–û */
    .keno-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-bottom: 15px; }
    .keno-num { aspect-ratio: 1; background: #222; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; border: 1px solid #333; cursor: pointer; color: #aaa; }
    .keno-num.picked { background: #1a3a6b; border-color: #4a7ac0; color: #fff; }
    .keno-num.hit { background: var(--green); border-color: var(--green); color: #000; }
    .keno-num.miss { background: #333; color: #555; }

    /* –°–ö–†–ï–¢–ß */
    .scratch-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
    .scratch-cell { height: 80px; background: linear-gradient(135deg, #888, #555); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; border: 2px solid #999; position: relative; overflow: hidden; }
    .scratch-cell.scratched { background: #111; border-color: #333; }
    .scratch-overlay { position: absolute; inset: 0; background: linear-gradient(135deg, #888, #555); display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 12px; font-weight: bold; }

    /* –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–ò */
    .fortune-wheel-wrap { position: relative; width: 260px; height: 260px; margin: 0 auto 15px; }
    .fortune-wheel { width: 100%; height: 100%; border-radius: 50%; border: 6px solid #8B6914; transition: 4s cubic-bezier(0.17,0.67,0.12,0.99); position: relative; }
    .wheel-arrow { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 28px; z-index: 10; filter: drop-shadow(0 2px 4px #000); }
    .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 40px; height: 40px; background: #8B6914; border-radius: 50%; border: 3px solid #ffdb4d; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 16px; }

    /* –ß–ê–¢ –õ–û–ë–Ü */
    /* old chat-box replaced below */

    /* ===== CASHIER TABS ===== */
    .cashier-tab-btn { flex:1;padding:10px;background:none;border:none;color:#777;font-size:12px;font-weight:bold;cursor:pointer;border-radius:10px;transition:all 0.2s; }
    .cashier-tab-btn.active { background:var(--accent);color:#000; }
    .chart-period-btn { padding:4px 10px;background:var(--input);border:1px solid var(--border);color:#777;border-radius:8px;font-size:11px;cursor:pointer; }
    .chart-period-btn.active { background:var(--accent);color:#000;border-color:var(--accent); }

    /* ===== SPORT BETTING v2 ‚Äî REAL ===== */
    .match-card { background:var(--box);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;transition:border-color 0.2s; }
    .match-card:hover { border-color:#444; }
    .match-card.live { border-color:#e74c3c;box-shadow:0 0 12px rgba(231,76,60,0.15); }
    .live-score-badge { background:#1a0505;border:2px solid #e74c3c;color:#fff;font-size:22px;font-weight:900;font-family:monospace;border-radius:12px;padding:6px 14px;letter-spacing:2px;animation:livePulse 2s infinite; }
    @keyframes livePulse { 0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.4)} 50%{box-shadow:0 0 0 8px rgba(231,76,60,0)} }
    .match-odds-row { display:flex;gap:6px; }
    .odds-btn { flex:1;background:var(--input);border:2px solid var(--border);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.15s; }
    .odds-btn:hover:not(.disabled) { border-color:var(--accent);background:rgba(212,175,55,0.08); }
    .odds-btn.disabled { opacity:0.4;cursor:not-allowed; }
    .odds-label { font-size:10px;color:#777;margin-bottom:4px; }
    .odds-val { font-size:16px;font-weight:900;color:var(--accent); }
    .ai-badge { background:rgba(212,175,55,0.15);border:1px solid rgba(212,175,55,0.3);color:var(--accent);font-size:9px;font-weight:bold;padding:2px 6px;border-radius:8px; }

        /* ===== SPORT BETTING ===== */
    .sport-tab-btn { padding:7px 14px;background:var(--input);border:1px solid var(--border);color:#777;border-radius:20px;font-size:11px;font-weight:bold;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all 0.15s;-webkit-tap-highlight-color:transparent; }
    .sport-tab-btn.active { background:var(--accent);color:#000;border-color:var(--accent); }
    .sport-tab-btn:hover { border-color:#555;color:#ccc; }
    #sportTabsRow::-webkit-scrollbar { display:none; }
    #sportTabsRow { -ms-overflow-style:none; }
    .match-card { background:var(--box);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer; }
    .match-card:hover { border-color:#555; }
    .match-odds-row { display:flex;gap:6px;margin-top:10px; }
    .odds-btn { flex:1;padding:10px 4px;background:var(--input);border:1px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s; }
    .odds-btn:hover { border-color:var(--green);background:rgba(39,174,96,0.1); }
    .odds-btn.selected { border-color:var(--green);background:rgba(39,174,96,0.2); }
    .odds-val { font-size:16px;font-weight:900;color:var(--green); }
    .odds-label { font-size:10px;color:#555;margin-top:2px; }
    .ai-badge { display:inline-block;background:linear-gradient(90deg,#27ae60,#2ecc71);color:#000;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:8px;margin-left:4px; }
    .bet-status-won { color:var(--green);font-weight:bold; }
    .bet-status-lost { color:var(--red);font-weight:bold; }
    .bet-status-pending { color:var(--accent);font-weight:bold; }

    /* ===== TOWER GAME ===== */
    .tower-cell { flex:1;height:44px;background:var(--input);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all 0.15s;position:relative; }
    .tower-cell:hover { border-color:#aaa;transform:scale(1.05); }
    .tower-cell.safe { background:#0d2a0d;border-color:var(--green); }
    .tower-cell.mine { background:#2a0d0d;border-color:var(--red); }
    .tower-cell.disabled { cursor:default;opacity:0.5; }
    .tower-row { display:flex;gap:6px; }

    /* ===== HILO GAME ===== */
    .hilo-card { width:80px;height:110px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,0.5); }

    /* ===== DICE ===== */
    .dice-result-dot { width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#fff; }

    /* ===== RATE TICKER ===== */
    @keyframes tickerScroll { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
    #rateTicker:hover #rateTickerInner { animation-play-state:paused; }

    /* ===== CURRENCY SYSTEM ===== */
    .currency-btn { padding:12px 8px;background:var(--input);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.15s;text-align:center; }
    .currency-btn:hover { border-color:#555; }
    .currency-btn.active { border-color:var(--accent);background:rgba(212,175,55,0.12); }
    #currencyPickerModal .currency-btn { display:flex;flex-direction:column;align-items:center; }
    .rate-ticker { font-size:9px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .currency-flag { font-size:20px; }
    .header-bal { font-size: 15px; background: #1a1a1a; padding: 6px 12px; border-radius: 16px; border: 1px solid #333; font-weight:bold; color: var(--green); cursor: pointer; white-space:nowrap; }

    /* ===== HOME SUB-TABS ===== */
    .home-tabs { display:flex; gap:0; background:#111; border-radius:12px; padding:4px; margin-bottom:15px; border:1px solid #222; }
    .home-tab-btn { flex:1; padding:10px 6px; border-radius:8px; font-size:12px; font-weight:bold; cursor:pointer; text-align:center; color:#666; transition:all 0.2s; position:relative; }
    .home-tab-btn.active { background:var(--box); color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.4); }
    .home-tab-btn .htbadge { position:absolute; top:4px; right:6px; background:var(--red); color:#fff; border-radius:8px; font-size:8px; padding:1px 4px; font-weight:bold; }
    .home-panel { display:none; }
    .home-panel.active { display:block; }

    /* ===== –ù–û–í–ò–ù–ò ===== */
    .news-card { background:var(--box); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-bottom:14px; }
    .news-header { padding:14px 14px 10px; }
    .news-author { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .news-avatar { width:38px; height:38px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; overflow:hidden; }
    .news-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .news-name { font-size:13px; font-weight:bold; }
    .news-time { font-size:10px; color:#555; }
    .news-admin-badge { background:linear-gradient(45deg,#ff4444,#cc0000); color:#fff; font-size:9px; padding:1px 6px; border-radius:8px; margin-left:4px; font-weight:bold; }
    .news-title { font-size:16px; font-weight:900; color:#fff; margin-bottom:6px; line-height:1.3; }
    .news-body  { font-size:13px; color:#aaa; line-height:1.5; margin-bottom:10px; }
    .news-image { width:100%; max-height:200px; object-fit:cover; background:#111; }
    .news-reactions { display:flex; gap:8px; padding:10px 14px; border-top:1px solid #1a1a1a; flex-wrap:wrap; }
    .reaction-btn { display:flex; align-items:center; gap:4px; padding:5px 10px; background:#1a1a1a; border-radius:20px; cursor:pointer; font-size:13px; border:1px solid transparent; transition:all 0.15s; }
    .reaction-btn.reacted { border-color:var(--accent); background:rgba(212,175,55,0.1); }
    .reaction-count { font-size:11px; color:#777; }
    .news-comments-toggle { padding:8px 14px; color:#777; font-size:12px; cursor:pointer; border-top:1px solid #111; display:flex; align-items:center; gap:5px; }
    .news-comments-toggle:hover { color:#aaa; }
    .news-comments-box { display:none; border-top:1px solid #1a1a1a; padding:10px 14px; }
    .news-comments-box.open { display:block; }
    .comment-item { display:flex; gap:8px; padding:7px 0; border-bottom:1px solid #111; }
    .comment-avatar { width:28px; height:28px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; overflow:hidden; }
    .comment-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .comment-nick { font-size:12px; font-weight:bold; color:var(--accent); cursor:pointer; }
    .comment-text { font-size:12px; color:#ccc; margin-top:2px; line-height:1.4; }
    .comment-time { font-size:10px; color:#444; margin-top:2px; }
    .comment-input-row { display:flex; gap:8px; margin-top:8px; }

    /* ===== –ë–û–¢–ò ===== */
    .bot-card { display:flex; align-items:center; gap:10px; padding:10px 12px; background:#111; border:1px solid #222; border-radius:10px; margin-bottom:6px; }
    .bot-avatar { width:36px; height:36px; border-radius:50%; background:#1a1a1a; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; overflow:hidden; }
    .bot-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .bot-status { font-size:9px; padding:2px 7px; border-radius:8px; font-weight:bold; }
    .bot-status.active   { background:rgba(76,217,100,0.2); color:var(--green); }
    .bot-status.inactive { background:rgba(100,100,100,0.2); color:#666; }

    /* ===== CHAT IMPROVEMENTS ===== */
    .chat-box { height:300px; overflow-y:auto; background:#050505; border:1px solid #1a1a1a; border-radius:10px; padding:10px; margin-bottom:10px; scrollbar-width:thin; scrollbar-color:#222 transparent; }
    .chat-msg { margin-bottom:10px; padding:8px 10px; background:#111; border-radius:8px; border-left:2px solid #222; }
    .chat-msg.mine { border-left-color:var(--accent); background:rgba(212,175,55,0.06); }
    .chat-msg.admin-msg { border-left-color:var(--red); background:rgba(255,59,48,0.05); }
    .chat-msg.bot-msg { border-left-color:#9b59b6; background:rgba(155,89,182,0.06); }
    .chat-avatar-sm { width:22px; height:22px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:12px; vertical-align:middle; margin-right:5px; overflow:hidden; flex-shrink:0; }
    .chat-avatar-sm img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .chat-header-line { display:flex; align-items:center; gap:4px; margin-bottom:4px; }
    .chat-body-text { font-size:13px; color:#ccc; line-height:1.4; word-break:break-word; }
    .chat-emoji-pick { display:flex; gap:6px; padding:6px; background:#111; border-radius:8px; margin-bottom:8px; }
    .chat-emoji-btn { font-size:20px; cursor:pointer; padding:4px; border-radius:6px; transition:transform 0.1s; }
    .chat-emoji-btn:active { transform:scale(1.3); }
    .online-pill { display:inline-flex; align-items:center; gap:5px; background:#0d1a0d; border:1px solid #1a2a1a; border-radius:20px; padding:4px 10px; font-size:12px; color:var(--green); }

    .chat-nick { font-weight: bold; cursor: pointer; }
    .chat-nick:hover { text-decoration: underline; }
    .chat-time { color: #555; font-size: 10px; margin-left: 5px; }
    .chat-input-row { display: flex; gap: 8px; }
    .chat-system { color: #555; font-style: italic; font-size: 12px; text-align: center; padding: 4px 0; }
    .online-badge { display: inline-block; width: 8px; height: 8px; background: var(--green); border-radius: 50%; margin-right: 4px; }

    /* –î–£–ï–õ–Ü */
    .duel-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 12px; margin-bottom: 8px; }
    .duel-vs { text-align: center; color: var(--red); font-weight: bold; font-size: 18px; }
    .duel-players { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; text-align: center; }
    .duel-status { font-size: 11px; padding: 3px 10px; border-radius: 10px; }
    .ds-waiting { background: rgba(212,175,55,0.2); color: var(--accent); }
    .ds-active { background: rgba(76,217,100,0.2); color: var(--green); }

    /* –¢–£–†–ù–Ü–†–ò */
    .tournament-card { background: linear-gradient(135deg, #1a1a00, #0d0d00); border: 1px solid var(--accent); border-radius: 12px; padding: 15px; margin-bottom: 12px; }
    .t-prize { font-size: 24px; font-weight: 900; color: var(--accent); }
    .t-info { color: #777; font-size: 12px; margin-top: 5px; }
    .t-leaderboard { margin-top: 10px; }
    .t-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1a1a00; font-size: 13px; }

    /* –†–ï–§–ï–†–ê–õ–ò */
    .ref-link-box { background: #111; border: 1px solid #333; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; word-break: break-all; font-size: 12px; color: #aaa; }
    .ref-stat { text-align: center; flex: 1; }
    .ref-stat-num { font-size: 24px; font-weight: bold; color: var(--accent); }
    .ref-stat-label { font-size: 11px; color: #777; }

    /* –ü–£–ë–õ–Ü–ß–ù–ò–ô –ü–†–û–§–Ü–õ–¨ */
    .pub-profile { background: var(--box); border-radius: 12px; padding: 20px; }
    .pub-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .pub-stat { background: #111; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #222; }
    .pub-stat-val { font-size: 20px; font-weight: bold; color: var(--accent); }
    .pub-stat-label { font-size: 11px; color: #777; margin-top: 3px; }
    .pub-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
    .badge { background: #222; border: 1px solid #444; border-radius: 20px; padding: 4px 10px; font-size: 11px; color: #aaa; }
    .badge.gold { border-color: var(--accent); color: var(--accent); background: rgba(212,175,55,0.1); }

    /* –ê–î–ú–Ü–ù –†–û–ó–®–ò–†–ï–ù–ò–ô */
    .admin-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .admin-stat { background: #111; border: 1px solid #222; border-radius: 8px; padding: 12px; text-align: center; }
    .admin-stat-val { font-size: 22px; font-weight: bold; color: var(--accent); }
    .admin-stat-label { font-size: 11px; color: #555; }
    .promo-row { display: flex; justify-content: space-between; align-items: center; background: #111; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; border: 1px solid #222; }
    .announce-item { background: #1a1a00; border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
    .support-thread { background: #111; border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid #222; cursor: pointer; }
    .support-thread:hover { border-color: #444; }
    .support-unread { background: var(--accent); color: #000; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; }

    /* ===== VIP –°–ò–°–¢–ï–ú–ê ===== */
    :root {
      --bronze: #cd7f32; --silver-c: #aaa; --gold-c: #d4af37; --plat: #e5e4e2;
    }
    .vip-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .vip-bronze { background: rgba(205,127,50,0.2); border: 1px solid var(--bronze); color: var(--bronze); }
    .vip-silver { background: rgba(170,170,170,0.15); border: 1px solid var(--silver-c); color: var(--silver-c); }
    .vip-gold { background: rgba(212,175,55,0.2); border: 1px solid var(--gold-c); color: var(--gold-c); }
    .vip-platinum { background: rgba(229,228,226,0.15); border: 1px solid var(--plat); color: var(--plat); box-shadow: 0 0 10px rgba(229,228,226,0.2); }
    .vip-progress-bar { height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin: 6px 0 3px; }
    .vip-progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    .vip-card { border-radius: 14px; padding: 18px; margin-bottom: 12px; position: relative; overflow: hidden; }
    .vip-card::before { content:''; position:absolute; top:-40px; right:-40px; width:120px; height:120px; border-radius:50%; opacity:0.08; }
    .vip-card.bronze { background: linear-gradient(135deg, #1a0f05, #2d1a08); border: 1px solid var(--bronze); }
    .vip-card.bronze::before { background: var(--bronze); }
    .vip-card.silver { background: linear-gradient(135deg, #111, #1a1a1a); border: 1px solid var(--silver-c); }
    .vip-card.gold { background: linear-gradient(135deg, #1a1500, #2d2400); border: 1px solid var(--gold-c); }
    .vip-card.platinum { background: linear-gradient(135deg, #0d0d12, #1a1a22); border: 1px solid var(--plat); }
    .vip-perk { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
    .vip-perk-icon { font-size: 18px; min-width: 25px; }
    .cashback-toast { background: linear-gradient(135deg, #0d2a0d, #1a4a1a); border-left-color: var(--green) !important; }

    /* ===== –õ–£–¢–ë–û–ö–°–ò ===== */
    .lootbox-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .lootbox-card { border-radius: 14px; padding: 15px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid; position: relative; overflow: hidden; }
    .lootbox-card:active { transform: scale(0.96); }
    .lootbox-card.common { background: linear-gradient(135deg, #1a1a1a, #222); border-color: #555; }
    .lootbox-card.rare { background: linear-gradient(135deg, #0d1a3a, #1a2a5a); border-color: #4a7ac0; }
    .lootbox-card.epic { background: linear-gradient(135deg, #2a0d3a, #3a1a5a); border-color: #9b59b6; }
    .lootbox-icon { font-size: 40px; margin-bottom: 5px; }
    .lootbox-name { font-size: 11px; font-weight: bold; margin-bottom: 3px; }
    .lootbox-price { font-size: 14px; font-weight: 900; }
    .lootbox-common-color { color: #aaa; }
    .lootbox-rare-color { color: #4a9eff; }
    .lootbox-epic-color { color: #b57bee; }
    .lootbox-reward-screen { text-align: center; padding: 30px 20px; }
    .lootbox-open-anim { font-size: 80px; animation: lbPop 0.5s ease; }
    @keyframes lbPop { 0% { transform: scale(0); opacity:0; } 60% { transform: scale(1.3); } 100% { transform: scale(1); opacity:1; } }
    .lootbox-win-amount { font-size: 48px; font-weight: 900; color: var(--accent); margin: 15px 0 5px; animation: lbPop 0.4s ease 0.2s both; }
    .lootbox-win-type { font-size: 12px; color: #777; margin-bottom: 20px; }

    /* ===== –ü–û–ì–û–î–ò–ù–ù–ò–ô –ë–û–ù–£–° ===== */
    .hourly-ring { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #333; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 15px; position: relative; cursor: pointer; transition: border-color 0.3s; }
    .hourly-ring.ready { border-color: var(--green); box-shadow: 0 0 20px rgba(76,217,100,0.3); animation: pulse 1.5s ease infinite; }
    .hourly-cooldown-text { font-size: 30px; font-weight: 900; color: var(--accent); text-align: center; }
    .hourly-vip-perks { display: flex; justify-content: space-between; margin-top: 12px; }
    .hourly-vip-tier { text-align: center; flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 11px; background: #111; border: 1px solid #222; margin: 0 3px; }
    .hourly-vip-tier.active { border-color: var(--accent); background: rgba(212,175,55,0.08); }
    .hourly-vip-amount { font-size: 16px; font-weight: bold; margin-bottom: 2px; }

    /* ===== –ö–í–ï–°–¢–ò ===== */
    .quest-card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 14px; margin-bottom: 10px; }
    .quest-card.done { border-color: var(--green); background: rgba(76,217,100,0.05); }
    .quest-card.claimed { border-color: #333; opacity: 0.5; }
    .quest-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .quest-icon { font-size: 24px; }
    .quest-title { font-size: 14px; font-weight: bold; flex: 1; }
    .quest-reward { font-size: 13px; color: var(--accent); font-weight: bold; }
    .quest-prog-bar { height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
    .quest-prog-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ffdb4d); border-radius: 3px; transition: width 0.4s ease; }
    .quest-prog-text { font-size: 11px; color: #777; }
    .quest-claim-btn { background: linear-gradient(45deg, var(--accent), #ffdb4d); color: #000; border: none; border-radius: 8px; padding: 8px 16px; font-weight: bold; font-size: 12px; cursor: pointer; width: 100%; margin-top: 8px; }
    .quest-timer { font-size: 11px; color: #555; text-align: right; }
    .tab-badge { display: inline-block; background: var(--red); color: #fff; border-radius: 10px; font-size: 9px; font-weight: bold; padding: 1px 5px; margin-left: 3px; vertical-align: middle; animation: pulse 1s ease infinite; }

    /* ===== –ö–õ–ê–ù–ò ===== */
    .clan-banner { border-radius: 14px; padding: 18px; margin-bottom: 15px; position: relative; overflow: hidden; }
    .clan-banner.none   { background: linear-gradient(135deg,#111,#1a1a1a); border: 1px dashed #444; }
    .clan-banner.member { background: linear-gradient(135deg,#0d1a0d,#1a2d1a); border: 1px solid var(--green); }
    .clan-name   { font-size: 22px; font-weight: 900; }
    .clan-tag    { font-size: 11px; color: #777; margin-top: 3px; }
    .clan-stats  { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 12px 0; }
    .clan-stat   { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px 6px; text-align: center; }
    .clan-stat-v { font-size: 18px; font-weight: bold; color: var(--accent); }
    .clan-stat-l { font-size: 10px; color: #777; margin-top: 2px; }
    .clan-member-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: #111; border-radius: 8px; margin-bottom: 6px; border: 1px solid #222; }
    .clan-member-avatar { width: 36px; height: 36px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .clan-role   { font-size: 10px; padding: 2px 7px; border-radius: 8px; margin-left: auto; }
    .clan-role.leader  { background: rgba(212,175,55,0.2); color: var(--accent); }
    .clan-role.member  { background: rgba(76,217,100,0.15); color: var(--green); }
    .clan-task   { background: #111; border: 1px solid #222; border-radius: 10px; padding: 12px; margin-bottom: 8px; }
    .clan-task.done { border-color: var(--green); }
    /* ===== –õ–Ü–î–ï–†–ë–û–†–î ===== */
    .lb-tabs { display: flex; gap: 6px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
    .lb-tab  { padding: 7px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; background: #1a1a1a; border: 1px solid #333; color: #777; white-space: nowrap; }
    .lb-tab.active { background: rgba(212,175,55,0.15); border-color: var(--accent); color: var(--accent); }
    .lb-row  { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #111; border-radius: 10px; margin-bottom: 6px; border: 1px solid #1a1a1a; cursor: pointer; }
    .lb-row:active { background: #1a1a1a; }
    .lb-medal { font-size: 20px; min-width: 28px; text-align: center; }
    .lb-name  { flex: 1; font-size: 14px; font-weight: bold; }
    .lb-val   { font-size: 14px; color: var(--accent); font-weight: bold; }
    .lb-me    { border-color: var(--accent) !important; background: rgba(212,175,55,0.05) !important; }
    /* ===== –ü–û–î–ê–†–£–ù–ö–ò ===== */
    .gift-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .gift-card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 14px; text-align: center; cursor: pointer; transition: border-color 0.2s, transform 0.15s; }
    .gift-card:active { transform: scale(0.97); }
    .gift-card.selected { border-color: var(--accent); background: rgba(212,175,55,0.06); }
    .gift-icon   { font-size: 36px; margin-bottom: 6px; }
    .gift-name   { font-size: 13px; font-weight: bold; }
    .gift-price  { font-size: 12px; color: var(--accent); margin-top: 3px; }
    .gift-desc   { font-size: 10px; color: #555; margin-top: 2px; }
    .inbox-gift  { display: flex; align-items: center; gap: 12px; padding: 12px; background: #111; border: 1px solid #222; border-radius: 10px; margin-bottom: 8px; }
    .inbox-gift.new-gift { border-color: var(--accent); background: rgba(212,175,55,0.05); animation: pulse 2s ease infinite; }
    /* ===== –ú–û–ù–û–ü–û–õ–Ü–Ø ===== */
    .mono-board-wrap { position: relative; width: 100%; max-width: 420px; margin: 0 auto 10px; aspect-ratio: 1; background: #e8f4e8; border: 3px solid #2d5a2d; border-radius: 4px; overflow: hidden; }
    .mono-board { display: grid; grid-template-columns: 56px repeat(9,1fr) 56px; grid-template-rows: 56px repeat(9,1fr) 56px; width: 100%; height: 100%; }
    .mono-cell { border: 0.5px solid #bbb; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 7px; text-align: center; cursor: pointer; position: relative; overflow: hidden; line-height: 1.1; padding: 1px; background: #f5f5f5; }
    .mono-cell.corner { font-size: 9px; background: #d4edda; font-weight: bold; }
    .mono-cell.prop-top    { border-bottom: 4px solid; }
    .mono-cell.prop-bottom { border-top: 4px solid; }
    .mono-cell.prop-left   { border-right: 4px solid; }
    .mono-cell.prop-right  { border-left: 4px solid; }
    .mono-cell.owned-me    { box-shadow: inset 0 0 0 2px #4cd964; }
    .mono-cell.owned-ai    { box-shadow: inset 0 0 0 2px #ff3b30; }
    .mono-cell .cell-price { font-size: 6px; color: #666; }
    .mono-player { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid #fff; font-size: 8px; z-index: 5; transition: all 0.5s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.5); pointer-events: none; }
    .mono-center { grid-column: 2/11; grid-row: 2/11; background: #d4edda; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; color: #2d5a2d; letter-spacing: 2px; text-align: center; }
    .mono-info-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .mono-info-card { background: #111; border-radius: 10px; padding: 12px; border: 1px solid #222; text-align: center; }
    .mono-info-val { font-size: 20px; font-weight: bold; }
    .mono-info-lbl { font-size: 10px; color: #777; margin-top: 2px; }
    .mono-dice { display: flex; justify-content: center; gap: 12px; margin: 8px 0; }
    .mono-die  { width: 44px; height: 44px; background: #fff; border-radius: 8px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 26px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); transition: transform 0.3s; }
    .mono-die.rolling { animation: diceRoll 0.5s ease; }
    @keyframes diceRoll { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-25deg)scale(1.1)} 75%{transform:rotate(25deg)scale(1.1)} }
    .mono-log  { height: 120px; overflow-y: auto; background: #0a0a0a; border: 1px solid #222; border-radius: 8px; padding: 8px; font-size: 12px; scrollbar-width: none; }
    .mono-log-item { padding: 3px 0; border-bottom: 1px solid #0d0d0d; color: #ccc; }
    .mono-log-item.good  { color: var(--green); }
    .mono-log-item.bad   { color: var(--red); }
    .mono-log-item.info  { color: var(--accent); font-weight: bold; }
    .mono-action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }


    /* ===== NAV DOT ===== */
    .nav-notif-dot { position:absolute; top:8px; right:12px; width:8px; height:8px; background:var(--red); border-radius:50%; border:1.5px solid #080808; }

    /* ===== –°–ü–û–í–Ü–©–ï–ù–ù–Ø ===== */
    .notif-item { display:flex; align-items:flex-start; gap:12px; padding:12px; background:#111; border:1px solid #1a1a1a; border-radius:12px; margin-bottom:8px; cursor:pointer; transition:border-color 0.2s; }
    .notif-item.unread { border-left:3px solid var(--accent); background:rgba(212,175,55,0.04); }
    .notif-item.unread.green-notif { border-left-color:var(--green); background:rgba(76,217,100,0.04); }
    .notif-item.unread.red-notif   { border-left-color:var(--red); }
    .notif-icon { font-size:26px; flex-shrink:0; margin-top:2px; }
    .notif-body { flex:1; }
    .notif-title { font-size:14px; font-weight:bold; margin-bottom:2px; }
    .notif-text  { font-size:12px; color:#777; line-height:1.4; }
    .notif-time  { font-size:10px; color:#444; margin-top:4px; }
    .notif-filter { display:flex; gap:6px; margin-bottom:14px; overflow-x:auto; scrollbar-width:none; padding-bottom:2px; }
    .notif-filter-btn { padding:6px 14px; border-radius:20px; font-size:12px; font-weight:bold; cursor:pointer; background:#1a1a1a; border:1px solid #333; color:#777; white-space:nowrap; }
    .notif-filter-btn.active { background:rgba(212,175,55,0.15); border-color:var(--accent); color:var(--accent); }

    /* ===== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ===== */
    .settings-section { background:#111; border:1px solid #1a1a1a; border-radius:14px; overflow:hidden; margin-bottom:15px; }
    .settings-row { display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid #1a1a1a; }
    .settings-row:last-child { border-bottom:none; }
    .settings-icon { font-size:22px; min-width:30px; }
    .settings-label { flex:1; font-size:14px; }
    .settings-sub   { font-size:11px; color:#555; margin-top:2px; }
    .toggle-switch  { position:relative; width:46px; height:26px; flex-shrink:0; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .toggle-slider  { position:absolute; inset:0; background:#333; border-radius:26px; cursor:pointer; transition:.3s; }
    .toggle-slider::before { content:''; position:absolute; width:20px; height:20px; left:3px; bottom:3px; background:#888; border-radius:50%; transition:.3s; }
    .toggle-switch input:checked + .toggle-slider { background:rgba(76,217,100,0.3); }
    .toggle-switch input:checked + .toggle-slider::before { background:var(--green); transform:translateX(20px); }
    .settings-select { background:#222; border:1px solid #444; color:#fff; border-radius:8px; padding:6px 10px; font-size:13px; }
    .theme-preview { display:flex; gap:8px; flex-wrap:wrap; }
    .theme-dot { width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
    .theme-dot.active { border-color:#fff; }
    .lang-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .lang-btn { background:#1a1a1a; border:1px solid #333; border-radius:10px; padding:10px; text-align:center; cursor:pointer; font-size:13px; }
    .lang-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(212,175,55,0.08); }

    /* ===== –ú–£–õ–¨–¢–ò–ü–õ–ï–Ñ–† –ú–û–ù–û–ü–û–õ–Ü–Ø ===== */
    .mp-room-card { background:#111; border:1px solid #222; border-radius:12px; padding:14px; margin-bottom:8px; }
    .mp-room-card.waiting { border-color:#d4af37; }
    .mp-room-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .mp-players { display:flex; gap:6px; margin-top:6px; }
    .mp-player-slot { flex:1; background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:8px; text-align:center; font-size:12px; }
    .mp-player-slot.filled { border-color:var(--green); background:rgba(76,217,100,0.05); }
    .mp-player-slot.empty  { border-style:dashed; color:#555; }
    .mp-status-badge { font-size:10px; padding:3px 8px; border-radius:10px; font-weight:bold; }
    .mp-waiting { background:rgba(212,175,55,0.2); color:var(--accent); }
    .mp-playing  { background:rgba(76,217,100,0.2); color:var(--green); }


    /* ===== –°–õ–û–¢–Ü–ö–ò ===== */
    #tab-slotiky .section-header { color:#c9a0ff; }

    /* ===== –°–¢–†–Ü–ú VIEWER ===== */
    #streamViewerModal { backdrop-filter: blur(4px); }

    /* ===== –¢–£–†–ù–Ü–† V2 ===== */
    .tournament-card { background:linear-gradient(135deg,#1a1200,#0d0800);border:1px solid #3a2800;border-radius:14px;padding:14px;margin-bottom:10px; }
    .t-prize { font-size:22px;font-weight:900;color:var(--accent);margin:6px 0; }
    .t-info  { font-size:11px;color:#555; }
    .t-row   { display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid #111; }
    .t-row:last-child { border-bottom:none; }

    /* ===== –ö–ï–®–ë–ï–ö —É –∫–∞—Å—ñ ===== */
    #cashierCashbackPanel .btn-green { width:100%;padding:12px;font-size:14px;font-weight:bold;border:none;border-radius:12px;background:linear-gradient(135deg,var(--green),#1a5a20);color:#000;cursor:pointer; }
    #cashierCashbackPanel .btn-green:disabled { background:#1a1a1a;color:#555; }

    /* ===== ESPORTS BADGE ===== */
    .esport-badge { background:linear-gradient(135deg,#1a0a2e,#2d1060);border:1px solid #5a20c0;color:#c9a0ff;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:8px;display:inline-block;margin-left:4px; }

  </style>
</head>
<body data-theme="dark">

  <div id="loading-overlay">
    <div style="font-size:50px; margin-bottom:20px;">üé∞</div>
    <div>SlotOK v46</div>
    <div style="font-size:12px; color:#555; margin-top:10px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>
  
  <div id="toast-container"></div>
  
  <div class="header">
    <h1>SLOT<span>OK</span></h1>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;">
      <div style="display:flex;align-items:center;gap:6px;">
        <div class="header-bal" onclick="switchTab('cashier')"><span class="bal">‚Ç¥ 0</span></div>
        <div onclick="switchTab('slotiky')" style="background:#1a0a2e;border:1px solid #5a20c0;border-radius:10px;padding:3px 8px;font-size:11px;color:#c9a0ff;cursor:pointer;display:flex;align-items:center;gap:3px;" title="–°–ª–æ—Ç—ñ–∫–∏">
          <span>ü™ô</span><span id="headerSlotiky">0</span>
        </div>
        <button onclick="openCurrencyPicker()" style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:5px 8px;font-size:11px;color:#aaa;cursor:pointer;font-weight:bold;" id="headerCurrencyCode" title="–ó–º—ñ–Ω–∏—Ç–∏ –≤–∞–ª—é—Ç—É">UAH</button>
      </div>
      <div id="currencyRateLine" style="font-size:9px;color:#444;text-align:right;max-width:220px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"></div>
    </div>
  </div>

  <div class="container">
    
    <!-- –ì–û–õ–û–í–ù–ê -->
    <!-- Live –∫—É—Ä—Å —Ç—ñ–∫–µ—Ä -->
  <div id="rateTicker" onclick="openCurrencyPicker()" style="background:#080808;border-bottom:1px solid #1a1a1a;overflow:hidden;height:22px;position:relative;cursor:pointer;flex-shrink:0;">
    <div id="rateTickerInner" style="display:flex;gap:0;position:absolute;white-space:nowrap;animation:tickerScroll 50s linear infinite;align-items:center;height:22px;padding:0 16px;">
      <span style="color:#555;font-size:10px;">üìä –ö—É—Ä—Å–∏:</span>
    </div>
  </div>

  <div id="tab-home" class="screen">
      <!-- Sub-tabs -->
      <div class="home-tabs">
        <div class="home-tab-btn active" id="htb-main" onclick="switchHomeTab('main',this)">üè† –ì–æ–ª–æ–≤–Ω–∞</div>
        <div class="home-tab-btn" id="htb-chat" onclick="switchHomeTab('chat',this)">üí¨ –ß–∞—Ç <span class="htbadge hidden" id="chatNewBadge">!</span></div>
        <div class="home-tab-btn" id="htb-news" onclick="switchHomeTab('news',this)">üì∞ –ù–æ–≤–∏–Ω–∏ <span class="htbadge hidden" id="newsNewBadge">!</span></div>
      </div>

      <!-- === –ì–û–õ–û–í–ù–ê –ø–∞–Ω–µ–ª—å === -->
      <div class="home-panel active" id="hp-main">

        <!-- HERO BANNER ‚Äî –∞–Ω—ñ–º–æ–≤–∞–Ω–∏–π -->
        <div class="hero-banner" onclick="openDailyBonus()" style="cursor:pointer;position:relative;overflow:hidden;">
          <div style="position:absolute;top:-30px;right:-20px;font-size:100px;opacity:0.06;pointer-events:none;">üé∞</div>
          <div style="position:relative;z-index:1;width:100%;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div>
                <div class="hero-title" style="font-size:28px;letter-spacing:2px;">üíé VIP –ë–û–ù–£–°</div>
                <div style="color:#d4af37;font-size:13px;font-weight:bold;margin-top:4px;">–î–æ +250% –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç</div>
                <div style="color:#888;font-size:11px;margin-top:2px;">–©–æ–¥–µ–Ω–Ω—ñ –±–æ–Ω—É—Å–∏ ‚Ä¢ –õ—É—Ç-–±–æ–∫—Å–∏ ‚Ä¢ –ü–æ–¥–∞—Ä—É–Ω–∫–∏</div>
              </div>
              <div style="background:rgba(212,175,55,0.2);border:1px solid var(--accent);border-radius:12px;padding:8px 14px;text-align:center;flex-shrink:0;">
                <div style="font-size:9px;color:#888;">–°—å–æ–≥–æ–¥–Ω—ñ</div>
                <div style="font-size:18px;font-weight:900;color:var(--accent);" id="homeJackpot">‚Äî</div>
                <div style="font-size:9px;color:#888;">–î–∂–µ–∫–ø–æ—Ç</div>
              </div>
            </div>
          </div>
        </div>

        <!-- –©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å -->
        <div id="dailyBonusBanner" class="hidden" style="background:linear-gradient(135deg,#0d2a0d,#051a05);border:1px solid var(--green);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="openDailyBonus()">
          <div>
            <div style="font-size:15px;font-weight:bold;color:var(--green);">üéÅ –©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å –≥–æ—Ç–æ–≤–∏–π!</div>
            <div style="font-size:11px;color:#aaa;margin-top:2px;">–ù–∞—Ç–∏—Å–Ω–∏ —â–æ–± –∑–∞–±—Ä–∞—Ç–∏ –Ω–∞–≥–æ—Ä–æ–¥—É</div>
          </div>
          <div style="font-size:36px;animation:pulse2 1s infinite;">‚ú®</div>
        </div>

        <!-- Live –ª–µ–Ω—Ç–∞ –≤–∏–≥—Ä–∞—à—ñ–≤ -->
        <div style="background:#050505;border:1px solid #1a1a1a;border-radius:10px;padding:8px 12px;margin-bottom:12px;overflow:hidden;display:flex;align-items:center;gap:8px;">
          <span style="background:#e74c3c;color:#fff;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:10px;flex-shrink:0;animation:pulse2 1.5s infinite;">LIVE</span>
          <span id="winTicker" style="font-size:12px;color:#ccc;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
        </div>

        <!-- –®–≤–∏–¥–∫—ñ –∫–∞—Ä—Ç–∫–∏-–±–∞–Ω–µ—Ä–∏ -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
          <div onclick="switchTab('sports')" style="background:linear-gradient(135deg,#0a1a0a,#0d2a14);border:1px solid #1a3a1a;border-radius:14px;padding:14px;cursor:pointer;position:relative;overflow:hidden;">
            <div style="position:absolute;right:-8px;top:-8px;font-size:52px;opacity:0.12;">‚öΩ</div>
            <div style="font-size:22px;margin-bottom:4px;">‚öΩ</div>
            <div style="font-size:13px;font-weight:bold;color:var(--green);">–°–ø–æ—Ä—Ç–±–µ—Ç–∏–Ω–≥</div>
            <div style="font-size:10px;color:#555;margin-top:2px;">Live —Å—Ç–∞–≤–∫–∏</div>
          </div>
          <div onclick="openDailyBonus()" style="background:linear-gradient(135deg,#1a1a05,#2a2005);border:1px solid #3a3010;border-radius:14px;padding:14px;cursor:pointer;position:relative;overflow:hidden;">
            <div style="position:absolute;right:-8px;top:-8px;font-size:52px;opacity:0.12;">üéÅ</div>
            <div style="font-size:22px;margin-bottom:4px;">üéÅ</div>
            <div style="font-size:13px;font-weight:bold;color:var(--accent);">–ë–æ–Ω—É—Å –¥–Ω—è</div>
            <div style="font-size:10px;color:#555;margin-top:2px;">–©–æ–¥–µ–Ω–Ω–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞</div>
          </div>
          <div onclick="switchTab('vip')" style="background:linear-gradient(135deg,#1a0a1a,#2a0530);border:1px solid #3a0a50;border-radius:14px;padding:14px;cursor:pointer;position:relative;overflow:hidden;">
            <div style="position:absolute;right:-8px;top:-8px;font-size:52px;opacity:0.12;">üëë</div>
            <div style="font-size:22px;margin-bottom:4px;">üëë</div>
            <div style="font-size:13px;font-weight:bold;color:#c17eea;">VIP –ö–ª—É–±</div>
            <div style="font-size:10px;color:#555;margin-top:2px;">14 —Ä—ñ–≤–Ω—ñ–≤ ‚Ä¢ Cashback</div>
          </div>
          <div onclick="switchTab('tournaments')" style="background:linear-gradient(135deg,#1a0a05,#2a1505);border:1px solid #3a2505;border-radius:14px;padding:14px;cursor:pointer;position:relative;overflow:hidden;">
            <div style="position:absolute;right:-8px;top:-8px;font-size:52px;opacity:0.12;">üèÜ</div>
            <div style="font-size:22px;margin-bottom:4px;">üèÜ</div>
            <div style="font-size:13px;font-weight:bold;color:#f39c12;">–¢—É—Ä–Ω—ñ—Ä–∏</div>
            <div style="font-size:10px;color:#555;margin-top:2px;" id="homeTournamentPrize">–¢–æ–ø –ø—Ä–∏–∑–∏</div>
          </div>
        </div>

        <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ñ —ñ–≥—Ä–∏ -->
        <div class="section-header">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ</div>
        <div class="games-scroll">
          <div class="game-thumb" onclick="openGame('crash')"><span class="icon">üöÄ</span><span class="label">–ö—Ä–∞—à</span></div>
          <div class="game-thumb" onclick="openGame('slots')"><span class="icon">üé∞</span><span class="label">–°–ª–æ—Ç–∏</span></div>
          <div class="game-thumb" onclick="openGame('mines')"><span class="icon">üí£</span><span class="label">–ú—ñ–Ω–∏</span></div>
          <div class="game-thumb" onclick="switchTab('sports')"><span class="icon">‚öΩ</span><span class="label">–°–ø–æ—Ä—Ç</span></div>
          <div class="game-thumb" onclick="openGame('tower')"><span class="icon">üóº</span><span class="label">Tower</span></div>
          <div class="game-thumb" onclick="openGame('plinko')"><span class="icon">üîª</span><span class="label">Plinko</span></div>
          <div class="game-thumb" onclick="openGame('blackjack')"><span class="icon">üÉè</span><span class="label">–ë–ª–µ–∫–¥–∂–µ–∫</span></div>
          <div class="game-thumb" onclick="openGame('roulette')"><span class="icon">üé°</span><span class="label">–†—É–ª–µ—Ç–∫–∞</span></div>
          <div class="game-thumb" onclick="openGame('fortune')"><span class="icon">üé°</span><span class="label">–ö–æ–ª–µ—Å–æ</span></div>
          <div class="game-thumb" onclick="openGame('hilo')"><span class="icon">üÉè</span><span class="label">Hi-Lo</span></div>
          <div class="game-thumb" onclick="openGame('dice')"><span class="icon">üé≤</span><span class="label">Dice</span></div>
          <div class="game-thumb" onclick="openGame('poker')"><span class="icon">‚ô†Ô∏è</span><span class="label">–ü–æ–∫–µ—Ä</span></div>
          <div class="game-thumb" onclick="openGame('keno')"><span class="icon">üî¢</span><span class="label">–ö–µ–Ω–æ</span></div>
          <div class="game-thumb" onclick="openGame('monopoly')"><span class="icon">üé©</span><span class="label">–ú–æ–Ω–æ–ø–æ–ª—ñ—è</span></div>
          <div class="game-thumb" onclick="openGame('scratch')"><span class="icon">üéüÔ∏è</span><span class="label">–°–∫—Ä–µ—Ç—á</span></div>
          <div class="game-thumb" onclick="openGame('cardgame')"><span class="icon">üÉè</span><span class="label">–ö–∞—Ä—Ç–∏</span></div>
        </div>

        <!-- –ù–æ–≤—ñ —ñ–≥—Ä–∏ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª–ª –∫–∞—Ä—Ç–æ—á–æ–∫) -->
        <div class="section-header" style="margin-top:16px;">‚ú® –ù–æ–≤—ñ —ñ–≥—Ä–∏</div>
        <div style="display:flex;gap:10px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:4px;margin-bottom:12px;">
          <div onclick="openGame('limbo')" style="min-width:130px;background:linear-gradient(135deg,#1a0a05,#2a1005);border:1px solid #4a2010;border-radius:14px;padding:14px;cursor:pointer;flex-shrink:0;">
            <div style="font-size:28px;">üéØ</div><div style="font-size:13px;font-weight:bold;margin-top:6px;">Limbo</div><div style="font-size:10px;color:#f39c12;">–¥–æ √ó1,000,000</div>
            <div style="background:#f39c12;color:#000;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:6px;display:inline-block;margin-top:6px;">NEW</div>
          </div>
          <div onclick="openGame('tower')" style="min-width:130px;background:linear-gradient(135deg,#050a1a,#0a1530);border:1px solid #0a2060;border-radius:14px;padding:14px;cursor:pointer;flex-shrink:0;">
            <div style="font-size:28px;">üóº</div><div style="font-size:13px;font-weight:bold;margin-top:6px;">Tower</div><div style="font-size:10px;color:#4a90e2;">8 —Ä—ñ–≤–Ω—ñ–≤ –≤–≥–æ—Ä—É</div>
            <div style="background:#4a90e2;color:#fff;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:6px;display:inline-block;margin-top:6px;">HOT</div>
          </div>
          <div onclick="openGame('hilo')" style="min-width:130px;background:linear-gradient(135deg,#0a1a05,#102505);border:1px solid #1a4010;border-radius:14px;padding:14px;cursor:pointer;flex-shrink:0;">
            <div style="font-size:28px;">üÉè</div><div style="font-size:13px;font-weight:bold;margin-top:6px;">Hi-Lo</div><div style="font-size:10px;color:var(--green);">–í–∏—â–µ —á–∏ –Ω–∏–∂—á–µ?</div>
            <div style="background:var(--green);color:#000;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:6px;display:inline-block;margin-top:6px;">NEW</div>
          </div>
          <div onclick="openGame('dice')" style="min-width:130px;background:linear-gradient(135deg,#1a0a1a,#2a0a30);border:1px solid #3a1050;border-radius:14px;padding:14px;cursor:pointer;flex-shrink:0;">
            <div style="font-size:28px;">üé≤</div><div style="font-size:13px;font-weight:bold;margin-top:6px;">Dice</div><div style="font-size:10px;color:#c17eea;">–ö–∏–Ω—å —á–∏—Å–ª–æ 0-99</div>
            <div style="background:#c17eea;color:#000;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:6px;display:inline-block;margin-top:6px;">NEW</div>
          </div>
          <div onclick="switchTab('sports')" style="min-width:130px;background:linear-gradient(135deg,#0a1a0a,#0d2a14);border:1px solid #1a4020;border-radius:14px;padding:14px;cursor:pointer;flex-shrink:0;">
            <div style="font-size:28px;">‚öΩ</div><div style="font-size:13px;font-weight:bold;margin-top:6px;">–°–ø–æ—Ä—Ç</div><div style="font-size:10px;color:var(--green);">Live —Å—Ç–∞–≤–∫–∏</div>
            <div style="background:#e74c3c;color:#fff;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:6px;display:inline-block;margin-top:6px;">LIVE</div>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞–≤—Ü—è -->
        <div style="background:#0a0a0a;border:1px solid #1a1a1a;border-radius:14px;padding:14px;margin-bottom:12px;">
          <div style="font-size:12px;font-weight:bold;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <div style="text-align:center;"><div style="font-size:11px;color:#555;">–°—Ç–∞–≤–æ–∫</div><div style="font-size:18px;font-weight:bold;color:var(--accent);" id="homeStatBets">‚Äî</div></div>
            <div style="text-align:center;"><div style="font-size:11px;color:#555;">–í–∏–≥—Ä–∞—à—ñ–≤</div><div style="font-size:18px;font-weight:bold;color:var(--green);" id="homeStatWins">‚Äî</div></div>
            <div style="text-align:center;"><div style="font-size:11px;color:#555;">VIP —Ä—ñ–≤–µ–Ω—å</div><div style="font-size:18px;font-weight:bold;color:#c17eea;" id="homeStatVip">‚Äî</div></div>
          </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
          <button class="btn-gold" onclick="switchTab('cashier')">üí≥ –ü–æ–ø–æ–≤–Ω–∏—Ç–∏</button>
          <button class="btn-outline" onclick="switchTab('lobby')">üé∞ –í—Å—ñ —ñ–≥—Ä–∏</button>
        </div>
      </div>

      <!-- === –ß–ê–¢ –ø–∞–Ω–µ–ª—å === -->
      <div class="home-panel" id="hp-chat">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:16px;font-weight:bold;color:var(--accent);">üí¨ –ì–ª–æ–±–∞–ª—å–Ω–∏–π —á–∞—Ç</div>
          <div class="online-pill" onclick="showOnlineUsers()" style="cursor:pointer;" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –æ–Ω–ª–∞–π–Ω">
            <span style="width:8px;height:8px;background:var(--green);border-radius:50%;display:inline-block;"></span>
            <span id="onlineCount">‚Äî</span> –æ–Ω–ª–∞–π–Ω ‚ñæ
          </div>
        </div>
        <!-- Online users dropdown -->
        <div id="onlineUsersDropdown" class="hidden" style="position:relative;z-index:100;margin-bottom:8px;">
          <div style="background:var(--box);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div style="font-size:13px;font-weight:bold;color:var(--accent);">üü¢ –ó–∞—Ä–∞–∑ –æ–Ω–ª–∞–π–Ω</div>
              <button onclick="document.getElementById('onlineUsersDropdown').classList.add('hidden')" style="background:none;border:none;color:#777;font-size:18px;cursor:pointer;">‚úï</button>
            </div>
            <div id="onlineUsersList" style="display:flex;flex-wrap:wrap;gap:8px;max-height:200px;overflow-y:auto;"></div>
          </div>
        </div>
        <div id="announceBanner" class="hidden" style="background:#1a1a00;border:1px solid var(--accent);border-radius:8px;padding:10px;margin-bottom:10px;font-size:13px;color:var(--accent);"></div>
        <div class="chat-emoji-pick">
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üòÑ')">üòÑ</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üî•')">üî•</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üé∞')">üé∞</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üí∞')">üí∞</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üòÇ')">üòÇ</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üëë')">üëë</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('üíé')">üíé</span>
          <span class="chat-emoji-btn" onclick="appendChatEmoji('ü§ë')">ü§ë</span>
        </div>
        <div class="chat-box" id="lobbyChatBox"></div>
        <div class="chat-input-row">
          <input id="lobbyChatInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="margin:0;" onkeypress="if(event.key==='Enter')sendLobbyMsg()" maxlength="200">
          <button class="btn-gold" style="width:auto;padding:14px 18px;margin:0;" onclick="sendLobbyMsg()">‚û§</button>
        </div>
      </div>

      <!-- === –ù–û–í–ò–ù–ò –ø–∞–Ω–µ–ª—å === -->
      <div class="home-panel" id="hp-news">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <div style="font-size:16px;font-weight:bold;color:var(--accent);">üì∞ –ù–æ–≤–∏–Ω–∏ –∫–∞–∑–∏–Ω–æ</div>
          <div style="font-size:11px;color:#555;">–≤—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó</div>
        </div>
        <div id="newsListContainer">
          <div style="text-align:center;color:#555;padding:30px 0;font-size:13px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      </div>
    </div>

    <!-- –õ–û–ë–Ü -->
    <div id="tab-lobby" class="screen hidden">
      <div class="game-card" onclick="openGame('blackjack')"><span class="game-icon">üÉè</span><div class="game-info"><div class="game-title">Blackjack</div><div class="game-desc">21 ‚Ä¢ –ö–ª–∞—Å–∏–∫–∞</div></div><span style="background:var(--accent);color:#000;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('keno')"><span class="game-icon">üî¢</span><div class="game-info"><div class="game-title">Keno</div><div class="game-desc">–í–∏–±–µ—Ä–∏ —á–∏—Å–ª–∞</div></div><span style="background:var(--accent);color:#000;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('scratch')"><span class="game-icon">üéüÔ∏è</span><div class="game-info"><div class="game-title">–°–∫—Ä–µ—Ç—á</div><div class="game-desc">–°—Ç–∏—Ä–∞–π —ñ –≤–∏–≥—Ä–∞–≤–∞–π</div></div><span style="background:var(--accent);color:#000;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('fortune')"><span class="game-icon">üé°</span><div class="game-info"><div class="game-title">–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω–∏</div><div class="game-desc">–ö—Ä—É—Ç–∏ —ñ –≤–∏–≥—Ä–∞–≤–∞–π</div></div><span style="background:var(--accent);color:#000;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('slots')"><span class="game-icon">üé∞</span><div class="game-info"><div class="game-title">Classic 777</div><div class="game-desc">–°–ª–æ—Ç–∏ ‚Ä¢ RTP 95%</div></div></div>
      <div class="game-card" onclick="openGame('roulette')"><span class="game-icon">üé°</span><div class="game-info"><div class="game-title">Royal Roulette</div><div class="game-desc">–†—É–ª–µ—Ç–∫–∞ ‚Ä¢ x2 / x14</div></div></div>
      <div class="game-card" onclick="openGame('crash')"><span class="game-icon">üöÄ</span><div class="game-info"><div class="game-title">Crash Aviator</div><div class="game-desc">–ö—Ä–∞—à ‚Ä¢ –¥–æ x‚àû</div></div></div>
      <div class="game-card" onclick="openGame('poker')"><span class="game-icon">üÉè</span><div class="game-info"><div class="game-title">Video Poker</div><div class="game-desc">5-–∫–∞—Ä—Ç–∫–æ–≤–∞ —Ä–æ–∑–¥–∞—á–∞ ‚Ä¢ NEW</div></div><span style="background:var(--green);color:#000;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('chests')"><span class="game-icon">üì¶</span><div class="game-info"><div class="game-title">Magic Chests</div><div class="game-desc">–°—É–Ω–¥—É–∫–∏</div></div></div>
      <div class="game-card" onclick="openGame('mines')"><span class="game-icon">üí£</span><div class="game-info"><div class="game-title">Mines</div><div class="game-desc">–°–∞–ø–µ—Ä</div></div></div>
      <div class="game-card" onclick="openGame('plinko')"><span class="game-icon">üîª</span><div class="game-info"><div class="game-title">Plinko</div><div class="game-desc">–ü–ª—ñ–Ω–∫–æ</div></div></div>
      <div class="game-card" onclick="openGame('monopoly')"><span class="game-icon">üé©</span><div class="game-info"><div class="game-title">–ú–æ–Ω–æ–ø–æ–ª—ñ—è</div><div class="game-desc">–ö—É–ø—É–π –Ω–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å ‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥—ñ—è</div></div><span style="background:#9b59b6;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">HOT</span></div>
      <div class="game-card" onclick="openGame('cardgame')"><span class="game-icon">üÉè</span><div class="game-info"><div class="game-title">–ö–∞—Ä—Ç–∏ (–î—É—Ä–µ–Ω—å)</div><div class="game-desc">vs AI ‚Ä¢ vs –≥—Ä–∞–≤—Ü—ñ –æ–Ω–ª–∞–π–Ω</div></div><span style="background:#e91e63;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>

      <!-- NEW MULTIPLIER GAMES -->
      <div style="font-size:11px;color:#555;text-transform:uppercase;letter-spacing:1px;font-weight:bold;padding:8px 0 4px;">üéØ –ú—É–ª—å—Ç–∏–ø–ª–∞—î—Ä —ñ–≥—Ä–∏</div>
      <div class="game-card" onclick="openGame('tower')"><span class="game-icon">üóº</span><div class="game-info"><div class="game-title">Tower Climb</div><div class="game-desc">–ü—ñ–¥–Ω—ñ–º–∞–π—Å—è –≤–∏—â–µ ‚Ä¢ –¥–æ x500</div></div><span style="background:#ff6b35;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">HOT</span></div>
      <div class="game-card" onclick="openGame('hilo')"><span class="game-icon">üÉè</span><div class="game-info"><div class="game-title">Hi-Lo Cards</div><div class="game-desc">–í–∏—â–µ —á–∏ –Ω–∏–∂—á–µ ‚Ä¢ –¥–æ x100</div></div><span style="background:#4a90e2;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('dice')"><span class="game-icon">üé≤</span><div class="game-info"><div class="game-title">Dice Roll</div><div class="game-desc">–ö—É–±–∏–∫ ‚Ä¢ –≤–∏–±–µ—Ä–∏ —á–∏—Å–ª–æ</div></div><span style="background:#27ae60;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>
      <div class="game-card" onclick="openGame('double')"><span class="game-icon">üé∞</span><div class="game-info"><div class="game-title">Double</div><div class="game-desc">–ß–æ—Ä–Ω–µ/–ß–µ—Ä–≤–æ–Ω–µ/–ó–µ–ª–µ–Ω–µ ‚Ä¢ x2/x14</div></div><span style="background:#9b59b6;color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">NEW</span></div>

      <!-- SPORT BETTING -->
      <div style="font-size:11px;color:#555;text-transform:uppercase;letter-spacing:1px;font-weight:bold;padding:8px 0 4px;">‚öΩ –°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç</div>
      <div class="game-card" onclick="openGame('sports')"><span class="game-icon">‚öΩ</span><div class="game-info"><div class="game-title">Sports Betting</div><div class="game-desc">–†–µ–∞–ª—å–Ω–∏–π —Å–ø–æ—Ä—Ç ‚Ä¢ AI –ø—Ä–æ–≥–Ω–æ–∑–∏</div></div><span style="background:linear-gradient(90deg,#27ae60,#2ecc71);color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:10px;margin-left:auto;">LIVE</span></div>
    </div>

    <!-- –Ü–ì–†–ò -->
    <div id="tab-slots" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="reels-container"><div class="reel" id="r1">7</div><div class="reel" id="r2">7</div><div class="reel" id="r3">7</div></div>
      <div class="box">
        <input id="betAmountSlots" type="number" value="100">
        <button class="btn-gold" onclick="spinSlots()">–ö–†–£–¢–ò–¢–ò üé∞</button>
      </div>
    </div>
    
    <div id="tab-roulette" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="roulette-wheel" id="wheel"></div>
      <div class="box">
        <div class="bet-grid">
          <div class="bet-btn" data-color="red" onclick="selectRouletteBet('red', this)">üî¥ RED (x2)</div>
          <div class="bet-btn" data-color="green" onclick="selectRouletteBet('green', this)">üü¢ ZERO (x14)</div>
          <div class="bet-btn" data-color="black" onclick="selectRouletteBet('black', this)">‚ö´ BLACK (x2)</div>
        </div>
        <input id="betAmountRoulette" type="number" value="100">
        <button class="btn-gold" onclick="spinRoulette()">–°–¢–ê–†–¢ üé°</button>
      </div>
    </div>
    
    <div id="tab-crash" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="crash-screen">
        <canvas class="crash-graph" id="crashCanvas"></canvas>
        <div class="crash-rocket" id="crashRocket">üöÄ</div>
        <div class="crash-multiplier" id="crashDisplay">1.00x</div>
      </div>
      <div class="box">
        <input id="betAmountCrash" type="number" value="100">
        <button class="btn-gold" id="crashBtn" onclick="startCrash()">–°–¢–ê–†–¢ üöÄ</button>
        <button class="btn-green hidden" id="crashCashoutBtn" onclick="cashoutCrash()">üí∞ –ó–ê–ë–†–ê–¢–ò</button>
      </div>
    </div>

    <!-- –ü–û–ö–ï–† -->
    <div id="tab-poker" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="poker-table">
        <div style="text-align:center; color:#aaa; font-size:12px; margin-bottom:10px;">üÉè VIDEO POKER ‚Äî –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∏ –¥–ª—è –∑–∞–º—ñ–Ω–∏</div>
        <div class="poker-cards" id="pokerCards"></div>
        <div class="poker-info" id="pokerInfo">–ó—Ä–æ–±—ñ—Ç—å —Å—Ç–∞–≤–∫—É —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ì–†–ê–¢–ò</div>
      </div>
      <div class="box">
        <input id="betAmountPoker" type="number" value="100">
        <div class="poker-actions">
          <button class="btn-gold" id="pokerDealBtn" onclick="dealPoker()">üÉè –†–û–ó–î–ê–¢–ò</button>
          <button class="btn-green hidden" id="pokerDrawBtn" onclick="drawPoker()">üîÑ –ó–ê–ú–Ü–ù–ò–¢–ò</button>
        </div>
        <div id="pokerPaytable" style="margin-top:10px; background:#111; border-radius:8px; padding:10px; font-size:12px; color:#777; display:none;">
          <div style="color:var(--accent); margin-bottom:5px; font-weight:bold;">–¢–ê–ë–õ–ò–¶–Ø –í–ò–ü–õ–ê–¢:</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:3px;">
            <span>–†–æ—è–ª-—Ñ–ª–µ—à</span><span style="color:var(--accent);">x800</span>
            <span>–°—Ç—Ä–µ–π—Ç-—Ñ–ª–µ—à</span><span style="color:var(--accent);">x50</span>
            <span>–ö–∞—Ä–µ</span><span style="color:var(--accent);">x25</span>
            <span>–§—É–ª-—Ö–∞—É—Å</span><span style="color:var(--accent);">x9</span>
            <span>–§–ª–µ—à</span><span style="color:var(--accent);">x6</span>
            <span>–°—Ç—Ä–µ–π—Ç</span><span style="color:var(--accent);">x4</span>
            <span>–¢—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö</span><span style="color:var(--accent);">x3</span>
            <span>–î–≤—ñ –ø–∞—Ä–∏</span><span style="color:var(--accent);">x2</span>
            <span>–ü–∞—Ä–∞ JJ+</span><span style="color:var(--accent);">x1</span>
          </div>
        </div>
        <button class="btn-outline" style="margin-top:5px; font-size:12px; padding:8px;" onclick="togglePaytable()">‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü—è –≤–∏–ø–ª–∞—Ç</button>
      </div>
    </div>
    
    <div id="tab-chests" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box"><div class="chests-grid" id="chestsGrid"></div></div>
      <div class="box"><input id="betAmountChests" type="number" value="100"><button class="btn-gold" id="chestsPlayBtn" onclick="startChests()">–ì–†–ê–¢–ò üì¶</button></div>
    </div>
    
    <div id="tab-mines" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box"><div class="mines-grid" id="minesGrid"></div></div>
      <div class="box">
        <input id="betAmountMines" type="number" value="100">
        <button class="btn-gold" id="minesBtn" onclick="startMines()">–°–¢–ê–†–¢ üí£</button>
        <button class="btn-green hidden" id="minesCashoutBtn" onclick="cashoutMines()">–ó–ê–ë–†–ê–¢–ò</button>
      </div>
    </div>
    
    <div id="tab-plinko" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box">
        <div class="plinko-board" id="plinkoBoard"><div class="plinko-ball" id="plinkoBall"></div></div>
        <div class="plinko-buckets">
          <div class="bucket">x5</div><div class="bucket">x2</div><div class="bucket">x0.5</div>
          <div class="bucket">x0.2</div><div class="bucket">x0.5</div><div class="bucket">x2</div><div class="bucket">x5</div>
        </div>
      </div>
      <div class="box"><input id="betAmountPlinko" type="number" value="100"><button class="btn-gold" onclick="dropPlinko()">–ö–ò–ù–£–¢–ò üîª</button></div>
    </div>

    <!-- –ö–ê–°–ê (–æ–Ω–æ–≤–ª–µ–Ω–∞) -->
    <div id="tab-cashier" class="screen hidden">
      <!-- Cashier sub-tabs -->
      <div style="display:flex;gap:0;background:var(--box);border-radius:14px;padding:4px;margin-bottom:14px;border:1px solid var(--border);">
        <button class="cashier-tab-btn active" id="ctb-deposit" onclick="switchCashierTab('deposit',this)">üí≥ –ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è</button>
        <button class="cashier-tab-btn" id="ctb-withdraw" onclick="switchCashierTab('withdraw',this)">üí∏ –í–∏–≤—ñ–¥</button>
        <button class="cashier-tab-btn" id="ctb-cashback" onclick="switchCashierTab('cashback',this)">üí∞ –ö–µ—à–±–µ–∫</button>
        <button class="cashier-tab-btn" id="ctb-markets" onclick="switchCashierTab('markets',this)">üìä –†–∏–Ω–æ–∫</button>
      </div>

      
      <!-- DEPOSIT PANEL -->
      <div id="cashier-panel-deposit">
      <div class="tg-deposit-box">
        <div class="tg-logo">‚úàÔ∏è</div>
        <div class="tg-title">–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram</div>
        <div class="tg-desc">–ë–µ–∑–ø–µ—á–Ω–æ —ñ —à–≤–∏–¥–∫–æ —á–µ—Ä–µ–∑ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞.<br>–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –∑–∞—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 1-5 —Ö–≤–∏–ª–∏–Ω.</div>
        <div class="tg-steps">
          <div class="tg-step"><span class="tg-step-num">1.</span><span>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ‚Äî –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –±–æ—Ç</span></div>
          <div class="tg-step"><span class="tg-step-num">2.</span><span>–ù–∞–¥—ñ—à–ª—ñ—Ç—å –±–æ—Ç—É —Å–≤—ñ–π ID —Ç–∞ —Å—É–º—É</span></div>
          <div class="tg-step"><span class="tg-step-num">3.</span><span>–°–ø–ª–∞—Ç—ñ—Ç—å —á–µ—Ä–µ–∑ Privat24 / Mono / –ö–∞—Ä—Ç—É</span></div>
          <div class="tg-step"><span class="tg-step-num">4.</span><span>–ö–æ—à—Ç–∏ –∑–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</span></div>
        </div>
        <div style="background: rgba(0,0,0,0.3); border-radius:8px; padding:10px; margin-bottom:12px; font-size:13px; color:#aaa;">
          –í–∞—à ID: <span id="cashierUserId" style="color:#229ED9; font-weight:bold; font-size:16px;">‚Äî</span>
        </div>
        <div class="amount-grid">
          <div class="amount-btn" onclick="selectDepAmount(100, this)">100‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(250, this)">250‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(500, this)">500‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(1000, this)">1000‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(2000, this)">2000‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(5000, this)">5000‚Ç¥</div>
          <div class="amount-btn" onclick="selectDepAmount(10000, this)">10k‚Ç¥</div>
          <div class="amount-btn" id="customAmtBtn" onclick="selectCustomAmount()">–Ü–Ω—à–∞</div>
        </div>
        <div id="customAmountBox" class="hidden">
          <input id="customDepAmount" type="number" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É" style="margin-bottom:8px;">
        </div>
        <button class="btn-tg" onclick="openTelegramBot()">‚úàÔ∏è –í—ñ–¥–∫—Ä–∏—Ç–∏ Telegram –ë–æ—Ç–∞</button>
      </div>
      </div><!-- /cashier-panel-deposit -->

      <!-- WITHDRAW PANEL -->
      <div id="cashier-panel-withdraw" class="hidden">
      <!-- –í–ò–í–Ü–î –ö–û–®–¢–Ü–í -->
      <div class="withdraw-box">
        <div class="withdraw-title">üí∏ –í–∏–≤—ñ–¥ –∫–æ—à—Ç—ñ–≤</div>
        <div class="withdraw-method">
          <div class="wm-btn selected" id="wm-privat" onclick="selectWithdrawMethod('privat', this)">üü¢ PrivatBank</div>
          <div class="wm-btn" id="wm-mono" onclick="selectWithdrawMethod('mono', this)">üêà Monobank</div>
          <div class="wm-btn" id="wm-usdt" onclick="selectWithdrawMethod('usdt', this)">‚ÇÆ USDT</div>
        </div>
        <input id="withdrawCard" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ / USDT –∞–¥—Ä–µ—Å–∞">
        <input id="withdrawAmount" type="number" placeholder="–°—É–º–∞ –≤–∏–≤–æ–¥—É (–º—ñ–Ω. 200‚Ç¥)">
        <button class="btn-green" onclick="submitWithdraw()">üí∏ –ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£</button>
      </div>

      <!-- –ú–æ—ó –∑–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤—ñ–¥ -->
      <div id="myWithdrawsBox">
        <div class="section-header">–ú–æ—ó –∑–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤—ñ–¥</div>
        <div id="myWithdrawsList" style="color:#777; font-size:13px; padding:10px 0;">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>
      </div>

      <div style="display:flex; gap:8px;">
        <button class="btn-outline" style="border-color:var(--accent); color:var(--accent);" onclick="openModal('transfer-modal')">üí∏ –ü–µ—Ä–µ–∫–∞–∑</button>
        <button class="btn-outline" onclick="openModal('promo-modal')">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</button>
      </div>
      </div><!-- /cashier-panel-withdraw -->

      <!-- CASHBACK PANEL -->
      <div id="cashier-panel-cashback" class="hidden">
        <div id="cashierCashbackPanel" style="padding:4px 0;">
          <div style="text-align:center;color:#555;padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      </div><!-- /cashier-panel-cashback -->

      <!-- MARKETS PANEL -->
      <div id="cashier-panel-markets" class="hidden">
        <!-- Currency selector -->
        <div style="background:var(--box);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;">
          <div style="font-size:13px;font-weight:bold;color:var(--accent);margin-bottom:10px;">üí± –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:8px;" id="marketsMiniFiatGrid"></div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;" id="marketsMinicryptoGrid"></div>
        </div>

        <!-- Chart selector -->
        <div style="background:var(--box);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="font-size:13px;font-weight:bold;color:var(--accent);">üìà –ì—Ä–∞—Ñ—ñ–∫</div>
            <div style="display:flex;gap:4px;">
              <button class="chart-period-btn active" onclick="setChartPeriod('1D',this)">1–î</button>
              <button class="chart-period-btn" onclick="setChartPeriod('7D',this)">7–î</button>
              <button class="chart-period-btn" onclick="setChartPeriod('30D',this)">30–î</button>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;" id="chartCurrencySelector"></div>
          <canvas id="currencyChartCanvas" width="360" height="200" style="width:100%;height:200px;border-radius:8px;background:#0a0a0a;"></canvas>
          <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:#555;">
            <span id="chartLow">Min: ‚Äî</span>
            <span id="chartSymbol" style="color:var(--accent);font-weight:bold;">BTC/UAH</span>
            <span id="chartHigh">Max: ‚Äî</span>
          </div>
        </div>

        <!-- Live rate table -->
        <div style="background:var(--box);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:12px;">
          <div style="padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <div style="font-size:13px;font-weight:bold;">üìä –ê–∫—Ç—É–∞–ª—å–Ω–∏–π –∫—É—Ä—Å –¥–æ ‚Ç¥</div>
            <button onclick="fetchRates().then(()=>{buildMarketsPage();buildRatesList();})" style="background:var(--input);border:1px solid var(--border);color:#aaa;border-radius:8px;padding:4px 10px;font-size:11px;cursor:pointer;">üîÑ</button>
          </div>
          <div id="marketsRateTable"></div>
          <div id="marketsRateTs" style="font-size:10px;color:#333;padding:6px 14px 10px;text-align:right;"></div>
        </div>
      </div><!-- /cashier-panel-markets -->
    </div>


    <!-- TOWER CLIMB -->
    <div id="tab-tower" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:#ff6b35;margin-bottom:4px;">üóº Tower Climb</h2>
      <div style="color:#777;font-size:12px;margin-bottom:12px;">–í–∏–±–∏—Ä–∞–π –±–µ–∑–ø–µ—á–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —ñ –ø—ñ–¥–Ω—ñ–º–∞–π—Å—è –≤–∏—â–µ. –ß–∏–º –≤–∏—â–µ ‚Äî —Ç–∏–º –±—ñ–ª—å—à–∏–π –º–Ω–æ–∂–Ω–∏–∫!</div>
      <div class="box" style="display:flex;gap:10px;align-items:center;margin-bottom:12px;">
        <div style="flex:1;">
          <div style="font-size:11px;color:#555;margin-bottom:4px;">–°—Ç–∞–≤–∫–∞ (‚Ç¥)</div>
          <input id="towerBet" type="number" value="100" style="margin:0;">
        </div>
        <div style="flex:1;">
          <div style="font-size:11px;color:#555;margin-bottom:4px;">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å</div>
          <select id="towerDiff" style="width:100%;padding:14px;background:var(--input);border:1px solid var(--border);color:var(--text);border-radius:10px;font-size:14px;font-weight:bold;">
            <option value="1">üü¢ –õ–µ–≥–∫–∞ (1 –º—ñ–Ω–∞)</option>
            <option value="2" selected>üü° –°–µ—Ä–µ–¥–Ω—è (2 –º—ñ–Ω–∏)</option>
            <option value="3">üî¥ –í–∞–∂–∫–∞ (3 –º—ñ–Ω–∏)</option>
            <option value="4">‚ò†Ô∏è –•–∞—Ä–¥–∫–æ—Ä (4 –º—ñ–Ω–∏)</option>
          </select>
        </div>
      </div>
      <div id="towerStartArea">
        <button class="btn-gold" onclick="startTower()">üóº –ü–û–ß–ê–¢–ò</button>
      </div>
      <div id="towerGameArea" class="hidden">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;background:var(--box);border-radius:10px;padding:10px;">
          <div style="text-align:center;">
            <div style="font-size:10px;color:#555;">–†–Ü–í–ï–ù–¨</div>
            <div style="font-size:20px;font-weight:900;color:var(--accent);" id="towerLevel">0</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#555;">–ú–ù–û–ñ–ù–ò–ö</div>
            <div style="font-size:20px;font-weight:900;color:var(--green);" id="towerMult">x1.00</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#555;">–í–ò–ì–†–ê–®</div>
            <div style="font-size:20px;font-weight:900;" id="towerWin" style="color:var(--green);">0 ‚Ç¥</div>
          </div>
        </div>
        <div id="towerGrid" style="display:flex;flex-direction:column-reverse;gap:6px;margin-bottom:12px;"></div>
        <button class="btn-green" id="towerCashoutBtn" onclick="towerCashout()" style="display:none;">üí∞ –ö–ï–®–ê–£–¢</button>
      </div>
    </div>

    <!-- HI-LO CARDS -->
    <div id="tab-hilo" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:#4a90e2;margin-bottom:4px;">üÉè Hi-Lo Cards</h2>
      <div style="color:#777;font-size:12px;margin-bottom:12px;">–í–≥–∞–¥–∞–π: –Ω–∞—Å—Ç—É–ø–Ω–∞ –∫–∞—Ä—Ç–∞ –≤–∏—â–∞ —á–∏ –Ω–∏–∂—á–∞? –ö–æ–∂–µ–Ω —Ä–∞–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–Ω–æ–∂–∏—Ç—å —Å—Ç–∞–≤–∫—É!</div>
      <div class="box" style="text-align:center;">
        <input id="hiloBet" type="number" value="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚Ç¥)" style="text-align:center;">
        <button class="btn-gold" onclick="startHilo()">üÉè –ü–û–ß–ê–¢–ò</button>
      </div>
      <div id="hiloGameArea" class="hidden">
        <div style="display:flex;justify-content:center;gap:20px;margin-bottom:16px;">
          <div style="text-align:center;">
            <div style="font-size:10px;color:#555;margin-bottom:4px;">–ü–û–¢–û–ß–ù–ê</div>
            <div id="hiloCurrentCard" style="width:80px;height:110px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:#000;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.5);">?</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#555;margin-bottom:4px;">–ù–ê–°–¢–£–ü–ù–ê</div>
            <div style="width:80px;height:110px;background:#1a1a2e;border:2px dashed #333;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto;">?</div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;background:var(--box);border-radius:10px;padding:10px;">
          <div style="text-align:center;flex:1;"><div style="font-size:10px;color:#555;">–°–ï–†–Ü–Ø</div><div style="font-size:18px;font-weight:bold;color:var(--accent);" id="hiloStreak">0</div></div>
          <div style="text-align:center;flex:1;"><div style="font-size:10px;color:#555;">–ú–ù–û–ñ–ù–ò–ö</div><div style="font-size:18px;font-weight:bold;color:var(--green);" id="hiloMult">x1.00</div></div>
          <div style="text-align:center;flex:1;"><div style="font-size:10px;color:#555;">–í–ò–ì–†–ê–®</div><div style="font-size:18px;font-weight:bold;" id="hiloWin">0 ‚Ç¥</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <button class="btn-gold" onclick="hiloGuess('high')" style="padding:18px;font-size:16px;">‚¨ÜÔ∏è –í–ò–©–ï</button>
          <button class="btn-outline" onclick="hiloGuess('low')" style="padding:18px;font-size:16px;">‚¨áÔ∏è –ù–ò–ñ–ß–ï</button>
        </div>
        <button class="btn-green" id="hiloCashoutBtn" onclick="hiloCashout()">üí∞ –ö–ï–®–ê–£–¢</button>
      </div>
    </div>

    <!-- DICE ROLL -->
    <div id="tab-dice" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:#27ae60;margin-bottom:4px;">üé≤ Dice Roll</h2>
      <div style="color:#777;font-size:12px;margin-bottom:12px;">–í–∏–±–µ—Ä–∏: –≤–∏–ø–∞–¥–µ –ë–Ü–õ–¨–®–ï –∞–±–æ –ú–ï–ù–®–ï –≤–∏–±—Ä–∞–Ω–æ–≥–æ —á–∏—Å–ª–∞. –ß–∏–º —Ä—ñ–¥—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —Ç–∏–º –±—ñ–ª—å—à–∏–π –≤–∏–≥—Ä–∞—à!</div>
      <div class="box">
        <div style="font-size:11px;color:#555;margin-bottom:6px;">–°—Ç–∞–≤–∫–∞ (‚Ç¥)</div>
        <input id="diceBet" type="number" value="100" style="text-align:center;">
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:#555;margin-bottom:4px;">
            <span>1</span><span>–û–±–µ—Ä–∏ —á–∏—Å–ª–æ: <b style="color:var(--accent);" id="diceNumLabel">50</b></span><span>99</span>
          </div>
          <input type="range" id="diceSlider" min="1" max="99" value="50" oninput="updateDiceUI()" style="width:100%;accent-color:var(--accent);">
        </div>
        <div style="display:flex;justify-content:space-between;background:var(--input);border-radius:10px;padding:10px;margin-bottom:10px;">
          <div style="text-align:center;flex:1;">
            <div style="font-size:10px;color:#555;">–®–ê–ù–°</div>
            <div id="diceChance" style="font-size:16px;font-weight:bold;color:var(--accent);">50%</div>
          </div>
          <div style="text-align:center;flex:1;">
            <div style="font-size:10px;color:#555;">–ú–ù–û–ñ–ù–ò–ö</div>
            <div id="diceMult" style="font-size:16px;font-weight:bold;color:var(--green);">x1.90</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <button class="btn-gold" onclick="rollDice('over')" style="font-size:13px;">‚¨ÜÔ∏è –ë–Ü–õ–¨–®–ï <span id="diceOverNum">50</span></button>
          <button class="btn-outline" onclick="rollDice('under')" style="font-size:13px;">‚¨áÔ∏è –ú–ï–ù–®–ï <span id="diceUnderNum">50</span></button>
        </div>
      </div>
      <div id="diceResult" style="text-align:center;font-size:18px;min-height:30px;margin-top:10px;"></div>
      <div id="diceHistory" style="margin-top:10px;display:flex;gap:4px;flex-wrap:wrap;"></div>
    </div>

    <!-- DOUBLE GAME -->
    <div id="tab-double" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:#9b59b6;margin-bottom:4px;">üé∞ Double</h2>
      <div style="color:#777;font-size:12px;margin-bottom:12px;">–ü–æ—Å—Ç–∞–≤ –Ω–∞ –∫–æ–ª—ñ—Ä —ñ –æ—Ç—Ä–∏–º–∞–π –º–Ω–æ–∂–Ω–∏–∫! –ó–µ–ª–µ–Ω–∏–π ‚Äî x14!</div>
      <div class="box" style="text-align:center;margin-bottom:12px;">
        <div id="doubleWheel" style="width:160px;height:160px;border-radius:50%;border:6px solid #333;margin:0 auto 16px;background:conic-gradient(#e74c3c 0% 48.5%,#2ecc71 48.5% 51.5%,#2c3e50 51.5% 100%);box-shadow:0 0 30px rgba(0,0,0,0.5);transition:transform 3s cubic-bezier(0.17,0.67,0.12,0.99);"></div>
        <div id="doubleResult" style="font-size:22px;font-weight:900;min-height:32px;margin-bottom:10px;"></div>
        <input id="doubleBet" type="number" value="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚Ç¥)" style="text-align:center;">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:4px;">
          <button onclick="betDouble('red')" style="background:#c0392b;border:none;color:#fff;border-radius:10px;padding:14px;font-size:13px;font-weight:bold;cursor:pointer;">üî¥ x2</button>
          <button onclick="betDouble('green')" style="background:#16a085;border:none;color:#fff;border-radius:10px;padding:14px;font-size:13px;font-weight:bold;cursor:pointer;">üü¢ x14</button>
          <button onclick="betDouble('black')" style="background:#2c3e50;border:none;color:#fff;border-radius:10px;padding:14px;font-size:13px;font-weight:bold;cursor:pointer;">‚ö´ x2</button>
        </div>
      </div>
      <div id="doubleHistory" style="display:flex;gap:5px;flex-wrap:wrap;"></div>
    </div>

    <!-- SPORTS BETTING -->
    <div id="tab-sports" class="screen hidden" style="padding:0;">
      <div style="background:linear-gradient(180deg,#0a1a0a,#000);padding:16px 15px 12px;border-bottom:1px solid #1a2a1a;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <div style="font-size:20px;font-weight:900;color:var(--accent);">‚öΩ –°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç</div>
            <div style="font-size:10px;color:#555;margin-top:2px;">–†–µ–∞–ª—å–Ω—ñ –º–∞—Ç—á—ñ ‚Ä¢ ESPN ‚Ä¢ –ê–≤—Ç–æ-–∑–∞–∫—Ä–∏—Ç—Ç—è —Å—Ç–∞–≤–æ–∫</div>
          </div>
          <button onclick="loadRealSportMatches(sportsCurrentSport||'soccer', document.querySelector('.sport-tab-btn.active'))" 
            style="background:#1a2a1a;border:1px solid #1a3a1a;border-radius:10px;padding:8px 12px;font-size:11px;color:var(--green);cursor:pointer;font-weight:bold;">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <!-- Sport type tabs ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª–ª -->
        <div style="display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;" id="sportTabsRow">
          <button class="sport-tab-btn active" data-sport="soccer"      onclick="loadRealSportMatches('soccer',this)">‚öΩ –§—É—Ç–±–æ–ª</button>
          <button class="sport-tab-btn"        data-sport="ucl"         onclick="loadRealSportMatches('ucl',this)">üèÜ UCL</button>
          <button class="sport-tab-btn"        data-sport="laliga"      onclick="loadRealSportMatches('laliga',this)">üá™üá∏ La Liga</button>
          <button class="sport-tab-btn"        data-sport="bundesliga"  onclick="loadRealSportMatches('bundesliga',this)">üá©üá™ –ë—É–Ω–¥–µ—Å–ª—ñ–≥–∞</button>
          <button class="sport-tab-btn"        data-sport="basketball"  onclick="loadRealSportMatches('basketball',this)">üèÄ NBA</button>
          <button class="sport-tab-btn"        data-sport="hockey"      onclick="loadRealSportMatches('hockey',this)">üèí NHL</button>
          <button class="sport-tab-btn"        data-sport="tennis"      onclick="loadRealSportMatches('tennis',this)">üéæ –¢–µ–Ω—ñ—Å</button>
          <button class="sport-tab-btn"        data-sport="mma"         onclick="loadRealSportMatches('mma',this)">ü•ä UFC</button>
          <button class="sport-tab-btn"        data-sport="football"    onclick="loadRealSportMatches('football',this)">üèà NFL</button>
          <button class="sport-tab-btn"        data-sport="baseball"    onclick="loadRealSportMatches('baseball',this)">‚öæ MLB</button>
          <button class="sport-tab-btn"        data-sport="csgo"        onclick="loadRealSportMatches('csgo',this)">üéÆ CS2</button>
          <button class="sport-tab-btn"        data-sport="dota2"       onclick="loadRealSportMatches('dota2',this)">‚öîÔ∏è Dota 2</button>
          <button class="sport-tab-btn"        data-sport="lol"         onclick="loadRealSportMatches('lol',this)">üèÜ LoL</button>
          <button class="sport-tab-btn"        data-sport="valorant"    onclick="loadRealSportMatches('valorant',this)">üî´ Valorant</button>
          <button class="sport-tab-btn"        data-sport="efootball"   onclick="loadRealSportMatches('efootball',this)">‚ö° eFootball</button>
        </div>
      </div>

      <!-- Loader -->
      <div id="sportsLoadingEl" class="hidden" style="text-align:center;padding:32px;color:#555;font-size:13px;background:#000;">
        <div style="font-size:28px;margin-bottom:8px;animation:spin 1s linear infinite;display:inline-block;">‚öΩ</div><br>
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤...
      </div>

      <!-- LIVE + info bar -->
      <div style="display:flex;align-items:center;gap:8px;padding:8px 15px;background:#050505;border-bottom:1px solid #111;">
        <div style="background:#e74c3c;color:#fff;font-size:9px;font-weight:bold;padding:2px 8px;border-radius:20px;animation:pulse2 1.5s infinite;flex-shrink:0;">üî¥ LIVE</div>
        <div style="font-size:10px;color:#555;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å LIVE –ü–ï–†–ï–ì–õ–Ø–î –Ω–∞ –º–∞—Ç—á—ñ —â–æ–± —Å—Ç–µ–∂–∏—Ç–∏ –∑–∞ —Ä–∞—Ö—É–Ω–∫–æ–º</div>
      </div>

      <!-- Matches list -->
      <div id="sportMatchesList" style="padding:10px 15px;"></div>

      <!-- My bets -->
      <div style="margin:0 15px 20px;background:var(--box);border:1px solid var(--border);border-radius:14px;padding:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-size:13px;font-weight:bold;color:var(--accent);">üìã –ú–æ—ó —Å—Ç–∞–≤–∫–∏</div>
          <button onclick="loadSportMyBets()" style="background:none;border:none;color:#555;font-size:11px;cursor:pointer;padding:0;">üîÑ</button>
        </div>
        <div id="sportMyBets" style="color:#555;font-size:12px;">–ù–µ–º–∞—î —Å—Ç–∞–≤–æ–∫</div>
      </div>
    </div>

    </div>

    <!-- BET SLIP modal -->
    <div id="betSlipModal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:8000;display:flex;align-items:flex-end;backdrop-filter:blur(4px);">
      <div style="width:100%;background:var(--box);border-radius:24px 24px 0 0;padding:0;box-shadow:0 -8px 40px rgba(0,0,0,0.8);max-height:85vh;overflow-y:auto;box-sizing:border-box;">
        <!-- Header -->
        <div style="padding:20px 20px 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:14px;">
          <div style="font-size:18px;font-weight:900;color:var(--accent);">üéØ –ö—É–ø–æ–Ω —Å—Ç–∞–≤–∫–∏</div>
          <button onclick="closeBetSlip()" style="width:34px;height:34px;border-radius:50%;background:#1a1a1a;border:1px solid #333;color:#777;font-size:16px;cursor:pointer;">‚úï</button>
        </div>
        <div style="padding:16px 20px 24px;">
          <!-- Match info -->
          <div id="betSlipMatchInfo" style="font-size:13px;color:#aaa;margin-bottom:14px;background:var(--input);border-radius:12px;padding:12px;"></div>
          <!-- Odds display -->
          <div style="background:rgba(212,175,55,0.08);border:1px solid rgba(212,175,55,0.3);border-radius:12px;padding:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#aaa;font-size:13px;">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç</span>
            <span style="font-size:24px;font-weight:900;color:var(--accent);" id="betSlipOdds">√ó2.00</span>
          </div>
          <!-- Amount -->
          <div style="font-size:11px;color:#555;margin-bottom:4px;">–°—É–º–∞ —Å—Ç–∞–≤–∫–∏ (‚Ç¥)</div>
          <input id="betSlipAmount" type="number" value="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚Ç¥)" oninput="updateBetSlipPotential()" style="margin-bottom:4px;">
          <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
            <div class="amount-btn" style="flex:1;" onclick="document.getElementById('betSlipAmount').value=100;updateBetSlipPotential()">100‚Ç¥</div>
            <div class="amount-btn" style="flex:1;" onclick="document.getElementById('betSlipAmount').value=500;updateBetSlipPotential()">500‚Ç¥</div>
            <div class="amount-btn" style="flex:1;" onclick="document.getElementById('betSlipAmount').value=1000;updateBetSlipPotential()">1k‚Ç¥</div>
            <div class="amount-btn" style="flex:1;" onclick="document.getElementById('betSlipAmount').value=5000;updateBetSlipPotential()">5k‚Ç¥</div>
          </div>
          <!-- Potential win -->
          <div style="background:#0a1a0a;border:1px solid #1a3a1a;border-radius:12px;padding:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#aaa;font-size:12px;">–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–∏–≥—Ä–∞—à</span>
            <span id="betSlipPotential" style="font-size:20px;font-weight:900;color:var(--green);">0 ‚Ç¥</span>
          </div>
          <!-- AI tip in slip -->
          <div style="background:#080d14;border:1px solid #0d1a2e;border-radius:12px;padding:10px;margin-bottom:14px;font-size:11px;color:#777;" id="betSlipAiTip">ü§ñ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω–∞–ª—ñ–∑—É...</div>
          <!-- Buttons -->
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:10px;">
            <button class="btn-outline" onclick="closeBetSlip()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button class="btn-gold" onclick="confirmRealSportBet()">‚úÖ –ü–Ü–î–¢–í–ï–†–î–ò–¢–ò –°–¢–ê–í–ö–£</button>
          </div>
          <div style="font-size:10px;color:#333;text-align:center;margin-top:8px;">–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏–≤–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –®–Ü –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—é –º–∞—Ç—á—É</div>
        </div>
      </div>
    </div>

    <!-- LIVE VIEW modal (built dynamically) -->

        <!-- –¢–û–ü -->
    <div id="tab-top" class="screen hidden">
        <div class="box"><h3 style="text-align:center; color:#777; margin:0 0 15px;">üèÜ –†–ï–ô–¢–ò–ù–ì –ì–†–ê–í–¶–Ü–í</h3><table id="topTable"></table></div>
    </div>
    
    <!-- –ü–†–û–§–Ü–õ–¨ -->
    <div id="tab-profile" class="screen hidden">
      <div class="box">
        <div class="profile-header">
            <div class="avatar-large" id="currentAvatar">üë§</div>
            <div>
                <div style="font-size:24px; font-weight:bold;"><span id="profileName">...</span> <span id="adminBadge" class="hidden" style="color:red; font-size:12px;">[ADMIN]</span></div>
                <div style="font-size:12px; color:#777; margin-top:5px;" id="profileTag">...</div>
                <div style="margin-top:6px;" id="profileVipBadge"></div>
            </div>
        </div>
        <input id="bioInput" placeholder="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å..." onchange="updateBio(this.value)">
        <div style="margin-top:10px; color:#777;">ID: <span id="profileId">...</span></div>
        <div style="margin-top:5px; color:#777;">Email: <span id="profileEmail">...</span></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-outline" onclick="document.getElementById('avatarInput').click()">üì∑ –§–æ—Ç–æ</button>
            <button class="btn-outline" onclick="openHistoryModal()">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>
            <button class="btn-outline" onclick="openDailyBonus()">üéÅ –ë–æ–Ω—É—Å</button>
        </div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(this)">
      </div>
      <div class="box hidden" id="adminPanelBtnBox" style="border-color: #ff3b30; text-align:center;">
          <button class="btn-red" onclick="switchTab('admin')">‚öôÔ∏è –ü–ê–ù–ï–õ–¨ –ê–î–ú–Ü–ù–Ü–°–¢–†–ê–¢–û–†–ê</button>
      </div>
    </div>

    <!-- –ó–ù–ê–ô–û–ú–Ü -->
    <div id="tab-contacts" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom:15px;">–ó–Ω–∞–π–æ–º—ñ</h2>
        <div class="box"><div style="display:flex; gap:10px;"><input id="addContactInput" placeholder="–ù—ñ–∫ –∞–±–æ ID" style="margin:0;"><button class="btn-gold" style="width:auto; margin:0;" onclick="addContact()">+</button></div></div>
        <div id="contactsList" style="margin-top:20px;"></div>
    </div>

    <!-- –©–ï -->
    <div id="tab-more" class="screen hidden">
      <div class="box">
        <button class="btn-outline" onclick="switchTab('vip')">üëë VIP –°—Ç–∞—Ç—É—Å</button>
        <button class="btn-outline" onclick="switchTab('quests')">üìã –ó–∞–≤–¥–∞–Ω–Ω—è <span id="questsBadge" class="tab-badge hidden">!</span></button>
        <button class="btn-outline" onclick="switchTab('lootboxes')">üì¶ –õ—É—Ç-–ë–æ–∫—Å–∏</button>
        <button class="btn-outline" onclick="switchTab('hourly')">‚è∞ –ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å</button>
        <button class="btn-outline" onclick="switchTab('clans')">üõ°Ô∏è –ö–ª–∞–Ω–∏</button>
        <button class="btn-outline" onclick="switchTab('leaderboard')">üìä –õ—ñ–¥–µ—Ä–±–æ—Ä–¥</button>
        <button class="btn-outline" onclick="switchTab('gifts')">üéÄ –ü–æ–¥–∞—Ä—É–Ω–∫–∏ <span id="giftsBadge" class="tab-badge hidden">!</span></button>
        <button class="btn-outline" style="border-top: 1px solid #333; margin-top:8px; padding-top:16px;" onclick="switchTab('duels')">‚öîÔ∏è –î—É–µ–ª—ñ</button>
        <button class="btn-outline" onclick="switchTab('tournaments')">üèÜ –¢—É—Ä–Ω—ñ—Ä–∏</button>
        <button class="btn-outline" onclick="switchTab('referrals')">üë• –†–µ—Ñ–µ—Ä–∞–ª–∏</button>
        <button class="btn-outline" onclick="switchTab('contacts')">ü§ù –ó–Ω–∞–π–æ–º—ñ</button>
        <button class="btn-outline" onclick="openSupportModal()">üí¨ –ß–∞—Ç –ü—ñ–¥—Ç—Ä–∏–º–∫–∏</button>
        <button class="btn-outline" onclick="openDailyBonus()">üéÅ –©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å</button>
        <button class="btn-outline" onclick="logout()">–í–∏–π—Ç–∏</button>
        <button class="btn-red" onclick="deleteAccount()">–í–ò–î–ê–õ–ò–¢–ò –ê–ö–ê–£–ù–¢</button>
        <button class="btn-outline" onclick="switchTab('slotiky')">ü™ô –°–ª–æ—Ç—ñ–∫–∏ / –ú–∞–≥–∞–∑–∏–Ω</button>
      </div>
    </div>


    <!-- ===== –ö–õ–ê–ù–ò ===== -->
    <div id="tab-clans" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent);margin-bottom:4px;">üõ°Ô∏è –ö–ª–∞–Ω–∏</h2>
      <div style="color:#777;font-size:13px;margin-bottom:15px;">–û–±'—î–¥–Ω—É–π—Å—è –∑ –≥—Ä–∞–≤—Ü—è–º–∏, –≤–∏–∫–æ–Ω—É–π —Å–ø—ñ–ª—å–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</div>

      <div id="clanView">
        <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JS -->
      </div>

      <!-- –Ø–∫—â–æ –Ω–µ–º–∞—î –∫–ª–∞–Ω—É -->
      <div id="noClanSection">
        <div class="clan-banner none" style="text-align:center;">
          <div style="font-size:40px;margin-bottom:10px;">üõ°Ô∏è</div>
          <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">–í–∏ –Ω–µ –≤ –∫–ª–∞–Ω—ñ</div>
          <div style="color:#777;font-size:13px;">–°—Ç–≤–æ—Ä–∏ –≤–ª–∞—Å–Ω–∏–π –∞–±–æ –≤—Å—Ç—É–ø–∏ –¥–æ —ñ—Å–Ω—É—é—á–æ–≥–æ</div>
        </div>
        <div class="box">
          <div class="section-header" style="margin-top:0;">‚öîÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª–∞–Ω</div>
          <input id="clanNameInput" placeholder="–ù–∞–∑–≤–∞ –∫–ª–∞–Ω—É (–º–∞–∫—Å 20 —Å–∏–º–≤–æ–ª—ñ–≤)">
          <input id="clanTagInput" placeholder="–¢–µ–≥ [3-4 –ª—ñ—Ç–µ—Ä–∏, –Ω–∞–ø—Ä. PRO]" style="text-transform:uppercase;">
          <input id="clanDescInput" placeholder="–û–ø–∏—Å –∫–ª–∞–Ω—É...">
          <button class="btn-gold" onclick="createClan()">üõ°Ô∏è –°–¢–í–û–†–ò–¢–ò –ö–õ–ê–ù (500‚Ç¥)</button>
        </div>
        <div class="section-header">üîç –í—Å—Ç—É–ø–∏—Ç–∏ –¥–æ –∫–ª–∞–Ω—É</div>
        <div id="clanListPublic"></div>
        <button class="btn-outline" onclick="loadPublicClans()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
      </div>

      <!-- –Ø–∫—â–æ –≤ –∫–ª–∞–Ω—ñ -->
      <div id="myClanSection" class="hidden">
        <div id="myClanBanner" class="clan-banner member"></div>
        <div class="section-header">üèÜ –¢–∏–∂–Ω–µ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∫–ª–∞–Ω—É</div>
        <div id="clanTasksList"></div>
        <div class="section-header">üë• –£—á–∞—Å–Ω–∏–∫–∏</div>
        <div id="clanMembersList"></div>
        <button id="leaveClanBtn" class="btn-red" style="margin-top:10px;" onclick="leaveClan()">üö™ –ü–æ–∫–∏–Ω—É—Ç–∏ –∫–ª–∞–Ω</button>
      </div>
    </div>

    <!-- ===== –õ–Ü–î–ï–†–ë–û–†–î ===== -->
    <div id="tab-leaderboard" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent);margin-bottom:10px;">üìä –õ—ñ–¥–µ—Ä–±–æ—Ä–¥</h2>
      <div class="lb-tabs">
        <div class="lb-tab active" onclick="loadLeaderboard('balance',this)">üí∞ –ë–∞–ª–∞–Ω—Å</div>
        <div class="lb-tab" onclick="loadLeaderboard('totalWagered',this)">üé∞ –°—Ç–∞–≤–∫–∏</div>
        <div class="lb-tab" onclick="loadLeaderboard('stats.biggestWin',this)">üèÜ –†–µ–∫–æ—Ä–¥</div>
        <div class="lb-tab" onclick="loadLeaderboard('dailyStreak',this)">üî• –°–µ—Ä—ñ—è</div>
        <div class="lb-tab" onclick="loadLeaderboard('stats.gamesPlayed',this)">üéÆ –Ü–≥—Ä–∏</div>
      </div>
      <div id="leaderboardList"></div>
    </div>

    <!-- ===== –ü–û–î–ê–†–£–ù–ö–ò ===== -->
    <div id="tab-gifts" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent);margin-bottom:4px;">üéÄ –ü–æ–¥–∞—Ä—É–Ω–∫–∏</h2>
      <div style="color:#777;font-size:13px;margin-bottom:15px;">–ù–∞–¥—ñ—à–ª–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –¥—Ä—É–≥—É —ñ –ø–æ—Ä–∞–¥—É–π –π–æ–≥–æ!</div>

      <div class="box">
        <div class="section-header" style="margin-top:0;">üì¶ –û–±–µ—Ä—ñ—Ç—å –ø–æ–¥–∞—Ä—É–Ω–æ–∫</div>
        <div class="gift-grid" id="giftGrid">
          <div class="gift-card" onclick="selectGift('bouquet',this)">
            <div class="gift-icon">üíê</div>
            <div class="gift-name">–ë—É–∫–µ—Ç</div>
            <div class="gift-price">50 ‚Ç¥</div>
            <div class="gift-desc">–ú–∏–ª–∏–π –∑–Ω–∞–∫ —É–≤–∞–≥–∏</div>
          </div>
          <div class="gift-card" onclick="selectGift('chest',this)">
            <div class="gift-icon">üì¶</div>
            <div class="gift-name">Common Box</div>
            <div class="gift-price">200 ‚Ç¥</div>
            <div class="gift-desc">–ì–æ—Ç–æ–≤–∞ —Å–∫—Ä–∏–Ω—å–∫–∞</div>
          </div>
          <div class="gift-card" onclick="selectGift('money500',this)">
            <div class="gift-icon">üíµ</div>
            <div class="gift-name">–ö–æ–Ω–≤–µ—Ä—Ç 500‚Ç¥</div>
            <div class="gift-price">500 ‚Ç¥</div>
            <div class="gift-desc">–ü—Ä—è–º–∏–π –ø–µ—Ä–µ–∫–∞–∑</div>
          </div>
          <div class="gift-card" onclick="selectGift('diamond',this)">
            <div class="gift-icon">üíé</div>
            <div class="gift-name">–î—ñ–∞–º–∞–Ω—Ç</div>
            <div class="gift-price">1 000 ‚Ç¥</div>
            <div class="gift-desc">–†—ñ–¥–∫—ñ—Å–Ω–∏–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫</div>
          </div>
          <div class="gift-card" onclick="selectGift('crown',this)">
            <div class="gift-icon">üëë</div>
            <div class="gift-name">–ó–æ–ª–æ—Ç–∞ –∫–æ—Ä–æ–Ω–∞</div>
            <div class="gift-price">2 500 ‚Ç¥</div>
            <div class="gift-desc">–î–ª—è —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö VIP</div>
          </div>
          <div class="gift-card" onclick="selectGift('rocket',this)">
            <div class="gift-icon">üöÄ</div>
            <div class="gift-name">–†–∞–∫–µ—Ç–∞</div>
            <div class="gift-price">5 000 ‚Ç¥</div>
            <div class="gift-desc">–ü—Ä–µ–º—ñ—É–º-–ø–æ–¥–∞—Ä—É–Ω–æ–∫</div>
          </div>
        </div>
        <input id="giftRecipient" placeholder="–ù—ñ–∫ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞">
        <input id="giftMessage" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
        <button class="btn-gold" onclick="sendGift()">üéÄ –ù–ê–î–Ü–°–õ–ê–¢–ò –ü–û–î–ê–†–£–ù–û–ö</button>
      </div>

      <div class="section-header">üì¨ –í—Ö—ñ–¥–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏</div>
      <div id="inboxGifts"><div style="color:#777;font-size:13px;text-align:center;padding:15px 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    </div>

    <!-- ===== –ú–û–ù–û–ü–û–õ–Ü–Ø ===== -->
    <div id="tab-monopoly" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:var(--accent);margin-bottom:4px;">üé© –ú–æ–Ω–æ–ø–æ–ª—ñ—è</h2>
      <div style="color:#777;font-size:12px;margin-bottom:10px;">–ö—É–ø—É–π –Ω–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å, –∑–±–∏—Ä–∞–π —Ä–µ–Ω—Ç—É, –æ–±–∞–Ω–∫—Ä—É—Ç—å —Å—É–ø–µ—Ä–Ω–∏–∫–∞!</div>

      <div id="monoStartScreen">
        <div class="box" style="text-align:center;">
          <div style="font-size:60px;margin-bottom:10px;">üé©</div>
          <h3 style="color:var(--accent);margin:0 0 8px;">–ú–æ–Ω–æ–ø–æ–ª—ñ—è</h3>
          <div style="color:#777;font-size:13px;margin-bottom:15px;">–¢–∏ –≥—Ä—ñ—î—à –ø—Ä–æ—Ç–∏ AI-—Å—É–ø–µ—Ä–Ω–∏–∫–∞.<br>–°—Ç–∞—Ä—Ç–æ–≤–∏–π –∫–∞–ø—ñ—Ç–∞–ª: 3 000 ‚Ç¥ –∫–æ–∂–Ω–æ–º—É</div>
          <input id="monoEntryBet" type="number" value="500" placeholder="–ü–æ—á–∞—Ç–∫–æ–≤–∞ —Å—Ç–∞–≤–∫–∞ (‚Ç¥)">
          <div style="color:#555;font-size:12px;margin-bottom:15px;">–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å –∑–∞–±–∏—Ä–∞—î –≤—Å—ñ –≥—Ä–æ—à—ñ</div>
          <button class="btn-gold" style="font-size:16px;" onclick="startMonopoly()">üé≤ vs AI</button>
          <button class="btn-outline" style="margin-top:0;" onclick="switchTab('monopoly-mp')">üë• –ú–£–õ–¨–¢–ò–ü–õ–ï–Ñ–†</button>
        </div>
      </div>

      <div id="monoGameScreen" class="hidden">
        <div class="mono-info-bar">
          <div class="mono-info-card">
            <div class="mono-info-val" id="monoPlayerMoney" style="color:var(--green);">3000‚Ç¥</div>
            <div class="mono-info-lbl">üí∞ –í–∞—à –∫–∞–ø—ñ—Ç–∞–ª</div>
          </div>
          <div class="mono-info-card">
            <div class="mono-info-val" id="monoAiMoney" style="color:var(--red);">3000‚Ç¥</div>
            <div class="mono-info-lbl">ü§ñ –ö–∞–ø—ñ—Ç–∞–ª AI</div>
          </div>
        </div>

        <div class="mono-board-wrap" id="monoBoardWrap">
          <div class="mono-board" id="monoBoard"></div>
        </div>

        <div class="mono-dice">
          <div class="mono-die" id="die1">üé≤</div>
          <div class="mono-die" id="die2">üé≤</div>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <button class="btn-gold" id="monoRollBtn" onclick="monoRoll()" style="flex:2;">üé≤ –ö–ò–ù–£–¢–ò –ö–£–ë–ò–ö–ò</button>
          <button class="btn-green" id="monoBuyBtn" onclick="monoBuy()" style="flex:1;" disabled>üè† –ö—É–ø–∏—Ç–∏</button>
          <button class="btn-red" id="monoPassBtn" onclick="monoPass()" style="flex:1;" disabled>‚è≠ –ü–∞—Å</button>
        </div>

        <div class="mono-log" id="monoLog">
          <div class="mono-log-item info">üé© –ì—Ä–∞ —Ä–æ–∑–ø–æ—á–∞—Ç–∞! –í–∞—à —Ö—ñ–¥.</div>
        </div>

        <button class="btn-red" style="margin-top:10px;" onclick="surrenderMonopoly()">üè≥Ô∏è –ó–¥–∞—Ç–∏—Å—å</button>
      </div>
    </div>



    <!-- ===== –ú–£–õ–¨–¢–ò–ü–õ–ï–Ñ–† –ú–û–ù–û–ü–û–õ–Ü–Ø ===== -->
    <div id="tab-monopoly-mp" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('monopoly')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent);margin-bottom:4px;">üé© –ú–æ–Ω–æ–ø–æ–ª—ñ—è ‚Äî –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä</h2>
      <div style="color:#777;font-size:12px;margin-bottom:12px;">–ì—Ä–∞–π –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –≥—Ä–∞–≤—Ü—è–º–∏: 2, 3 –∞–±–æ 4 —É—á–∞—Å–Ω–∏–∫–∏</div>

      <div id="mpLobbyScreen">
        <div class="box">
          <div class="section-header" style="margin-top:0;">‚ûï –ù–æ–≤–∞ –∫—ñ–º–Ω–∞—Ç–∞</div>
          <input id="mpBetInput" type="number" value="500" placeholder="–°—Ç–∞–≤–∫–∞ –Ω–∞ –≥—Ä–∞–≤—Ü—è (‚Ç¥)">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
            <div class="mp-size-btn active" id="mpSize2" onclick="selectMpSize(2,this)">üë• 2 –≥—Ä–∞–≤—Ü—ñ</div>
            <div class="mp-size-btn" id="mpSize3" onclick="selectMpSize(3,this)">üë• 3 –≥—Ä–∞–≤—Ü—ñ</div>
            <div class="mp-size-btn" id="mpSize4" onclick="selectMpSize(4,this)">üë• 4 –≥—Ä–∞–≤—Ü—ñ</div>
          </div>
          <button class="btn-gold" onclick="createMpRoom()">üé≤ –°–¢–í–û–†–ò–¢–ò –ö–Ü–ú–ù–ê–¢–£</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="section-header" style="margin:0;">üè† –í—ñ–¥–∫—Ä–∏—Ç—ñ –∫—ñ–º–Ω–∞—Ç–∏</div>
          <button class="btn-outline" style="width:auto;padding:6px 12px;font-size:11px;margin:0;" onclick="loadMpRooms()">üîÑ</button>
        </div>
        <div id="mpRoomsList"><div style="color:#777;font-size:13px;text-align:center;padding:20px;">–ù–µ–º–∞—î –∫—ñ–º–Ω–∞—Ç</div></div>
      </div>

      <div id="mpWaitScreen" class="hidden">
        <div class="box" style="text-align:center;">
          <div style="font-size:36px;margin-bottom:8px;">‚è≥</div>
          <h3 style="color:var(--accent);margin:0 0 4px;">–ó–±–∏—Ä–∞—î–º–æ –≥—Ä–∞–≤—Ü—ñ–≤...</h3>
          <div id="mpWaitInfo" style="color:#777;font-size:12px;margin-bottom:12px;"></div>
          <div class="mp-players" id="mpWaitPlayers"></div>
          <button class="btn-red" style="margin-top:12px;" onclick="cancelMpRoom()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
      </div>

      <div id="mpGameScreen" class="hidden">
        <!-- –Ü–Ω—Ñ–æ–±–∞—Ä —É—Å—ñ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ -->
        <div id="mpPlayersInfoBar" style="display:flex;gap:6px;overflow-x:auto;margin-bottom:10px;padding-bottom:4px;scrollbar-width:none;"></div>

        <div class="mono-board-wrap" id="mpBoardWrap" style="margin-bottom:8px;">
          <div class="mono-board" id="mpBoard"></div>
        </div>

        <div class="mono-dice" style="margin:6px 0;">
          <div class="mono-die" id="mpDie1">üé≤</div>
          <div class="mono-die" id="mpDie2">üé≤</div>
        </div>

        <div id="mpTurnInfo" style="text-align:center;font-size:13px;margin-bottom:8px;font-weight:bold;padding:8px;background:#111;border-radius:8px;border:1px solid #222;">–í–∞—à —Ö—ñ–¥!</div>

        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:6px;margin-bottom:8px;">
          <button class="btn-gold" id="mpRollBtn" onclick="mpRoll()">üé≤ –ö–£–ë–ò–ö–ò</button>
          <button class="btn-green" id="mpBuyBtn" onclick="mpBuy()" disabled style="font-size:12px;">üè† –ö—É–ø–∏—Ç–∏</button>
          <button class="btn-outline" id="mpPassBtn" onclick="mpPass()" disabled style="font-size:12px;">‚è≠ –ü–∞—Å</button>
        </div>

        <div class="mono-log" id="mpLog" style="height:100px;">
          <div class="mono-log-item info">üé© –ì—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è!</div>
        </div>

        <button class="btn-red" style="margin-top:8px;padding:10px;" onclick="surrenderMp()">üè≥Ô∏è –ó–¥–∞—Ç–∏—Å—å</button>
      </div>
    </div>

    <!-- ===== –°–ü–û–í–Ü–©–ï–ù–ù–Ø ===== -->
    <div id="tab-notifications" class="screen hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h2 style="margin:0;color:var(--accent);">üîî –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h2>
        <button class="btn-outline" style="width:auto;padding:6px 12px;font-size:11px;margin:0;" onclick="markAllNotifsRead()">‚úÖ –í—Å—ñ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</button>
      </div>
      <div class="notif-filter">
        <div class="notif-filter-btn active" onclick="filterNotifs('all',this)">–í—Å—ñ</div>
        <div class="notif-filter-btn" onclick="filterNotifs('gift',this)">üéÄ –ü–æ–¥–∞—Ä—É–Ω–∫–∏</div>
        <div class="notif-filter-btn" onclick="filterNotifs('game',this)">üéÆ –Ü–≥—Ä–∏</div>
        <div class="notif-filter-btn" onclick="filterNotifs('bonus',this)">üéÅ –ë–æ–Ω—É—Å–∏</div>
        <div class="notif-filter-btn" onclick="filterNotifs('system',this)">üì¢ –°–∏—Å—Ç–µ–º–∞</div>
      </div>
      <div id="notifList"><div style="color:#777;font-size:13px;text-align:center;padding:30px 0;">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div></div>
    </div>

    <!-- ===== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ===== -->
    <div id="tab-settings" class="screen hidden">
      <h2 style="color:var(--accent);margin-bottom:15px;">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>

      <!-- –ó–≤—É–∫ -->
      <div class="settings-section">
        <div class="settings-row">
          <span class="settings-icon">üîä</span>
          <div style="flex:1;"><div class="settings-label">–ó–≤—É–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏</div><div class="settings-sub">–ó–≤—É–∫–∏ –≤–∏–≥—Ä–∞—à—É —ñ –Ω–∞—Ç–∏—Å–∫–∞–Ω—å</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingSounds" checked onchange="saveSetting('sounds',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-icon">üéµ</span>
          <div style="flex:1;"><div class="settings-label">–§–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞</div><div class="settings-sub">–ú—É–∑–∏–∫–∞ –≤ –∫–∞–∑–∏–Ω–æ</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingMusic" onchange="saveSetting('music',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-icon">üì≥</span>
          <div style="flex:1;"><div class="settings-label">–í—ñ–±—Ä–∞—Ü—ñ—è</div><div class="settings-sub">–¢–∞–∫—Ç–∏–ª—å–Ω–∏–π –≤—ñ–¥–≥—É–∫</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingVibrate" checked onchange="saveSetting('vibrate',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- –¢–µ–º–∞ -->
      <div class="settings-section">
        <div class="settings-row">
          <span class="settings-icon">üé®</span>
          <div style="flex:1;">
            <div class="settings-label">–¢–µ–º–∞</div>
            <div style="margin-top:10px;" class="theme-preview">
              <div class="theme-dot active" id="theme-dark" style="background:#050505;border:2px solid #444;" onclick="setTheme('dark',this)" title="–¢–µ–º–Ω–∞"></div>
              <div class="theme-dot" id="theme-light" style="background:#f0f0f0;border:2px solid #ccc;" onclick="setTheme('light',this)" title="–°–≤—ñ—Ç–ª–∞"></div>
              <div class="theme-dot" id="theme-blue"  style="background:linear-gradient(135deg,#0a0a2e,#1a1a5e);" onclick="setTheme('blue',this)" title="–°–∏–Ω—è –Ω—ñ—á"></div>
              <div class="theme-dot" id="theme-green" style="background:linear-gradient(135deg,#0a1a0a,#0d3318);" onclick="setTheme('green',this)" title="–ó–µ–ª–µ–Ω–∞"></div>
              <div class="theme-dot" id="theme-red"   style="background:linear-gradient(135deg,#1a0505,#3a0808);" onclick="setTheme('red',this)" title="–ß–µ—Ä–≤–æ–Ω–∞"></div>
            </div>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-icon">üî°</span>
          <div style="flex:1;"><div class="settings-label">–†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É</div></div>
          <select class="settings-select" id="settingFontSize" onchange="saveSetting('fontSize',this.value);applyFontSize(this.value)">
            <option value="14">–ú–∞–ª–∏–π</option>
            <option value="16" selected>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
            <option value="18">–í–µ–ª–∏–∫–∏–π</option>
          </select>
        </div>
      </div>

      <!-- –ú–æ–≤–∞ -->
      <div class="settings-section">
        <div class="settings-row" style="flex-direction:column;align-items:flex-start;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;width:100%;">
            <span class="settings-icon">üåê</span>
            <div class="settings-label">–ú–æ–≤–∞ / Language</div>
          </div>
          <div class="lang-grid" style="width:100%;">
            <div class="lang-btn active" id="lang-uk" onclick="setLang('uk',this)">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</div>
            <div class="lang-btn" id="lang-en" onclick="setLang('en',this)">üá∫üá∏ English</div>
            <div class="lang-btn" id="lang-ru" onclick="setLang('ru',this)">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
            <div class="lang-btn" id="lang-pl" onclick="setLang('pl',this)">üáµüá± Polski</div>
          </div>
        </div>
      </div>

      <!-- –í–∞–ª—é—Ç–∞ -->
      <div class="settings-section">
        <div class="settings-row" style="flex-direction:column;align-items:flex-start;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;width:100%;">
            <span class="settings-icon">üí±</span>
            <div>
              <div class="settings-label">–í–∞–ª—é—Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>
              <div class="settings-sub" id="settingRateInfo">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—É...</div>
            </div>
          </div>
          <button onclick="openCurrencyPicker()" style="width:100%;padding:12px;background:linear-gradient(135deg,var(--input),#222);border:1px solid var(--border);border-radius:10px;color:var(--accent);font-size:14px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;" id="currencySettingBtn">
            <span id="settingCurrencyFlag">üá∫üá¶</span>
            <span id="settingCurrencyName">–ì—Ä–∏–≤–Ω—è (UAH)</span>
            <span style="margin-left:auto;color:#555;">‚Ä∫</span>
          </button>
          <div style="margin-top:10px;width:100%;background:var(--input);border-radius:10px;padding:10px;box-sizing:border-box;">
            <div style="font-size:11px;color:#555;margin-bottom:6px;">üìä –ö—É—Ä—Å–∏ –¥–æ ‚Ç¥ (–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∫–æ–∂–Ω—ñ 5 —Ö–≤)</div>
            <div id="miniRatesList" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;"></div>
          </div>
        </div>
      </div>

      <!-- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
      <div class="settings-section">
        <div class="settings-row">
          <span class="settings-icon">üîî</span>
          <div style="flex:1;"><div class="settings-label">Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</div><div class="settings-sub">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –±–æ–Ω—É—Å–∏ —ñ –≤–∏–≥—Ä–∞—à—ñ</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingNotifs" checked onchange="saveSetting('notifs',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-icon">üéÅ</span>
          <div style="flex:1;"><div class="settings-label">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–¥–∞—Ä—É–Ω–∫–∏</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingGiftNotifs" checked onchange="saveSetting('giftNotifs',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-icon">‚è∞</span>
          <div style="flex:1;"><div class="settings-label">–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –±–æ–Ω—É—Å</div><div class="settings-sub">–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π —ñ —â–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å–∏</div></div>
          <label class="toggle-switch">
            <input type="checkbox" id="settingBonusNotifs" checked onchange="saveSetting('bonusNotifs',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- –ê–∫–∞—É–Ω—Ç -->
      <div class="settings-section">
        <div class="settings-row" onclick="openDailyBonus()" style="cursor:pointer;">
          <span class="settings-icon">üéÅ</span>
          <div class="settings-label">–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å</div>
          <span style="color:#555;font-size:18px;">‚Ä∫</span>
        </div>
        <div class="settings-row" onclick="openHistoryModal()" style="cursor:pointer;">
          <span class="settings-icon">üìú</span>
          <div class="settings-label">–Ü—Å—Ç–æ—Ä—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π</div>
          <span style="color:#555;font-size:18px;">‚Ä∫</span>
        </div>
        <div class="settings-row" onclick="openModal('promo-modal')" style="cursor:pointer;">
          <span class="settings-icon">üéüÔ∏è</span>
          <div class="settings-label">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</div>
          <span style="color:#555;font-size:18px;">‚Ä∫</span>
        </div>
        <div class="settings-row" onclick="logout()" style="cursor:pointer;">
          <span class="settings-icon">üö™</span>
          <div class="settings-label" style="color:#aaa;">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</div>
        </div>
        <div class="settings-row" onclick="deleteAccount()" style="cursor:pointer;">
          <span class="settings-icon">üóëÔ∏è</span>
          <div class="settings-label" style="color:var(--red);">–í–∏–¥–∞–ª–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</div>
        </div>
      </div>

      <div style="text-align:center;color:#333;font-size:11px;padding:10px 0;">SlotOK v42 ‚Ä¢ Made with ‚ù§Ô∏è</div>
    </div>



    <!-- ===== –ö–ê–†–¢–ò (–î–£–†–ï–ù–¨) ===== -->
    <div id="tab-cardgame" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <h2 style="color:var(--accent);margin-bottom:4px;">üÉè –ö–∞—Ä—Ç–∏ ‚Äî –î—É—Ä–µ–Ω—å</h2>
      <div style="color:#777;font-size:12px;margin-bottom:10px;">–ö–ª–∞—Å–∏—á–Ω–∏–π –î—É—Ä–µ–Ω—å. –ü—Ä–æ–≥—Ä–∞–≤ ‚Äî –ø–ª–∞—Ç–∏—à —Å—Ç–∞–≤–∫—É!</div>

      <!-- –°—Ç–∞—Ä—Ç–æ–≤–∏–π –µ–∫—Ä–∞–Ω -->
      <div id="cgStartScreen">
        <div class="box" style="text-align:center;">
          <div style="font-size:50px;margin-bottom:10px;">üÉè</div>
          <div style="color:#777;font-size:13px;margin-bottom:15px;">–ö–ª–∞—Å–∏—á–Ω–∏–π –î—É—Ä–µ–Ω—å: —Å–∫–∏–Ω—å –≤—Å—ñ –∫–∞—Ä—Ç–∏ –ø–µ—Ä—à–∏–º!</div>
          <input id="cgBet" type="number" value="200" placeholder="–°—Ç–∞–≤–∫–∞ (‚Ç¥)">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="btn-gold" onclick="startCardGame('ai')">ü§ñ vs AI</button>
            <button class="btn-outline" onclick="openCardLobby()">üë• –û–Ω–ª–∞–π–Ω</button>
          </div>
        </div>
      </div>

      <!-- –û–Ω–ª–∞–π–Ω –ª–æ–±—ñ -->
      <div id="cgOnlineLobby" class="hidden">
        <div class="box">
          <div class="section-header" style="margin-top:0;">–í—ñ–¥–∫—Ä–∏—Ç—ñ –∫—ñ–º–Ω–∞—Ç–∏</div>
          <div id="cgRoomsList" style="min-height:60px;"></div>
          <button class="btn-gold" onclick="createCardRoom()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
          <button class="btn-outline" onclick="loadCardRooms()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button class="btn-red" style="margin-top:0;" onclick="document.getElementById('cgOnlineLobby').classList.add('hidden');document.getElementById('cgStartScreen').classList.remove('hidden');">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
      </div>

      <!-- –Ü–≥—Ä–æ–≤–∏–π —Å—Ç—ñ–ª -->
      <div id="cgGameScreen" class="hidden">
        <!-- –ö–∞—Ä—Ç–∏ —Å—É–ø–µ—Ä–Ω–∏–∫–∞ -->
        <div style="background:linear-gradient(135deg,#0d3318,#051a0a);border:1px solid #1a3a1a;border-radius:12px;padding:12px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-size:12px;color:#777;" id="cgOpponentLabel">ü§ñ AI</div>
            <div class="tab-badge" id="cgOpponentCards" style="background:#555;animation:none;font-size:12px;padding:3px 8px;">0 –∫–∞—Ä—Ç</div>
          </div>
          <div id="cgOpponentHand" style="display:flex;gap:4px;flex-wrap:wrap;min-height:50px;"></div>
        </div>

        <!-- –°—Ç—ñ–ª (–∫–æ–∑–∏—Ä + —Å—Ç–æ–ø–∫–∞ + –ø–æ–ª–µ –±–æ—é) -->
        <div style="background:#0a1a0a;border:1px solid #1a2a1a;border-radius:12px;padding:10px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="font-size:11px;color:#777;">–ö–æ–∑–∏—Ä:</div>
              <div id="cgTrumpCard" style="background:#fff;border-radius:6px;width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#000;border:1px solid #ddd;"></div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px;color:#777;">–ö–æ–ª–æ–¥–∞</div>
              <div id="cgDeckCount" style="font-size:18px;font-weight:bold;color:var(--accent);">36</div>
            </div>
            <div id="cgPhaseInfo" style="font-size:12px;color:var(--accent);font-weight:bold;text-align:right;"></div>
          </div>
          <!-- –ü–æ–ª–µ –±–æ—é -->
          <div id="cgBattleField" style="min-height:70px;background:#081508;border-radius:8px;padding:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <div style="color:#333;font-size:12px;font-style:italic;">–ü–æ–ª–µ –ø–æ—Ä–æ–∂–Ω—î</div>
          </div>
        </div>

        <!-- –†—É–∫–∞ –≥—Ä–∞–≤—Ü—è -->
        <div style="background:linear-gradient(135deg,#0d1a3a,#050d1a);border:1px solid #1a2a5a;border-radius:12px;padding:12px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-size:12px;color:#777;">–í–∞—à—ñ –∫–∞—Ä—Ç–∏</div>
            <div class="tab-badge" id="cgPlayerCardsCount" style="background:var(--accent);color:#000;animation:none;font-size:12px;padding:3px 8px;">0</div>
          </div>
          <div id="cgPlayerHand" style="display:flex;gap:6px;flex-wrap:wrap;min-height:60px;"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
          <button class="btn-gold" id="cgAttackBtn" onclick="cgAttack()">‚öîÔ∏è –ê—Ç–∞–∫—É–≤–∞—Ç–∏</button>
          <button class="btn-outline" id="cgPassBtn" onclick="cgPass()">‚è≠ –ü–∞—Å / –í–∑—è—Ç–∏</button>
        </div>

        <!-- –õ–æ–≥ -->
        <div class="mono-log" id="cgLog" style="height:80px;">
          <div class="mono-log-item info">üÉè –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å!</div>
        </div>
      </div>
    </div>


    <!-- ===== VIP –°–¢–ê–¢–£–° ===== -->
    <div id="tab-vip" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent); margin-bottom:4px;">üëë VIP –°—Ç–∞—Ç—É—Å</h2>
      <div style="color:#777; font-size:13px; margin-bottom:15px;">–ß–∏–º –±—ñ–ª—å—à–µ –≥—Ä–∞—î—à ‚Äî —Ç–∏–º –≤–∏—â–∏–π —Å—Ç–∞—Ç—É—Å —ñ –±—ñ–ª—å—à–µ –ø—Ä–∏–≤—ñ–ª–µ—ó–≤</div>

      <div id="vipCurrentCard" class="vip-card bronze">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div>
            <div style="font-size:11px; color:#777;">–í–∞—à —Ä—ñ–≤–µ–Ω—å</div>
            <div id="vipLevelName" style="font-size:22px; font-weight:900;">ü•â Bronze</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:11px; color:#777;">–ó–∞–≥–∞–ª—å–Ω—ñ —Å—Ç–∞–≤–∫–∏</div>
            <div id="vipWagered" style="font-size:16px; font-weight:bold; color:var(--accent);">0 ‚Ç¥</div>
          </div>
        </div>
        <div class="vip-progress-bar"><div id="vipProgressFill" class="vip-progress-fill" style="width:0%;background:var(--bronze);"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:11px; color:#777;">
          <span id="vipProgLeft">0 ‚Ç¥</span>
          <span id="vipProgRight">–¥–æ Silver: 5 000 ‚Ç¥</span>
        </div>
      </div>

      <div class="section-header">üíé –í—Å—ñ —Ä—ñ–≤–Ω—ñ</div>
      <div class="vip-card bronze" style="margin-bottom:8px;">
        <div style="font-size:14px; font-weight:bold; color:var(--bronze); margin-bottom:8px;">ü•â Bronze ‚Äî —Å—Ç–∞—Ä—Ç</div>
        <div class="vip-perk"><span class="vip-perk-icon">üéÅ</span><span>–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å √ó1.0</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">‚è∞</span><span>–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å: 25 ‚Ç¥</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üí∞</span><span>–ö–µ—à–±–µ–∫: 0%</span></div>
      </div>
      <div class="vip-card silver" style="margin-bottom:8px;">
        <div style="font-size:14px; font-weight:bold; color:var(--silver-c); margin-bottom:8px;">ü•à Silver ‚Äî –≤—ñ–¥ 5 000 ‚Ç¥ —Å—Ç–∞–≤–æ–∫</div>
        <div class="vip-perk"><span class="vip-perk-icon">üéÅ</span><span>–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å √ó1.2</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">‚è∞</span><span>–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å: 50 ‚Ç¥</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üí∞</span><span>–ö–µ—à–±–µ–∫: 1% –∑ –∫–æ–∂–Ω–æ—ó —Å—Ç–∞–≤–∫–∏</span></div>
      </div>
      <div class="vip-card gold" style="margin-bottom:8px;">
        <div style="font-size:14px; font-weight:bold; color:var(--gold-c); margin-bottom:8px;">ü•á Gold ‚Äî –≤—ñ–¥ 25 000 ‚Ç¥ —Å—Ç–∞–≤–æ–∫</div>
        <div class="vip-perk"><span class="vip-perk-icon">üéÅ</span><span>–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å √ó1.5</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">‚è∞</span><span>–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å: 100 ‚Ç¥</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üí∞</span><span>–ö–µ—à–±–µ–∫: 2% –∑ –∫–æ–∂–Ω–æ—ó —Å—Ç–∞–≤–∫–∏</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üì¶</span><span>–©–æ—Ç–∏–∂–Ω–µ–≤–∏–π –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –ª—É—Ç–±–æ–∫—Å</span></div>
      </div>
      <div class="vip-card platinum">
        <div style="font-size:14px; font-weight:bold; color:var(--plat); margin-bottom:8px;">üíé Platinum ‚Äî –≤—ñ–¥ 100 000 ‚Ç¥ —Å—Ç–∞–≤–æ–∫</div>
        <div class="vip-perk"><span class="vip-perk-icon">üéÅ</span><span>–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å √ó2.0</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">‚è∞</span><span>–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å: 200 ‚Ç¥</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üí∞</span><span>–ö–µ—à–±–µ–∫: 5% –∑ –∫–æ–∂–Ω–æ—ó —Å—Ç–∞–≤–∫–∏</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">üì¶</span><span>–©–æ—Ç–∏–∂–Ω–µ–≤–∏–π Rare –ª—É—Ç–±–æ–∫—Å –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</span></div>
        <div class="vip-perk"><span class="vip-perk-icon">‚ö°</span><span>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ 24/7</span></div>
      </div>
    </div>

    <!-- ===== –ö–í–ï–°–¢–ò ===== -->
    <div id="tab-quests" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
        <h2 style="margin:0; color:var(--accent);">üìã –ó–∞–≤–¥–∞–Ω–Ω—è</h2>
        <div id="questTimerDisplay" class="quest-timer"></div>
      </div>
      <div style="color:#777; font-size:13px; margin-bottom:15px;">–©–æ–¥–µ–Ω–Ω—ñ –∫–≤–µ—Å—Ç–∏ ‚Äî –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –æ 00:00</div>
      <div id="questsList"></div>
      <div class="section-header" style="margin-top:10px;">üèÜ –¢–∏–∂–Ω–µ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</div>
      <div id="weeklyQuestsList"></div>
    </div>

    <!-- ===== –õ–£–¢-–ë–û–ö–°–ò ===== -->
    <div id="tab-lootboxes" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent); margin-bottom:4px;">üì¶ –õ—É—Ç-–ë–æ–∫—Å–∏</h2>
      <div style="color:#777; font-size:13px; margin-bottom:20px;">–í—ñ–¥–∫—Ä–∏–π —Å–∫—Ä–∏–Ω—å–∫—É ‚Äî –æ—Ç—Ä–∏–º–∞–π –ø—Ä–∏–∑</div>

      <div class="lootbox-grid">
        <div class="lootbox-card common" onclick="openLootbox('common')">
          <div class="lootbox-icon">üì¶</div>
          <div class="lootbox-name lootbox-common-color">COMMON</div>
          <div class="lootbox-price lootbox-common-color">150 ‚Ç¥</div>
          <div style="font-size:9px; color:#555; margin-top:4px;">–ü—Ä–∏–∑: 75‚Äì500‚Ç¥</div>
        </div>
        <div class="lootbox-card rare" onclick="openLootbox('rare')">
          <div class="lootbox-icon">üí†</div>
          <div class="lootbox-name lootbox-rare-color">RARE</div>
          <div class="lootbox-price lootbox-rare-color">500 ‚Ç¥</div>
          <div style="font-size:9px; color:#4a7ac0; margin-top:4px;">–ü—Ä–∏–∑: 250‚Äì2 500‚Ç¥</div>
        </div>
        <div class="lootbox-card epic" onclick="openLootbox('epic')">
          <div class="lootbox-icon">üíú</div>
          <div class="lootbox-name lootbox-epic-color">EPIC</div>
          <div class="lootbox-price lootbox-epic-color">2 000 ‚Ç¥</div>
          <div style="font-size:9px; color:#9b59b6; margin-top:4px;">–ü—Ä–∏–∑: 1k‚Äì20k‚Ç¥</div>
        </div>
      </div>

      <div id="lootboxResultScreen" class="hidden">
        <div class="lootbox-reward-screen">
          <div id="lbOpenEmoji" class="lootbox-open-anim">üì¶</div>
          <div id="lbWinAmount" class="lootbox-win-amount">+500 ‚Ç¥</div>
          <div id="lbWinType" class="lootbox-win-type">Common Box</div>
          <button class="btn-gold" onclick="closeLootboxResult()">üéâ –ó–ê–ë–†–ê–¢–ò</button>
        </div>
      </div>

      <div class="box">
        <div class="section-header" style="margin-top:0;">üìä –®–∞–Ω—Å–∏ –≤–∏–≥—Ä–∞—à—É</div>
        <table style="width:100%; font-size:12px; color:#777;">
          <tr><td>üì¶ Common</td><td>–ú—ñ–Ω 75‚Ç¥ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ</td><td style="color:var(--green);">Avg √ó1.5</td></tr>
          <tr><td>üí† Rare</td><td>–ú—ñ–Ω 250‚Ç¥ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ</td><td style="color:#4a9eff;">Avg √ó1.8</td></tr>
          <tr><td>üíú Epic</td><td>–ú—ñ–Ω 1 000‚Ç¥ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ</td><td style="color:#b57bee;">Avg √ó2.5</td></tr>
        </table>
      </div>

      <div class="section-header">üìú –û—Å—Ç–∞–Ω–Ω—ñ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è</div>
      <div id="lootboxHistory" style="color:#777; font-size:13px; text-align:center; padding:10px 0;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ–≤</div>
    </div>

    <!-- ===== –ü–û–ì–û–î–ò–ù–ù–ò–ô –ë–û–ù–£–° ===== -->
    <div id="tab-hourly" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>
      <h2 style="color:var(--accent); margin-bottom:4px;">‚è∞ –ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å</h2>
      <div style="color:#777; font-size:13px; margin-bottom:20px;">–ó–∞—Ö–æ–¥—å —â–æ–≥–æ–¥–∏–Ω–∏ —ñ –∑–∞–±–∏—Ä–∞–π –±–æ–Ω—É—Å</div>

      <div class="box" style="text-align:center;">
        <div id="hourlyRing" class="hourly-ring" onclick="claimHourlyBonus()">‚è∞</div>
        <div id="hourlyTimerText" class="hourly-cooldown-text">--:--</div>
        <div style="color:#777; font-size:12px; margin-top:5px;" id="hourlyStatusText">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...</div>
        <div style="color:#aaa; font-size:13px; margin-top:8px;">–í–∞—à –±–æ–Ω—É—Å: <span id="hourlyBonusAmount" style="color:var(--accent); font-weight:bold;">‚Äî</span> ‚Ç¥</div>
        <button id="hourlyClaimBtn" class="btn-gold hidden" style="margin-top:15px; font-size:16px;" onclick="claimHourlyBonus()">
          ‚è∞ –ó–ê–ë–†–ê–¢–ò –ë–û–ù–£–°
        </button>
      </div>

      <div class="section-header">üëë –ë–æ–Ω—É—Å –∑–∞ VIP —Ä—ñ–≤–µ–Ω—å</div>
      <div class="hourly-vip-perks">
        <div class="hourly-vip-tier" id="hvt-bronze"><div class="hourly-vip-amount" style="color:var(--bronze);">25‚Ç¥</div><div style="color:var(--bronze);">ü•â Bronze</div></div>
        <div class="hourly-vip-tier" id="hvt-silver"><div class="hourly-vip-amount" style="color:var(--silver-c);">50‚Ç¥</div><div style="color:var(--silver-c);">ü•à Silver</div></div>
        <div class="hourly-vip-tier" id="hvt-gold"><div class="hourly-vip-amount" style="color:var(--gold-c);">100‚Ç¥</div><div style="color:var(--gold-c);">ü•á Gold</div></div>
        <div class="hourly-vip-tier" id="hvt-plat"><div class="hourly-vip-amount" style="color:var(--plat);">200‚Ç¥</div><div style="color:var(--plat);">üíé Plat</div></div>
      </div>

      <div class="section-header" style="margin-top:15px;">üìú –û—Å—Ç–∞–Ω–Ω—ñ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è</div>
      <div id="hourlyHistory" style="color:#777; font-size:13px; text-align:center; padding:10px 0;">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</div>
    </div>

    <!-- –ê–î–ú–Ü–ù -->
    <div id="tab-admin" class="screen hidden">
       <button class="btn-outline" onclick="switchTab('profile')">‚¨Ö –ù–∞–∑–∞–¥</button>
       <h2 style="color:var(--accent);">‚öôÔ∏è –ê–¥–º—ñ–Ω-–ü–∞–Ω–µ–ª—å</h2>

       <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–∑–∏–Ω–æ -->
       <div class="section-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–∑–∏–Ω–æ</div>
       <div class="admin-stat-grid" id="casinoStats">
         <div class="admin-stat"><div class="admin-stat-val" id="statTotalUsers">‚Äî</div><div class="admin-stat-label">–ì—Ä–∞–≤—Ü—ñ–≤</div></div>
         <div class="admin-stat"><div class="admin-stat-val" id="statTotalBalance">‚Äî</div><div class="admin-stat-label">–ì—Ä–æ—à–µ–π –≤ –≥—Ä—ñ</div></div>
         <div class="admin-stat"><div class="admin-stat-val" id="statActiveDuels">‚Äî</div><div class="admin-stat-label">–î—É–µ–ª–µ–π</div></div>
         <div class="admin-stat"><div class="admin-stat-val" id="statPendingWithdraws">‚Äî</div><div class="admin-stat-label">–í–∏–≤–æ–¥—ñ–≤</div></div>
       </div>
       <button class="btn-outline" onclick="loadAdminStats()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

       <!-- –û–≥–æ–ª–æ—à–µ–Ω–Ω—è -->
       <div class="section-header">üì¢ –ì–ª–æ–±–∞–ª—å–Ω–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
       <div class="box">
         <input id="announceText" placeholder="–¢–µ–∫—Å—Ç –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö –≥—Ä–∞–≤—Ü—ñ–≤...">
         <button class="btn-gold" onclick="sendAnnouncement()">üì¢ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò</button>
         <button class="btn-outline" onclick="clearAnnouncement()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
       </div>

       <!-- –ü—Ä–æ–º–æ–∫–æ–¥–∏ -->
       <div class="section-header">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥–∏</div>
       <div class="box">
         <input id="promoCode" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. SUMMER25)">
         <input id="promoValue" type="number" placeholder="–°—É–º–∞ (‚Ç¥)">
         <input id="promoUses" type="number" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—å">
         <button class="btn-green" onclick="createPromo()">‚úÖ –°–¢–í–û–†–ò–¢–ò –ü–†–û–ú–û–ö–û–î</button>
       </div>
       <div id="promoList" style="margin-bottom:15px;"></div>
       <button class="btn-outline" onclick="loadPromos()">üîÑ –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∏</button>

       <!-- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ -->
       <div class="section-header">üí¨ –ó–∞–ø–∏—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</div>
       <button class="btn-outline" onclick="loadSupportThreads()">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏</button>
       <div id="supportThreadsList" style="margin-top:10px;"></div>

       <!-- –†—É—á–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥–µ–ø–æ–∑–∏—Ç—ñ–≤ -->
       <div class="section-header">üí∞ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥–µ–ø–æ–∑–∏—Ç—ñ–≤</div>
       <button class="btn-outline" onclick="loadDepositRequests()">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞—è–≤–∫–∏</button>
       <div id="depositRequestsList" style="margin-top:10px;"></div>

       <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤—ñ–¥ -->
       <div class="section-header">üí∏ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤—ñ–¥</div>
       <button class="btn-outline" onclick="loadWithdrawRequests()">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞—è–≤–∫–∏</button>
       <div id="withdrawRequestsList" style="margin-top:10px;"></div>
       <div id="withdrawRequestsContent"></div>

       <!-- –¢—É—Ä–Ω—ñ—Ä–∏ -->
       <div class="section-header">üèÜ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—É—Ä–Ω—ñ—Ä–∞–º–∏</div>
       <div class="box">
         <input id="tName" placeholder="–ù–∞–∑–≤–∞ —Ç—É—Ä–Ω—ñ—Ä—É">
         <input id="tPrize" type="number" placeholder="–ü—Ä–∏–∑–æ–≤–∏–π —Ñ–æ–Ω–¥ (‚Ç¥)">
         <input id="tDuration" type="number" placeholder="–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (–≥–æ–¥–∏–Ω)">
         <button class="btn-gold" onclick="createTournament()">üèÜ –°–¢–í–û–†–ò–¢–ò –¢–£–†–ù–Ü–†</button>
       </div>

       <!-- –ì—Ä–∞–≤—Ü—ñ -->
       <div class="section-header">üë• –ì—Ä–∞–≤—Ü—ñ</div>
       <div class="box">
           <button class="btn-outline" onclick="loadUserList()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
           <button class="btn-red" onclick="wipeEconomy()">üíÄ –û–ë–ù–£–õ–ò–¢–ò –í–°–Ü–• (1000)</button>
       </div>
       <div id="userList" style="margin-top:10px;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫"</div>

       <!-- –ë–æ—Ç–∏ -->
       <div class="section-header">ü§ñ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–æ—Ç–∞–º–∏</div>
       <div class="box">
         <input id="botNick" placeholder="–ù—ñ–∫ –±–æ—Ç–∞ (–Ω–∞–ø—Ä. Lucky_77)">
         <input id="botBalance" type="number" placeholder="–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å (‚Ç¥)" value="5000">
         <div style="display:flex;gap:8px;margin-bottom:10px;">
           <select id="botAvatar" style="flex:1;background:#222;border:1px solid #444;color:#fff;border-radius:8px;padding:8px;font-size:13px;">
             <option value="üë§">üë§ –°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
             <option value="ü§ë">ü§ë –ì—Ä–æ—à–æ–≤–∏–π</option>
             <option value="üòé">üòé –ö—Ä—É—Ç–∏–π</option>
             <option value="üé∞">üé∞ –ì—Ä–∞–≤–µ—Ü—å</option>
             <option value="üëë">üëë –ö–æ—Ä–æ–ª—å</option>
             <option value="üêâ">üêâ –î—Ä–∞–∫–æ–Ω</option>
             <option value="üíÄ">üíÄ –°–∫–µ–ª–µ—Ç</option>
             <option value="ü¶ä">ü¶ä –õ–∏—Å–∏—Ü—è</option>
             <option value="üê∫">üê∫ –í–æ–≤–∫</option>
             <option value="custom">üì∑ –°–≤—ñ–π URL...</option>
           </select>
         </div>
         <div id="botAvatarUrlBox" class="hidden">
           <input id="botAvatarUrl" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏ (https://...)">
         </div>
         <div style="display:flex;gap:8px;">
           <select id="botActivity" style="flex:1;background:#222;border:1px solid #444;color:#fff;border-radius:8px;padding:8px;font-size:13px;">
             <option value="active">üü¢ –ê–∫—Ç–∏–≤–Ω–∏–π (–ø–∏—à–µ –≤ —á–∞—Ç)</option>
             <option value="passive">‚ö´ –ü–∞—Å–∏–≤–Ω–∏–π (—Ç—ñ–ª—å–∫–∏ –±–∞–ª–∞–Ω—Å)</option>
           </select>
         </div>
         <button class="btn-gold" style="margin-top:8px;" onclick="createBot()">ü§ñ –°–¢–í–û–†–ò–¢–ò –ë–û–¢–ê</button>
       </div>
       <div id="botList" style="margin-top:4px;"></div>
       <button class="btn-outline" onclick="loadBots()">üîÑ –°–ø–∏—Å–æ–∫ –±–æ—Ç—ñ–≤</button>

       <!-- –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –Ω–æ–≤–∏–Ω -->
       <div class="section-header">üì∞ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –Ω–æ–≤–∏–Ω</div>
       <div class="box">
         <input id="newsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–∏–Ω–∏...">
         <textarea id="newsBody" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–∏–Ω–∏..." style="width:100%;min-height:80px;background:#1a1a1a;border:1px solid #333;color:#fff;border-radius:8px;padding:12px;font-size:14px;box-sizing:border-box;resize:vertical;margin-bottom:10px;font-family:sans-serif;"></textarea>
         <input id="newsEmoji" placeholder="Emoji/—ñ–∫–æ–Ω–∫–∞ (–Ω–∞–ø—Ä. üéâ)" value="üì¢" style="text-align:left;">
         <div style="display:flex;gap:8px;">
           <select id="newsCategory" style="flex:1;background:#222;border:1px solid #444;color:#fff;border-radius:8px;padding:8px;font-size:13px;">
             <option value="news">üì∞ –ù–æ–≤–∏–Ω–∞</option>
             <option value="update">üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è</option>
             <option value="event">üéâ –ü–æ–¥—ñ—è</option>
             <option value="promo">üéÅ –ê–∫—Ü—ñ—è</option>
             <option value="warn">‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ</option>
           </select>
         </div>
         <button class="btn-gold" style="margin-top:8px;" onclick="publishNews()">üì∞ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò –ù–û–í–ò–ù–£</button>
       </div>
       <div id="adminNewsList" style="margin-top:4px;max-height:200px;overflow-y:auto;"></div>
       <button class="btn-outline" onclick="loadAdminNews()">üîÑ –ú–æ—ó –Ω–æ–≤–∏–Ω–∏</button>
    </div>
    <!-- –ë–õ–ï–ö–î–ñ–ï–ö -->
    <div id="tab-blackjack" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="bj-table">
        <div class="bj-area"><div class="bj-label">üè¶ –î–∏–ª–µ—Ä</div><div class="bj-cards" id="bjDealerCards"></div><div class="bj-score" id="bjDealerScore">‚Äî</div></div>
        <div style="border-top:1px solid rgba(255,255,255,0.1);margin:10px 0;"></div>
        <div class="bj-area"><div class="bj-label">üë§ –í–∏</div><div class="bj-cards" id="bjPlayerCards"></div><div class="bj-score" id="bjPlayerScore">‚Äî</div></div>
        <div id="bjResult" style="text-align:center;font-size:18px;font-weight:bold;min-height:28px;margin-top:8px;"></div>
      </div>
      <div class="box">
        <input id="betAmountBJ" type="number" value="100">
        <button class="btn-gold" id="bjDealBtn" onclick="bjDeal()">üÉè –†–û–ó–î–ê–¢–ò</button>
        <div class="bj-actions hidden" id="bjActions">
          <button class="btn-green" onclick="bjHit()">‚ûï –©–ï –ö–ê–†–¢–£</button>
          <button class="btn-red" onclick="bjStand()">‚úã –°–¢–û–ü</button>
        </div>
      </div>
    </div>

    <!-- –ö–ï–ù–û -->
    <div id="tab-keno" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box">
        <div style="color:#aaa;font-size:12px;text-align:center;margin-bottom:10px;">–û–±–µ—Ä–∏ –≤—ñ–¥ 1 –¥–æ 10 —á–∏—Å–µ–ª (1‚Äì40)</div>
        <div class="keno-grid" id="kenoGrid"></div>
        <div id="kenoSelected" style="color:#777;font-size:12px;text-align:center;margin-bottom:5px;">–û–±—Ä–∞–Ω–æ: 0 / 10</div>
      </div>
      <div class="box">
        <input id="betAmountKeno" type="number" value="100">
        <button class="btn-gold" onclick="playKeno()">üî¢ –ì–†–ê–¢–ò</button>
        <button class="btn-outline" onclick="clearKeno()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
    </div>

    <!-- –°–ö–†–ï–¢–ß -->
    <div id="tab-scratch" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box">
        <div style="color:#aaa;font-size:12px;text-align:center;margin-bottom:12px;">–ù–∞—Ç–∏—Å–∫–∞–π –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —â–æ–± —Å—Ç–µ—Ä—Ç–∏ üëÜ</div>
        <div class="scratch-grid" id="scratchGrid"></div>
        <div id="scratchResult" style="text-align:center;min-height:24px;font-size:14px;margin-top:8px;"></div>
      </div>
      <div class="box">
        <input id="betAmountScratch" type="number" value="50">
        <button class="btn-gold" id="scratchBuyBtn" onclick="buyScratch()">üéüÔ∏è –ö–£–ü–ò–¢–ò –ö–ê–†–¢–ö–£</button>
      </div>
    </div>

    <!-- –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–ò -->
    <div id="tab-fortune" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="box" style="text-align:center;">
        <div class="fortune-wheel-wrap">
          <div class="wheel-arrow">‚ñº</div>
          <canvas id="fortuneCanvas" width="260" height="260" style="border-radius:50%;border:6px solid #8B6914;display:block;"></canvas>
          <div class="wheel-center">‚òÖ</div>
        </div>
        <div id="fortuneResult" style="font-size:18px;font-weight:bold;min-height:28px;margin-bottom:10px;"></div>
      </div>
      <div class="box">
        <input id="betAmountFortune" type="number" value="100">
        <button class="btn-gold" id="fortuneBtn" onclick="spinFortune()">üé° –ö–†–£–¢–ò–¢–ò</button>
        <div style="font-size:11px;color:#555;text-align:center;margin-top:5px;">x0.2 ‚Ä¢ x0.5 ‚Ä¢ x1 ‚Ä¢ x2 ‚Ä¢ x3 ‚Ä¢ x5 ‚Ä¢ x10 ‚Ä¢ –î–∂–µ–∫–ø–æ—Ç x50</div>
      </div>
    </div>

    <!-- –ß–ê–¢ –õ–û–ë–Ü -->
    <!-- chat moved to home sub-tab -->

    <!-- –î–£–ï–õ–Ü -->
    <div id="tab-duels" class="screen hidden">
      <h2 style="color:var(--accent);">‚öîÔ∏è –î—É–µ–ª—ñ</h2>
      <div class="box">
        <div style="color:#aaa;font-size:13px;margin-bottom:10px;">–í–∏–∫–ª–∏—á –≥—Ä–∞–≤—Ü—è ‚Äî –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å –∑–∞–±–∏—Ä–∞—î –≤—Å–µ!</div>
        <input id="duelTarget" placeholder="–ù—ñ–∫ —Å—É–ø–µ—Ä–Ω–∏–∫–∞">
        <input id="duelAmount" type="number" placeholder="–°—Ç–∞–≤–∫–∞ (‚Ç¥)">
        <button class="btn-red" onclick="createDuel()">‚öîÔ∏è –ö–ò–ù–£–¢–ò –í–ò–ö–õ–ò–ö</button>
      </div>
      <div class="section-header">–ê–∫—Ç–∏–≤–Ω—ñ –¥—É–µ–ª—ñ</div>
      <div id="duelsList" style="color:#777;font-size:13px;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –¥—É–µ–ª–µ–π</div>
      <div class="section-header">–ú–æ—ó –≤–∏–∫–ª–∏–∫–∏</div>
      <div id="myDuelsList" style="color:#777;font-size:13px;">–ù–µ–º–∞—î</div>
    </div>

    <!-- –¢–£–†–ù–Ü–†–ò -->
    <!-- –¢–£–†–ù–Ü–†–ò ‚Äî –ø–æ–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ -->
    <div id="tab-tournaments" class="screen hidden" style="padding:0;">
      <div style="background:linear-gradient(180deg,#1a1200,#000);padding:16px 15px 12px;border-bottom:1px solid #2a2000;">
        <div style="font-size:20px;font-weight:900;color:var(--accent);">üèÜ –¢—É—Ä–Ω—ñ—Ä–∏</div>
        <div style="font-size:10px;color:#555;margin-top:2px;">–ó–º–∞–≥–∞–π—Å—è ‚Ä¢ –ó–∞—Ä–æ–±–ª—è–π –æ—á–∫–∏ ‚Ä¢ –û—Ç—Ä–∏–º—É–π –ø—Ä–∏–∑–∏</div>
      </div>

      <!-- My tournament stats -->
      <div id="myTourneyStats" style="padding:12px 15px;background:#0a0a00;border-bottom:1px solid #1a1a00;"></div>

      <!-- Sub-tabs: –ê–∫—Ç–∏–≤–Ω—ñ / –ú–æ—ó / –Ü–≥—Ä–∏ -->
      <div style="display:flex;gap:0;padding:10px 15px 0;background:#050500;">
        <button class="cashier-tab-btn active" id="ttb-active" onclick="switchTourneyTab('active',this)">üü¢ –ê–∫—Ç–∏–≤–Ω—ñ</button>
        <button class="cashier-tab-btn" id="ttb-mine" onclick="switchTourneyTab('mine',this)">üéØ –ú–æ—ó</button>
        <button class="cashier-tab-btn" id="ttb-games" onclick="switchTourneyTab('games',this)">üéÆ –¢—É—Ä–Ω—ñ—Ä. —ñ–≥—Ä–∏</button>
      </div>

      <div style="padding:10px 15px;">
        <!-- Active tournaments -->
        <div id="tourney-panel-active">
          <div id="tournamentsList"></div>
        </div>
        <!-- My tournaments -->
        <div id="tourney-panel-mine" class="hidden">
          <div id="myTournamentsList"></div>
        </div>
        <!-- Tournament games -->
        <div id="tourney-panel-games" class="hidden">
          <div style="background:linear-gradient(135deg,#1a1200,#0d0800);border:1px solid #3a2800;border-radius:14px;padding:14px;margin-bottom:12px;">
            <div style="font-size:13px;font-weight:bold;color:var(--accent);margin-bottom:4px;">üéÆ –ï–∫—Å–∫–ª—é–∑–∏–≤–Ω—ñ —Ç—É—Ä–Ω—ñ—Ä–Ω—ñ —ñ–≥—Ä–∏</div>
            <div style="font-size:11px;color:#777;">–î–æ—Å—Ç—É–ø–Ω—ñ –ª–∏—à–µ —É—á–∞—Å–Ω–∏–∫–∞–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–Ω—ñ—Ä—É. –ó–∞—Ä–æ–±–ª—è–π –æ—á–∫–∏ ‚Äî –ø—ñ–¥–Ω—ñ–º–∞–π—Å—è –Ω–∞ –≤–µ—Ä—à–∏–Ω—É!</div>
          </div>
          <div id="tourneyGamesGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
        </div>
      </div>
    </div>



    <!-- –°–õ–û–¢–Ü–ö–ò ‚Äî –≤–Ω—É—Ç—Ä—ñ—à–Ω—è –≤–∞–ª—é—Ç–∞ –∫–∞–∑–∏–Ω–æ -->
    <div id="tab-slotiky" class="screen hidden">
      <button class="btn-outline" onclick="history.back()||switchTab('more')">‚¨Ö –ù–∞–∑–∞–¥</button>

      <!-- Balance -->
      <div style="background:linear-gradient(135deg,#1a0a2e,#2d1060);border:1px solid #5a20c0;border-radius:20px;padding:20px;margin:12px 0;text-align:center;position:relative;overflow:hidden;">
        <div style="position:absolute;top:-20px;right:-20px;font-size:100px;opacity:0.08;">ü™ô</div>
        <div style="font-size:11px;color:#a080e0;margin-bottom:4px;text-transform:uppercase;letter-spacing:2px;">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
        <div style="font-size:48px;font-weight:900;color:#c9a0ff;" id="slotikyBalance">0</div>
        <div style="font-size:14px;color:#8060c0;margin-top:2px;">ü™ô –°–ª–æ—Ç—ñ–∫—ñ–≤</div>
        <div style="font-size:10px;color:#5a3090;margin-top:8px;">1 –°–ª–æ—Ç—ñ–∫ = 10,000,000 ‚Ç¥ ‚Ä¢ –ö—É–ø—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–æ</div>
      </div>

      <!-- Buy slotiky -->
      <div style="background:var(--box);border:1px solid #3a1080;border-radius:16px;padding:14px;margin-bottom:14px;">
        <div style="font-size:14px;font-weight:bold;color:#c9a0ff;margin-bottom:12px;">üíé –ü—Ä–∏–¥–±–∞—Ç–∏ –°–ª–æ—Ç—ñ–∫–∏</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
          <div onclick="buySlotiky(1)" style="background:linear-gradient(135deg,#1a0a2e,#2d1060);border:1px solid #5a20c0;border-radius:12px;padding:12px;text-align:center;cursor:pointer;">
            <div style="font-size:24px;">ü™ô</div>
            <div style="font-size:16px;font-weight:bold;color:#c9a0ff;margin:4px 0;">1 –°–ª–æ—Ç—ñ–∫</div>
            <div style="font-size:13px;color:#8060c0;">10,000,000 ‚Ç¥</div>
          </div>
          <div onclick="buySlotiky(5)" style="background:linear-gradient(135deg,#1a0a2e,#2d1060);border:1px solid #5a20c0;border-radius:12px;padding:12px;text-align:center;cursor:pointer;">
            <div style="font-size:24px;">ü™ôü™ôü™ô</div>
            <div style="font-size:16px;font-weight:bold;color:#c9a0ff;margin:4px 0;">5 –°–ª–æ—Ç—ñ–∫—ñ–≤</div>
            <div style="font-size:13px;color:#8060c0;">50,000,000 ‚Ç¥</div>
            <div style="font-size:9px;background:#5a20c0;color:#fff;border-radius:6px;padding:2px 6px;margin-top:4px;display:inline-block;">-0%</div>
          </div>
          <div onclick="buySlotiky(10)" style="background:linear-gradient(135deg,#1a0a2e,#2d1060);border:1px solid #7a30e0;border-radius:12px;padding:12px;text-align:center;cursor:pointer;position:relative;">
            <div style="position:absolute;top:-6px;right:8px;background:#f39c12;color:#000;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:8px;">–ó–ù–ò–ñ–ö–ê</div>
            <div style="font-size:24px;">üíé</div>
            <div style="font-size:16px;font-weight:bold;color:#c9a0ff;margin:4px 0;">10 –°–ª–æ—Ç—ñ–∫—ñ–≤</div>
            <div style="font-size:13px;color:#8060c0;">95,000,000 ‚Ç¥</div>
            <div style="font-size:9px;background:#f39c12;color:#000;border-radius:6px;padding:2px 6px;margin-top:4px;display:inline-block;">–ó–Ω–∏–∂–∫–∞ 5%</div>
          </div>
          <div onclick="buySlotiky(50)" style="background:linear-gradient(135deg,#2e0a1a,#601030);border:1px solid #e020a0;border-radius:12px;padding:12px;text-align:center;cursor:pointer;position:relative;">
            <div style="position:absolute;top:-6px;right:8px;background:#e74c3c;color:#fff;font-size:9px;font-weight:bold;padding:2px 6px;border-radius:8px;">BEST</div>
            <div style="font-size:24px;">üëë</div>
            <div style="font-size:16px;font-weight:bold;color:#ff80c0;margin:4px 0;">50 –°–ª–æ—Ç—ñ–∫—ñ–≤</div>
            <div style="font-size:13px;color:#c060a0;">450,000,000 ‚Ç¥</div>
            <div style="font-size:9px;background:#e74c3c;color:#fff;border-radius:6px;padding:2px 6px;margin-top:4px;display:inline-block;">–ó–Ω–∏–∂–∫–∞ 10%</div>
          </div>
        </div>
      </div>

      <!-- Shop -->
      <div style="font-size:15px;font-weight:bold;color:#c9a0ff;margin-bottom:10px;">üõí –ú–∞–≥–∞–∑–∏–Ω –°–ª–æ—Ç—ñ–∫—ñ–≤</div>
      <div id="slotikyShopGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
      <div style="height:20px;"></div>
    </div>

    <!-- –†–ï–§–ï–†–ê–õ–ò -->
    <div id="tab-referrals" class="screen hidden">
      <h2 style="color:var(--accent);">üë• –†–µ—Ñ–µ—Ä–∞–ª–∏</h2>
      <div class="box">
        <div style="color:#aaa;font-size:13px;margin-bottom:12px;">–ó–∞–ø—Ä–æ—Å–∏ –¥—Ä—É–≥–∞ ‚Äî –æ—Ç—Ä–∏–º–∞–π <b style="color:var(--accent);">10%</b> –≤—ñ–¥ –π–æ–≥–æ –ø–µ—Ä—à–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç—É!</div>
        <div class="ref-link-box">
          <span id="refLinkText" style="flex:1;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
          <button class="btn-gold" style="width:auto;padding:8px 12px;margin:0;font-size:12px;flex-shrink:0;" onclick="copyRefLink()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;">
          <div class="ref-stat"><div class="ref-stat-num" id="refCount">0</div><div class="ref-stat-label">–ó–∞–ø—Ä–æ—à–µ–Ω–æ</div></div>
          <div class="ref-stat"><div class="ref-stat-num" id="refEarned">0‚Ç¥</div><div class="ref-stat-label">–ó–∞—Ä–æ–±–ª–µ–Ω–æ</div></div>
        </div>
      </div>
      <div class="section-header">–ó–∞–ø—Ä–æ—à–µ–Ω—ñ –≥—Ä–∞–≤—Ü—ñ</div>
      <div id="refFriendsList" style="color:#777;font-size:13px;padding:5px 0;">–ü–æ–∫–∏ –Ω—ñ–∫–æ–≥–æ –Ω–µ–º–∞—î</div>
    </div>

    <!-- –ü–£–ë–õ–Ü–ß–ù–ò–ô –ü–†–û–§–Ü–õ–¨ (–º–æ–¥–∞–ª) -->
    <div id="pub-profile-modal" class="full-modal hidden">
      <button class="btn-outline" onclick="closeModal('pub-profile-modal')" style="width:50px;">‚¨Ö</button>
      <div id="pubProfileContent" style="margin-top:10px;"></div>
    </div>

    <!-- –ê–î–ú–Ü–ù –ü–Ü–î–¢–†–ò–ú–ö–ê -->
    <div id="admin-support-modal" class="full-modal hidden">
      <button class="btn-outline" onclick="closeModal('admin-support-modal')" style="width:50px;">‚¨Ö</button>
      <h2 id="admSupportTitle" style="color:var(--accent);">–ß–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</h2>
      <div id="admSupportChat" style="height:320px;overflow-y:auto;background:#111;border:1px solid #333;margin-bottom:10px;padding:10px;border-radius:8px;"></div>
      <div style="display:flex;gap:8px;">
        <input id="admSupportReply" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å..." style="margin:0;">
        <button class="btn-gold" style="width:auto;margin:0;" onclick="sendAdminSupportReply()">‚û§</button>
      </div>
    </div>

    <!-- –î–£–ï–õ–¨ ‚Äî –≤—Ö—ñ–¥–Ω–∏–π –≤–∏–∫–ª–∏–∫ -->
    <div id="duel-incoming-modal" class="full-modal hidden">
      <div style="margin-top:30vh;text-align:center;">
        <div style="font-size:60px;margin-bottom:15px;">‚öîÔ∏è</div>
        <h2 style="color:var(--red);">–í–∞—Å –≤–∏–∫–ª–∏–∫–∞–ª–∏ –Ω–∞ –¥—É–µ–ª—å!</h2>
        <div id="duelIncomingInfo" style="color:#aaa;margin-bottom:25px;font-size:15px;line-height:1.6;"></div>
        <button class="btn-green" style="margin-bottom:10px;" onclick="acceptDuel()">‚úÖ –ü–†–ò–ô–ù–Ø–¢–ò</button>
        <button class="btn-outline" onclick="declineDuel()">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
      </div>
    </div>


    <!-- STREAM VIEWER MODAL -->
    <div id="streamViewerModal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9800;display:flex;flex-direction:column;">
      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#080808;border-bottom:1px solid #1a1a1a;flex-shrink:0;">
        <button onclick="closeStreamViewer()" style="background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:6px 12px;color:#aaa;font-size:12px;cursor:pointer;">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        <div style="font-size:13px;font-weight:bold;color:#fff;" id="streamTitle">üéÆ Live —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è</div>
        <div style="background:#e74c3c;color:#fff;font-size:9px;font-weight:bold;padding:3px 8px;border-radius:12px;animation:pulse2 1.5s infinite;">üî¥ LIVE</div>
      </div>
      <!-- Stream area -->
      <div style="flex:1;position:relative;background:#0a0a0a;overflow:hidden;">
        <div id="streamEmbedArea" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;">
          <div style="font-size:48px;margin-bottom:16px;animation:pulse2 2s infinite;">üì∫</div>
          <div style="font-size:14px;color:#777;margin-bottom:8px;">–í–∏–±–µ—Ä–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é –Ω–∏–∂—á–µ</div>
        </div>
      </div>
      <!-- Stream sources -->
      <div style="padding:12px 16px;background:#080808;border-top:1px solid #1a1a1a;flex-shrink:0;">
        <div style="font-size:11px;color:#555;margin-bottom:8px;">üì° –î–∂–µ—Ä–µ–ª–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ–π:</div>
        <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;" id="streamSourcesList"></div>
      </div>
    </div>


  </div><!-- /container -->
  <div id="auth-screen" class="full-modal">
      <div style="text-align:center; margin-bottom:30px;"><h1 style="color:var(--accent); font-size:50px; font-style:italic; font-weight:900;">SlotOK</h1><div style="color:#555; font-size:13px;">v34 ‚Äî Telegram Deposits</div></div>
      <div id="loginForm">
        <h3 style="color:#fff;">–í—Ö—ñ–¥</h3>
        <input id="loginName" placeholder="–ù—ñ–∫–Ω–µ–π–º">
        <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-gold" onclick="authLogin()">–£–í–Ü–ô–¢–ò</button>
        <div style="text-align:center; margin-top:20px; color:#777; cursor:pointer;" onclick="toggleAuthMode(true)">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç ‚Üí</div>
      </div>
      <div id="regForm" class="hidden">
        <h3 style="color:#fff;">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
        <input id="regEmail" placeholder="Email">
        <input id="regName" placeholder="–ù—ñ–∫–Ω–µ–π–º (–±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤)">
        <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω 8 —Å–∏–º–≤)">
        <button class="btn-green" onclick="authRegister()">–°–¢–í–û–†–ò–¢–ò</button>
        <div style="text-align:center; margin-top:20px; color:#777; cursor:pointer;" onclick="toggleAuthMode(false)">‚Üê –í–∂–µ —î –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏</div>
      </div>
  </div>
  
  <!-- MODALS -->
  <div id="admin-user-manage" class="full-modal hidden">
      <button class="btn-outline" onclick="closeModal('admin-user-manage')" style="width:50px;">‚¨Ö</button>
      <h2 id="admManageName" style="color:var(--accent)">–ì—Ä–∞–≤–µ—Ü—å</h2>
      <div class="box">
        <input id="admAmount" type="number" placeholder="–°—É–º–∞ (+ –∞–±–æ -)">
        <button class="btn-green" onclick="admGiveMoney()">–ó–º—ñ–Ω–∏—Ç–∏ –±–∞–ª–∞–Ω—Å</button>
        <input id="admTag" placeholder="–ù–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å">
        <button class="btn-outline" onclick="admSetTag()">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
      </div>
      <div class="box" style="border-color:red;">
        <button class="btn-red" onclick="admBanUser()">üö´ –ó–ê–ë–õ–û–ö–£–í–ê–¢–ò</button>
        <button class="btn-red" onclick="admDeleteUser()">‚ùå –í–ò–î–ê–õ–ò–¢–ò –ê–ö–ê–£–ù–¢</button>
      </div>
  </div>

  <div id="support-modal" class="full-modal hidden">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <button class="btn-outline" onclick="closeModal('support-modal')" style="width:50px;">‚¨Ö</button>
      <div style="flex:1;">
        <div style="font-size:18px;font-weight:bold;">üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</div>
        <div id="supportAdminStatus" style="font-size:11px;color:#4a90e2;margin-top:2px;">ü§ñ AI –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</div>
      </div>
    </div>
    <div style="background:#0d1a0d;border:1px solid #1a2a1a;border-radius:10px;padding:8px 12px;margin-bottom:10px;font-size:11px;color:#aaa;">
      üí° –ê–¥–º—ñ–Ω –æ—Ñ–ª–∞–π–Ω ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î AI –∞—Å–∏—Å—Ç–µ–Ω—Ç. –°–∫–ª–∞–¥–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è –±—É–¥—É—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ñ –∞–¥–º—ñ–Ω—É.
    </div>
    <div id="supportChatBox" style="height:340px;overflow-y:auto;background:#0a0a0a;border:1px solid #1a1a1a;margin-bottom:10px;padding:10px;border-radius:12px;"></div>
    <div style="display:flex; gap:10px;">
      <input id="supportMsg" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter')sendSupportMsg()">
      <button class="btn-gold" style="width:auto;margin-bottom:0;padding:14px 18px;" onclick="sendSupportMsg()">‚û§</button>
    </div>
    <style>@keyframes blink{0%,100%{opacity:0.2}50%{opacity:1}}</style>
  </div>

  <div id="transfer-modal" class="full-modal hidden">
    <button class="btn-outline" onclick="closeModal('transfer-modal')" style="width:50px;">‚¨Ö</button>
    <h2>üí∏ –ü–µ—Ä–µ–∫–∞–∑ –î—Ä—É–≥—É</h2>
    <input id="transferTo" placeholder="–ù—ñ–∫ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞">
    <input id="transferAmount" type="number" placeholder="–°—É–º–∞ –ø–µ—Ä–µ–∫–∞–∑—É">
    <button class="btn-gold" onclick="sendMoney()">–ù–ê–î–Ü–°–õ–ê–¢–ò</button>
  </div>

  <div id="promo-modal" class="full-modal hidden">
    <button class="btn-outline" onclick="closeModal('promo-modal')" style="width:50px;">‚¨Ö</button>
    <h2>üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</h2>
    <input id="promoInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥">
    <button class="btn-gold" onclick="activatePromo()">–ê–ö–¢–ò–í–£–í–ê–¢–ò</button>
  </div>

  <div id="history-modal" class="full-modal hidden">
    <button class="btn-outline" onclick="closeModal('history-modal')" style="width:50px;">‚¨Ö</button>
    <h2>üìú –Ü—Å—Ç–æ—Ä—ñ—è –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π</h2>
    <div id="historyList" style="background:#111; border-radius:8px; border:1px solid #333;"></div>
  </div>

  <div id="view-user-modal" class="full-modal hidden" onclick="closeModal('view-user-modal')">
    <div onclick="event.stopPropagation()" style="margin-top:20vh;">
      <div class="box" style="text-align:center;">
        <div class="avatar-large" id="viewUserAvatar" style="margin:0 auto 15px auto;">üë§</div>
        <h2 style="margin:0; color:var(--accent)" id="viewUserName">Name</h2>
        <div id="viewUserTag" style="color:#777; margin-bottom:5px;"></div>
        <p style="color:#555;">ID: <span id="viewUserId">000</span></p>
        <div style="font-size:28px; font-weight:bold; margin-bottom:20px; color:var(--green);"><span id="viewUserBal">0</span> ‚Ç¥</div>
        <button class="btn-outline" onclick="closeModal('view-user-modal')">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –©–û–î–ï–ù–ù–ò–ô –ë–û–ù–£–° –ú–û–î–ê–õ -->
  <div id="daily-bonus-modal" class="full-modal hidden">
    <button class="btn-outline" onclick="closeModal('daily-bonus-modal')" style="width:50px;">‚¨Ö</button>
    <div class="daily-bonus-modal-content" id="dailyBonusContent"></div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)"><span class="icon">üè†</span><span>–ì–æ–ª–æ–≤–Ω–∞</span></div>
    <div class="nav-item" onclick="switchTab('lobby', this)"><span class="icon">üé∞</span><span>–ö–∞–∑–∏–Ω–æ</span></div>
    <div class="nav-item" onclick="switchTab('cashier', this)"><span class="icon">üí≥</span><span>–ö–∞—Å–∞</span></div>
    <div class="nav-item" onclick="switchTab('notifications', this)" style="position:relative;">
      <span class="icon">üîî</span><span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span>
      <span id="notifNavBadge" class="nav-notif-dot hidden"></span>
    </div>
    <div class="nav-item" onclick="switchTab('profile', this)"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></div>
    <div class="nav-item" onclick="switchTab('settings', this)"><span class="icon">‚öôÔ∏è</span><span>–ù–∞–ª–∞—à—Ç.</span></div>
    <div class="nav-item" onclick="switchTab('more', this)"><span class="icon">‚ò∞</span><span>–©–µ</span></div>
  </nav>

  <script>
    // ============================================
    // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    // ============================================
    setTimeout(() => {
        const loader = document.getElementById('loading-overlay');
        if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.classList.add('hidden'), 500); }
    }, 1500);

    const firebaseConfig = { 
        apiKey: "AIzaSyB0gJDyr8z2SWPV3Tf73ZRNNPuglxHTCZw", 
        authDomain: "slotok-web-server.firebaseapp.com", 
        databaseURL: "https://slotok-web-server-default-rtdb.firebaseio.com", 
        projectId: "slotok-web-server", 
        storageBucket: "slotok-web-server.firebasestorage.app", 
        messagingSenderId: "1086314476940", 
        appId: "1:1086314476940:web:d3629d2d0fe16f7c1f12a9" 
    };
    
    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } 
    catch(e) { console.error("Firebase init error", e); }
    const db = firebase.database();

    // ============================================
    // –û–°–ù–û–í–ù–Ü –ó–ú–Ü–ù–ù–Ü
    // ============================================
    let currentUser = null; 
    let userData = {}; 
    let currentRouletteBet = null;
    let selectedWithdrawMethod = 'privat';
    let selectedDepAmount = 0;
    const MAX_BET = 1000000; 
    let audioCtx = null;

    // Telegram Bot Username ‚Äî –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —Å–≤—ñ–π!
    const TG_BOT_USERNAME = 'SlotOK_DepositBot';

    // ============================================
    // –ü–ï–†–ï–í–Ü–†–ö–ê –õ–û–ì–Ü–ù–£
    // ============================================
    const savedUser = localStorage.getItem("royal_online_user");
    if(savedUser) { currentUser = savedUser; startDataSync(); }

    function startDataSync() {
        try {
            db.ref('users/' + currentUser).on('value', (snapshot) => {
                const data = snapshot.val();
                if(!data) { logout(); return; }
                userData = data; 
                if(userData.banned) { alert("–í–ê–® –ê–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–û–í–ê–ù–û!"); logout(); return; }
                document.getElementById('auth-screen').classList.add('hidden');
                updateUI(); 
                loadContacts(); 
                checkAdmin();
                checkDailyBonus();
                checkInboxGifts();
                loadNotifsFromStorage();
                updateNotifBadge();
                loadSettings();
                if(!window._initDone) {
                  window._initDone = true;
                  setTimeout(initHomeTab, 100);
                  setTimeout(initChatAutoClear, 500);
                  setTimeout(initAiSupport, 600);
                  setTimeout(initCurrencySystem, 200);
                  setTimeout(checkPendingBetsOnStartup, 3000);
                }
            }, (error) => {
                notify("–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –∑ –±–∞–∑–æ—é.", "error");
            });
            db.ref('users').orderByChild('balance').limitToLast(20).on('value', snap => renderTop(snap.val()));
        } catch(e) { console.error("Sync error:", e); }
    }

    // ============================================
    // –Ü–ù–¢–ï–†–§–ï–ô–°
    // ============================================
    function updateUI() {
        if(!userData) return;
        if(typeof updateCurrencyDisplay === 'function') updateCurrencyDisplay();
        else document.querySelectorAll('.bal').forEach(e => e.textContent = formatNumber(userData.balance));
        document.getElementById('profileName').textContent = currentUser;
        document.getElementById('profileId').textContent = userData.id || '---';
        document.getElementById('profileEmail').textContent = userData.email || "-";
        document.getElementById('profileTag').textContent = userData.tag || "–ì—Ä–∞–≤–µ—Ü—å";
        document.getElementById('cashierUserId').textContent = userData.id || '---';
        const avDiv = document.getElementById('currentAvatar');
        avDiv.innerHTML = (userData.avatar && userData.avatar.length > 20) ? `<img src="${userData.avatar}">` : 'üë§';
        updateVipUI();
        loadMyWithdraws();
    }

    function checkAdmin() {
        if (currentUser.toLowerCase() === 'theivankoo' || userData.isAdmin === true) {
            document.getElementById('adminPanelBtnBox').classList.remove('hidden');
            document.getElementById('adminBadge').classList.remove('hidden');
        } else {
            document.getElementById('adminPanelBtnBox').classList.add('hidden');
            document.getElementById('adminBadge').classList.add('hidden');
        }
    }

    function formatNumber(num) {
        if(num >= 1000000000) return (num/1000000000).toFixed(1) + 'B';
        if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return Math.floor(num).toLocaleString();
    }

    function notify(msg, type='info') { 
        const c = document.getElementById('toast-container'); 
        const d = document.createElement('div'); 
        d.className = `toast ${type}`; 
        d.innerHTML = `<span>${msg}</span>`; 
        c.appendChild(d); 
        setTimeout(() => d.remove(), 3500); 
    }
    
    function playSound(type) { 
        try {
            // Check settings - getSetting may not be available yet, use localStorage directly
            try { const s = JSON.parse(localStorage.getItem('slotok_settings')||'{}'); if(s.sounds===false) return; } catch(e){}
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            const t = audioCtx.currentTime;
            if(type === 'click') {
                o.frequency.value = 800; g.gain.setValueAtTime(0.15, t);
                g.gain.exponentialRampToValueAtTime(0.01, t+0.08);
                o.start(t); o.stop(t+0.08);
            } else if(type === 'win') {
                o.type = 'sine';
                o.frequency.setValueAtTime(440, t);
                o.frequency.linearRampToValueAtTime(880, t+0.1);
                o.frequency.linearRampToValueAtTime(1320, t+0.25);
                g.gain.setValueAtTime(0.25, t); g.gain.linearRampToValueAtTime(0, t+0.5);
                o.start(t); o.stop(t+0.5);
                // Second tone for big win
                const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
                o2.connect(g2); g2.connect(audioCtx.destination); o2.type = 'triangle';
                o2.frequency.setValueAtTime(660, t+0.1); o2.frequency.linearRampToValueAtTime(1100, t+0.4);
                g2.gain.setValueAtTime(0.15, t+0.1); g2.gain.linearRampToValueAtTime(0, t+0.5);
                o2.start(t+0.1); o2.stop(t+0.5);
            } else if(type === 'spin') {
                o.type = 'sawtooth'; o.frequency.setValueAtTime(200, t);
                o.frequency.linearRampToValueAtTime(100, t+0.3);
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.3);
                o.start(t); o.stop(t+0.3);
            } else if(type === 'deal') {
                o.frequency.setValueAtTime(600, t); o.frequency.setValueAtTime(400, t+0.05);
                g.gain.setValueAtTime(0.12, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                o.start(t); o.stop(t+0.1);
            } else if(type === 'loss') {
                o.type = 'sawtooth'; o.frequency.setValueAtTime(300, t);
                o.frequency.linearRampToValueAtTime(150, t+0.4);
                g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t+0.4);
                o.start(t); o.stop(t+0.4);
            } else if(type === 'bonus') {
                // Multi-tone fanfare
                [440,554,659,880].forEach((freq, i) => {
                    const oi = audioCtx.createOscillator(); const gi = audioCtx.createGain();
                    oi.connect(gi); gi.connect(audioCtx.destination); oi.type = 'sine';
                    oi.frequency.value = freq; gi.gain.setValueAtTime(0.2, t+i*0.1);
                    gi.gain.linearRampToValueAtTime(0, t+i*0.1+0.15);
                    oi.start(t+i*0.1); oi.stop(t+i*0.1+0.15);
                });
            }
        } catch(e) {}
    }
    
    function validateBet(amount) { 
        const bet = Math.abs(parseInt(amount)); 
        if(isNaN(bet) || bet <= 0 || bet > MAX_BET || userData.balance < bet) { 
            notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤ –∞–±–æ –Ω–µ–≤—ñ—Ä–Ω–∞ —Å—É–º–∞!", "error"); 
            return false; 
        } 
        return bet; 
    }
    
    function addToHistory(msg) { 
        try { db.ref(`users/${currentUser}/history`).push({text: msg, date: Date.now()}); } catch(e){} 
    }

    // ============================================
    // –©–û–î–ï–ù–ù–ò–ô –ë–û–ù–£–°
    // ============================================
    const DAILY_BONUSES = [100, 150, 200, 300, 500, 750, 1000];

    function checkDailyBonus() {
        const lastClaim = userData.lastDailyBonus || 0;
        const now = Date.now();
        const dayMs = 24 * 60 * 60 * 1000;
        const canClaim = (now - lastClaim) >= dayMs;
        
        const banner = document.getElementById('dailyBonusBanner');
        if(canClaim) {
            banner.style.display = 'flex';
            banner.classList.remove('hidden');
        } else {
            banner.classList.add('hidden');
        }
    }

    function openDailyBonus() {
        const lastClaim = userData.lastDailyBonus || 0;
        const now = Date.now();
        const dayMs = 24 * 60 * 60 * 1000;
        const canClaim = (now - lastClaim) >= dayMs;
        const streak = userData.dailyStreak || 0;
        const bonusAmount = DAILY_BONUSES[Math.min(streak, 6)];
        
        const content = document.getElementById('dailyBonusContent');
        
        if(canClaim) {
            content.innerHTML = `
                <div class="bonus-icon">üéÅ</div>
                <h2 style="color:var(--accent);">–©–æ–¥–µ–Ω–Ω–∏–π –ë–æ–Ω—É—Å!</h2>
                <div style="color:#aaa; margin-bottom:10px;">–î–µ–Ω—å ${streak + 1} —Å–µ—Ä—ñ—ó</div>
                <div class="bonus-amount">+${bonusAmount} ‚Ç¥</div>
                <div class="streak-dots">
                    ${DAILY_BONUSES.map((b, i) => `
                        <div class="streak-dot ${i < streak ? 'done' : i === streak ? 'today' : ''}" title="${b}‚Ç¥">
                            ${i < streak ? '‚úì' : i === streak ? '‚òÖ' : i+1}
                        </div>
                    `).join('')}
                </div>
                <div style="color:#aaa; font-size:12px; margin-bottom:20px;">7 –¥–Ω—ñ–≤ –ø–æ—Å–ø—ñ–ª—å = 1000‚Ç¥</div>
                <button class="btn-gold" style="font-size:18px; padding:18px;" onclick="claimDailyBonus(${bonusAmount})">
                    üéÅ –ó–ê–ë–†–ê–¢–ò ${bonusAmount} ‚Ç¥
                </button>
            `;
        } else {
            const msLeft = dayMs - (now - lastClaim);
            const h = Math.floor(msLeft / 3600000);
            const m = Math.floor((msLeft % 3600000) / 60000);
            content.innerHTML = `
                <div style="font-size:60px; margin-bottom:20px;">‚è∞</div>
                <h2 style="color:#777;">–í–∂–µ –∑–∞–±—Ä–∞–Ω–æ</h2>
                <div style="color:#aaa; margin-bottom:10px;">–ù–∞—Å—Ç—É–ø–Ω–∏–π –±–æ–Ω—É—Å —á–µ—Ä–µ–∑:</div>
                <div style="font-size:36px; font-weight:900; color:var(--accent);">${h}–≥–æ–¥ ${m}—Ö–≤</div>
                <div style="color:#aaa; margin:15px 0; font-size:13px;">–í–∞—à–∞ —Å–µ—Ä—ñ—è: ${streak} –¥–Ω—ñ–≤ üî•</div>
                <div class="streak-dots">
                    ${DAILY_BONUSES.map((b, i) => `
                        <div class="streak-dot ${i < streak ? 'done' : ''}" title="${b}‚Ç¥">
                            ${i < streak ? '‚úì' : i+1}
                        </div>
                    `).join('')}
                </div>
                <button class="btn-outline" onclick="closeModal('daily-bonus-modal')" style="margin-top:20px;">–ó–∞–∫—Ä–∏—Ç–∏</button>
            `;
        }
        openModal('daily-bonus-modal');
    }

    function claimDailyBonus(amount) {
        const streak = (userData.dailyStreak || 0) + 1;
        const newStreak = streak >= 7 ? 0 : streak;
        // VIP –º–Ω–æ–∂–Ω–∏–∫
        const vip = getVipLevel(userData.totalWagered || 0);
        const finalAmount = Math.floor(amount * vip.dailyMult);
        
        db.ref('users/' + currentUser).update({
            balance: userData.balance + finalAmount,
            lastDailyBonus: Date.now(),
            dailyStreak: newStreak
        });
        
        playSound('win');
        const multText = vip.dailyMult > 1 ? ` (${vip.icon} VIP √ó${vip.dailyMult})` : '';
        notify(`üéÅ –©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å: +${finalAmount} ‚Ç¥${multText}`, 'success');
        addToHistory(`Daily Bonus: +${finalAmount}`);
        closeModal('daily-bonus-modal');
        document.getElementById('dailyBonusBanner').classList.add('hidden');
    }

    // ============================================
    // TELEGRAM –î–ï–ü–û–ó–ò–¢
    // ============================================
    function selectDepAmount(amount, el) {
        selectedDepAmount = amount;
        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('customAmountBox').classList.add('hidden');
    }

    function selectCustomAmount() {
        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('customAmtBtn').classList.add('selected');
        document.getElementById('customAmountBox').classList.remove('hidden');
        selectedDepAmount = 0;
    }

    function openTelegramBot() {
        const customInput = document.getElementById('customDepAmount');
        let amount = selectedDepAmount;
        if(amount === 0 && customInput.value) amount = parseInt(customInput.value);
        
        if(!amount || amount < 50) {
            notify("–û–±–µ—Ä—ñ—Ç—å —Å—É–º—É –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è (–º—ñ–Ω. 50‚Ç¥)", "error");
            return;
        }

        const userId = userData.id;
        const userName = currentUser;
        
        // Deep link –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –±–æ—Ç–∞
        // –ë–æ—Ç –æ—Ç—Ä–∏–º–∞—î: /start dep_USERID_AMOUNT
        const startParam = `dep_${userId}_${amount}`;
        const tgUrl = `https://t.me/${TG_BOT_USERNAME}?start=${startParam}`;
        
        // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –±–æ—Ç
        window.open(tgUrl, '_blank');
        
        notify(`–í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è Telegram –±–æ—Ç. –í–∞—à ID: ${userId}`, 'info');
        notify(`–°—É–º–∞: ${amount} ‚Ç¥ ‚Äî –ø–µ—Ä–µ–¥–∞–Ω–∞ –±–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ`, 'success');
        
        // –§—ñ–∫—Å—É—î–º–æ –∑–∞–ø–∏—Ç –¥–µ–ø–æ–∑–∏—Ç—É –≤ –±–∞–∑—ñ (–¥–ª—è –∞–¥–º—ñ–Ω–∞)
        db.ref(`deposit_requests/${userId}_${Date.now()}`).set({
            user: userName,
            userId: userId,
            amount: amount,
            status: 'pending',
            method: 'telegram',
            time: Date.now()
        });
    }

    // ============================================
    // –í–ò–í–Ü–î –ö–û–®–¢–Ü–í
    // ============================================
    function selectWithdrawMethod(method, el) {
        selectedWithdrawMethod = method;
        document.querySelectorAll('.wm-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        
        const cardInput = document.getElementById('withdrawCard');
        if(method === 'usdt') {
            cardInput.placeholder = 'USDT TRC20 –∞–¥—Ä–µ—Å–∞';
        } else if(method === 'privat') {
            cardInput.placeholder = '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ PrivatBank';
        } else {
            cardInput.placeholder = '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ Monobank';
        }
    }

    function submitWithdraw() {
        const card = document.getElementById('withdrawCard').value.trim();
        const amount = parseInt(document.getElementById('withdrawAmount').value);
        
        if(!card) return notify("–í–≤–µ–¥—ñ—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –≤–∏–≤–æ–¥—É", "error");
        if(!amount || amount < 200) return notify("–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—É–º–∞ –≤–∏–≤–æ–¥—É: 200‚Ç¥", "error");
        if(userData.balance < amount) return notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤", "error");
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ pending –∑–∞—è–≤–∫–∏
        if(userData.pendingWithdraw) {
            return notify("–£ –≤–∞—Å –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–∏–≤—ñ–¥. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å —ó—ó –æ–±—Ä–æ–±–∫–∏.", "error");
        }
        
        const requestId = `${currentUser}_${Date.now()}`;
        
        // –ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏ –≥—Ä–æ—à—ñ
        db.ref('users/' + currentUser).update({
            balance: userData.balance - amount,
            pendingWithdraw: true
        });
        
        // –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞—è–≤–∫—É
        db.ref('withdraw_requests/' + requestId).set({
            user: currentUser,
            userId: userData.id,
            amount: amount,
            method: selectedWithdrawMethod,
            card: card,
            status: 'pending',
            time: Date.now()
        });
        
        db.ref('users/' + currentUser + '/withdraws/' + requestId).set({
            amount: amount,
            method: selectedWithdrawMethod,
            status: 'pending',
            time: Date.now()
        });
        
        addToHistory(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–∏–≤—ñ–¥: -${amount} ‚Ç¥ (–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è)`);
        notify(`‚úÖ –ó–∞—è–≤–∫—É –Ω–∞ –≤–∏–≤—ñ–¥ ${amount}‚Ç¥ –ø—Ä–∏–π–Ω—è—Ç–æ! –û–±—Ä–æ–±–∫–∞ 1-24 –≥–æ–¥.`, 'success');
        
        document.getElementById('withdrawCard').value = '';
        document.getElementById('withdrawAmount').value = '';
        loadMyWithdraws();
    }

    function loadMyWithdraws() {
        const list = document.getElementById('myWithdrawsList');
        if(!list) return;
        
        db.ref('users/' + currentUser + '/withdraws').limitToLast(5).once('value', snap => {
            const data = snap.val();
            if(!data) { list.innerHTML = '<div style="color:#777; font-size:13px; padding:10px 0;">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>'; return; }
            
            list.innerHTML = '';
            Object.entries(data).reverse().forEach(([id, w]) => {
                const date = new Date(w.time).toLocaleDateString('uk-UA');
                const statusClass = w.status === 'done' ? 'pw-done' : 'pw-pending';
                const statusText = w.status === 'done' ? '‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ' : '‚è≥ –û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è';
                list.innerHTML += `
                    <div class="pending-withdraw">
                        <div>
                            <div style="font-weight:bold;">${w.amount} ‚Ç¥</div>
                            <div style="color:#777; font-size:11px;">${w.method} ‚Ä¢ ${date}</div>
                        </div>
                        <span class="pw-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
        });
    }

    // ============================================
    // –Ü–ì–†–ò
    // ============================================

    // --- –°–ª–æ—Ç–∏ ---
    function spinSlots() { 
        const b = validateBet(document.getElementById('betAmountSlots').value); 
        if(!b) return; 
        db.ref('users/'+currentUser).update({balance: userData.balance - b}); 
        addWager(b);
        if(userData.clanId) trackClanWager(b);
        trackQuest('slotsPlayed', 1);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', b);
        playSound('click'); 
        const reels = [document.getElementById('r1'), document.getElementById('r2'), document.getElementById('r3')]; 
        const sym = ["üçí", "üçã", "7", "üíé", "üîî"]; 
        let count = 0; 
        let int = setInterval(() => { 
            reels.forEach(r => r.textContent = sym[Math.floor(Math.random()*sym.length)]); 
            count++; 
            if(count > 15) { clearInterval(int); finishSlots(b); } 
        }, 80); 
    }
    
    function finishSlots(bet) { 
        const r = Math.random(); 
        let win = 0; let res = ["üçí","üçã","üîî"]; 
        if(r < 0.015) { res = ["7","7","7"]; win = bet*40; }       // 1.5% ‚Üí x40
        else if(r < 0.04) { res = ["üíé","üíé","üíé"]; win = bet*12; } // 2.5% ‚Üí x12
        else if(r < 0.12) { res = ["üçí","üçí","üçí"]; win = bet*2.5; }// 8% ‚Üí x2.5
        else if(r < 0.25) { res = ["üîî","üîî","üçã"]; win = bet*1.3; }// 13% ‚Üí x1.3
        
        document.getElementById('r1').textContent = res[0]; 
        document.getElementById('r2').textContent = res[1]; 
        document.getElementById('r3').textContent = res[2]; 
        
        if(win > 0) { 
            db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win)); 
            playSound('win'); 
            notify(`üé∞ WIN: ${win} ‚Ç¥`, "success"); 
            addToHistory(`Slots: +${win}`); 
        } 
    }

    // --- –†—É–ª–µ—Ç–∫–∞ ---
    function selectRouletteBet(c, e){ 
        document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected')); 
        e.classList.add('selected'); 
        currentRouletteBet = c; 
        playSound('click'); 
    }
    
    function spinRoulette(){ 
        const b = validateBet(document.getElementById('betAmountRoulette').value); 
        if(!b || !currentRouletteBet) { notify("–û–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä —ñ —Å—Ç–∞–≤–∫—É"); return; }
        db.ref('users/'+currentUser).update({balance: userData.balance - b}); 
        addWager(b);
        trackQuest('rouletteBets', 1);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', b);
        playSound('click'); 
        const wheel = document.getElementById('wheel'); 
        const randDeg = Math.random() * 360; 
        wheel.style.transform = `rotate(${1800 + (360 - randDeg)}deg)`; 
        setTimeout(() => { 
            let win = 0; let c = 'black'; 
            if(randDeg <= 18) c = 'green'; 
            else if(randDeg <= 189) c = 'red'; 
            if(c === currentRouletteBet){ 
                win = (c === 'green') ? b*14 : b*2; 
                db.ref('users/'+currentUser+'/balance').set(userData.balance + win); 
                notify(`üé° –í–∏–≥—Ä–∞—à: ${win} ‚Ç¥`, "success"); 
                playSound('win'); 
                addToHistory(`Roulette: +${win}`); 
            } else { notify("–ü—Ä–æ–≥—Ä–∞—à üòî", "error"); } 
        }, 4000); 
    }

    // --- –°—É–Ω–¥—É–∫–∏ ---
    function startChests(){ 
        const b = validateBet(document.getElementById('betAmountChests').value); 
        if(!b) return; 
        db.ref('users/'+currentUser).update({balance: userData.balance - b}); 
        const g = document.getElementById('chestsGrid'); 
        g.innerHTML = ""; 
        for(let i=0; i<3; i++){ 
            const d = document.createElement('div'); 
            d.className = "chest-item"; 
            d.textContent = "üì¶"; 
            d.onclick = () => { 
                const w = Math.random() > 0.6 ? b*2.5 : 0; 
                d.textContent = w ? "üí∞" : "üí®"; 
                if(w){ db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(w)); playSound('win'); notify(`+${w} ‚Ç¥`, "success"); addToHistory(`Chests: +${w}`); } 
                else { playSound('click'); }
                Array.from(g.children).forEach(c => c.onclick = null);
            }; 
            g.appendChild(d); 
        }
    }

    // --- –ö—Ä–∞—à ---
    let crashInt; let isCrashPlaying = false;
    function startCrash() { 
        const b = validateBet(document.getElementById('betAmountCrash').value); 
        if(!b) return; 
        db.ref('users/'+currentUser).update({balance: userData.balance - b}); 
        addWager(b);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', b);
        document.getElementById('crashBtn').classList.add('hidden'); 
        document.getElementById('crashCashoutBtn').classList.remove('hidden'); 
        let m = 1.00; 
        let crashPoint = 1 + (Math.random() * 8);
        isCrashPlaying = true; 
        crashInt = setInterval(() => { 
            m += 0.03 + (m * 0.002); 
            document.getElementById('crashDisplay').textContent = m.toFixed(2) + 'x'; 
            if(m >= crashPoint){ 
                clearInterval(crashInt); 
                isCrashPlaying = false; 
                notify("üí• –ö–†–ê–® –Ω–∞ " + m.toFixed(2) + "x!", "error"); 
                document.getElementById('crashDisplay').style.color = "red";
                setTimeout(()=> { document.getElementById('crashDisplay').style.color = "white"; document.getElementById('crashDisplay').textContent = "1.00x"; }, 2000);
                document.getElementById('crashBtn').classList.remove('hidden'); 
                document.getElementById('crashCashoutBtn').classList.add('hidden'); 
            } 
        }, 100); 
    }
    
    function cashoutCrash() { 
        if(!isCrashPlaying) return; 
        clearInterval(crashInt); 
        isCrashPlaying = false; 
        const b = parseInt(document.getElementById('betAmountCrash').value); 
        const mult = parseFloat(document.getElementById('crashDisplay').textContent);
        const w = Math.floor(b * mult); 
        db.ref('users/'+currentUser+'/balance').set(userData.balance + w); 
        trackQuest('crashCashouts', 1);
        notify(`üöÄ –í–∏–≤–µ–¥–µ–Ω–æ: +${w} ‚Ç¥`, "success"); 
        addToHistory(`Crash: +${w} (x${mult})`); 
        document.getElementById('crashBtn').classList.remove('hidden'); 
        document.getElementById('crashCashoutBtn').classList.add('hidden'); 
    }

    // ============================================
    // –í–Ü–î–ï–û–ü–û–ö–ï–†
    // ============================================
    const POKER_SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
    const POKER_RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const RANK_VALUES = {2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13,A:14};

    let pokerHand = [];
    let pokerSelectedCards = [];
    let pokerBet = 0;
    let pokerPhase = 'deal'; // 'deal' –∞–±–æ 'draw'

    function createDeck() {
        const deck = [];
        for(const suit of POKER_SUITS) for(const rank of POKER_RANKS) deck.push({rank, suit});
        return deck.sort(() => Math.random() - 0.5);
    }

    function cardHTML(card, index, selectable=false) {
        const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
        const colorClass = isRed ? 'red-card' : '';
        const selectedClass = pokerSelectedCards.includes(index) ? 'selected' : '';
        const onclick = selectable ? `onclick="togglePokerCard(${index})"` : '';
        return `<div class="card ${colorClass} ${selectedClass}" ${onclick} data-idx="${index}">
            <span style="font-size:11px;">${card.rank}</span>
            <span style="font-size:16px;">${card.suit}</span>
        </div>`;
    }

    function togglePokerCard(idx) {
        if(pokerPhase !== 'draw') return;
        const pos = pokerSelectedCards.indexOf(idx);
        if(pos === -1) pokerSelectedCards.push(idx);
        else pokerSelectedCards.splice(pos, 1);
        renderPokerHand(true);
    }

    function renderPokerHand(selectable=false) {
        const container = document.getElementById('pokerCards');
        container.innerHTML = pokerHand.map((c, i) => cardHTML(c, i, selectable)).join('');
    }

    function dealPoker() {
        const b = validateBet(document.getElementById('betAmountPoker').value);
        if(!b) return;
        pokerBet = b;
        db.ref('users/'+currentUser).update({balance: userData.balance - b});
        addWager(b);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', b);
        
        const deck = createDeck();
        pokerHand = deck.slice(0, 5);
        pokerSelectedCards = [];
        pokerPhase = 'draw';
        
        renderPokerHand(true);
        document.getElementById('pokerInfo').textContent = 'üîÑ –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∏ –¥–ª—è –ó–ê–ú–Ü–ù–ò (–∞–±–æ –Ω–µ –æ–±–∏—Ä–∞–π—Ç–µ)';
        document.getElementById('pokerDealBtn').classList.add('hidden');
        document.getElementById('pokerDrawBtn').classList.remove('hidden');
        playSound('click');
    }

    function drawPoker() {
        // –ó–∞–º—ñ–Ω—é—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω—ñ –∫–∞—Ä—Ç–∏
        const deck = createDeck().filter(c => !pokerHand.find(h => h.rank===c.rank && h.suit===c.suit));
        let di = 0;
        pokerSelectedCards.forEach(idx => { pokerHand[idx] = deck[di++]; });
        pokerSelectedCards = [];
        pokerPhase = 'deal';
        
        renderPokerHand(false);
        
        const result = evaluatePokerHand(pokerHand);
        const win = Math.floor(pokerBet * result.multiplier);
        
        if(win > 0) {
            db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
            playSound('win');
            notify(`üÉè ${result.name}! +${win} ‚Ç¥`, 'success');
            addToHistory(`Poker ${result.name}: +${win}`);
            document.getElementById('pokerInfo').innerHTML = `<span style="color:var(--green); font-weight:bold;">üèÜ ${result.name}! –í–∏–≥—Ä–∞—à: +${win} ‚Ç¥</span>`;
        } else {
            notify('üòî –ù—ñ—á–æ–≥–æ –Ω–µ–º–∞—î', 'error');
            document.getElementById('pokerInfo').textContent = result.name + ' ‚Äî –ø—Ä–æ–≥—Ä–∞—à';
        }
        
        document.getElementById('pokerDealBtn').classList.remove('hidden');
        document.getElementById('pokerDrawBtn').classList.add('hidden');
    }

    function evaluatePokerHand(hand) {
        const ranks = hand.map(c => RANK_VALUES[c.rank]).sort((a,b) => a-b);
        const suits = hand.map(c => c.suit);
        const rankStr = hand.map(c => c.rank);
        
        const isFlush = suits.every(s => s === suits[0]);
        const isStraight = ranks[4]-ranks[0]===4 && new Set(ranks).size===5 || 
                          (ranks.join(',') === '2,3,4,5,14'); // Wheel
        
        const rankCount = {};
        rankStr.forEach(r => rankCount[r] = (rankCount[r]||0)+1);
        const counts = Object.values(rankCount).sort((a,b) => b-a);
        
        if(isFlush && isStraight && ranks[0]===10) return {name:'–†–æ—è–ª-—Ñ–ª–µ—à üëë', multiplier:800};
        if(isFlush && isStraight) return {name:'–°—Ç—Ä–µ–π—Ç-—Ñ–ª–µ—à', multiplier:50};
        if(counts[0]===4) return {name:'–ö–∞—Ä–µ', multiplier:25};
        if(counts[0]===3 && counts[1]===2) return {name:'–§—É–ª-—Ö–∞—É—Å', multiplier:9};
        if(isFlush) return {name:'–§–ª–µ—à', multiplier:6};
        if(isStraight) return {name:'–°—Ç—Ä–µ–π—Ç', multiplier:4};
        if(counts[0]===3) return {name:'–¢—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö', multiplier:3};
        if(counts[0]===2 && counts[1]===2) return {name:'–î–≤—ñ –ø–∞—Ä–∏', multiplier:2};
        
        // –ü–∞—Ä–∞ JJ+
        if(counts[0]===2) {
            const pairRank = Object.keys(rankCount).find(r => rankCount[r]===2);
            if(['J','Q','K','A'].includes(pairRank)) return {name:`–ü–∞—Ä–∞ ${pairRank}`, multiplier:1};
        }
        
        return {name:'–ù—ñ—á–æ–≥–æ', multiplier:0};
    }

    function togglePaytable() {
        const pt = document.getElementById('pokerPaytable');
        pt.style.display = pt.style.display === 'none' ? 'block' : 'none';
    }

    // --- –°–∞–ø–µ—Ä ---
    let minesGrid = []; let isMinesPlaying = false; let currentMinesProfit = 0; let movesMade = 0;
    function startMines() { 
        const bet = validateBet(document.getElementById('betAmountMines').value); 
        if(!bet) return; 
        db.ref('users/'+currentUser).update({balance: userData.balance - bet}); 
        addWager(bet);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', bet);
        isMinesPlaying = true; currentMinesProfit = bet; movesMade = 0; 
        document.getElementById('minesBtn').classList.add('hidden'); 
        document.getElementById('minesCashoutBtn').classList.remove('hidden'); 
        document.getElementById('minesCashoutBtn').textContent = `–ó–ê–ë–†–ê–¢–ò (0)`;
        minesGrid = new Array(25).fill(0); 
        let placed = 0; 
        while(placed < 5) { let idx = Math.floor(Math.random()*25); if(minesGrid[idx]===0){ minesGrid[idx]=1; placed++; } } 
        const container = document.getElementById('minesGrid'); 
        container.innerHTML = ''; 
        for(let i=0; i<25; i++){ 
            const cell = document.createElement('div'); 
            cell.className='mine-cell'; cell.textContent="‚ùì"; 
            cell.onclick = () => clickMineCell(i, cell); 
            container.appendChild(cell); 
        } 
        playSound('click'); 
    }
    
    function clickMineCell(idx, el) { 
        if(!isMinesPlaying || el.classList.contains('revealed')) return; 
        el.classList.add('revealed'); 
        if(minesGrid[idx]===1){ 
            el.textContent="üí£"; playSound('click'); notify("üí£ –ë—É–º! –ü—Ä–æ–≥—Ä–∞—à", "error"); 
            isMinesPlaying=false;
            document.getElementById('minesBtn').classList.remove('hidden'); 
            document.getElementById('minesCashoutBtn').classList.add('hidden'); 
        } else { 
            el.textContent="üíé"; playSound('click'); movesMade++; 
            currentMinesProfit=Math.floor(currentMinesProfit*1.18); 
            document.getElementById('minesCashoutBtn').textContent=`–ó–ê–ë–†–ê–¢–ò ${currentMinesProfit} ‚Ç¥`; 
        } 
    }
    
    function cashoutMines() { 
        if(!isMinesPlaying || movesMade===0) return; 
        db.ref('users/'+currentUser+'/balance').set(userData.balance+currentMinesProfit); 
        playSound('win'); notify(`üíé –í–∏–≤–µ–¥–µ–Ω–æ: +${currentMinesProfit} ‚Ç¥`, "success"); 
        addToHistory(`Mines: +${currentMinesProfit}`); 
        isMinesPlaying=false;
        document.getElementById('minesBtn').classList.remove('hidden'); 
        document.getElementById('minesCashoutBtn').classList.add('hidden'); 
    }

    // --- –ü–ª—ñ–Ω–∫–æ ---
    function dropPlinko() { 
        const bet = validateBet(document.getElementById('betAmountPlinko').value); 
        if(!bet) return; 
        db.ref('users/'+currentUser).update({balance: userData.balance - bet}); 
        addWager(bet);
        trackQuest('totalGames', 1);
        trackQuest('weekWager', bet);
        playSound('click'); 
        const ball = document.getElementById('plinkoBall'); 
        ball.style.display='block'; 
        const rand = Math.random(); 
        let bucketIndex = 3; 
        if(rand < 0.10) bucketIndex=0; 
        else if(rand < 0.30) bucketIndex=1; 
        else if(rand < 0.60) bucketIndex=2; 
        else bucketIndex=3; 
        if(Math.random()>0.5) bucketIndex=6-bucketIndex; 
        const targetLeft=(bucketIndex*14)+7; 
        ball.animate([{top:'0',left:'50%'},{top:'100%',left:targetLeft+'%'}],{duration:1500,fill:'forwards',easing:'linear'}); 
        setTimeout(() => { 
            const multipliers=[3,1.5,0.4,0.1,0.4,1.5,3]; 
            const mult=multipliers[bucketIndex]; 
            const win=Math.floor(bet*mult); 
            if(mult>=1){ db.ref('users/'+currentUser+'/balance').set(userData.balance+win); playSound('win'); notify(`üîª +${win} ‚Ç¥`, "success"); addToHistory(`Plinko: +${win}`); } 
            else { addToHistory(`Plinko: -${bet-win}`); } 
            ball.style.display='none'; 
        }, 1500); 
    }

    // ============================================
    // –†–ï–ô–¢–ò–ù–ì
    // ============================================
    function renderTop(d) {
        if(!d) return;
        let arr = [];
        for(let k in d) arr.push({n:k, ...d[k]});
        arr.sort((a,b) => b.balance - a.balance);
        let h = "";
        arr.forEach((u,i) => {
            const av = u.avatar && u.avatar.length > 20 ? `<img src="${u.avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;">` : 'üë§';
            const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`${i+1}`;
            h += `<tr onclick="openUserProfile('${u.n}')" style="cursor:pointer;">
                    <td style="font-size:16px;">${medal}</td>
                    <td>${av} <b>${u.n}</b></td>
                    <td class="rank">${formatNumber(u.balance)} ‚Ç¥</td>
                  </tr>`;
        });
        document.getElementById('topTable').innerHTML = h;
    }

    // ============================================
    // –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø
    // ============================================
    function authLogin() { 
        const n = document.getElementById('loginName').value.trim(); 
        const p = document.getElementById('loginPass').value; 
        if(!n || !p) return notify("–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ", "error"); 
        db.ref('users/'+n).once('value', s => { 
            if(s.exists() && s.val().pass == p) { 
                currentUser=n; localStorage.setItem("royal_online_user",n); startDataSync(); 
            } else { notify("–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å", "error"); } 
        }); 
    }
    
    function authRegister() { 
        const e=document.getElementById('regEmail').value.trim(); 
        const n=document.getElementById('regName').value.trim(); 
        const p=document.getElementById('regPass').value; 
        if(!e||!n||!p) return notify("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è","error"); 
        if(p.length<8||n.includes(' ')||n.includes('.')) return notify("–ü–∞—Ä–æ–ª—å –º—ñ–Ω 8 —Å–∏–º–≤. –ù—ñ–∫ –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤!","error"); 
        db.ref('users/'+n).once('value', s => { 
            if(s.exists()){ notify("–¶–µ–π –Ω—ñ–∫–Ω–µ–π–º –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π","error"); } 
            else { 
                const id=Math.floor(Math.random()*900000)+100000; 
                db.ref('users/'+n).set({pass:p,email:e,balance:1000,id:id,tag:"–ù–æ–≤–∞—á–æ–∫",dailyStreak:0}).then(() => { 
                    notify("–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.","success"); toggleAuthMode(false); 
                }); 
            } 
        }); 
    }
    
    function toggleAuthMode(reg) { 
        document.getElementById('loginForm').classList.toggle('hidden', reg); 
        document.getElementById('regForm').classList.toggle('hidden', !reg); 
    }
    
    function logout(){ localStorage.removeItem("royal_online_user"); location.reload(); }

    // ============================================
    // –ê–î–ú–Ü–ù-–ü–ê–ù–ï–õ–¨
    // ============================================
    function loadUserList() { 
        const d=document.getElementById('userList'); 
        d.innerHTML="–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..."; 
        db.ref('users').once('value', s => { 
            d.innerHTML=""; 
            const users=s.val(); 
            if(!users){ d.innerHTML="–ù–µ–º–∞—î –≥—Ä–∞–≤—Ü—ñ–≤"; return; } 
            for(let n in users){ 
                d.innerHTML+=`<div class="admin-user-card" onclick="openAdminManage('${n}')">
                    <div><b>${n}</b><div style="color:#555;font-size:11px;">ID: ${users[n].id||'?'}</div></div>
                    <span style="color:var(--green)">${formatNumber(users[n].balance)} ‚Ç¥</span></div>`; 
            } 
        }); 
    }

    function loadWithdrawRequests() {
        const box = document.getElementById('withdrawRequestsList');
        const content = document.getElementById('withdrawRequestsContent');
        box.classList.remove('hidden');
        content.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        
        db.ref('withdraw_requests').orderByChild('status').equalTo('pending').once('value', snap => {
            const data = snap.val();
            if(!data) { content.innerHTML = '<div style="color:#777; padding:10px;">–ù–µ–º–∞ –∑–∞—è–≤–æ–∫</div>'; return; }
            
            content.innerHTML = '';
            Object.entries(data).forEach(([id, req]) => {
                content.innerHTML += `
                    <div class="request-card">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <b>${req.user}</b><span style="color:var(--green);font-weight:bold;">${req.amount} ‚Ç¥</span>
                        </div>
                        <div style="color:#777;font-size:12px;">${req.method} ‚Ä¢ ${req.card}</div>
                        <div style="color:#555;font-size:11px;">${new Date(req.time).toLocaleString('uk-UA')}</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button class="btn-green" style="padding:8px;font-size:12px;" onclick="approveWithdraw('${id}','${req.user}')">‚úÖ –°—Ö–≤–∞–ª–∏—Ç–∏</button>
                            <button class="btn-red" style="padding:8px;font-size:12px;" onclick="rejectWithdraw('${id}','${req.user}',${req.amount})">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                        </div>
                    </div>
                `;
            });
        });
    }

    function approveWithdraw(id, user) {
        db.ref('withdraw_requests/'+id).update({status:'done'});
        db.ref('users/'+user+'/withdraws/'+id).update({status:'done'});
        db.ref('users/'+user).update({pendingWithdraw: false});
        notify('–í–∏–≤—ñ–¥ —Å—Ö–≤–∞–ª–µ–Ω–æ', 'success');
        loadWithdrawRequests();
    }

    function rejectWithdraw(id, user, amount) {
        // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ—à—Ç–∏
        db.ref('users/'+user+'/balance').set(firebase.database.ServerValue.increment(amount));
        db.ref('withdraw_requests/'+id).update({status:'rejected'});
        db.ref('users/'+user+'/withdraws/'+id).update({status:'rejected'});
        db.ref('users/'+user).update({pendingWithdraw: false});
        notify('–í–∏–≤—ñ–¥ –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ, –∫–æ—à—Ç–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç–æ', 'success');
        loadWithdrawRequests();
    }
    
    let admSelectedUser = null;
    function openAdminManage(n) { 
        admSelectedUser=n; 
        document.getElementById('admin-user-manage').classList.remove('hidden'); 
        document.getElementById('admManageName').textContent=n; 
    }
    function admGiveMoney() { 
        const a=parseInt(document.getElementById('admAmount').value); 
        if(!a) return; 
        db.ref('users/'+admSelectedUser+'/balance').set(firebase.database.ServerValue.increment(a)); 
        notify("–ë–∞–ª–∞–Ω—Å –∑–º—ñ–Ω–µ–Ω–æ","success"); 
    }
    function admSetTag() { 
        const t=document.getElementById('admTag').value; 
        if(t){ db.ref('users/'+admSelectedUser).update({tag:t}); notify("–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–µ–Ω–æ"); } 
    }
    function admBanUser() { 
        if(confirm("–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è?")){ db.ref('users/'+admSelectedUser).update({banned:true}); notify("–ó–ê–ë–õ–û–ö–û–í–ê–ù–û"); } 
    }
    function admDeleteUser() { 
        if(confirm("–í–ò–î–ê–õ–ò–¢–ò –ê–ö–ê–£–ù–¢ –ù–ê–ó–ê–í–ñ–î–ò?")){ 
            db.ref('users/'+admSelectedUser).remove().then(()=>{ notify("–í–∏–¥–∞–ª–µ–Ω–æ"); closeModal('admin-user-manage'); loadUserList(); }); 
        } 
    }
    function wipeEconomy() { 
        if(prompt("–í–≤–µ–¥—ñ—Ç—å WIPE:")==="WIPE"){ 
            db.ref('users').once('value', s=>{ for(let k in s.val()) db.ref('users/'+k+'/balance').set(1000); notify("–°–∫–∏–Ω—É—Ç–æ","success"); }); 
        } 
    }

    // ============================================
    // –Ü–ù–®–Ü –§–£–ù–ö–¶–Ü–á
    // ============================================
    function switchTab(id, el) { 
        document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); 
        const tab = document.getElementById('tab-'+id);
        if(tab) tab.classList.remove('hidden'); 
        if(el){ document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); } 
    }
    
    function openGame(g) { switchTab(g); }
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    
    function sendMoney() { 
        const t=document.getElementById('transferTo').value; 
        const a=parseInt(document.getElementById('transferAmount').value); 
        if(userData.balance<a||a<=0) return notify("–ù–µ–≤—ñ—Ä–Ω–∞ —Å—É–º–∞","error"); 
        db.ref('users/'+t).once('value', s=>{ 
            if(s.exists()){ 
                db.ref('users/'+currentUser+'/balance').set(userData.balance-a); 
                db.ref('users/'+t+'/balance').set(s.val().balance+a); 
                notify("–ì—Ä–æ—à—ñ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!","success"); closeModal('transfer-modal'); 
            } else { notify("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ","error"); } 
        }); 
    }
    
    function activatePromo() { 
        const c=document.getElementById('promoInput').value.trim(); 
        db.ref('promos/'+c).once('value', s=>{ 
            if(s.exists()){ 
                db.ref('users/'+currentUser+'/balance').set(userData.balance+s.val().value); 
                notify("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!","success"); closeModal('promo-modal'); 
            } else { notify("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥","error"); } 
        }); 
    }
    
    function addContact() { 
        const i=document.getElementById('addContactInput').value; 
        db.ref('users/'+i).once('value', s=>{ 
            if(s.exists()){ db.ref('users/'+currentUser+'/contacts/'+i).set({avatar:s.val().avatar||'üë§'}); notify("–î–æ–¥–∞–Ω–æ!"); loadContacts(); } 
            else { notify("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ","error"); } 
        }); 
    }
    
    function loadContacts() { 
        const l=document.getElementById('contactsList'); 
        if(!userData.contacts){ l.innerHTML="<div style='color:#777'>–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>"; return; } 
        l.innerHTML=""; 
        for(let n in userData.contacts){ 
            l.innerHTML+=`<div class="contact-row"><b>${n}</b> <button class="btn-green" style="width:auto;padding:8px 15px;margin:0;" onclick="quickSend('${n}')">üí∏</button></div>`; 
        } 
    }
    
    function quickSend(n) { document.getElementById('transferTo').value=n; openModal('transfer-modal'); }
    function deleteAccount() { if(confirm("–í–ò–î–ê–õ–ò–¢–ò –ê–ö–ê–£–ù–¢ –ù–ê–ó–ê–í–ñ–î–ò?")) db.ref('users/'+currentUser).remove().then(logout); }
    function updateBio(v) { db.ref('users/'+currentUser).update({tag:v}); notify("–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ"); }
    function handleAvatarUpload(i) { 
        if(i.files[0]){ 
            const r=new FileReader(); 
            r.onload=e=>db.ref('users/'+currentUser).update({avatar:e.target.result}); 
            r.readAsDataURL(i.files[0]); notify("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..."); 
        } 
    }
    function openHistoryModal() { 
        openModal('history-modal'); 
        const c=document.getElementById('historyList'); c.innerHTML="–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        db.ref('users/'+currentUser+'/history').limitToLast(20).once('value', s=>{ 
            c.innerHTML=""; 
            if(s.val()) Object.values(s.val()).reverse().forEach(i=>{ c.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #333;color:#ccc;">${i.text}</div>`; }); 
            else c.innerHTML="<div style='padding:10px;color:#777;'>–ü–æ—Ä–æ–∂–Ω—å–æ</div>"; 
        }); 
    }
    function openSupportModal() { 
        openModal('support-modal'); 
        const box=document.getElementById('supportChatBox'); box.innerHTML="";
        db.ref('support_chats/'+currentUser).limitToLast(20).on('child_added', s=>{ 
            const m=s.val(); 
            box.innerHTML+=`<div style="margin-bottom:8px;padding:8px 12px;background:${m.sender==='user'?'#005c4b':'#333'};border-radius:8px;width:fit-content;max-width:80%;margin-left:${m.sender==='user'?'auto':'0'}">${m.text}</div>`; 
            box.scrollTop=box.scrollHeight; 
        }); 
    }
    function sendSupportMsg() { 
        const t=document.getElementById('supportMsg').value; 
        if(t){ db.ref('support_chats/'+currentUser).push({text:t,sender:'user',time:Date.now()}); document.getElementById('supportMsg').value=""; } 
    }
    window.openUserProfile = function(name) { 
        if(name===currentUser) return switchTab('profile'); 
        db.ref('users/'+name).once('value', s=>{ 
            const d=s.val(); 
            if(d){ 
                document.getElementById('viewUserName').textContent=name; 
                document.getElementById('viewUserId').textContent=d.id; 
                document.getElementById('viewUserBal').textContent=formatNumber(d.balance); 
                document.getElementById('viewUserTag').textContent=d.tag||"–ì—Ä–∞–≤–µ—Ü—å"; 
                document.getElementById('viewUserAvatar').innerHTML=(d.avatar&&d.avatar.length>20)?`<img src="${d.avatar}">`:'üë§'; 
                openModal('view-user-modal'); 
            } 
        }); 
    }
    // ============================================
    // –ë–õ–ï–ö–î–ñ–ï–ö
    // ============================================
    const BJ_DECK = [];
    let bjPlayerHand = [], bjDealerHand = [], bjBet = 0, bjActive = false;

    function bjCreateDeck() {
      const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'], ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      const d = [];
      for(const s of suits) for(const r of ranks) d.push({r,s});
      return d.sort(() => Math.random()-0.5);
    }

    function bjValue(hand) {
      let v = 0, aces = 0;
      for(const c of hand) {
        if(c.r === 'A') { aces++; v += 11; }
        else if(['J','Q','K'].includes(c.r)) v += 10;
        else v += parseInt(c.r);
      }
      while(v > 21 && aces > 0) { v -= 10; aces--; }
      return v;
    }

    function bjCardHTML(c, hidden=false) {
      if(hidden) return `<div class="bj-card" style="background:#1a3a6b;color:transparent;">üÇ†</div>`;
      const red = c.s==='‚ô•'||c.s==='‚ô¶';
      return `<div class="bj-card ${red?'red':''}">${c.r}<br>${c.s}</div>`;
    }

    function bjRender(hideDealer=true) {
      document.getElementById('bjPlayerCards').innerHTML = bjPlayerHand.map(c=>bjCardHTML(c)).join('');
      document.getElementById('bjDealerCards').innerHTML = bjDealerHand.map((c,i)=>bjCardHTML(c, hideDealer && i===1)).join('');
      document.getElementById('bjPlayerScore').textContent = bjValue(bjPlayerHand);
      document.getElementById('bjDealerScore').textContent = hideDealer ? '?' : bjValue(bjDealerHand);
    }

    function bjDeal() {
      const b = validateBet(document.getElementById('betAmountBJ').value);
      if(!b) return;
      bjBet = b;
      db.ref('users/'+currentUser).update({balance: userData.balance - b});
      addWager(b);
      trackQuest('totalGames', 1);
      trackQuest('weekWager', b);
      const deck = bjCreateDeck();
      bjPlayerHand = [deck[0], deck[2]];
      bjDealerHand = [deck[1], deck[3]];
      bjActive = true;
      document.getElementById('bjDealBtn').classList.add('hidden');
      document.getElementById('bjActions').classList.remove('hidden');
      document.getElementById('bjResult').textContent = '';
      bjRender(true);
      playSound('click');
      if(bjValue(bjPlayerHand) === 21) { bjStand(); }
    }

    function bjHit() {
      if(!bjActive) return;
      const deck = bjCreateDeck();
      bjPlayerHand.push(deck[0]);
      bjRender(true);
      if(bjValue(bjPlayerHand) > 21) { bjEnd('bust'); }
    }

    function bjStand() {
      if(!bjActive) return;
      const deck = bjCreateDeck();
      let di = 0;
      while(bjValue(bjDealerHand) < 17) { bjDealerHand.push(deck[di++]); }
      bjRender(false);
      const p = bjValue(bjPlayerHand), d = bjValue(bjDealerHand);
      if(p > 21) bjEnd('bust');
      else if(d > 21 || p > d) bjEnd('win');
      else if(p === d) bjEnd('push');
      else bjEnd('lose');
    }

    function bjEnd(result) {
      bjActive = false;
      document.getElementById('bjDealBtn').classList.remove('hidden');
      document.getElementById('bjActions').classList.add('hidden');
      bjRender(false);
      const msgs = {win:'üèÜ –í–∏ –≤–∏–≥—Ä–∞–ª–∏!', lose:'üòî –î–∏–ª–µ—Ä –≤–∏–≥—Ä–∞–≤', bust:'üí• –ü–µ—Ä–µ–±—ñ—Ä!', push:'ü§ù –ù—ñ—á–∏—è'};
      const colors = {win:'var(--green)', lose:'var(--red)', bust:'var(--red)', push:'var(--accent)'};
      document.getElementById('bjResult').innerHTML = `<span style="color:${colors[result]}">${msgs[result]}</span>`;
      let win = 0;
      if(result === 'win') win = bjBet * 2;
      else if(result === 'push') win = bjBet;
      if(win > 0) {
        db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
        if(result === 'win') { playSound('win'); notify(`üÉè –í–∏–≥—Ä–∞—à: +${win - bjBet} ‚Ç¥`, 'success'); addToHistory(`Blackjack WIN: +${win-bjBet}`); trackQuest('bjWins', 1); }
      } else { addToHistory(`Blackjack: -${bjBet}`); }
    }

    // ============================================
    // –ö–ï–ù–û
    // ============================================
    let kenoSelected = new Set();

    function initKeno() {
      const g = document.getElementById('kenoGrid');
      if(!g || g.children.length > 0) return;
      g.innerHTML = '';
      for(let i=1; i<=40; i++) {
        const d = document.createElement('div');
        d.className = 'keno-num'; d.textContent = i; d.dataset.n = i;
        d.onclick = () => toggleKeno(i, d);
        g.appendChild(d);
      }
    }

    function toggleKeno(n, el) {
      if(kenoSelected.has(n)) { kenoSelected.delete(n); el.classList.remove('picked'); }
      else if(kenoSelected.size < 10) { kenoSelected.add(n); el.classList.add('picked'); }
      else { notify('–ú–∞–∫—Å–∏–º—É–º 10 —á–∏—Å–µ–ª', 'error'); return; }
      document.getElementById('kenoSelected').textContent = `–û–±—Ä–∞–Ω–æ: ${kenoSelected.size} / 10`;
    }

    function clearKeno() {
      kenoSelected.clear();
      document.querySelectorAll('.keno-num').forEach(el => el.classList.remove('picked','hit','miss'));
      document.getElementById('kenoSelected').textContent = '–û–±—Ä–∞–Ω–æ: 0 / 10';
    }

    function playKeno() {
      if(kenoSelected.size < 1) return notify('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± 1 —á–∏—Å–ª–æ', 'error');
      const b = validateBet(document.getElementById('betAmountKeno').value);
      if(!b) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - b});

      // –¢—è–≥–Ω–µ–º–æ 20 —á–∏—Å–µ–ª
      const drawn = new Set();
      while(drawn.size < 20) drawn.add(Math.floor(Math.random()*40)+1);

      const hits = [...kenoSelected].filter(n => drawn.has(n)).length;
      const total = kenoSelected.size;

      // –ú—É–ª—å—Ç–∏–ø–ª—ñ–∫–∞—Ç–æ—Ä–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≤–≥–∞–¥–Ω–∏—Ö
      const multTable = {1:[0,3], 2:[0,1,5], 3:[0,0,2,10], 4:[0,0,1,4,20], 5:[0,0,1,3,8,40],
        6:[0,0,0,2,5,15,60], 7:[0,0,0,1,3,8,25,100], 8:[0,0,0,1,2,5,15,50,200],
        9:[0,0,0,0,2,4,10,30,100,500], 10:[0,0,0,0,1,3,8,20,60,200,1000]};
      const mults = multTable[total] || [0];
      const mult = mults[Math.min(hits, mults.length-1)] || 0;
      const win = Math.floor(b * mult);

      // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      document.querySelectorAll('.keno-num').forEach(el => {
        const n = parseInt(el.dataset.n);
        el.classList.remove('picked');
        if(drawn.has(n) && kenoSelected.has(n)) el.classList.add('hit');
        else if(drawn.has(n)) el.classList.add('miss');
      });

      document.getElementById('kenoSelected').innerHTML = `<b style="color:${win>0?'var(--green)':'var(--red)'}">–í–≥–∞–¥–∞–Ω–æ: ${hits}/${total} ‚Üí ${win>0?'+'+win+' ‚Ç¥':'–ü—Ä–æ–≥—Ä–∞—à'}</b>`;

      if(win > 0) {
        db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
        playSound('win'); notify(`üî¢ –ö–µ–Ω–æ: +${win} ‚Ç¥ (${hits} –≤–ª—É—á–∞–Ω—å)`, 'success');
        addToHistory(`Keno ${hits}/${total}: +${win}`);
      } else { addToHistory(`Keno ${hits}/${total}: -${b}`); }

      kenoSelected.clear();
    }

    // ============================================
    // –°–ö–†–ï–¢–ß-–ö–ê–†–¢–ö–ê
    // ============================================
    let scratchRevealed = 0, scratchValues = [], scratchBetAmt = 0, scratchDone = false;

    function buyScratch() {
      const b = validateBet(document.getElementById('betAmountScratch').value);
      if(!b) return;
      scratchBetAmt = b;
      db.ref('users/'+currentUser).update({balance: userData.balance - b});
      document.getElementById('scratchBuyBtn').classList.add('hidden');
      scratchRevealed = 0; scratchDone = false;
      const symbols = ['üí∞','üí∞','üíé','üíé','7Ô∏è','üçí','üçí','üîî','‚≠ê','üí∞'];
      // –ì–µ–Ω–µ—Ä—É—î–º–æ 9 –∫–ª—ñ—Ç–∏–Ω–æ–∫: –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–≥—Ä–∞—à
      scratchValues = [];
      const r = Math.random();
      let winSym = null;
      if(r < 0.05) { winSym = 'üíé'; } // –¢—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö = –¥–∂–µ–∫–ø–æ—Ç
      else if(r < 0.20) { winSym = 'üí∞'; }
      else if(r < 0.40) { winSym = '‚≠ê'; }

      for(let i=0; i<9; i++) {
        if(winSym && i < 3) scratchValues.push(winSym);
        else scratchValues.push(symbols[Math.floor(Math.random()*symbols.length)]);
      }
      scratchValues.sort(() => Math.random()-0.5);

      const grid = document.getElementById('scratchGrid');
      grid.innerHTML = '';
      document.getElementById('scratchResult').textContent = '';
      scratchValues.forEach((sym, i) => {
        const cell = document.createElement('div');
        cell.className = 'scratch-cell';
        cell.innerHTML = `<div class="scratch-overlay">–°—Ç–µ—Ä—Ç–∏</div><span style="opacity:0">${sym}</span>`;
        cell.onclick = () => revealScratch(i, cell, sym);
        grid.appendChild(cell);
      });
      playSound('click');
    }

    function revealScratch(idx, cell, sym) {
      if(scratchDone || cell.classList.contains('scratched')) return;
      cell.classList.add('scratched');
      cell.innerHTML = sym;
      scratchRevealed++;
      playSound('click');
      if(scratchRevealed >= 9) finishScratch();
    }

    function finishScratch() {
      scratchDone = true;
      const counts = {};
      scratchValues.forEach(s => counts[s] = (counts[s]||0)+1);
      const best = Object.entries(counts).find(([,v]) => v >= 3);
      let win = 0, msg = '';
      if(best) {
        const mults = {'üíé': 20, 'üí∞': 5, '‚≠ê': 3};
        const mult = mults[best[0]] || 2;
        win = Math.floor(scratchBetAmt * mult);
        msg = `üéâ –¢—Ä–∏ ${best[0]}! –í–∏–≥—Ä–∞—à: +${win} ‚Ç¥`;
      } else { msg = 'üòî –ù–µ–º–∞—î —Ç—Ä—å–æ—Ö –æ–¥–Ω–∞–∫–æ–≤–∏—Ö'; }

      document.getElementById('scratchResult').innerHTML = `<b style="color:${win>0?'var(--green)':'#777'}">${msg}</b>`;
      if(win > 0) {
        db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
        playSound('win'); addToHistory(`Scratch: +${win}`);
      } else { addToHistory(`Scratch: -${scratchBetAmt}`); }
      setTimeout(() => document.getElementById('scratchBuyBtn').classList.remove('hidden'), 1500);
    }

    // ============================================
    // –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–ò
    // ============================================
    const FORTUNE_SEGMENTS = [
      {label:'x0',   mult:0,   color:'#1a0505'},
      {label:'x1',   mult:1,   color:'#1a3a6b'},
      {label:'x0.5', mult:0.5, color:'#333'},
      {label:'x2',   mult:2,   color:'#1a5c2a'},
      {label:'x0.2', mult:0.2, color:'#333'},
      {label:'x3',   mult:3,   color:'#5c1a1a'},
      {label:'x0.5', mult:0.5, color:'#333'},
      {label:'x5',   mult:5,   color:'#8B6914'},
      {label:'x0.2', mult:0.2, color:'#333'},
      {label:'x10',  mult:10,  color:'#4a0080'},
      {label:'x0.5', mult:0.5, color:'#333'},
      {label:'x50 üéâ',mult:50, color:'#c00'},
    ];
    let fortuneRotation = 0, fortuneSpinning = false;

    function drawFortuneWheel(rotation=0) {
      const canvas = document.getElementById('fortuneCanvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const cx = 130, cy = 130, r = 124;
      const seg = FORTUNE_SEGMENTS.length;
      const arc = (2 * Math.PI) / seg;
      ctx.clearRect(0,0,260,260);
      FORTUNE_SEGMENTS.forEach((s, i) => {
        const startAngle = rotation + i * arc;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.arc(cx, cy, r, startAngle, startAngle + arc);
        ctx.closePath(); ctx.fillStyle = s.color; ctx.fill();
        ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
        ctx.save(); ctx.translate(cx, cy);
        ctx.rotate(startAngle + arc/2);
        ctx.textAlign = 'right'; ctx.fillStyle = '#fff';
        ctx.font = 'bold 11px sans-serif';
        ctx.fillText(s.label, r - 8, 4);
        ctx.restore();
      });
    }

    function spinFortune() {
      if(fortuneSpinning) return;
      const b = validateBet(document.getElementById('betAmountFortune').value);
      if(!b) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - b});
      addWager(b);
      fortuneSpinning = true;
      document.getElementById('fortuneBtn').disabled = true;
      playSound('spin');

      const seg = FORTUNE_SEGMENTS.length;
      const arc = (2 * Math.PI) / seg;
      const winIdx = Math.floor(Math.random() * seg);

      // Pointer (‚ñº) is at TOP of wheel = angle -œÄ/2 in canvas coordinates.
      // Segment i is drawn from angle (rotation + i*arc) to (rotation + (i+1)*arc).
      // For pointer to land in center of segment winIdx:
      //   rotation_final + winIdx*arc + arc/2 = -œÄ/2  (mod 2œÄ)
      //   rotation_final = -œÄ/2 - winIdx*arc - arc/2
      const neededRot = -Math.PI/2 - winIdx * arc - arc/2;

      // How many radians to rotate forward from current position
      let diff = ((neededRot - fortuneRotation) % (2*Math.PI) + 2*Math.PI) % (2*Math.PI);
      if(diff < 0.3) diff += 2 * Math.PI; // at least one full segment

      const totalRotation = fortuneRotation + 5 * 2 * Math.PI + diff;
      const steps = 120, duration = 4500;
      let step = 0;
      const startRot = fortuneRotation;

      const anim = setInterval(() => {
        step++;
        const progress = step / steps;
        const ease = 1 - Math.pow(1 - progress, 4);
        const current = startRot + (totalRotation - startRot) * ease;
        drawFortuneWheel(current);
        if(step >= steps) {
          clearInterval(anim);
          // Store exact final angle for next spin
          fortuneRotation = ((neededRot % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
          drawFortuneWheel(fortuneRotation);

          const won = FORTUNE_SEGMENTS[winIdx];
          const win = Math.floor(b * won.mult);
          document.getElementById('fortuneResult').innerHTML =
            `<span style="color:${win>0?'var(--green)':'var(--red)'}">${won.label} ‚Üí ${win > 0 ? '+'+formatNumber(win)+' ‚Ç¥' : '0 ‚Ç¥'}</span>`;
          if(win > 0) {
            db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
            playSound(won.mult >= 10 ? 'bonus' : 'win');
            if(won.mult >= 10) notify('üéâ –í–ï–õ–ò–ö–ò–ô –í–ò–ì–†–ê–®: +'+formatNumber(win)+' ‚Ç¥!', 'success');
            else notify('üé° '+won.label+': +'+formatNumber(win)+' ‚Ç¥', 'success');
            addToHistory('Fortune '+won.label+': +'+win);
            if(win >= 500) addToWinFeed('Fortune', win, won.mult);
          } else {
            playSound('loss');
            addToHistory('Fortune '+won.label+': -'+b);
          }
          fortuneSpinning = false;
          document.getElementById('fortuneBtn').disabled = false;
        }
      }, duration/steps);
    }

    // ============================================
    // –ß–ê–¢ –õ–û–ë–Ü (moved to home tab, new version below)
    // ============================================
    let chatListener = null;

    // ============================================
    // ===== HOME SUB-TABS =====
    // ============================================
    let homeTabInited = { chat: false, news: false };

    function initHomeTab() {
      startWinTicker();
      if(!chatListener) initLobbyChat();
    }

    function switchHomeTab(tab, el) {
      document.querySelectorAll('.home-tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.home-panel').forEach(p => p.classList.remove('active'));
      if(el) el.classList.add('active');
      const panel = document.getElementById('hp-' + tab);
      if(panel) panel.classList.add('active');

      if(tab === 'chat') {
        if(!chatListener) initLobbyChat();
        const badge = document.getElementById('chatNewBadge');
        if(badge) badge.classList.add('hidden');
        setTimeout(() => {
          const box = document.getElementById('lobbyChatBox');
          if(box) box.scrollTop = box.scrollHeight;
        }, 100);
      }
      if(tab === 'news') {
        if(!homeTabInited.news) { loadNews(); homeTabInited.news = true; }
        const badge = document.getElementById('newsNewBadge');
        if(badge) badge.classList.add('hidden');
      }
    }

    function appendChatEmoji(emoji) {
      const inp = document.getElementById('lobbyChatInput');
      if(inp) { inp.value += emoji; inp.focus(); }
    }

    // ===== WIN TICKER =====
    const TICKER_GAMES = ['Slots','Blackjack','Crash','Roulette','Mines','Poker','Plinko','Keno','Fortune'];
    const TICKER_NAMES = ['Lucky_77','ProGamer','MaxWin','CashKing','SlotMaster','VegasPro','UkrChamp','BonusHunter'];
    let tickerIdx = 0;
    let tickerItems = [];

    function startWinTicker() {
      const el = document.getElementById('winTicker');
      if(!el) return;
      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏–º–æ —Ä–µ–∞–ª—å–Ω—ñ –≤–∏–≥—Ä–∞—à—ñ + –¥–æ–¥–∞–º–æ —Ñ–µ–π–∫–æ–≤—ñ –º—ñ–∂ –Ω–∏–º–∏
      db.ref('win_feed').limitToLast(20).once('value', snap => {
        const real = snap.val() ? Object.values(snap.val()) : [];
        const fake = Array.from({length:10}, () => ({
          user: TICKER_NAMES[Math.floor(Math.random()*TICKER_NAMES.length)],
          game: TICKER_GAMES[Math.floor(Math.random()*TICKER_GAMES.length)],
          amount: (Math.floor(Math.random()*200)+2)*50,
          mult: (Math.random()*15+1.5).toFixed(1)
        }));
        tickerItems = [...real.map(r => ({ user:r.user, game:r.game, amount:r.amount, mult:r.mult })), ...fake];
        tickerItems.sort(() => Math.random()-0.5);
        animateTicker();
      });
    }

    function animateTicker() {
      const el = document.getElementById('winTicker');
      if(!el || !tickerItems.length) return;
      const item = tickerItems[tickerIdx % tickerItems.length];
      tickerIdx++;
      const emojis = { Slots:'üé∞', Blackjack:'üÉè', Crash:'üöÄ', Roulette:'üé°', Mines:'üí£', Poker:'‚ô†Ô∏è', Plinko:'üîª', Keno:'üî¢', Fortune:'üé°' };
      el.textContent = (emojis[item.game]||'üéÆ') + ' ' + item.user + ' –≤–∏–≥—Ä–∞–≤ ' + formatNumber(item.amount) + '‚Ç¥ √ó ' + item.mult + ' —É ' + item.game;
      el.style.opacity = '0';
      el.style.transition = 'opacity 0.5s';
      setTimeout(() => { el.style.opacity = '1'; }, 50);
      setTimeout(animateTicker, 4000);
    }

    // ============================================
    // ===== –ü–û–ö–†–ê–©–ï–ù–ò–ô –ß–ê–¢ =====
    // ============================================
    // Override initLobbyChat completely
    function initLobbyChat() {
      const box = document.getElementById('lobbyChatBox');
      if(!box || chatListener) return;
      box.innerHTML = '';
      chatListener = db.ref('lobby_chat').limitToLast(60).on('child_added', snap => {
        const m = snap.val();
        if(!m) return;
        const time = new Date(m.time).toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit'});
        const el = document.createElement('div');
        const isMe = m.sender === currentUser;
        const isAdmin = m.isAdmin;
        if(m.system) {
          el.style.cssText = 'color:#555;font-size:11px;text-align:center;padding:6px 0;';
          el.textContent = m.text;
        } else {
          el.className = 'chat-msg' + (isMe ? ' mine' : '') + (isAdmin ? ' admin-msg' : '');
          const nickColor = isMe ? 'var(--accent)' : (isAdmin ? '#ff6b6b' : '#4a9eff');
          const av = m.avatarEmoji || 'üë§';
          const avHtml = m.avatarUrl
            ? '<div class="chat-avatar-sm"><img src="' + m.avatarUrl + '" onerror="this.parentElement.textContent=\'üë§\'"></div>'
            : '<div class="chat-avatar-sm">' + av + '</div>';
          const adminTag = isAdmin ? '<span style="background:#ff4444;color:#fff;font-size:8px;padding:1px 5px;border-radius:6px;margin-left:3px;">ADMIN</span>' : '';
          const botTag = '';  // bots look like regular players
          const msgKey = snap.key;
          const isAdminUser = (currentUser.toLowerCase()==='theivankoo' || (userData && userData.isAdmin===true));
          const delBtn = isAdminUser ? '<button onclick="adminDeleteMsg(\'' + msgKey + '\')" style="background:none;border:none;color:#ff3b30;font-size:11px;cursor:pointer;padding:0 3px;opacity:0.5;" title="–í–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>' : '';
          el.innerHTML =
            '<div class="chat-header-line">' + avHtml +
              '<span class="chat-nick" style="color:' + nickColor + '" onclick="openPublicProfile(\'' + m.sender + '\')">' + m.sender + '</span>' +
              adminTag + botTag +
              '<span class="chat-time" style="margin-left:auto;">' + time + '</span>' +
              delBtn +
            '</div>' +
            '<div class="chat-body-text">' + escapeHtml(m.text) + '</div>';
        }
        box.appendChild(el);
        box.scrollTop = box.scrollHeight;

        // –Ø–∫—â–æ —á–∞—Ç –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ badge
        const htbChat = document.getElementById('htb-chat');
        if(htbChat && !htbChat.classList.contains('active') && !m.system) {
          const badge = document.getElementById('chatNewBadge');
          if(badge) badge.classList.remove('hidden');
        }
      });

      db.ref('announcement').on('value', snap => {
        const txt = snap.val();
        const banner = document.getElementById('announceBanner');
        if(banner) {
          if(txt) { banner.textContent = 'üì¢ ' + txt; banner.classList.remove('hidden'); }
          else { banner.classList.add('hidden'); }
        }
      });

      db.ref('online').on('value', snap => {
        const data = snap.val() || {};
        const users = Object.keys(data);
        window._onlineUsers = users;
        const el = document.getElementById('onlineCount');
        if(el) el.textContent = users.length;
      });
      db.ref('online/'+currentUser).set(true);
      db.ref('online/'+currentUser).onDisconnect().remove();
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function sendLobbyMsg() {
      const input = document.getElementById('lobbyChatInput');
      const txt = input.value.trim();
      if(!txt || txt.length > 200) return;
      if(userData.muted) return notify('–í–∞—Å –∑–∞–º—É—Ç–æ–≤–∞–Ω–æ –≤ —á–∞—Ç—ñ', 'error');
      const isAdmin = (currentUser.toLowerCase()==='theivankoo' || userData.isAdmin===true);
      db.ref('lobby_chat').push({
        sender: currentUser,
        text: txt,
        time: Date.now(),
        isAdmin,
        avatarEmoji: typeof userData.avatar === 'string' && userData.avatar.length <= 4 ? userData.avatar : 'üë§',
        avatarUrl: typeof userData.avatar === 'string' && userData.avatar.length > 10 ? userData.avatar : null,
      });
      input.value = '';
    }

    // ============================================
    // ===== –ù–û–í–ò–ù–ò =====
    // ============================================
    const NEWS_REACTIONS = ['‚ù§Ô∏è','üî•','üëè','üòÆ','üòÇ','üíé'];

    function loadNews() {
      const container = document.getElementById('newsListContainer');
      if(!container) return;
      container.innerHTML = '<div style="text-align:center;color:#555;padding:30px 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      db.ref('casino_news').orderByChild('time').limitToLast(20).once('value', snap => {
        const data = snap.val();
        if(!data) {
          container.innerHTML = '<div style="text-align:center;color:#555;padding:30px 0;font-size:13px;">–ù–æ–≤–∏–Ω —â–µ –Ω–µ–º–∞—î.<br>–°–ª—ñ–¥–∫—É–π –∑–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏!</div>';
          return;
        }
        const items = Object.entries(data).map(([id,n])=>({id,...n})).reverse();
        container.innerHTML = '';
        items.forEach(n => container.appendChild(buildNewsCard(n)));
      });
    }

    function buildNewsCard(n) {
      const card = document.createElement('div');
      card.className = 'news-card';
      card.id = 'news-' + n.id;
      const t = timeAgo(n.time);
      const catColors = { news:'#4a9eff', update:'#4cd964', event:'#d4af37', promo:'#ff6b6b', warn:'#ff9f0a' };
      const catColor = catColors[n.category] || '#777';

      // Reactions
      const myReactions = n.myReaction ? [n.myReaction] : [];
      const reactionHtml = NEWS_REACTIONS.map(r => {
        const cnt = n.reactions && n.reactions[r] ? n.reactions[r] : 0;
        const reacted = myReactions.includes(r);
        return '<div class="reaction-btn ' + (reacted?'reacted':'') + '" onclick="reactNews(\'' + n.id + '\',\'' + r + '\',this)">' +
          r + '<span class="reaction-count">' + (cnt||'') + '</span></div>';
      }).join('');

      const avHtml = n.authorAvatarUrl
        ? '<div class="news-avatar"><img src="' + n.authorAvatarUrl + '"></div>'
        : '<div class="news-avatar">' + (n.authorEmoji||'üë§') + '</div>';

      card.innerHTML =
        '<div class="news-header">' +
          '<div class="news-author">' +
            avHtml +
            '<div>' +
              '<div class="news-name">' + (n.author||'–ê–¥–º—ñ–Ω') + ' <span class="news-admin-badge">ADMIN</span></div>' +
              '<div class="news-time">' + t + ' ¬∑ <span style="color:' + catColor + ';font-size:10px;">' + (n.emoji||'üì¢') + ' ' + n.category + '</span></div>' +
            '</div>' +
          '</div>' +
          '<div class="news-title">' + escapeHtml(n.title) + '</div>' +
          '<div class="news-body">' + escapeHtml(n.body) + '</div>' +
        '</div>' +
        '<div class="news-reactions" id="reactions-' + n.id + '">' + reactionHtml + '</div>' +
        '<div class="news-comments-toggle" onclick="toggleComments(\'' + n.id + '\')">' +
          'üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ <span id="cmtcount-' + n.id + '">' + (n.commentCount||0) + '</span>' +
        '</div>' +
        '<div class="news-comments-box" id="cmtbox-' + n.id + '">' +
          '<div id="cmtlist-' + n.id + '"></div>' +
          '<div class="comment-input-row">' +
            '<input id="cmtinput-' + n.id + '" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä..." style="margin:0;flex:1;padding:10px;" maxlength="200" onkeypress="if(event.key===\'Enter\')submitComment(\'' + n.id + '\')">' +
            '<button class="btn-gold" style="width:auto;padding:10px 14px;margin:0;" onclick="submitComment(\'' + n.id + '\')">‚û§</button>' +
          '</div>' +
        '</div>';

      return card;
    }

    function reactNews(newsId, reaction, el) {
      db.ref('casino_news/' + newsId + '/reactions/' + reaction).transaction(v => (v||0) + 1);
      // Track user reaction locally
      const container = document.getElementById('reactions-' + newsId);
      if(container) {
        container.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('reacted'));
        el.classList.toggle('reacted');
        const countEl = el.querySelector('.reaction-count');
        if(countEl) {
          const cur = parseInt(countEl.textContent) || 0;
          countEl.textContent = cur + 1;
        }
      }
    }

    function toggleComments(newsId) {
      const box = document.getElementById('cmtbox-' + newsId);
      if(!box) return;
      const isOpen = box.classList.contains('open');
      box.classList.toggle('open', !isOpen);
      if(!isOpen) loadComments(newsId);
    }

    function loadComments(newsId) {
      const list = document.getElementById('cmtlist-' + newsId);
      if(!list) return;
      list.innerHTML = '<div style="color:#555;font-size:12px;padding:5px 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      db.ref('casino_news/' + newsId + '/comments').orderByChild('time').limitToLast(30).once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#555;font-size:12px;padding:8px 0;">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î. –ë—É–¥—å –ø–µ—Ä—à–∏–º!</div>'; return; }
        list.innerHTML = '';
        Object.values(data).forEach(c => {
          const t = timeAgo(c.time);
          const avHtml = c.avatarUrl
            ? '<div class="comment-avatar"><img src="' + c.avatarUrl + '"></div>'
            : '<div class="comment-avatar">' + (c.avatarEmoji||'üë§') + '</div>';
          const div = document.createElement('div');
          div.className = 'comment-item';
          div.innerHTML = avHtml +
            '<div>' +
              '<span class="comment-nick" onclick="openPublicProfile(\'' + c.author + '\')">' + c.author + '</span>' +
              '<div class="comment-text">' + escapeHtml(c.text) + '</div>' +
              '<div class="comment-time">' + t + '</div>' +
            '</div>';
          list.appendChild(div);
        });
      });
    }

    function submitComment(newsId) {
      const inp = document.getElementById('cmtinput-' + newsId);
      const txt = inp ? inp.value.trim() : '';
      if(!txt || txt.length > 200) return;
      const isAdmin = (currentUser.toLowerCase()==='theivankoo' || userData.isAdmin===true);
      const av = typeof userData.avatar === 'string';
      const comment = {
        author: currentUser,
        text: txt,
        time: Date.now(),
        avatarEmoji: av && userData.avatar.length <= 4 ? userData.avatar : 'üë§',
        avatarUrl: av && userData.avatar.length > 10 ? userData.avatar : null,
        isAdmin,
      };
      db.ref('casino_news/' + newsId + '/comments').push(comment);
      db.ref('casino_news/' + newsId + '/commentCount').transaction(v => (v||0)+1);
      inp.value = '';
      // –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
      setTimeout(() => loadComments(newsId), 500);
      // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫
      const cnt = document.getElementById('cmtcount-' + newsId);
      if(cnt) cnt.textContent = parseInt(cnt.textContent||0)+1;
      notify('üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ–¥–∞–Ω–æ!', 'success');
    }

    // ===== ADMIN: –ü–£–ë–õ–Ü–ö–ê–¶–Ü–Ø –ù–û–í–ò–ù =====
    function publishNews() {
      const title    = document.getElementById('newsTitle').value.trim();
      const body     = document.getElementById('newsBody').value.trim();
      const emoji    = document.getElementById('newsEmoji').value.trim() || 'üì¢';
      const category = document.getElementById('newsCategory').value;
      if(!title || !body) return notify('–í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ç–µ–∫—Å—Ç –Ω–æ–≤–∏–Ω–∏', 'error');

      const av = typeof userData.avatar === 'string';
      db.ref('casino_news').push({
        title, body, emoji, category,
        author: currentUser,
        authorEmoji: av && userData.avatar.length <= 4 ? userData.avatar : 'üë§',
        authorAvatarUrl: av && userData.avatar.length > 10 ? userData.avatar : null,
        time: Date.now(),
        reactions: {},
        commentCount: 0,
      });
      document.getElementById('newsTitle').value = '';
      document.getElementById('newsBody').value = '';
      notify('üì∞ –ù–æ–≤–∏–Ω—É –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!', 'success');
      homeTabInited.news = false; // Reset so it reloads

      // –ü–æ–∫–∞–∑–∞—Ç–∏ badge –Ω–∞ news –≤–∫–ª–∞–¥—Ü—ñ
      const badge = document.getElementById('newsNewBadge');
      if(badge) badge.classList.remove('hidden');
    }

    function loadAdminNews() {
      const list = document.getElementById('adminNewsList');
      if(!list) return;
      db.ref('casino_news').orderByChild('author').equalTo(currentUser).limitToLast(10).once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#555;font-size:12px;padding:8px;">–ù–æ–≤–∏–Ω –Ω–µ–º–∞—î</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).reverse().forEach(([id,n]) => {
          const div = document.createElement('div');
          div.style.cssText = 'padding:8px;background:#111;border-radius:8px;margin-bottom:5px;border:1px solid #222;';
          div.innerHTML =
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<div style="font-size:13px;font-weight:bold;">' + (n.emoji||'üì¢') + ' ' + n.title + '</div>' +
              '<button onclick="deleteNews(\'' + id + '\')" style="background:var(--red);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">üóëÔ∏è</button>' +
            '</div>' +
            '<div style="font-size:11px;color:#555;margin-top:3px;">' + timeAgo(n.time) + ' ¬∑ üí¨' + (n.commentCount||0) + '</div>';
          list.appendChild(div);
        });
      });
    }

    function deleteNews(id) {
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ–≤–∏–Ω—É?')) return;
      db.ref('casino_news/' + id).remove();
      notify('üóëÔ∏è –ù–æ–≤–∏–Ω—É –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
      loadAdminNews();
    }

    // ============================================
    // ===== –ë–û–¢–ò =====
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('botAvatar');
      if(sel) sel.addEventListener('change', function() {
        const urlBox = document.getElementById('botAvatarUrlBox');
        if(urlBox) urlBox.classList.toggle('hidden', this.value !== 'custom');
      });
    });

    function createBot() {
      const nick    = document.getElementById('botNick').value.trim();
      const balance = parseInt(document.getElementById('botBalance').value) || 5000;
      const avSel   = document.getElementById('botAvatar').value;
      const avUrl   = document.getElementById('botAvatarUrl') ? document.getElementById('botAvatarUrl').value.trim() : '';
      const activity= document.getElementById('botActivity').value;

      if(!nick || nick.length < 2) return notify('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫ –±–æ—Ç–∞ (–º—ñ–Ω. 2 —Å–∏–º–≤–æ–ª–∏)', 'error');
      if(!/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å—ñ–Ü—ó–á—î–Ñ0-9_]+$/.test(nick)) return notify('–ù—ñ–∫ –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ª–∏—à–µ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ _', 'error');

      const avatarEmoji = avSel === 'custom' ? 'üë§' : avSel;
      const avatarUrl   = avSel === 'custom' ? avUrl : null;

      // –°—Ç–≤–æ—Ä—é—î–º–æ —é–∑–µ—Ä–∞-–±–æ—Ç–∞ –≤ Firebase
      db.ref('users/' + nick).set({
        balance, tag: '', isBot: true, isActive: activity === 'active',
        createdBy: currentUser, createdAt: Date.now(),
        regDate: Date.now(), dailyStreak: 0, id: 'BOT_' + Date.now(),
        avatar: avatarUrl || avatarEmoji,
        stats: { gamesPlayed: Math.floor(Math.random()*500)+50, biggestWin: Math.floor(Math.random()*5000)+500 },
        totalWagered: Math.floor(Math.random()*50000)+1000,
      });

      // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏–π ‚Äî –∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç
      if(activity === 'active') scheduleBotMessages(nick, avatarEmoji, avatarUrl);

      notify('ü§ñ –ë–æ—Ç ' + nick + ' —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
      document.getElementById('botNick').value = '';
      loadBots();
    }

    const BOT_MESSAGES = [
      '–¢—ñ–ª—å–∫–∏ —â–æ –∑—Ä–æ–±–∏–≤ x{{mult}} –Ω–∞ —Å–ª–æ—Ç–∞—Ö! üé∞', '–•—Ç–æ –≥—Ä–∞—î –≤ –∫—Ä–∞—à? üöÄ',
      '–£–¥–∞—á–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –Ω–∞ –º–æ—î–º—É –±–æ—Ü—ñ! üí∞', '–°—Ç–∞–≤–ª—é 500 –Ω–∞ —á–æ—Ä–Ω–µ üé°',
      '–û–≥–æ, –≤–∏–≥—Ä–∞–≤ {{amount}}‚Ç¥! ü§ë', '–•—Ç–æ —â–µ –≤ –æ–Ω–ª–∞–π–Ω—ñ?',
      '–ú–æ–Ω–æ–ø–æ–ª—ñ—è ‚Äî –Ω–∞–π–∫—Ä–∞—â–∞ –≥—Ä–∞! üé©', '–ñ–∞–ª—å, –ø—Ä–æ–≥—Ä–∞–≤... —Å–ø—Ä–æ–±—É—é —â–µ —Ä–∞–∑',
      '–ë–ª–µ–∫–¥–∂–µ–∫ –¥–∞–≤ –º–µ–Ω—ñ 21! üÉè', '–ö—Ä–∞—à –∑–ª–µ—Ç—ñ–≤ –¥–æ x{{mult}}!',
    ];

    function scheduleBotMessages(nick, avatarEmoji, avatarUrl) {
      // –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ—Ç—è–≥–æ–º 10 —Ö–≤–∏–ª–∏–Ω
      for(let i = 0; i < 3; i++) {
        setTimeout(() => {
          const tpl = BOT_MESSAGES[Math.floor(Math.random()*BOT_MESSAGES.length)];
          const msg = tpl
            .replace('{{mult}}', (Math.random()*10+1.5).toFixed(1))
            .replace('{{amount}}', formatNumber((Math.floor(Math.random()*100)+5)*100));
          db.ref('lobby_chat').push({
            sender: nick, text: msg, time: Date.now(),
            isBot: true, avatarEmoji, avatarUrl,
          });
        }, (i+1) * (Math.random()*60000 + 30000)); // 30-90 —Å–µ–∫ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏
      }
    }

    function loadBots() {
      const list = document.getElementById('botList');
      if(!list) return;
      list.innerHTML = '<div style="color:#555;font-size:12px;padding:8px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      db.ref('users').orderByChild('isBot').equalTo(true).once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#555;font-size:12px;padding:8px;">–ë–æ—Ç—ñ–≤ –Ω–µ–º–∞—î</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([nick, b]) => {
          const av = typeof b.avatar === 'string' && b.avatar.length > 4
            ? '<img src="' + b.avatar + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">'
            : (b.avatar||'üë§');
          const div = document.createElement('div');
          div.className = 'bot-card';
          div.innerHTML =
            '<div class="bot-avatar">' + av + '</div>' +
            '<div style="flex:1;">' +
              '<div style="font-weight:bold;font-size:14px;">' + nick + '</div>' +
              '<div style="font-size:11px;color:#777;">–ë–∞–ª–∞–Ω—Å: ' + formatNumber(b.balance) + '‚Ç¥</div>' +
            '</div>' +
            '<span class="bot-status ' + (b.isActive?'active':'inactive') + '">' + (b.isActive?'üü¢ –ê–∫—Ç–∏–≤–Ω–∏–π':'‚ö´ –ü–∞—Å–∏–≤–Ω–∏–π') + '</span>' +
            '<button onclick="deleteBot(\'' + nick + '\')" style="background:var(--red);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;margin-left:6px;">‚úï</button>';
          list.appendChild(div);
        });
      });
    }

    function deleteBot(nick) {
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –±–æ—Ç–∞ ' + nick + '?')) return;
      db.ref('users/' + nick).remove();
      notify('üóëÔ∏è –ë–æ—Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
      loadBots();
    }

    // ===== ONLINE USERS POPUP =====
    function showOnlineUsers() {
      const dropdown = document.getElementById('onlineUsersDropdown');
      const listEl = document.getElementById('onlineUsersList');
      if(!dropdown || !listEl) return;

      const isOpen = !dropdown.classList.contains('hidden');
      if(isOpen) { dropdown.classList.add('hidden'); return; }

      dropdown.classList.remove('hidden');
      listEl.innerHTML = '<div style="color:#555;font-size:12px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

      const users = window._onlineUsers || [];
      if(!users.length) { listEl.innerHTML = '<div style="color:#555;font-size:12px;">–ù–µ–º–∞—î –æ–Ω–ª–∞–π–Ω</div>'; return; }

      // Fetch avatars for online users
      listEl.innerHTML = '';
      let loaded = 0;
      users.slice(0, 30).forEach(name => {
        db.ref('users/' + name + '/avatar').once('value', snap => {
          const av = snap.val();
          const avHtml = av && av.length > 4
            ? '<img src="' + av + '" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">'
            : (av || 'üë§');
          const pill = document.createElement('div');
          pill.style.cssText = 'display:flex;align-items:center;gap:6px;background:var(--box);border:1px solid var(--border);border-radius:20px;padding:4px 10px 4px 4px;cursor:pointer;';
          pill.onclick = () => { dropdown.classList.add('hidden'); openPublicProfile(name); };
          pill.innerHTML =
            '<div style="width:28px;height:28px;border-radius:50%;background:#222;display:flex;align-items:center;justify-content:center;font-size:14px;overflow:hidden;flex-shrink:0;">' + avHtml + '</div>' +
            '<span style="font-size:12px;font-weight:bold;' + (name===currentUser?'color:var(--accent);':'') + '">' + name + (name===currentUser?' (—è)':'') + '</span>' +
            '<span style="width:6px;height:6px;background:var(--green);border-radius:50%;flex-shrink:0;"></span>';
          listEl.appendChild(pill);
        });
      });
    }

    // Close online dropdown on outside click
    document.addEventListener('click', e => {
      const dropdown = document.getElementById('onlineUsersDropdown');
      const pill = e.target.closest('.online-pill');
      if(dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(e.target) && !pill) {
        dropdown.classList.add('hidden');
      }
    });

    // ===== WIN FEED –¥–ª—è —Ç—ñ–∫–µ—Ä–∞ =====
    function addToWinFeed(game, amount, mult) {
      if(amount < 500) return; // –¢—ñ–ª—å–∫–∏ –≤–µ–ª–∏–∫—ñ –≤–∏–≥—Ä–∞—à—ñ
      db.ref('win_feed').push({
        user: currentUser, game, amount, mult: mult||1,
        time: Date.now()
      });
      // –ß–∏—Å—Ç–∏–º–æ —Å—Ç–∞—Ä—ñ
      db.ref('win_feed').orderByChild('time').limitToFirst(1).once('value', snap => {
        const data = snap.val();
        if(!data) return;
        const count = Object.keys(data).length;
        if(count > 50) Object.keys(data).forEach(k => db.ref('win_feed/' + k).remove());
      });
    }



    // ============================================
    // –ü–£–ë–õ–Ü–ß–ù–ò–ô –ü–†–û–§–Ü–õ–¨
    // ============================================
    function openPublicProfile(name) {
      if(name === currentUser) return switchTab('profile');
      db.ref('users/'+name).once('value', snap => {
        const d = snap.val();
        if(!d) return notify('–ì—Ä–∞–≤—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        const av = d.avatar && d.avatar.length > 20 ? `<img src="${d.avatar}">` : 'üë§';
        const badges = computeBadges(d);
        document.getElementById('pubProfileContent').innerHTML = `
          <div class="pub-profile">
            <div class="profile-header">
              <div class="avatar-large">${av}</div>
              <div>
                <div style="font-size:22px;font-weight:bold;">${name}</div>
                <div style="color:#777;font-size:13px;">${d.tag||'–ì—Ä–∞–≤–µ—Ü—å'}</div>
              </div>
            </div>
            <div style="color:#555;font-size:12px;margin-bottom:10px;">ID: ${d.id||'‚Äî'} ‚Ä¢ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: ${d.regDate ? new Date(d.regDate).toLocaleDateString('uk-UA') : '–ù–µ–≤—ñ–¥–æ–º–æ'}</div>
            <div class="pub-stats-grid">
              <div class="pub-stat"><div class="pub-stat-val">${formatNumber(d.balance)}</div><div class="pub-stat-label">‚Ç¥ –ë–∞–ª–∞–Ω—Å</div></div>
              <div class="pub-stat"><div class="pub-stat-val">${d.dailyStreak||0}</div><div class="pub-stat-label">üî• –°–µ—Ä—ñ—è</div></div>
              <div class="pub-stat"><div class="pub-stat-val">${d.stats?.gamesPlayed||0}</div><div class="pub-stat-label">–Ü–≥–æ—Ä –∑—ñ–≥—Ä–∞–Ω–æ</div></div>
              <div class="pub-stat"><div class="pub-stat-val">${d.stats?.biggestWin ? formatNumber(d.stats.biggestWin) : '0'}</div><div class="pub-stat-label">üèÜ –ù–∞–π–±. –≤–∏–≥—Ä–∞—à</div></div>
            </div>
            <div class="pub-badges">${badges}</div>
            <div style="display:flex;gap:8px;margin-top:15px;">
              <button class="btn-outline" style="flex:1;" onclick="document.getElementById('transferTo').value='${name}';openModal('transfer-modal');">üí∏ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
              <button class="btn-outline" style="flex:1;" onclick="addContactByName('${name}')">ü§ù –í –∑–Ω–∞–π–æ–º—ñ</button>
            </div>
          </div>`;
        openModal('pub-profile-modal');
      });
    }

    function computeBadges(d) {
      let badges = '';
      if(d.balance >= 100000) badges += `<span class="badge gold">üí∞ –ú—ñ–ª—å–π–æ–Ω–µ—Ä</span>`;
      if(d.dailyStreak >= 7) badges += `<span class="badge gold">üî• –°–µ—Ä—ñ—è 7+</span>`;
      if(d.stats?.gamesPlayed >= 100) badges += `<span class="badge">üéÆ –í–µ—Ç–µ—Ä–∞–Ω</span>`;
      if(d.isAdmin) badges += `<span class="badge gold">‚öôÔ∏è –ê–¥–º—ñ–Ω</span>`;
      if(d.stats?.biggestWin >= 10000) badges += `<span class="badge gold">üèÜ –í–µ–ª–∏–∫–∏–π –≤–∏–≥—Ä–∞—à</span>`;
      if(d.referrals >= 5) badges += `<span class="badge">üë• –†–µ–∫—Ä—É—Ç–µ—Ä</span>`;
      return badges || `<span class="badge">üÜï –ù–æ–≤–∞—á–æ–∫</span>`;
    }

    function addContactByName(name) {
      db.ref('users/'+currentUser+'/contacts/'+name).set({avatar:'üë§'});
      notify('–î–æ–¥–∞–Ω–æ —É –∑–Ω–∞–π–æ–º—ñ!', 'success');
    }

    // ============================================
    // –î–£–ï–õ–Ü
    // ============================================
    let activeDuelId = null;

    function createDuel() {
      const target = document.getElementById('duelTarget').value.trim();
      const amount = parseInt(document.getElementById('duelAmount').value);
      if(!target || target === currentUser) return notify('–ù–µ–≤—ñ—Ä–Ω–∏–π —Å—É–ø–µ—Ä–Ω–∏–∫', 'error');
      if(!amount || amount < 50) return notify('–ú—ñ–Ω. —Å—Ç–∞–≤–∫–∞ 50‚Ç¥', 'error');
      if(userData.balance < amount) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/'+target).once('value', snap => {
        if(!snap.exists()) return notify('–ì—Ä–∞–≤—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        const duelId = currentUser + '_' + Date.now();
        db.ref('users/'+currentUser).update({balance: userData.balance - amount});
        db.ref('duels/'+duelId).set({
          challenger: currentUser, target, amount, status: 'pending', time: Date.now()
        });
        notify(`‚öîÔ∏è –í–∏–∫–ª–∏–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ ${target}!`, 'success');
        document.getElementById('duelTarget').value = '';
        document.getElementById('duelAmount').value = '';
      });
    }

    function loadDuels() {
      // –ê–∫—Ç–∏–≤–Ω—ñ –¥—É–µ–ª—ñ
      db.ref('duels').orderByChild('status').equalTo('pending').limitToLast(10).once('value', snap => {
        const data = snap.val();
        const list = document.getElementById('duelsList');
        if(!data) { list.innerHTML = '<div style="color:#777;font-size:13px;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –¥—É–µ–ª–µ–π</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, d]) => {
          const isTarget = d.target === currentUser;
          const isChallenger = d.challenger === currentUser;
          list.innerHTML += `<div class="duel-card">
            <div class="duel-players">
              <div><div style="font-weight:bold;color:var(--accent);">${d.challenger}</div><div style="font-size:11px;color:#777;">Challenger</div></div>
              <div class="duel-vs">VS</div>
              <div><div style="font-weight:bold;color:#4a9eff;">${d.target}</div><div style="font-size:11px;color:#777;">Target</div></div>
            </div>
            <div style="text-align:center;margin-top:8px;">
              <span style="color:var(--accent);font-weight:bold;">${d.amount} ‚Ç¥</span>
              ${isTarget ? `<button class="btn-green" style="padding:6px 12px;width:auto;margin-left:10px;font-size:12px;" onclick="respondDuel('${id}','accept')">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="btn-red" style="padding:6px 12px;width:auto;margin-left:5px;font-size:12px;" onclick="respondDuel('${id}','decline')">‚ùå</button>` : ''}
              ${isChallenger ? `<button class="btn-outline" style="padding:6px 12px;width:auto;margin-left:10px;font-size:12px;" onclick="cancelDuel('${id}')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>` : ''}
            </div>
          </div>`;
        });
      });
    }

    function respondDuel(id, action) {
      db.ref('duels/'+id).once('value', snap => {
        const d = snap.val();
        if(!d || d.status !== 'pending') return;
        if(action === 'decline') {
          db.ref('duels/'+id).update({status:'declined'});
          db.ref('users/'+d.challenger+'/balance').set(firebase.database.ServerValue.increment(d.amount));
          notify('–î—É–µ–ª—å –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ', 'info'); loadDuels(); return;
        }
        if(userData.balance < d.amount) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');
        db.ref('users/'+currentUser).update({balance: userData.balance - d.amount});
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–µ—Ä–µ–º–æ–∂—Ü—è
        const winner = Math.random() > 0.5 ? d.challenger : d.target;
        const loser = winner === d.challenger ? d.target : d.challenger;
        const prize = Math.floor(d.amount * 1.9); // 5% –∫–æ–º—ñ—Å—ñ—è –∫–∞–∑–∏–Ω–æ
        db.ref('users/'+winner+'/balance').set(firebase.database.ServerValue.increment(prize));
        db.ref('duels/'+id).update({status:'done', winner, time_end: Date.now()});
        db.ref('lobby_chat').push({system:true, text:`‚öîÔ∏è –î—É–µ–ª—å: ${d.challenger} vs ${d.target} ‚Äî –ø–µ—Ä–µ–º—ñ–≥ ${winner}! (+${prize}‚Ç¥)`, time:Date.now()});
        notify(winner===currentUser ? `üèÜ –í–∏ –≤–∏–≥—Ä–∞–ª–∏ –¥—É–µ–ª—å! +${prize}‚Ç¥` : `üòî –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏ –¥—É–µ–ª—å`, winner===currentUser?'success':'error');
        addToHistory(`Duel vs ${loser}: ${winner===currentUser?'+'+prize:'-'+d.amount}`);
        loadDuels();
      });
    }

    function cancelDuel(id) {
      db.ref('duels/'+id).once('value', snap => {
        const d = snap.val();
        if(d && d.challenger === currentUser) {
          db.ref('duels/'+id).update({status:'cancelled'});
          db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(d.amount));
          notify('–î—É–µ–ª—å —Å–∫–∞—Å–æ–≤–∞–Ω–æ', 'info'); loadDuels();
        }
      });
    }

    // ============================================
    // –¢–£–†–ù–Ü–†–ò
    // ============================================
    function loadTournaments() {
      db.ref('tournaments').once('value', snap => {
        const data = snap.val();
        const list = document.getElementById('tournamentsList');
        if(!data) { list.innerHTML = '<div style="color:#777;padding:20px;text-align:center;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—É—Ä–Ω—ñ—Ä—ñ–≤</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, t]) => {
          const endTime = t.startTime + t.duration * 3600000;
          const msLeft = endTime - Date.now();
          const hoursLeft = Math.max(0, Math.floor(msLeft / 3600000));
          const minsLeft = Math.max(0, Math.floor((msLeft % 3600000) / 60000));
          const isActive = msLeft > 0;
          list.innerHTML += `<div class="tournament-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:16px;font-weight:bold;">${t.name}</div>
              <span style="font-size:11px;background:${isActive?'rgba(76,217,100,0.2)':'rgba(255,59,48,0.2)'};color:${isActive?'var(--green)':'var(--red)'};padding:3px 8px;border-radius:10px;">${isActive?'üü¢ –ê–∫—Ç–∏–≤–Ω–∏–π':'üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–æ'}</span>
            </div>
            <div class="t-prize">üèÜ ${formatNumber(t.prize)} ‚Ç¥</div>
            <div class="t-info">${isActive ? `–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ ${hoursLeft}–≥–æ–¥ ${minsLeft}—Ö–≤` : '–¢—É—Ä–Ω—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ'}</div>
            <div class="t-leaderboard" id="t-lb-${id}">
              <div style="color:#555;font-size:12px;margin-top:8px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É...</div>
            </div>
            ${isActive ? `<button class="btn-gold" style="margin-top:10px;padding:10px;" onclick="joinTournament('${id}','${t.name}',${t.prize})">üéØ –í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å</button>` : ''}
          </div>`;
          loadTournamentLeaderboard(id);
        });
      });
    }

    function loadTournamentLeaderboard(tId) {
      db.ref('tournament_scores/'+tId).orderByValue().limitToLast(5).once('value', snap => {
        const el = document.getElementById('t-lb-'+tId);
        if(!el) return;
        const data = snap.val();
        if(!data) { el.innerHTML = '<div style="color:#555;font-size:12px;margin-top:8px;">–©–µ –Ω–µ–º–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤</div>'; return; }
        const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
        el.innerHTML = sorted.map(([name, score], i) =>
          `<div class="t-row"><span>${['ü•á','ü•à','ü•â','4.','5.'][i]} ${name}</span><span style="color:var(--accent);">${formatNumber(score)} ‚Ç¥</span></div>`
        ).join('');
      });
    }

    function joinTournament(id, name, prize) {
      db.ref('tournament_scores/'+id+'/'+currentUser).once('value', snap => {
        if(!snap.exists()) {
          db.ref('tournament_scores/'+id+'/'+currentUser).set(0);
          notify(`üèÜ –í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ —Ç—É—Ä–Ω—ñ—Ä—É "${name}"!`, 'success');
        } else {
          notify(`–í–∏ –≤–∂–µ –±–µ—Ä–µ—Ç–µ—Å—å —É —Ç—É—Ä–Ω—ñ—Ä—ñ "${name}"`, 'info');
        }
      });
    }

    function createTournament() {
      const name  = document.getElementById('tName').value.trim();
      const prize = parseInt(document.getElementById('tPrize').value);
      const dur   = parseInt(document.getElementById('tDuration').value);
      const icon  = document.getElementById('tIcon')?.value || 'üèÜ';
      if(!name || !prize || !dur) return notify('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è', 'error');
      const allowedGames = ['crash','slots','mines','plinko','tower','limbo','dice','hilo'];
      db.ref('tournaments').push({name, prize, duration: dur, startTime: Date.now(), createdBy: currentUser, icon, allowedGames});
      notify(`${icon} –¢—É—Ä–Ω—ñ—Ä "${name}" —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ü—Ä–∏–∑: ${formatNumber(prize)} ‚Ç¥`, 'success');
      document.getElementById('tName').value=''; document.getElementById('tPrize').value=''; document.getElementById('tDuration').value='';
    }

    // ============================================
    // –†–ï–§–ï–†–ê–õ–ò
    // ============================================
    function initReferrals() {
      const id = userData.id;
      const link = `${location.origin}${location.pathname}?ref=${id}`;
      document.getElementById('refLinkText').textContent = link;
      document.getElementById('refCount').textContent = userData.referrals || 0;
      document.getElementById('refEarned').textContent = (userData.refEarned || 0) + '‚Ç¥';

      const list = document.getElementById('refFriendsList');
      if(userData.refFriends) {
        list.innerHTML = '';
        Object.keys(userData.refFriends).forEach(name => {
          list.innerHTML += `<div class="contact-row"><b>${name}</b></div>`;
        });
      }
    }

    function copyRefLink() {
      const link = document.getElementById('refLinkText').textContent;
      navigator.clipboard.writeText(link).then(() => notify('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success'));
    }

    function checkRefParam() {
      const urlParams = new URLSearchParams(location.search);
      const ref = urlParams.get('ref');
      if(ref && currentUser) {
        localStorage.setItem('ref_by', ref);
      }
    }

    // ============================================
    // –ê–î–ú–Ü–ù: –†–û–ó–®–ò–†–ï–ù–Ü –§–£–ù–ö–¶–Ü–á
    // ============================================
    function loadAdminStats() {
      db.ref('users').once('value', snap => {
        const users = snap.val() || {};
        const total = Object.keys(users).length;
        const totalBal = Object.values(users).reduce((s,u) => s+(u.balance||0), 0);
        document.getElementById('statTotalUsers').textContent = total;
        document.getElementById('statTotalBalance').textContent = formatNumber(totalBal)+'‚Ç¥';
      });
      db.ref('duels').orderByChild('status').equalTo('pending').once('value', snap => {
        document.getElementById('statActiveDuels').textContent = snap.val() ? Object.keys(snap.val()).length : 0;
      });
      db.ref('withdraw_requests').orderByChild('status').equalTo('pending').once('value', snap => {
        document.getElementById('statPendingWithdraws').textContent = snap.val() ? Object.keys(snap.val()).length : 0;
      });
    }

    function sendAnnouncement() {
      const txt = document.getElementById('announceText').value.trim();
      if(!txt) return notify('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç', 'error');
      db.ref('announcement').set(txt);
      notify('üì¢ –û–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!', 'success');
    }

    function clearAnnouncement() {
      db.ref('announcement').remove();
      notify('–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
    }

    function createPromo() {
      const code = document.getElementById('promoCode').value.trim().toUpperCase();
      const val = parseInt(document.getElementById('promoValue').value);
      const uses = parseInt(document.getElementById('promoUses').value) || 1;
      if(!code || !val) return notify('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è', 'error');
      db.ref('promos/'+code).set({value: val, uses, createdBy: currentUser, time: Date.now()});
      notify(`üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ ${code} (${val}‚Ç¥) —Å—Ç–≤–æ—Ä–µ–Ω–æ!`, 'success');
      document.getElementById('promoCode').value=''; document.getElementById('promoValue').value=''; document.getElementById('promoUses').value='';
      loadPromos();
    }

    function loadPromos() {
      db.ref('promos').once('value', snap => {
        const data = snap.val();
        const list = document.getElementById('promoList');
        if(!data) { list.innerHTML='<div style="color:#777;font-size:13px;">–ù–µ–º–∞—î –ø—Ä–æ–º–æ–∫–æ–¥—ñ–≤</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([code, p]) => {
          list.innerHTML += `<div class="promo-row">
            <div><b style="color:var(--accent);">${code}</b> <span style="color:#777;font-size:12px;">(${p.value}‚Ç¥, ${p.uses} —Ä–∞–∑)</span></div>
            <button class="btn-red" style="width:auto;padding:6px 12px;margin:0;font-size:12px;" onclick="deletePromo('${code}')">üóëÔ∏è</button>
          </div>`;
        });
      });
    }

    function deletePromo(code) {
      db.ref('promos/'+code).remove();
      notify('–ü—Ä–æ–º–æ–∫–æ–¥ –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
      loadPromos();
    }

    function loadSupportThreads() {
      db.ref('support_chats').once('value', snap => {
        const data = snap.val();
        const list = document.getElementById('supportThreadsList');
        if(!data) { list.innerHTML='<div style="color:#777;font-size:13px;">–ù–µ–º–∞—î —á–∞—Ç—ñ–≤</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([user, msgs]) => {
          const lastMsg = Object.values(msgs).pop();
          list.innerHTML += `<div class="support-thread" onclick="openAdminSupport('${user}')">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <b>${user}</b>
              ${lastMsg.sender==='user' ? '<span class="support-unread">–ù–æ–≤–µ</span>' : ''}
            </div>
            <div style="color:#777;font-size:12px;margin-top:4px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${lastMsg.text}</div>
          </div>`;
        });
      });
    }

    let admSupportUser = null;
    function openAdminSupport(user) {
      admSupportUser = user;
      document.getElementById('admSupportTitle').textContent = '–ß–∞—Ç –∑ ' + user;
      const chat = document.getElementById('admSupportChat');
      chat.innerHTML = '';
      db.ref('support_chats/'+user).limitToLast(30).on('child_added', snap => {
        const m = snap.val();
        chat.innerHTML += `<div style="margin-bottom:8px;padding:8px 12px;background:${m.sender==='user'?'#005c4b':'#1a1a6b'};border-radius:8px;width:fit-content;max-width:80%;margin-left:${m.sender==='user'?'0':'auto'}">${m.sender==='admin'?'[–ü—ñ–¥—Ç—Ä–∏–º–∫–∞] ':''}${m.text}</div>`;
        chat.scrollTop = chat.scrollHeight;
      });
      openModal('admin-support-modal');
    }

    function sendAdminSupportReply() {
      const txt = document.getElementById('admSupportReply').value.trim();
      if(!txt || !admSupportUser) return;
      db.ref('support_chats/'+admSupportUser).push({text:txt, sender:'admin', time:Date.now()});
      document.getElementById('admSupportReply').value = '';
    }

    function loadDepositRequests() {
      const list = document.getElementById('depositRequestsList');
      list.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      db.ref('deposit_requests').orderByChild('status').equalTo('pending').once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML='<div style="color:#777;font-size:13px;padding:10px 0;">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, req]) => {
          list.innerHTML += `<div class="request-card">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <b>${req.user}</b><span style="color:var(--green);font-weight:bold;">${req.amount} ‚Ç¥</span>
            </div>
            <div style="color:#777;font-size:12px;">ID: ${req.userId} ‚Ä¢ TG –±–æ—Ç</div>
            <div style="color:#555;font-size:11px;">${new Date(req.time).toLocaleString('uk-UA')}</div>
            <div style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn-green" style="padding:8px;font-size:12px;" onclick="approveDeposit('${id}','${req.user}',${req.amount})">‚úÖ –ó–∞—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
              <button class="btn-red" style="padding:8px;font-size:12px;" onclick="rejectDeposit('${id}')">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
            </div>
          </div>`;
        });
      });
    }

    function approveDeposit(id, user, amount) {
      db.ref('users/'+user+'/balance').set(firebase.database.ServerValue.increment(amount));
      db.ref('deposit_requests/'+id).update({status:'done'});
      db.ref('users/'+user+'/history').push({text:`–î–µ–ø–æ–∑–∏—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: +${amount}‚Ç¥`, date:Date.now()});
      notify(`‚úÖ –î–µ–ø–æ–∑–∏—Ç ${amount}‚Ç¥ –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ ${user}`, 'success');
      loadDepositRequests();
    }

    function rejectDeposit(id) {
      db.ref('deposit_requests/'+id).update({status:'rejected'});
      notify('–î–µ–ø–æ–∑–∏—Ç –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ', 'info');
      loadDepositRequests();
    }

    // ============================================
    // –û–ù–û–í–õ–ï–ù–ò–ô switchTab ‚Äî —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ
    // ============================================
    // ============================================
    // ===== –ö–õ–ê–ù–ò =====
    // ============================================
    function loadClanTab() {
      const clanId = userData.clanId;
      if(clanId) {
        document.getElementById('noClanSection').classList.add('hidden');
        document.getElementById('myClanSection').classList.remove('hidden');
        loadMyClan(clanId);
      } else {
        document.getElementById('noClanSection').classList.remove('hidden');
        document.getElementById('myClanSection').classList.add('hidden');
        loadPublicClans();
      }
    }

    function createClan() {
      const name = document.getElementById('clanNameInput').value.trim().slice(0,20);
      const tag  = document.getElementById('clanTagInput').value.trim().toUpperCase().slice(0,4);
      const desc = document.getElementById('clanDescInput').value.trim().slice(0,80);
      if(!name || !tag || tag.length < 2) return notify('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —ñ —Ç–µ–≥ (2-4 –ª—ñ—Ç–µ—Ä–∏)', 'error');
      if(userData.balance < 500) return notify('–ü–æ—Ç—Ä—ñ–±–Ω–æ 500‚Ç¥ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª–∞–Ω—É', 'error');
      const clanId = currentUser + '_clan_' + Date.now();
      db.ref('users/' + currentUser).update({ balance: userData.balance - 500, clanId });
      db.ref('clans/' + clanId).set({
        name, tag, desc, leader: currentUser,
        bank: 0, members: { [currentUser]: { role: 'leader', joined: Date.now() } },
        created: Date.now(), weekWager: 0
      });
      addToHistory('–°—Ç–≤–æ—Ä–µ–Ω–æ –∫–ª–∞–Ω ' + name + ': -500‚Ç¥');
      notify('üõ°Ô∏è –ö–ª–∞–Ω [' + tag + '] ' + name + ' —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
      loadClanTab();
    }

    function loadPublicClans() {
      db.ref('clans').limitToFirst(10).once('value', snap => {
        const list = document.getElementById('clanListPublic');
        if(!list) return;
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#777;font-size:13px;padding:10px 0;text-align:center;">–ö–ª–∞–Ω—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, c]) => {
          const memberCount = c.members ? Object.keys(c.members).length : 1;
          list.innerHTML += '<div class="clan-banner member" style="margin-bottom:8px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<div><span style="font-size:11px;color:var(--green);border:1px solid var(--green);padding:1px 6px;border-radius:6px;">[' + c.tag + ']</span>' +
              '<span class="clan-name" style="font-size:16px;margin-left:8px;">' + c.name + '</span></div>' +
              '<span style="color:#777;font-size:12px;">' + memberCount + ' –≥—Ä–∞–≤—Ü—ñ–≤</span>' +
            '</div>' +
            '<div style="color:#777;font-size:12px;margin:6px 0;">' + (c.desc||'') + '</div>' +
            '<button class="btn-green" style="padding:8px;font-size:12px;" onclick="joinClan(\'' + id + '\')">‚ûï –í—Å—Ç—É–ø–∏—Ç–∏</button>' +
          '</div>';
        });
      });
    }

    function joinClan(clanId) {
      if(userData.clanId) return notify('–í–∏ –≤–∂–µ –≤ –∫–ª–∞–Ω—ñ!', 'error');
      db.ref('clans/' + clanId).once('value', snap => {
        const c = snap.val();
        if(!c) return notify('–ö–ª–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        db.ref('clans/' + clanId + '/members/' + currentUser).set({ role: 'member', joined: Date.now() });
        db.ref('users/' + currentUser).update({ clanId });
        notify('üõ°Ô∏è –í–∏ –≤—Å—Ç—É–ø–∏–ª–∏ –¥–æ –∫–ª–∞–Ω—É ' + c.name, 'success');
        loadClanTab();
      });
    }

    function leaveClan() {
      if(!userData.clanId) return;
      const clanId = userData.clanId;
      db.ref('clans/' + clanId + '/members/' + currentUser).remove();
      db.ref('users/' + currentUser + '/clanId').remove();
      notify('–í–∏ –ø–æ–∫–∏–Ω—É–ª–∏ –∫–ª–∞–Ω', 'info');
      loadClanTab();
    }

    function loadMyClan(clanId) {
      db.ref('clans/' + clanId).once('value', snap => {
        const c = snap.val();
        if(!c) { leaveClan(); return; }
        const banner = document.getElementById('myClanBanner');
        const members = c.members ? Object.keys(c.members) : [];
        banner.innerHTML =
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">' +
            '<div><span style="font-size:11px;color:var(--green);border:1px solid var(--green);padding:1px 6px;border-radius:6px;">[' + c.tag + ']</span>' +
            '<span class="clan-name" style="font-size:18px;margin-left:8px;">' + c.name + '</span></div>' +
            '<span style="font-size:20px;">' + (c.leader===currentUser?'üëë':'') + '</span>' +
          '</div>' +
          '<div style="color:#aaa;font-size:13px;margin-bottom:10px;">' + (c.desc||'') + '</div>' +
          '<div class="clan-stats">' +
            '<div class="clan-stat"><div class="clan-stat-v">' + members.length + '</div><div class="clan-stat-l">–£—á–∞—Å–Ω–∏–∫—ñ–≤</div></div>' +
            '<div class="clan-stat"><div class="clan-stat-v">' + formatNumber(c.bank||0) + '‚Ç¥</div><div class="clan-stat-l">–ë–∞–Ω–∫ –∫–ª–∞–Ω—É</div></div>' +
            '<div class="clan-stat"><div class="clan-stat-v">' + formatNumber(c.weekWager||0) + '‚Ç¥</div><div class="clan-stat-l">–°—Ç–∞–≤–∫–∏/—Ç–∏–∂</div></div>' +
          '</div>';

        const mList = document.getElementById('clanMembersList');
        mList.innerHTML = '';
        members.forEach(name => {
          const role = c.members[name] && c.members[name].role || 'member';
          mList.innerHTML += '<div class="clan-member-row">' +
            '<div class="clan-member-avatar">' + (name===currentUser?'üôã':'üë§') + '</div>' +
            '<div style="flex:1;"><div style="font-weight:bold;font-size:14px;">' + name + '</div></div>' +
            '<span class="clan-role ' + role + '">' + (role==='leader'?'üëë –õ—ñ–¥–µ—Ä':'üõ°Ô∏è –£—á–∞—Å–Ω–∏–∫') + '</span>' +
          '</div>';
        });

        const tList = document.getElementById('clanTasksList');
        const CLAN_TASKS = [
          { goal: 5000,  label: '–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ 5 000‚Ç¥ —Å–ø—ñ–ª—å–Ω–æ',  reward: 500,  key: 'weekWager' },
          { goal: 25000, label: '–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ 25 000‚Ç¥ —Å–ø—ñ–ª—å–Ω–æ', reward: 2000, key: 'weekWager' },
          { goal: members.length * 3, label: '–ö–æ–∂–µ–Ω –≥—Ä–∞—î 3 —ñ–≥—Ä–∏ (' + (members.length*3) + ' —Ä–∞–∑—ñ–≤)', reward: 1000, key: 'weekGames' }
        ];
        tList.innerHTML = CLAN_TASKS.map(t => {
          const prog = Math.min(t.goal, c[t.key] || 0);
          const pct  = Math.min(100, (prog/t.goal)*100);
          const done = prog >= t.goal;
          return '<div class="clan-task ' + (done?'done':'') + '">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:6px;">' +
              '<span style="font-size:13px;">' + t.label + '</span>' +
              '<span style="color:var(--accent);font-size:12px;font-weight:bold;">+' + t.reward + '‚Ç¥</span>' +
            '</div>' +
            '<div class="quest-prog-bar"><div class="quest-prog-fill" style="width:' + pct + '%"></div></div>' +
            '<div style="font-size:11px;color:#777;">' + formatNumber(prog) + ' / ' + formatNumber(t.goal) + '</div>' +
            (done ? '<div style="color:var(--green);font-size:12px;margin-top:4px;">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ!</div>' : '') +
          '</div>';
        }).join('');
      });
    }

    // –¢—Ä–µ–∫—ñ–Ω–≥ –≤–∞–≥–µ—Ä–∞ –¥–ª—è –∫–ª–∞–Ω—É
    function trackClanWager(amount) {
      if(!userData.clanId) return;
      db.ref('clans/' + userData.clanId + '/weekWager').transaction(v => (v||0) + amount);
      db.ref('clans/' + userData.clanId + '/weekGames').transaction(v => (v||0) + 1);
    }

    // ============================================
    // ===== –õ–Ü–î–ï–†–ë–û–†–î =====
    // ============================================
    function loadLeaderboard(mode, el) {
      document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
      if(el) el.classList.add('active');

      const list = document.getElementById('leaderboardList');
      list.innerHTML = '<div style="color:#777;text-align:center;padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

      const fmts = {
        balance:           v => formatNumber(v||0) + ' ‚Ç¥',
        totalWagered:      v => formatNumber(v||0) + ' ‚Ç¥',
        'stats.biggestWin':v => formatNumber(v||0) + ' ‚Ç¥',
        dailyStreak:       v => (v||0) + ' üî•',
        'stats.gamesPlayed':v => (v||0) + ' üéÆ',
      };
      const fmt = fmts[mode] || fmts.balance;

      db.ref('users').once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML='<div style="color:#777;text-align:center;padding:20px;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>'; return; }
        let arr = Object.entries(data).map(([n, d]) => {
          let val = mode.includes('.') ? mode.split('.').reduce((o,k)=>(o||{})[k], d) : d[mode];
          return { name:n, val: val||0, avatar: d.avatar };
        }).filter(u => u.val > 0).sort((a,b) => b.val - a.val).slice(0,20);

        list.innerHTML = '';
        arr.forEach((u, i) => {
          const medals = ['ü•á','ü•à','ü•â'];
          const medal  = i < 3 ? medals[i] : (i+1) + '.';
          const isMe   = u.name === currentUser;
          const av = u.avatar && u.avatar.length > 20
            ? '<img src="' + u.avatar + '" style="width:30px;height:30px;border-radius:50%;vertical-align:middle;">'
            : 'üë§';
          list.innerHTML += '<div class="lb-row ' + (isMe?'lb-me':'') + '" onclick="openPublicProfile(\'' + u.name + '\')">' +
            '<span class="lb-medal">' + medal + '</span>' +
            '<span style="font-size:20px;">' + av + '</span>' +
            '<span class="lb-name">' + u.name + (isMe?' (–í–∏)':'') + '</span>' +
            '<span class="lb-val">' + fmt(u.val) + '</span>' +
          '</div>';
        });
        if(arr.length === 0) list.innerHTML='<div style="color:#777;text-align:center;padding:20px;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>';
      });
    }

    // ============================================
    // ===== –ü–û–î–ê–†–£–ù–ö–ò =====
    // ============================================
    const GIFT_CATALOG = {
      bouquet:  { icon:'üíê', name:'–ë—É–∫–µ—Ç',        price:50,   value:50,   isBox:null },
      chest:    { icon:'üì¶', name:'Common Box',    price:200,  value:null, isBox:'common' },
      money500: { icon:'üíµ', name:'–ö–æ–Ω–≤–µ—Ä—Ç 500‚Ç¥',  price:500,  value:500,  isBox:null },
      diamond:  { icon:'üíé', name:'–î—ñ–∞–º–∞–Ω—Ç',       price:1000, value:1000, isBox:null },
      crown:    { icon:'üëë', name:'–ó–æ–ª–æ—Ç–∞ –∫–æ—Ä–æ–Ω–∞', price:2500, value:2500, isBox:null },
      rocket:   { icon:'üöÄ', name:'–†–∞–∫–µ—Ç–∞',        price:5000, value:5000, isBox:null },
    };
    let selectedGiftType = null;

    function selectGift(type, el) {
      selectedGiftType = type;
      document.querySelectorAll('.gift-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    function sendGift() {
      if(!selectedGiftType) return notify('–û–±–µ—Ä—ñ—Ç—å –ø–æ–¥–∞—Ä—É–Ω–æ–∫', 'error');
      const recipient = document.getElementById('giftRecipient').value.trim();
      const message   = document.getElementById('giftMessage').value.trim();
      if(!recipient) return notify('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞', 'error');
      if(recipient === currentUser) return notify('–ù–µ –º–æ–∂–Ω–∞ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–æ–±—ñ üòÑ', 'error');
      const gift = GIFT_CATALOG[selectedGiftType];
      if(userData.balance < gift.price) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/' + recipient).once('value', snap => {
        if(!snap.exists()) return notify('–ì—Ä–∞–≤—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-gift.price));
        db.ref('gifts/' + recipient).push({
          from: currentUser, type: selectedGiftType, icon: gift.icon, name: gift.name,
          value: gift.value, isBox: gift.isBox, message: message||null, time: Date.now(), claimed: false
        });
        addToHistory('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ ' + gift.icon + ' -> ' + recipient + ': -' + gift.price + '‚Ç¥');
        notify(gift.icon + ' –ü–æ–¥–∞—Ä—É–Ω–æ–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ ' + recipient + '!', 'success');
        document.getElementById('giftRecipient').value = '';
        document.getElementById('giftMessage').value = '';
      });
    }

    function loadInboxGifts() {
      const inbox = document.getElementById('inboxGifts');
      if(!inbox) return;
      db.ref('gifts/' + currentUser).orderByChild('claimed').equalTo(false).once('value', snap => {
        const data = snap.val();
        if(!data) { inbox.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:15px 0;">–ù–µ–º–∞—î –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤</div>'; return; }
        inbox.innerHTML = '';
        let unclaimed = 0;
        Object.entries(data).forEach(([id, g]) => {
          unclaimed++;
          const t = new Date(g.time).toLocaleDateString('uk-UA');
          inbox.innerHTML += '<div class="inbox-gift new-gift">' +
            '<div style="font-size:36px;">' + g.icon + '</div>' +
            '<div style="flex:1;">' +
              '<div style="font-weight:bold;">' + g.name + ' <span style="color:#777;font-size:11px;">–≤—ñ–¥ ' + g.from + '</span></div>' +
              (g.message ? '<div style="color:#aaa;font-size:12px;margin-top:3px;">"' + g.message + '"</div>' : '') +
              '<div style="color:#555;font-size:11px;margin-top:2px;">' + t + '</div>' +
            '</div>' +
            '<button style="width:auto;padding:8px 14px;font-size:12px;flex-shrink:0;" class="btn-gold" onclick="claimGift(\'' + id + '\',\'' + g.type + '\',' + g.value + ',\'' + (g.isBox||'') + '\')">üéÅ –ó–∞–±—Ä–∞—Ç–∏</button>' +
          '</div>';
        });
        const badge = document.getElementById('giftsBadge');
        if(badge) badge.classList.toggle('hidden', unclaimed === 0);
      });
    }

    function claimGift(giftId, type, value, isBox) {
      db.ref('gifts/' + currentUser + '/' + giftId).update({ claimed: true });
      const gift = GIFT_CATALOG[type] || {};
      if(isBox && LOOTBOX_CONFIGS && LOOTBOX_CONFIGS[isBox]) {
        const cfg = LOOTBOX_CONFIGS[isBox];
        const prize = rollLootbox(cfg);
        const win = Math.floor(cfg.price * prize.mult);
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(win));
        notify((gift.icon||'üì¶') + ' –ü–æ–¥–∞—Ä—É–Ω–æ–∫ –≤—ñ–¥–∫—Ä–∏—Ç–æ! +' + win + '‚Ç¥', 'success');
        addToHistory('–ü–æ–¥–∞—Ä—É–Ω–æ–∫-—Å–∫—Ä–∏–Ω—å–∫–∞ +' + win + '‚Ç¥');
      } else if(value) {
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(value));
        notify((gift.icon||'üéÅ') + ' –ü–æ–¥–∞—Ä—É–Ω–æ–∫: +' + value + '‚Ç¥', 'success');
        addToHistory('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ ' + (gift.icon||'') + ' +' + value + '‚Ç¥');
      } else {
        notify((gift.icon||'üéÅ') + ' –ü–æ–¥–∞—Ä—É–Ω–æ–∫ ' + (gift.name||'') + ' –æ—Ç—Ä–∏–º–∞–Ω–æ!', 'success');
      }
      loadInboxGifts();
    }

    function checkInboxGifts() {
      db.ref('gifts/' + currentUser).orderByChild('claimed').equalTo(false).once('value', snap => {
        const count = snap.val() ? Object.keys(snap.val()).length : 0;
        const badge = document.getElementById('giftsBadge');
        if(badge) badge.classList.toggle('hidden', count === 0);
      });
    }

    // ============================================
    // ===== –ú–û–ù–û–ü–û–õ–Ü–Ø =====
    // ============================================
    const MONO_COLORS = {
      brown:'#8B4513', lightblue:'#87CEEB', pink:'#FF69B4', orange:'#FFA500',
      red:'#FF3B30', yellow:'#FFD700', green:'#4CD964', blue:'#0070C9'
    };

    const MONO_CELLS = [
      {type:'corner',  label:'GO\n+200‚Ç¥', pos:0},
      {type:'prop',    label:'–ö–∏—ó–≤\n–°—Ç–∞—Ä–∏–π',   color:'brown',     price:60,  rent:4,  pos:1},
      {type:'special', label:'–°–∫–∞—Ä–±',  icon:'üèÜ', pos:2},
      {type:'prop',    label:'–ö–∏—ó–≤\n–ù–æ–≤–∏–π',    color:'brown',     price:60,  rent:4,  pos:3},
      {type:'tax',     label:'–ü–æ–¥–∞—Ç–æ–∫\n-100‚Ç¥',  icon:'üí∏', pos:4},
      {type:'station', label:'–í–æ–∫–∑–∞–ª\n–ü–¥',      price:200, rent:25, pos:5},
      {type:'prop',    label:'–•–∞—Ä–∫—ñ–≤\n–°—Ö',      color:'lightblue', price:100, rent:6,  pos:6},
      {type:'special', label:'–®–∞–Ω—Å',   icon:'‚ùì', pos:7},
      {type:'prop',    label:'–•–∞—Ä–∫—ñ–≤\n–ó—Ö',      color:'lightblue', price:100, rent:6,  pos:8},
      {type:'prop',    label:'–•–∞—Ä–∫—ñ–≤\n–¶–µ–Ω—Ç—Ä',   color:'lightblue', price:120, rent:8,  pos:9},
      {type:'corner',  label:'–í\'–Ø–ó–ù–ò–¶–Ø', pos:10},
      {type:'prop',    label:'–û–¥–µ—Å–∞\n–¶–µ–Ω—Ç—Ä',    color:'pink',      price:140, rent:10, pos:11},
      {type:'utility', label:'–ï–ª–µ–∫—Ç-\n—Ä–æ—Å—Ç–∞–Ω—Ü—ñ—è', icon:'‚ö°', price:150, pos:12},
      {type:'prop',    label:'–û–¥–µ—Å–∞\n–ú–æ—Ä—Å—å–∫–∞',  color:'pink',      price:140, rent:10, pos:13},
      {type:'prop',    label:'–û–¥–µ—Å–∞\n–ö—É—Ä–æ—Ä—Ç',   color:'pink',      price:160, rent:12, pos:14},
      {type:'station', label:'–í–æ–∫–∑–∞–ª\n–°—Ö',       price:200, rent:25, pos:15},
      {type:'prop',    label:'–î–Ω—ñ–ø—Ä–æ\n–°—Ç–∞—Ä–∏–π',  color:'orange',    price:180, rent:14, pos:16},
      {type:'special', label:'–°–∫–∞—Ä–±',  icon:'üèÜ', pos:17},
      {type:'prop',    label:'–î–Ω—ñ–ø—Ä–æ\n–¶–µ–Ω—Ç—Ä',   color:'orange',    price:180, rent:14, pos:18},
      {type:'prop',    label:'–î–Ω—ñ–ø—Ä–æ\n–ê—Ç—Ä–∞–∫—Ü—ñ—ó', color:'orange',   price:200, rent:16, pos:19},
      {type:'corner',  label:'–ü–ê–†–ö', pos:20},
      {type:'prop',    label:'–ó–∞–ø–æ—Ä—ñ–∂–∂—è',        color:'red',       price:220, rent:18, pos:21},
      {type:'special', label:'–®–∞–Ω—Å',   icon:'‚ùì', pos:22},
      {type:'prop',    label:'–°—É–º–∏\n–¶–µ–Ω—Ç—Ä',      color:'red',       price:220, rent:18, pos:23},
      {type:'prop',    label:'–°—É–º–∏\n–°—É–ø–µ—Ä',      color:'red',       price:240, rent:20, pos:24},
      {type:'station', label:'–í–æ–∫–∑–∞–ª\n–ó—Ö',       price:200, rent:25, pos:25},
      {type:'prop',    label:'–ü–æ–ª—Ç–∞–≤–∞\n–°—Ç–∞—Ä–∞',   color:'yellow',    price:260, rent:22, pos:26},
      {type:'prop',    label:'–ü–æ–ª—Ç–∞–≤–∞\n–ù–æ–≤–∞',    color:'yellow',    price:260, rent:22, pos:27},
      {type:'utility', label:'–í–æ–¥–æ-\n–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è', icon:'üíß', price:150, pos:28},
      {type:'prop',    label:'–ü–æ–ª—Ç–∞–≤–∞\n–ú–æ–¥–µ—Ä–Ω',  color:'yellow',    price:280, rent:24, pos:29},
      {type:'corner',  label:'–ô–î–ò –£\n–í\'–Ø–ó–ù–ò–¶–Æ', pos:30},
      {type:'prop',    label:'Lviv\n–°—Ç–∞—Ä–µ',      color:'green',     price:300, rent:26, pos:31},
      {type:'prop',    label:'Lviv\n–¶–µ–Ω—Ç—Ä',      color:'green',     price:300, rent:26, pos:32},
      {type:'special', label:'–°–∫–∞—Ä–±',  icon:'üèÜ', pos:33},
      {type:'prop',    label:'Lviv\n–ü—Ä–µ–º\'—î—Ä',   color:'green',     price:320, rent:28, pos:34},
      {type:'station', label:'–í–æ–∫–∑–∞–ª\n–ü–Ω',       price:200, rent:25, pos:35},
      {type:'special', label:'–®–∞–Ω—Å',   icon:'‚ùì', pos:36},
      {type:'prop',    label:'Kyiv\n–ü—Ä–∞–π–º',      color:'blue',      price:350, rent:35, pos:37},
      {type:'tax',     label:'–†–æ–∑–∫—ñ—à\n-150‚Ç¥',    icon:'üíé', pos:38},
      {type:'prop',    label:'Kyiv\nPrestige',   color:'blue',      price:400, rent:50, pos:39},
    ];

    function cellGridPos(pos) {
      if(pos === 0)  return [10,10];
      if(pos <= 9)   return [10-pos, 10];
      if(pos === 10) return [0, 10];
      if(pos <= 19)  return [0, 10-(pos-10)];
      if(pos === 20) return [0, 0];
      if(pos <= 29)  return [pos-20, 0];
      if(pos === 30) return [10, 0];
      if(pos <= 39)  return [10, pos-30];
      return [0,0];
    }

    let monoState = null;

    function startMonopoly() {
      const bet = parseInt(document.getElementById('monoEntryBet').value) || 500;
      if(bet < 100) return notify('–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç–∞–≤–∫–∞ 100‚Ç¥', 'error');
      if(userData.balance < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/' + currentUser).update({ balance: userData.balance - bet });
      addWager(bet);
      trackQuest('totalGames', 1);
      trackQuest('weekWager', bet);
      if(userData.clanId) trackClanWager(bet);

      monoState = {
        bet, playerMoney:3000, aiMoney:3000,
        playerPos:0, aiPos:0, props:{},
        turn:'player', jailPlayer:0, jailAi:0, gameOver:false
      };

      document.getElementById('monoStartScreen').classList.add('hidden');
      document.getElementById('monoGameScreen').classList.remove('hidden');
      renderMonoBoard();
      updateMonoInfo();
      monoLog('üé© –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –í–∞—à —Ö—ñ–¥.', 'info');
    }

    function renderMonoBoard() {
      const board = document.getElementById('monoBoard');
      if(!board) return;
      const grid = Array.from({length:11}, () => Array(11).fill(null));
      MONO_CELLS.forEach(cell => { const [c,r] = cellGridPos(cell.pos); grid[r][c] = cell; });

      board.innerHTML = '';
      board.style.display = 'grid';
      board.style.gridTemplateColumns = '1fr repeat(9,1fr) 1fr';
      board.style.gridTemplateRows = '1fr repeat(9,1fr) 1fr';

      for(let r = 0; r < 11; r++) {
        for(let c = 0; c < 11; c++) {
          // Skip center cells ‚Äî handled by center div
          if(r >= 1 && r <= 9 && c >= 1 && c <= 9) {
            if(r === 1 && c === 1) {
              // Place center spanning element
              const ctr = document.createElement('div');
              ctr.className = 'mono-center';
              ctr.style.gridColumn = '2 / 11';
              ctr.style.gridRow = '2 / 11';
              ctr.innerHTML = '<div style="font-size:16px;letter-spacing:2px;">–ú–û–ù–û–ü–û–õ–Ü–Ø</div><div style="font-size:36px;margin-top:5px;">üé©</div>';
              board.appendChild(ctr);
            }
            continue;
          }

          const cell = grid[r][c];
          const div = document.createElement('div');

          if(!cell) {
            div.style.cssText = 'background:transparent;border:none;';
            board.appendChild(div);
            continue;
          }

          let stripeClass = '';
          if(cell.pos >= 1 && cell.pos <= 9)   stripeClass = 'prop-top';
          if(cell.pos >= 11 && cell.pos <= 19)  stripeClass = 'prop-right';
          if(cell.pos >= 21 && cell.pos <= 29)  stripeClass = 'prop-bottom';
          if(cell.pos >= 31 && cell.pos <= 39)  stripeClass = 'prop-left';

          let ownerClass = '';
          if(monoState && monoState.props[cell.pos]) ownerClass = 'owned-' + monoState.props[cell.pos];

          div.className = 'mono-cell ' + (cell.type==='corner'?'corner':'') + ' ' + stripeClass + ' ' + ownerClass;
          div.dataset.pos = cell.pos;

          if(cell.color) div.style.borderColor = MONO_COLORS[cell.color]||'#999';

          const cornerIcons = {0:'üèÅ',10:'‚õìÔ∏è',20:'üå≥',30:'üëÆ'};
          if(cell.type === 'corner') {
            div.innerHTML = '<span style="font-size:12px;">' + (cornerIcons[cell.pos]||'') + '</span><span style="font-size:8px;white-space:pre-line;">' + cell.label + '</span>';
          } else if(cell.type === 'prop') {
            div.innerHTML = '<span style="font-size:7px;white-space:pre-line;line-height:1.1;">' + cell.label + '</span><span class="cell-price">' + cell.price + '‚Ç¥</span>';
          } else if(cell.type === 'station') {
            div.innerHTML = '<span style="font-size:12px;">üöÇ</span><span style="font-size:7px;white-space:pre-line;">' + cell.label + '</span><span class="cell-price">' + cell.price + '‚Ç¥</span>';
          } else if(cell.type === 'utility') {
            div.innerHTML = '<span style="font-size:14px;">' + (cell.icon||'') + '</span><span style="font-size:7px;white-space:pre-line;">' + cell.label + '</span>';
          } else if(cell.type === 'special') {
            div.innerHTML = '<span style="font-size:16px;">' + (cell.icon||'?') + '</span>';
          } else if(cell.type === 'tax') {
            div.innerHTML = '<span style="font-size:12px;">' + (cell.icon||'') + '</span><span style="font-size:7px;white-space:pre-line;">' + cell.label + '</span>';
          }

          board.appendChild(div);
        }
      }
      placeMonoPlayers();
    }

    function placeMonoPlayers() {
      document.querySelectorAll('.mono-player').forEach(e => e.remove());
      if(!monoState) return;
      const wrap = document.getElementById('monoBoardWrap');
      if(!wrap) return;
      const W = wrap.offsetWidth;
      const cellW = W / 11;

      [
        { pos: monoState.playerPos, color:'#4CD964', label:'üßë', offset:0 },
        { pos: monoState.aiPos,     color:'#FF3B30', label:'ü§ñ', offset:6 }
      ].forEach(p => {
        const [col, row] = cellGridPos(p.pos);
        const el = document.createElement('div');
        el.className = 'mono-player';
        el.style.background = p.color;
        el.style.left = (col * cellW + p.offset + 2) + 'px';
        el.style.top  = (row * cellW + 2) + 'px';
        el.title = p.label;
        wrap.appendChild(el);
      });
    }

    function updateMonoInfo() {
      if(!monoState) return;
      const pm = document.getElementById('monoPlayerMoney');
      const am = document.getElementById('monoAiMoney');
      if(pm) pm.textContent = monoState.playerMoney + '‚Ç¥';
      if(am) am.textContent = monoState.aiMoney + '‚Ç¥';
    }

    const DICE_EMOJI = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
    function rollDice() { return Math.floor(Math.random()*6)+1; }

    function monoRoll() {
      if(!monoState || monoState.gameOver || monoState.turn !== 'player') return;
      const rollBtn = document.getElementById('monoRollBtn');
      if(rollBtn) rollBtn.disabled = true;

      const d1 = rollDice(), d2 = rollDice();
      const die1 = document.getElementById('die1');
      const die2 = document.getElementById('die2');
      if(die1) { die1.classList.add('rolling'); die1.textContent = DICE_EMOJI[d1]; }
      if(die2) { die2.classList.add('rolling'); die2.textContent = DICE_EMOJI[d2]; }
      setTimeout(() => {
        if(die1) die1.classList.remove('rolling');
        if(die2) die2.classList.remove('rolling');
      }, 500);

      if(monoState.jailPlayer > 0) {
        monoState.jailPlayer--;
        monoLog('‚õìÔ∏è –í–∏ —É –≤\'—è–∑–Ω–∏—Ü—ñ. –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ' + monoState.jailPlayer, 'bad');
        setTimeout(monoAiTurn, 1000); return;
      }

      const steps = d1 + d2;
      monoLog('üé≤ –í–∏ –∫–∏–Ω—É–ª–∏ ' + d1 + ' + ' + d2 + ' = ' + steps);
      const oldPos = monoState.playerPos;
      monoState.playerPos = (monoState.playerPos + steps) % 40;
      if(monoState.playerPos < oldPos) {
        monoState.playerMoney += 200;
        monoLog('üèÅ –í–∏ –ø—Ä–æ–π—à–ª–∏ GO! +200‚Ç¥', 'good');
      }
      updateMonoInfo();
      renderMonoBoard();
      setTimeout(monoLandPlayer, 600);
    }

    function monoLandPlayer() {
      const cell = MONO_CELLS[monoState.playerPos];
      if(!cell) { setTimeout(monoAiTurn, 500); return; }

      const buyBtn = document.getElementById('monoBuyBtn');
      if(buyBtn) buyBtn.disabled = true;

      if(cell.pos === 30) {
        monoState.playerPos = 10; monoState.jailPlayer = 2;
        monoLog('üëÆ –Ü–¥–∏ —É –≤\'—è–∑–Ω–∏—Ü—é!', 'bad');
        renderMonoBoard(); setTimeout(monoAiTurn, 1000); return;
      }
      if(cell.type === 'tax') {
        const tax = cell.pos === 4 ? 100 : 150;
        monoState.playerMoney -= tax;
        monoLog('üí∏ –ü–æ–¥–∞—Ç–æ–∫: -' + tax + '‚Ç¥', 'bad');
        updateMonoInfo();
        if(monoState.playerMoney <= 0) return monoGameOver('ai');
        setTimeout(monoAiTurn, 1000); return;
      }
      if(cell.type === 'special') {
        monoSpecialCard('player');
        setTimeout(monoAiTurn, 1200); return;
      }
      if((cell.type === 'prop' || cell.type === 'station') && cell.price) {
        const owner = monoState.props[cell.pos];
        if(!owner) {
          monoLog('üè† ' + cell.label.replace('\n',' ') + ' ‚Äî –≤—ñ–ª—å–Ω–∞ (' + cell.price + '‚Ç¥). –ö—É–ø–∏—Ç–∏?', 'info');
          const passBtn = document.getElementById('monoPassBtn');
          if(buyBtn) { buyBtn.disabled = false; buyBtn.onclick = () => monoPlayerBuy(cell); }
          if(passBtn) { passBtn.disabled = false; passBtn.onclick = () => monoPass(); }
          return;
        } else if(owner === 'ai') {
          const rent = cell.rent || 25;
          monoState.playerMoney -= rent; monoState.aiMoney += rent;
          monoLog('üè† –†–µ–Ω—Ç–∞ AI: -' + rent + '‚Ç¥', 'bad');
          updateMonoInfo();
          if(monoState.playerMoney <= 0) return monoGameOver('ai');
        } else {
          monoLog('‚úÖ –í–∞—à–∞ –≤–ª–∞—Å–Ω—ñ—Å—Ç—å!', 'good');
        }
      }
      setTimeout(monoAiTurn, 800);
    }

    function monoPlayerBuy(cell) {
      if(monoState.playerMoney < cell.price) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!', 'error'); setTimeout(monoAiTurn, 500); return; }
      monoState.playerMoney -= cell.price;
      monoState.props[cell.pos] = 'player';
      monoLog('‚úÖ –ö—É–ø–ª–µ–Ω–æ: ' + cell.label.replace('\n',' ') + ' (-' + cell.price + '‚Ç¥)', 'good');
      const buyBtn = document.getElementById('monoBuyBtn');
      if(buyBtn) buyBtn.disabled = true;
      renderMonoBoard(); updateMonoInfo();
      setTimeout(monoAiTurn, 800);
    }

    function monoAiTurn() {
      if(!monoState || monoState.gameOver) return;
      monoState.turn = 'ai';
      setTimeout(() => {
        const d1 = rollDice(), d2 = rollDice();
        const die1 = document.getElementById('die1');
        const die2 = document.getElementById('die2');
        if(die1) die1.textContent = DICE_EMOJI[d1];
        if(die2) die2.textContent = DICE_EMOJI[d2];
        const steps = d1 + d2;
        monoLog('ü§ñ AI –∫–∏–¥–∞—î: ' + d1 + '+' + d2 + '=' + steps);

        if(monoState.jailAi > 0) {
          monoState.jailAi--;
          monoLog('‚õìÔ∏è AI —É –≤\'—è–∑–Ω–∏—Ü—ñ. –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ' + monoState.jailAi);
          monoEndAiTurn(); return;
        }

        const oldPos = monoState.aiPos;
        monoState.aiPos = (monoState.aiPos + steps) % 40;
        if(monoState.aiPos < oldPos) {
          monoState.aiMoney += 200; monoLog('ü§ñ AI –ø—Ä–æ–π—à–æ–≤ GO +200‚Ç¥');
        }
        renderMonoBoard(); updateMonoInfo();
        setTimeout(monoAiAction, 700);
      }, 800);
    }

    function monoAiAction() {
      if(!monoState || monoState.gameOver) return;
      const cell = MONO_CELLS[monoState.aiPos];
      if(!cell) { monoEndAiTurn(); return; }

      if(cell.pos === 30) {
        monoState.aiPos = 10; monoState.jailAi = 2;
        monoLog('üëÆ AI —É –≤\'—è–∑–Ω–∏—Ü—ñ!');
        renderMonoBoard(); monoEndAiTurn(); return;
      }
      if(cell.type === 'tax') {
        const tax = cell.pos === 4 ? 100 : 150;
        monoState.aiMoney -= tax;
        monoLog('üí∏ AI –ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–∞—Ç–æ–∫: -' + tax + '‚Ç¥');
        updateMonoInfo();
        if(monoState.aiMoney <= 0) { monoGameOver('player'); return; }
        monoEndAiTurn(); return;
      }
      if(cell.type === 'special') { monoSpecialCard('ai'); monoEndAiTurn(); return; }
      if((cell.type === 'prop' || cell.type === 'station') && cell.price) {
        const owner = monoState.props[cell.pos];
        if(!owner && monoState.aiMoney >= cell.price && Math.random() > 0.25) {
          monoState.aiMoney -= cell.price;
          monoState.props[cell.pos] = 'ai';
          monoLog('ü§ñ AI –∫—É–ø–∏–≤: ' + cell.label.replace('\n',' '), 'info');
          renderMonoBoard(); updateMonoInfo();
        } else if(owner === 'player') {
          const rent = cell.rent || 25;
          monoState.aiMoney -= rent; monoState.playerMoney += rent;
          monoLog('üí∞ AI –ø–ª–∞—Ç–∏—Ç—å —Ä–µ–Ω—Ç—É: +' + rent + '‚Ç¥ –≤–∞–º!', 'good');
          updateMonoInfo();
          if(monoState.aiMoney <= 0) { monoGameOver('player'); return; }
        }
      }
      monoEndAiTurn();
    }

    function monoEndAiTurn() {
      monoState.turn = 'player';
      const rollBtn = document.getElementById('monoRollBtn');
      if(rollBtn) rollBtn.disabled = false;
      monoLog('‚Äî –í–∞—à —Ö—ñ–¥ ‚Äî', 'info');
    }

    function monoSpecialCard(who) {
      const cards = [
        { text:'+100‚Ç¥ –ó–Ω–∞—Ö—ñ–¥–∫–∞!',        dm: 1, da: 0, extra:100 },
        { text:'-75‚Ç¥ –®—Ç—Ä–∞—Ñ',             dm:-1, da: 0, extra:75  },
        { text:'+50‚Ç¥ –≤—ñ–¥ –±–∞–Ω–∫—É',         dm: 1, da: 0, extra:50  },
        { text:'+150‚Ç¥ –î–∏–≤—ñ–¥–µ–Ω–¥–∏',        dm: 1, da: 0, extra:150 },
        { text:'-50‚Ç¥ –†–µ–º–æ–Ω—Ç',            dm:-1, da: 0, extra:50  },
        { text:'–í–∏–π–¥–∏ –∑ –≤\'—è–∑–Ω–∏—Ü—ñ!',     jail:true               },
        { text:'+200‚Ç¥ –í–µ–ª–∏–∫–∞ —É–¥–∞—á–∞!',    dm: 1, da: 0, extra:200 },
      ];
      const card = cards[Math.floor(Math.random()*cards.length)];
      if(card.jail) {
        if(who==='player') monoState.jailPlayer=0; else monoState.jailAi=0;
      } else {
        const sign = card.dm;
        if(who==='player') monoState.playerMoney += sign * (card.extra||0);
        else monoState.aiMoney += sign * (card.extra||0);
      }
      monoLog('üÉè ' + (who==='player'?'–í–∏':'AI') + ': ' + card.text, who==='player'?'good':'info');
      updateMonoInfo(); renderMonoBoard();
      if(monoState.playerMoney <= 0) monoGameOver('ai');
      if(monoState.aiMoney <= 0) monoGameOver('player');
    }

    function surrenderMonopoly() {
      if(!monoState || monoState.gameOver) return;
      if(confirm('–ó–¥–∞—Ç–∏—Å—å —ñ –ø—Ä–æ–≥—Ä–∞—Ç–∏ —Å—Ç–∞–≤–∫—É?')) monoGameOver('ai');
    }

    function monoGameOver(winner) {
      if(!monoState || monoState.gameOver) return;
      monoState.gameOver = true;
      const rollBtn = document.getElementById('monoRollBtn');
      if(rollBtn) rollBtn.disabled = true;

      const isWin = winner === 'player';
      const prize = Math.floor(monoState.bet * 1.9);
      if(isWin) {
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(prize));
        monoLog('üèÜ –í–ò –ü–ï–†–ï–ú–û–ì–õ–ò! +' + prize + '‚Ç¥', 'good');
        addToHistory('–ú–æ–Ω–æ–ø–æ–ª—ñ—è: +' + prize + '‚Ç¥');
        playSound('win');
        notify('üé© –ü–µ—Ä–µ–º–æ–≥–∞ –≤ –ú–æ–Ω–æ–ø–æ–ª—ñ—ó! +' + prize + '‚Ç¥', 'success');
      } else {
        monoLog('üíÄ AI –ø–µ—Ä–µ–º—ñ–≥. –ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ.', 'bad');
        addToHistory('–ú–æ–Ω–æ–ø–æ–ª—ñ—è: -' + monoState.bet + '‚Ç¥');
        notify('üòî AI –ø–µ—Ä–µ–º—ñ–≥ —É –ú–æ–Ω–æ–ø–æ–ª—ñ—ó', 'error');
      }
      setTimeout(() => {
        const ss = document.getElementById('monoStartScreen');
        const gs = document.getElementById('monoGameScreen');
        if(ss) ss.classList.remove('hidden');
        if(gs) gs.classList.add('hidden');
        monoState = null;
      }, 3000);
    }

    function monoLog(text, cls) {
      const log = document.getElementById('monoLog');
      if(!log) return;
      const item = document.createElement('div');
      item.className = 'mono-log-item ' + (cls||'');
      item.textContent = text;
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }


    // ============================================
    // ===== VIP –°–ò–°–¢–ï–ú–ê =====
    // ============================================
    const VIP_LEVELS = [
      { name: 'Iron',      icon: '‚öôÔ∏è',  min: 0,         cashback: 0,      hourly: 10,  dailyMult: 1.0,  class: 'bronze',   cssVar: '#555' },
      { name: 'Bronze',    icon: 'ü•â',  min: 1000,      cashback: 0,      hourly: 25,  dailyMult: 1.0,  class: 'bronze',   cssVar: 'var(--bronze)' },
      { name: 'Silver',    icon: 'ü•à',  min: 5000,      cashback: 0.001,  hourly: 50,  dailyMult: 1.1,  class: 'silver',   cssVar: 'var(--silver-c)' },
      { name: 'Gold',      icon: 'ü•á',  min: 20000,     cashback: 0.002,  hourly: 80,  dailyMult: 1.25, class: 'gold',     cssVar: 'var(--gold-c)' },
      { name: 'Emerald',   icon: 'üíö',  min: 60000,     cashback: 0.003,  hourly: 120, dailyMult: 1.4,  class: 'gold',     cssVar: '#2ecc71' },
      { name: 'Sapphire',  icon: 'üíô',  min: 150000,    cashback: 0.004,  hourly: 160, dailyMult: 1.6,  class: 'silver',   cssVar: '#3498db' },
      { name: 'Ruby',      icon: '‚ù§Ô∏è',  min: 350000,    cashback: 0.005,  hourly: 200, dailyMult: 1.75, class: 'gold',     cssVar: '#e74c3c' },
      { name: 'Platinum',  icon: 'üíé',  min: 700000,    cashback: 0.006,  hourly: 250, dailyMult: 1.9,  class: 'platinum', cssVar: 'var(--plat)' },
      { name: 'Master',    icon: 'üîÆ',  min: 1500000,   cashback: 0.007,  hourly: 350, dailyMult: 2.0,  class: 'platinum', cssVar: '#9b59b6' },
      { name: 'Elite',     icon: '‚≠ê',  min: 3000000,   cashback: 0.008,  hourly: 500, dailyMult: 2.2,  class: 'platinum', cssVar: '#f39c12' },
      { name: 'Diamond',   icon: 'üí†',  min: 7000000,   cashback: 0.009,  hourly: 750, dailyMult: 2.5,  class: 'platinum', cssVar: '#1abc9c' },
      { name: 'Legend',    icon: 'üåü',  min: 15000000,  cashback: 0.010,  hourly: 1000,dailyMult: 3.0,  class: 'platinum', cssVar: '#e67e22' },
      { name: 'Mythic',    icon: 'üî±',  min: 35000000,  cashback: 0.012,  hourly: 1500,dailyMult: 3.5,  class: 'platinum', cssVar: '#e91e63' },
      { name: 'Supreme',   icon: 'üëë',  min: 100000000, cashback: 0.015,  hourly: 3000,dailyMult: 5.0,  class: 'platinum', cssVar: 'linear-gradient(45deg,#d4af37,#fff)' },
    ];

    function getVipLevel(wagered) {
      for(let i = VIP_LEVELS.length - 1; i >= 0; i--) {
        if(wagered >= VIP_LEVELS[i].min) return { ...VIP_LEVELS[i], index: i };
      }
      return { ...VIP_LEVELS[0], index: 0 };
    }

    // ============================================================
    // CASHBACK SYSTEM ‚Äî –ª—ñ–º—ñ—Ç 50‚Ç¥/—Å—Ç–∞–≤–∫–∞, 5000‚Ç¥/—Ç–∏–∂–¥–µ–Ω—å
    // ============================================================
    const CASHBACK_MAX_PER_BET  = 50;    // –≥—Ä–Ω
    const CASHBACK_MAX_PER_WEEK = 5000;  // –≥—Ä–Ω

    function getCashbackEnabled() {
      try { return localStorage.getItem('cashback_enabled') !== 'false'; } catch(e) { return true; }
    }
    function setCashbackEnabled(val) {
      try { localStorage.setItem('cashback_enabled', val ? 'true' : 'false'); } catch(e) {}
    }

    function addWager(amount) {
      const wagered = (userData.totalWagered || 0) + amount;
      const vip = getVipLevel(wagered);
      const prevVip = getVipLevel(userData.totalWagered || 0);
      const updates = { totalWagered: wagered };

      // Cashback (only if enabled by user)
      if(vip.cashback > 0 && getCashbackEnabled()) {
        // Raw cashback for this bet
        const rawCashback = Math.floor(amount * vip.cashback);
        // Clamp per-bet
        const betCashback = Math.min(rawCashback, CASHBACK_MAX_PER_BET);
        if(betCashback > 0) {
          // Check weekly limit
          const weeklyUsed = userData.cashbackWeekUsed || 0;
          const weekStart  = userData.cashbackWeekStart || 0;
          const now = Date.now();
          const oneWeek = 7 * 24 * 3600 * 1000;
          const isNewWeek = (now - weekStart) >= oneWeek;
          const currentWeekUsed = isNewWeek ? 0 : weeklyUsed;
          const canAdd = Math.max(0, CASHBACK_MAX_PER_WEEK - currentWeekUsed);
          const finalCashback = Math.min(betCashback, canAdd);
          if(finalCashback > 0) {
            // Accumulate pending cashback (user claims it from cashier)
            const pending = (userData.cashbackPending || 0) + finalCashback;
            updates.cashbackPending   = pending;
            updates.cashbackWeekUsed  = currentWeekUsed + finalCashback;
            updates.cashbackWeekStart = isNewWeek ? now : weekStart;
          }
        }
      }

      // VIP level up
      if(vip.index > prevVip.index) {
        setTimeout(() => notify(`üéâ VIP –ø—ñ–¥–≤–∏—â–µ–Ω–æ –¥–æ ${vip.icon} ${vip.name}!`, 'success'), 700);
      }
      db.ref('users/' + currentUser).update(updates);
    }

    // Claim cashback from cashier
    function claimCashback() {
      const pending = userData.cashbackPending || 0;
      if(pending <= 0) return notify('–ù–µ–º–∞—î –Ω–∞–∫–æ–ø–∏—á–µ–Ω–æ–≥–æ –∫–µ—à–±–µ–∫—É', 'info');
      db.ref('users/'+currentUser).update({
        balance: (userData.balance||0) + pending,
        cashbackPending: 0,
        cashbackTotalClaimed: (userData.cashbackTotalClaimed||0) + pending
      });
      playSound('win');
      notify(`üí∞ –ö–µ—à–±–µ–∫ –æ—Ç—Ä–∏–º–∞–Ω–æ: +${formatNumber(pending)} ‚Ç¥`, 'success');
      addToHistory('–ö–µ—à–±–µ–∫: +'+pending);
      updateCashierCashbackUI();
    }

    function toggleCashback(el) {
      const enabled = el.checked;
      setCashbackEnabled(enabled);
      notify(enabled ? 'üí∞ –ö–µ—à–±–µ–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ' : 'üí∞ –ö–µ—à–±–µ–∫ –≤–∏–º–∫–Ω–µ–Ω–æ', 'info');
    }

    function updateCashierCashbackUI() {
      const pending   = userData.cashbackPending || 0;
      const weekUsed  = userData.cashbackWeekUsed || 0;
      const weekStart = userData.cashbackWeekStart || Date.now();
      const daysLeft  = Math.max(0, Math.ceil((7*24*3600000 - (Date.now()-weekStart)) / 86400000));
      const weekLeft  = Math.max(0, CASHBACK_MAX_PER_WEEK - weekUsed);

      const el = document.getElementById('cashierCashbackPanel');
      if(!el) return;
      const vip = getVipLevel(userData.totalWagered||0);
      const enabled = getCashbackEnabled();

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div>
            <div style="font-size:15px;font-weight:bold;color:var(--green);">üí∞ –ö–µ—à–±–µ–∫</div>
            <div style="font-size:10px;color:#555;margin-top:2px;">${vip.icon} ${vip.name} ‚Ä¢ ${(vip.cashback*100).toFixed(1)}% –∑ —Å—Ç–∞–≤–∫–∏</div>
          </div>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <span style="font-size:11px;color:#777;">${enabled?'–£–≤—ñ–º–∫–Ω–µ–Ω–æ':'–í–∏–º–∫–Ω–µ–Ω–æ'}</span>
            <div class="toggle-switch" style="width:40px;height:22px;"><input type="checkbox" ${enabled?'checked':''} onchange="toggleCashback(this)"><div class="toggle-slider"></div></div>
          </label>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
          <div style="background:#0a0a0a;border-radius:10px;padding:10px;text-align:center;">
            <div style="font-size:9px;color:#555;margin-bottom:3px;">–ù–∞–∫–æ–ø–∏—á–µ–Ω–æ</div>
            <div style="font-size:18px;font-weight:900;color:var(--green);">${formatNumber(pending)}‚Ç¥</div>
          </div>
          <div style="background:#0a0a0a;border-radius:10px;padding:10px;text-align:center;">
            <div style="font-size:9px;color:#555;margin-bottom:3px;">–¢–∏–∂–Ω. –ª—ñ–º—ñ—Ç</div>
            <div style="font-size:18px;font-weight:900;color:var(--accent);">${formatNumber(weekLeft)}‚Ç¥</div>
          </div>
          <div style="background:#0a0a0a;border-radius:10px;padding:10px;text-align:center;">
            <div style="font-size:9px;color:#555;margin-bottom:3px;">–°–∫–∏–¥–∞–Ω–Ω—è</div>
            <div style="font-size:18px;font-weight:900;color:#777;">${daysLeft}–¥</div>
          </div>
        </div>
        <div style="background:#050a05;border:1px solid #0d2a0d;border-radius:10px;padding:10px;margin-bottom:12px;font-size:11px;color:#555;">
          ‚ÑπÔ∏è –õ—ñ–º—ñ—Ç –∫–µ—à–±–µ–∫—É: <b style="color:var(--green);">${CASHBACK_MAX_PER_BET}‚Ç¥</b> –∑–∞ —Å—Ç–∞–≤–∫—É ‚Ä¢
          <b style="color:var(--green);">${formatNumber(CASHBACK_MAX_PER_WEEK)}‚Ç¥</b>/—Ç–∏–∂–¥–µ–Ω—å
        </div>
        <button class="btn-green" onclick="claimCashback()" ${pending<=0?'disabled style="opacity:0.5;"':''}>
          üí∞ –ó–ê–ë–†–ê–¢–ò ${formatNumber(pending)} ‚Ç¥
        </button>
        <div style="font-size:10px;color:#555;text-align:center;margin-top:8px;">
          –í—Å—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–æ: ${formatNumber(userData.cashbackTotalClaimed||0)} ‚Ç¥
        </div>`;
    }

    function updateVipUI() {
      const wagered = userData.totalWagered || 0;
      const vip = getVipLevel(wagered);
      const nextVip = VIP_LEVELS[Math.min(vip.index + 1, VIP_LEVELS.length - 1)];
      
      // –ó–Ω–∞—á–æ–∫ —É –ø—Ä–æ—Ñ—ñ–ª—ñ
      const slotikyHeaderEl = document.getElementById('headerSlotiky');
      if(slotikyHeaderEl) slotikyHeaderEl.textContent = formatNumber(userData.slotiky||0);
      const badge = document.getElementById('profileVipBadge');
      if(badge) badge.innerHTML = `<span class="vip-badge vip-${vip.class}">${vip.icon} ${vip.name}</span>`;

      // VIP –µ–∫—Ä–∞–Ω
      const card = document.getElementById('vipCurrentCard');
      if(!card) return;
      card.className = `vip-card ${vip.class}`;
      document.getElementById('vipLevelName').textContent = `${vip.icon} ${vip.name}`;
      document.getElementById('vipWagered').textContent = formatNumber(wagered) + ' ‚Ç¥';

      const fill = document.getElementById('vipProgressFill');
      if(vip.index < VIP_LEVELS.length - 1) {
        const pct = Math.min(100, ((wagered - vip.min) / (nextVip.min - vip.min)) * 100);
        fill.style.width = pct + '%';
        fill.style.background = vip.cssVar;
        document.getElementById('vipProgLeft').textContent = formatNumber(wagered - vip.min) + ' ‚Ç¥';
        document.getElementById('vipProgRight').textContent = `–¥–æ ${nextVip.icon} ${nextVip.name}: ${formatNumber(nextVip.min)} ‚Ç¥`;
      } else {
        fill.style.width = '100%';
        fill.style.background = 'var(--plat)';
        document.getElementById('vipProgRight').textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å! üèÜ';
      }

      // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø–æ–≥–æ–¥–∏–Ω–Ω–æ–≥–æ VIP
      ['bronze','silver','gold','plat'].forEach((t, i) => {
        const el = document.getElementById('hvt-' + t);
        if(el) el.classList.toggle('active', i === vip.index);
      });
    }

    // ============================================
    // ===== –ü–û–ì–û–î–ò–ù–ù–ò–ô –ë–û–ù–£–° =====
    // ============================================
    let hourlyTimerInterval = null;

    function initHourlyBonus() {
      updateVipUI();
      const vip = getVipLevel(userData.totalWagered || 0);
      document.getElementById('hourlyBonusAmount').textContent = vip.hourly;
      updateHourlyTimer();
      if(hourlyTimerInterval) clearInterval(hourlyTimerInterval);
      hourlyTimerInterval = setInterval(updateHourlyTimer, 1000);
      loadHourlyHistory();
    }

    function updateHourlyTimer() {
      const last = userData.lastHourlyBonus || 0;
      const now = Date.now();
      const hourMs = 3600000;
      const diff = now - last;
      const ring = document.getElementById('hourlyRing');
      const timerText = document.getElementById('hourlyTimerText');
      const statusText = document.getElementById('hourlyStatusText');
      const claimBtn = document.getElementById('hourlyClaimBtn');
      if(!ring) return;

      if(diff >= hourMs) {
        ring.classList.add('ready');
        ring.textContent = 'üéÅ';
        timerText.textContent = '–ì–æ—Ç–æ–≤–æ!';
        timerText.style.color = 'var(--green)';
        statusText.textContent = '–ù–∞—Ç–∏—Å–Ω–∏ —â–æ–± –∑–∞–±—Ä–∞—Ç–∏ –±–æ–Ω—É—Å';
        claimBtn.classList.remove('hidden');
      } else {
        ring.classList.remove('ready');
        ring.textContent = '‚è∞';
        const left = hourMs - diff;
        const m = Math.floor(left / 60000);
        const s = Math.floor((left % 60000) / 1000);
        timerText.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        timerText.style.color = 'var(--accent)';
        statusText.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∏–π –±–æ–Ω—É—Å —á–µ—Ä–µ–∑';
        claimBtn.classList.add('hidden');
      }
    }

    function claimHourlyBonus() {
      const last = userData.lastHourlyBonus || 0;
      if(Date.now() - last < 3600000) return notify('–©–µ –Ω–µ —á–∞—Å! –ó–∞—á–µ–∫–∞–π –≥–æ–¥–∏–Ω—É.', 'error');
      const vip = getVipLevel(userData.totalWagered || 0);
      const amount = vip.hourly;
      db.ref('users/' + currentUser).update({
        balance: (userData.balance || 0) + amount,
        lastHourlyBonus: Date.now()
      });
      db.ref('users/' + currentUser + '/hourlyHistory').push({ amount, time: Date.now(), vip: vip.name });
      addToHistory(`Hourly Bonus +${amount}‚Ç¥ (${vip.name})`);
      playSound('win');
      notify(`‚è∞ –ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –±–æ–Ω—É—Å: +${amount} ‚Ç¥ (${vip.icon} ${vip.name})`, 'success');
      loadHourlyHistory();
    }

    function loadHourlyHistory() {
      db.ref('users/' + currentUser + '/hourlyHistory').limitToLast(5).once('value', snap => {
        const el = document.getElementById('hourlyHistory');
        if(!el) return;
        const data = snap.val();
        if(!data) { el.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:10px 0;">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</div>'; return; }
        el.innerHTML = '';
        Object.values(data).reverse().forEach(h => {
          const t = new Date(h.time).toLocaleString('uk-UA', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
          el.innerHTML += `<div style="display:flex;justify-content:space-between;padding:8px 10px;background:#111;border-radius:8px;margin-bottom:5px;font-size:13px;">
            <span style="color:#777;">${t}</span>
            <span style="color:var(--green);font-weight:bold;">+${h.amount} ‚Ç¥</span>
          </div>`;
        });
      });
    }

    // ============================================
    // ===== –õ–£–¢-–ë–û–ö–°–ò =====
    // ============================================
    const LOOTBOX_CONFIGS = {
      common: {
        name: 'Common Box', icon: 'üì¶', price: 150, color: '#aaa',
        prizes: [
          { weight: 40, mult: 0.5, label: '–í—Ç—ñ—à–Ω–∏–π –ø—Ä–∏–∑' },
          { weight: 35, mult: 1.0, label: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è' },
          { weight: 15, mult: 2.0, label: '–ü–æ–¥–≤–æ—î–Ω–Ω—è!' },
          { weight: 7,  mult: 4.0, label: 'üî• –ì–∞—Ä—è—á–∏–π –ø—Ä–∏–∑!' },
          { weight: 3,  mult: 10.0, label: 'üí• –î–ñ–ï–ö–ü–û–¢!' },
        ]
      },
      rare: {
        name: 'Rare Box', icon: 'üí†', price: 500, color: '#4a9eff',
        prizes: [
          { weight: 35, mult: 0.5, label: '–í—Ç—ñ—à–Ω–∏–π –ø—Ä–∏–∑' },
          { weight: 30, mult: 1.2, label: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è' },
          { weight: 20, mult: 2.5, label: '–ü–æ–¥–≤–æ—î–Ω–Ω—è!' },
          { weight: 10, mult: 5.0, label: 'üî• –ì–∞—Ä—è—á–∏–π –ø—Ä–∏–∑!' },
          { weight: 5,  mult: 12.0, label: 'üí• –î–ñ–ï–ö–ü–û–¢!' },
        ]
      },
      epic: {
        name: 'Epic Box', icon: 'üíú', price: 2000, color: '#b57bee',
        prizes: [
          { weight: 30, mult: 0.6, label: '–í—Ç—ñ—à–Ω–∏–π –ø—Ä–∏–∑' },
          { weight: 30, mult: 1.5, label: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è' },
          { weight: 20, mult: 3.0, label: '–ü–æ—Ç—Ä—ñ–π–Ω–∏–π –ø—Ä–∏–∑!' },
          { weight: 12, mult: 6.0, label: 'üî• –í–µ–ª–∏–∫–∏–π –ø—Ä–∏–∑!' },
          { weight: 8,  mult: 15.0, label: 'üí• –ï–ü–Ü–ß–ù–ò–ô –î–ñ–ï–ö–ü–û–¢!' },
        ]
      }
    };

    function rollLootbox(config) {
      const total = config.prizes.reduce((s, p) => s + p.weight, 0);
      let r = Math.random() * total;
      for(const p of config.prizes) { r -= p.weight; if(r <= 0) return p; }
      return config.prizes[config.prizes.length - 1];
    }

    function openLootbox(type) {
      const cfg = LOOTBOX_CONFIGS[type];
      if(userData.balance < cfg.price) return notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${cfg.price} ‚Ç¥`, 'error');

      // –°–ø–∏—Å—É—î–º–æ –≥—Ä–æ—à—ñ
      db.ref('users/' + currentUser).update({ balance: userData.balance - cfg.price });
      addWager(cfg.price);
      trackQuest('openLootbox', 1);

      const prize = rollLootbox(cfg);
      const win = Math.floor(cfg.price * prize.mult);

      // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è
      const resultScreen = document.getElementById('lootboxResultScreen');
      resultScreen.classList.remove('hidden');
      document.getElementById('lbOpenEmoji').textContent = cfg.icon;
      document.getElementById('lbWinAmount').textContent = '+' + win + ' ‚Ç¥';
      document.getElementById('lbWinAmount').style.color = prize.mult >= 5 ? 'var(--green)' : 'var(--accent)';
      document.getElementById('lbWinType').textContent = `${cfg.name} ‚Ä¢ ${prize.label}`;

      // –ù–∞—Ä–∞—Ö–æ–≤—É—î–º–æ –≤–∏–≥—Ä–∞—à
      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(win));
      db.ref('users/' + currentUser + '/lootboxHistory').push({ type, win, price: cfg.price, time: Date.now() });
      addToHistory(`LootBox ${cfg.name}: +${win} ‚Ç¥`);
      playSound(prize.mult >= 2 ? 'win' : 'click');
      loadLootboxHistory();
    }

    function closeLootboxResult() {
      document.getElementById('lootboxResultScreen').classList.add('hidden');
    }

    function loadLootboxHistory() {
      db.ref('users/' + currentUser + '/lootboxHistory').limitToLast(5).once('value', snap => {
        const el = document.getElementById('lootboxHistory');
        if(!el) return;
        const data = snap.val();
        if(!data) return;
        el.innerHTML = '';
        Object.values(data).reverse().forEach(h => {
          const cfg = LOOTBOX_CONFIGS[h.type];
          const t = new Date(h.time).toLocaleString('uk-UA', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
          const profit = h.win - h.price;
          const color = profit >= 0 ? 'var(--green)' : 'var(--red)';
          el.innerHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#111;border-radius:8px;margin-bottom:5px;font-size:13px;">
            <span>${cfg ? cfg.icon : 'üì¶'} ${cfg ? cfg.name : h.type}</span>
            <span style="color:#777;">${t}</span>
            <span style="color:${color};font-weight:bold;">${profit >= 0 ? '+' : ''}${profit} ‚Ç¥</span>
          </div>`;
        });
      });
    }

    // ============================================
    // ===== –ö–í–ï–°–¢–ò =====
    // ============================================
    const DAILY_QUESTS = [
      { id: 'playSlots5',    icon: 'üé∞', title: '–ó—ñ–≥—Ä–∞–π —É —Å–ª–æ—Ç–∏ 5 —Ä–∞–∑—ñ–≤',      reward: 150, goal: 5,  key: 'slotsPlayed' },
      { id: 'winBJ',         icon: 'üÉè', title: '–í–∏–≥—Ä–∞–π —É –±–ª–µ–∫–¥–∂–µ–∫ 2 —Ä–∞–∑–∏',    reward: 200, goal: 2,  key: 'bjWins' },
      { id: 'roulette3',     icon: 'üé°', title: '–ó—Ä–æ–±–∏ 3 —Å—Ç–∞–≤–∫–∏ –≤ —Ä—É–ª–µ—Ç—Ü—ñ',    reward: 100, goal: 3,  key: 'rouletteBets' },
      { id: 'crashCashout',  icon: 'üöÄ', title: '–ó—Ä–æ–±–∏ –∫–µ—à–∞—É—Ç —É –ö—Ä–∞—à—ñ',        reward: 300, goal: 1,  key: 'crashCashouts' },
      { id: 'openLootbox',   icon: 'üì¶', title: '–í—ñ–¥–∫—Ä–∏–π –ª—É—Ç-–±–æ–∫—Å',            reward: 100, goal: 1,  key: 'lootboxOpened' },
    ];

    const WEEKLY_QUESTS = [
      { id: 'play50games',   icon: 'üéÆ', title: '–ó—ñ–≥—Ä–∞–π 50 —ñ–≥–æ—Ä',              reward: 1000, goal: 50, key: 'totalGames' },
      { id: 'wager10k',      icon: 'üí∞', title: '–ü–æ—Å—Ç–∞–≤ 10 000 ‚Ç¥ —Å—É–º–∞—Ä–Ω–æ',    reward: 500,  goal: 10000, key: 'weekWager', isAmount: true },
      { id: 'openBox3',      icon: 'üì¶', title: '–í—ñ–¥–∫—Ä–∏–π 3 –ª—É—Ç-–±–æ–∫—Å–∏',         reward: 800,  goal: 3,  key: 'lootboxOpened' },
    ];

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function getWeekStr()  {
      const d = new Date(); const day = d.getDay();
      d.setDate(d.getDate() - day); return d.toISOString().split('T')[0];
    }

    function trackQuest(key, amount = 1) {
      const today = getTodayStr();
      const week  = getWeekStr();
      const dqPath = `users/${currentUser}/quests/daily/${today}`;
      const wqPath = `users/${currentUser}/quests/weekly/${week}`;

      db.ref(dqPath + '/' + key).transaction(v => (v || 0) + amount);
      db.ref(wqPath + '/' + key).transaction(v => (v || 0) + amount);

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ñ –∫–≤–µ—Å—Ç–∏ —ñ –ø–æ–∫–∞–∑—É—î–º–æ –∑–Ω–∞—á–æ–∫
      db.ref(`users/${currentUser}/quests/daily/${today}`).once('value', snap => {
        const prog = snap.val() || {};
        const readyCount = DAILY_QUESTS.filter(q => {
          const claimed = userData.quests?.daily?.[today]?.['claimed_' + q.id];
          return !claimed && (prog[q.key] || 0) >= q.goal;
        }).length;
        const badge = document.getElementById('questsBadge');
        if(badge) badge.classList.toggle('hidden', readyCount === 0);
      });
    }

    function renderQuestCard(q, progress, claimed, onClaim) {
      const done = progress >= q.goal;
      const pct = Math.min(100, (progress / q.goal) * 100);
      const statusClass = claimed ? 'claimed' : done ? 'done' : '';
      return `<div class="quest-card ${statusClass}">
        <div class="quest-header">
          <span class="quest-icon">${q.icon}</span>
          <span class="quest-title">${q.title}</span>
          <span class="quest-reward">+${q.reward} ‚Ç¥</span>
        </div>
        <div class="quest-prog-bar"><div class="quest-prog-fill" style="width:${pct}%"></div></div>
        <div class="quest-prog-text">${q.isAmount ? formatNumber(progress) + ' / ' + formatNumber(q.goal) + ' ‚Ç¥' : progress + ' / ' + q.goal}</div>
        ${done && !claimed ? `<button class="quest-claim-btn" onclick="claimQuest('${q.id}','${onClaim}',${q.reward})">üéÅ –ó–ê–ë–†–ê–¢–ò ${q.reward} ‚Ç¥</button>` : ''}
        ${claimed ? '<div style="color:var(--green);font-size:12px;margin-top:6px;text-align:center;">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ —ñ –æ—Ç—Ä–∏–º–∞–Ω–æ</div>' : ''}
      </div>`;
    }

    function loadQuests() {
      const today = getTodayStr();
      const week  = getWeekStr();

      db.ref(`users/${currentUser}/quests/daily/${today}`).once('value', snap => {
        const prog = snap.val() || {};
        const list = document.getElementById('questsList');
        if(!list) return;
        list.innerHTML = DAILY_QUESTS.map(q => {
          const claimed = prog['claimed_' + q.id];
          const progress = prog[q.key] || 0;
          return renderQuestCard(q, progress, claimed, 'daily/' + today);
        }).join('');
        // –û–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–æ–∫
        const readyCount = DAILY_QUESTS.filter(q => !prog['claimed_' + q.id] && (prog[q.key] || 0) >= q.goal).length;
        const badge = document.getElementById('questsBadge');
        if(badge) badge.classList.toggle('hidden', readyCount === 0);
      });

      db.ref(`users/${currentUser}/quests/weekly/${week}`).once('value', snap => {
        const prog = snap.val() || {};
        const list = document.getElementById('weeklyQuestsList');
        if(!list) return;
        list.innerHTML = WEEKLY_QUESTS.map(q => {
          const claimed = prog['claimed_' + q.id];
          const progress = prog[q.key] || 0;
          return renderQuestCard(q, progress, claimed, 'weekly/' + week);
        }).join('');
      });

      // –¢–∞–π–º–µ—Ä –¥–æ —Å–∫–∏–¥–∞–Ω–Ω—è
      const timerEl = document.getElementById('questTimerDisplay');
      if(timerEl) {
        const now = new Date();
        const midnight = new Date(); midnight.setHours(24,0,0,0);
        const left = midnight - now;
        const h = Math.floor(left / 3600000);
        const m = Math.floor((left % 3600000) / 60000);
        timerEl.textContent = `–°–∫–∏–¥–∞–Ω–Ω—è —á–µ—Ä–µ–∑ ${h}–≥–æ–¥ ${m}—Ö–≤`;
      }
    }

    function claimQuest(questId, pathSuffix, reward) {
      db.ref(`users/${currentUser}/quests/${pathSuffix}/claimed_${questId}`).set(true);
      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(reward));
      addToHistory(`Quest "${questId}": +${reward}‚Ç¥`);
      playSound('win');
      notify(`üìã –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ! +${reward} ‚Ç¥`, 'success');
      setTimeout(loadQuests, 300);
    }

    // ============================================
    // –û–ù–û–í–õ–ï–ù–ù–Ø switchTab + –Ü–ù–¢–ï–ì–†–ê–¶–Ü–Ø –ö–í–ï–°–¢–Ü–í
    // ============================================
    const _origSwitchTab = switchTab;
    function switchTab(id, el) {
      document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
      const tab = document.getElementById('tab-'+id);
      if(tab) tab.classList.remove('hidden');
      if(el){ document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); }
      if(id==='chat') initLobbyChat();
      if(id==='keno') initKeno();
      if(id==='fortune') { setTimeout(()=>drawFortuneWheel(0), 50); }
      if(id==='duels') loadDuels();
      if(id==='tournaments') loadTournaments();
      if(id==='referrals') initReferrals();
      if(id==='admin') loadAdminStats();
      if(id==='scratch') { const g=document.getElementById('scratchGrid'); if(!g.children.length) scratchReset(); }
      if(id==='vip') updateVipUI();
      if(id==='quests') loadQuests();
      if(id==='lootboxes') loadLootboxHistory();
      if(id==='hourly') initHourlyBonus();
      if(id==='clans') loadClanTab();
      if(id==='leaderboard') loadLeaderboard('balance', document.querySelector('.lb-tab'));
      if(id==='gifts') { loadInboxGifts(); }
      if(id==='monopoly') { const s = document.getElementById('monoStartScreen'); if(s) s.classList.remove('hidden'); }
      if(id==='cardgame') { document.getElementById('cgStartScreen').classList.remove('hidden'); document.getElementById('cgGameScreen').classList.add('hidden'); document.getElementById('cgOnlineLobby').classList.add('hidden'); }
      if(id==='tower') { towerReset(); setTimeout(()=>{if(document.getElementById('towerStartArea'))document.getElementById('towerStartArea').classList.remove('hidden');},50); }
      if(id==='hilo') { hiloState=null; document.getElementById('hiloGameArea')?.classList.add('hidden'); }
      if(id==='dice') { updateDiceUI(); }
      if(id==='slotiky') { initSlotiky(); }
      if(id==='tournaments') { loadTournamentsV2(); loadTourneyStatsBar(); }
      if(id==='sports') { loadRealSportMatches(sportsCurrentSport||'soccer', document.querySelector('.sport-tab-btn.active')||document.querySelector('.sport-tab-btn')); loadSportMyBets(); checkPendingBetsOnStartup(); }
      if(id==='cashier') { switchCashierTab('deposit', document.getElementById('ctb-deposit')); setTimeout(()=>updateCashierCashbackUI(),300); }
      if(id==='monopoly-mp') { loadMpRooms(); }
      if(id==='notifications') { renderNotifs(); }
      if(id==='settings') { loadSettings(); }
      if(id==='home') { initHomeTab(); updateHomeStats(); }
    }

    function scratchReset() {
      document.getElementById('scratchGrid').innerHTML = '<div style="text-align:center;color:#777;grid-column:1/-1;padding:20px;">–ö—É–ø–∏ –∫–∞—Ä—Ç–∫—É —â–æ–± –≥—Ä–∞—Ç–∏</div>';
      document.getElementById('scratchBuyBtn').classList.remove('hidden');
    }


    // ============================================
    // ===== MONO PASS (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∫—É–ø—ñ–≤–ª—é) =====
    // ============================================
    function monoPass() {
      const buyBtn  = document.getElementById('monoBuyBtn');
      const passBtn = document.getElementById('monoPassBtn');
      if(buyBtn)  buyBtn.disabled  = true;
      if(passBtn) passBtn.disabled = true;
      monoLog('‚è≠ –í–∏ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –∫—É–ø—ñ–≤–ª—é', 'info');
      setTimeout(monoAiTurn, 500);
    }

    // ============================================
    // ===== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø =====
    // ============================================
    let appSettings = {};

    function loadSettings() {
      try {
        appSettings = JSON.parse(localStorage.getItem('slotok_settings') || '{}');
      } catch(e) { appSettings = {}; }
      applyAllSettings();
      // Update currency mini display in settings
      const cur = CURRENCIES[currentCurrency] || CURRENCIES.UAH;
      const flagEl = document.getElementById('settingCurrencyFlag');
      const nameEl = document.getElementById('settingCurrencyName');
      if(flagEl) flagEl.textContent = cur.flag;
      if(nameEl) nameEl.textContent = cur.name + ' (' + cur.code + ')';
      buildMiniRatesList();
    }

    function buildMiniRatesList() {
      const el = document.getElementById('miniRatesList'); if(!el) return;
      el.innerHTML = '';
      const rateInfoEl = document.getElementById('settingRateInfo');
      const keys = ['USD','EUR','PLN','BTC','ETH','SOL'];
      keys.forEach(code => {
        const cur = CURRENCIES[code]; if(!cur) return;
        const rate = currencyRates[code];
        if(!rate) return;
        const uahPer1 = 1/rate;
        const fmt = uahPer1 >= 1 ? uahPer1.toLocaleString('uk-UA',{maximumFractionDigits:1}) : uahPer1.toFixed(6);
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;justify-content:space-between;color:#888;padding:2px 0;';
        div.innerHTML = '<span>' + cur.flag + ' ' + code + '</span><span style="color:var(--accent);">' + fmt + '‚Ç¥</span>';
        el.appendChild(div);
      });
      if(rateInfoEl && ratesLastFetch) {
        rateInfoEl.textContent = '–û–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date(ratesLastFetch).toLocaleTimeString('uk-UA');
      } else if(rateInfoEl) {
        rateInfoEl.textContent = '–ö–ª—ñ–∫–∏ –Ω–∞ –≤–∞–ª—é—Ç—É ‚Üí –∑–º—ñ–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è';
      }
    }

    function saveSetting(key, val) {
      appSettings[key] = val;
      localStorage.setItem('slotok_settings', JSON.stringify(appSettings));
      if(key === 'sounds') {
        notify(val ? 'üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ' : 'üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ', 'info');
      }
    }

    function getSetting(key, def) {
      return appSettings[key] !== undefined ? appSettings[key] : def;
    }

    function applyAllSettings() {
      // Sync toggles
      const ids = { sounds:'settingSounds', music:'settingMusic', vibrate:'settingVibrate', notifs:'settingNotifs', giftNotifs:'settingGiftNotifs', bonusNotifs:'settingBonusNotifs' };
      const defaults = { sounds:true, music:false, vibrate:true, notifs:true, giftNotifs:true, bonusNotifs:true };
      Object.entries(ids).forEach(([key, id]) => {
        const el = document.getElementById(id);
        if(el) el.checked = getSetting(key, defaults[key]);
      });
      // Font size
      const fs = getSetting('fontSize', '16');
      const fsel = document.getElementById('settingFontSize');
      if(fsel) fsel.value = fs;
      applyFontSize(fs);
      // Theme
      const theme = getSetting('theme', 'dark');
      applyThemeVars(theme);
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
      const td = document.getElementById('theme-' + theme);
      if(td) td.classList.add('active');
      // Lang
      const lang = getSetting('lang', 'uk');
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      const lb = document.getElementById('lang-' + lang);
      if(lb) lb.classList.add('active');
    }

    function applyFontSize(size) {
      document.body.style.fontSize = size + 'px';
    }

    const THEMES = {
      dark:  { bg:'#050505', box:'#141414', border:'#333', input:'#1a1a1a', text:'#fff' },
      light: { bg:'#f0f0f0', box:'#ffffff', border:'#ddd', input:'#e8e8e8', text:'#111' },
      blue:  { bg:'#050518', box:'#0d0d2e', border:'#1a1a55', input:'#0a0a22', text:'#e0e8ff' },
      green: { bg:'#030e03', box:'#071407', border:'#0d2a0d', input:'#051005', text:'#d0f0d0' },
      red:   { bg:'#0e0303', box:'#1a0505', border:'#3a0a0a', input:'#120404', text:'#ffe0e0' },
    };

    function applyThemeVars(theme) {
      const t = THEMES[theme] || THEMES.dark;
      const root = document.documentElement;
      root.style.setProperty('--bg', t.bg);
      root.style.setProperty('--box', t.box);
      root.style.setProperty('--border', t.border);
      root.style.setProperty('--input', t.input);
      root.style.setProperty('--text', t.text);
      document.body.style.background = t.bg;
      document.body.style.color = t.text;
      document.body.setAttribute('data-theme', theme);

      // Apply theme-specific overrides inline for elements that use hardcoded colors
      const styleId = 'theme-override-style';
      let styleEl = document.getElementById(styleId);
      if(!styleEl) { styleEl = document.createElement('style'); styleEl.id = styleId; document.head.appendChild(styleEl); }
      styleEl.textContent = `
        body, .header, .bottom-nav, .screen, .modal-content { background-color: ${t.bg} !important; color: ${t.text} !important; }
        .box, .game-card, .game-thumb, .home-tabs, .home-tab-btn, .mp-size-btn,
        .chat-box, .chat-msg, .mono-log, .news-card, .settings-section, .settings-row,
        .bot-card, .cg-room-card, .mp-room-card, .vip-card, .notif-item { background-color: ${t.box} !important; border-color: ${t.border} !important; color: ${t.text} !important; }
        input, select, textarea { background-color: ${t.input} !important; border-color: ${t.border} !important; color: ${t.text} !important; }
        .home-tab-btn.active { background-color: ${t.input} !important; }
        .chat-msg.mine { background: ${theme==='dark'?'rgba(212,175,55,0.06)':theme==='blue'?'rgba(100,150,255,0.1)':theme==='green'?'rgba(76,217,100,0.1)':theme==='red'?'rgba(255,100,80,0.1)':'rgba(0,100,200,0.1)'} !important; }
        .chat-body-text { color: ${theme==='light'?'#333':'#ccc'} !important; }
        .section-header { color: ${theme==='light'?'#555':'#777'} !important; }
        .nav-item span:last-child { color: ${theme==='light'?'#555':'#777'} !important; }
        .nav-item.active span { color: var(--accent) !important; }
      `;
    }

    function setTheme(theme, el) {
      saveSetting('theme', theme);
      applyThemeVars(theme);
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
      el.classList.add('active');
      notify('üé® –¢–µ–º–∞ –∑–º—ñ–Ω–µ–Ω–∞', 'info');
    }

    // ============================================================
    // ===== MULTILANG SYSTEM =====
    // ============================================================
    const TRANSLATIONS = {
      uk: {
        nav_home:'–ì–æ–ª–æ–≤–Ω–∞', nav_casino:'–ö–∞–∑–∏–Ω–æ', nav_cashier:'–ö–∞—Å–∞',
        nav_notif:'–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è', nav_profile:'–ü—Ä–æ—Ñ—ñ–ª—å', nav_settings:'–ù–∞–ª–∞—à—Ç.',
        nav_more:'–©–µ', nav_sport:'–°–ø–æ—Ä—Ç',
        home_popular:'üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ', home_all_games:'–í—Å—ñ —ñ–≥—Ä–∏ ‚û°',
        cashier_deposit:'üí≥ –ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è', cashier_withdraw:'üí∏ –í–∏–≤—ñ–¥', cashier_rates:'üìä –ö—É—Ä—Å–∏',
        sport_title:'–°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç', sport_refresh:'üîÑ –û–Ω–æ–≤–∏—Ç–∏',
        sport_loading:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤...',
        sport_my_bets:'üìã –ú–æ—ó —Å—Ç–∞–≤–∫–∏', sport_no_bets:'–ù–µ–º–∞—î —Å—Ç–∞–≤–æ–∫',
        bet_slip_title:'üéØ –ö—É–ø–æ–Ω —Å—Ç–∞–≤–∫–∏', bet_slip_odds:'–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç',
        bet_slip_potential:'–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–∏–≥—Ä–∞—à', bet_confirm:'‚úÖ –ü–Ü–î–¢–í–ï–†–î–ò–¢–ò –°–¢–ê–í–ö–£',
        lobby_title:'üé∞ –Ü–≥—Ä–∏', profile_title:'–ü—Ä–æ—Ñ—ñ–ª—å',
        settings_title:'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è', settings_lang:'–ú–æ–≤–∞',
        settings_theme:'–¢–µ–º–∞', settings_sound:'–ó–≤—É–∫–∏',
        tab_top:'üèÜ –†–ï–ô–¢–ò–ù–ì –ì–†–ê–í–¶–Ü–í',
        live_view:'üî¥ LIVE –ü–ï–†–ï–ì–õ–Ø–î', loading:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...',
        ai_pick:'ü§ñ –®–Ü:', odd_h:'–ü1', odd_x:'–ù—ñ—á–∏—è', odd_a:'–ü2',
        back:'‚¨Ö –õ–æ–±—ñ', deposit_title:'–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram',
        withdraw_title:'üí∏ –í–∏–≤—ñ–¥ –∫–æ—à—Ç—ñ–≤', my_withdraws:'–ú–æ—ó –∑–∞—è–≤–∫–∏',
        hero_bonus:'üéÅ –ë–û–ù–£–° 250%', hero_sub:'–í—ñ—Ç–∞–ª—å–Ω–∏–π –±–æ–Ω—É—Å –Ω–∞ –ø–µ—Ä—à–∏–π –¥–µ–ø–æ–∑–∏—Ç',
        win_feed:'üî¥ LIVE', quest_header:'üìã –ó–∞–≤–¥–∞–Ω–Ω—è', vip_header:'üëë VIP –°—Ç–∞—Ç—É—Å',
      },
      en: {
        nav_home:'Home', nav_casino:'Casino', nav_cashier:'Cashier',
        nav_notif:'Notifications', nav_profile:'Profile', nav_settings:'Settings',
        nav_more:'More', nav_sport:'Sports',
        home_popular:'üî• Popular', home_all_games:'All games ‚û°',
        cashier_deposit:'üí≥ Deposit', cashier_withdraw:'üí∏ Withdraw', cashier_rates:'üìä Rates',
        sport_title:'Sports Betting', sport_refresh:'üîÑ Refresh',
        sport_loading:'Loading matches...',
        sport_my_bets:'üìã My Bets', sport_no_bets:'No bets',
        bet_slip_title:'üéØ Bet Slip', bet_slip_odds:'Odds',
        bet_slip_potential:'Potential Win', bet_confirm:'‚úÖ PLACE BET',
        lobby_title:'üé∞ Games', profile_title:'Profile',
        settings_title:'Settings', settings_lang:'Language',
        settings_theme:'Theme', settings_sound:'Sounds',
        tab_top:'üèÜ LEADERBOARD',
        live_view:'üî¥ LIVE VIEW', loading:'Loading...',
        ai_pick:'ü§ñ AI:', odd_h:'Home', odd_x:'Draw', odd_a:'Away',
        back:'‚¨Ö Lobby', deposit_title:'Deposit via Telegram',
        withdraw_title:'üí∏ Withdraw', my_withdraws:'My Requests',
        hero_bonus:'üéÅ BONUS 250%', hero_sub:'Welcome bonus on first deposit',
        win_feed:'üî¥ LIVE', quest_header:'üìã Quests', vip_header:'üëë VIP Status',
      },
      ru: {
        nav_home:'–ì–ª–∞–≤–Ω–∞—è', nav_casino:'–ö–∞–∑–∏–Ω–æ', nav_cashier:'–ö–∞—Å—Å–∞',
        nav_notif:'–£–≤–µ–¥–æ–º–ª.', nav_profile:'–ü—Ä–æ—Ñ–∏–ª—å', nav_settings:'–ù–∞—Å—Ç—Ä.',
        nav_more:'–ï—â—ë', nav_sport:'–°–ø–æ—Ä—Ç',
        home_popular:'üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ', home_all_games:'–í—Å–µ –∏–≥—Ä—ã ‚û°',
        cashier_deposit:'üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ', cashier_withdraw:'üí∏ –í—ã–≤–æ–¥', cashier_rates:'üìä –ö—É—Ä—Å—ã',
        sport_title:'–°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç', sport_refresh:'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',
        sport_loading:'–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...',
        sport_my_bets:'üìã –ú–æ–∏ —Å—Ç–∞–≤–∫–∏', sport_no_bets:'–ù–µ—Ç —Å—Ç–∞–≤–æ–∫',
        bet_slip_title:'üéØ –ö—É–ø–æ–Ω', bet_slip_odds:'–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç',
        bet_slip_potential:'–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à', bet_confirm:'‚úÖ –ü–û–î–¢–í–ï–†–î–ò–¢–¨',
        lobby_title:'üé∞ –ò–≥—Ä—ã', profile_title:'–ü—Ä–æ—Ñ–∏–ª—å',
        settings_title:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', settings_lang:'–Ø–∑—ã–∫',
        settings_theme:'–¢–µ–º–∞', settings_sound:'–ó–≤—É–∫–∏',
        tab_top:'üèÜ –†–ï–ô–¢–ò–ù–ì –ò–ì–†–û–ö–û–í',
        live_view:'üî¥ LIVE –ü–†–û–°–ú–û–¢–†', loading:'–ó–∞–≥—Ä—É–∑–∫–∞...',
        ai_pick:'ü§ñ –ò–ò:', odd_h:'–ü1', odd_x:'–ù–∏—á—å—è', odd_a:'–ü2',
        back:'‚¨Ö –õ–æ–±–±–∏', deposit_title:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram',
        withdraw_title:'üí∏ –í—ã–≤–æ–¥', my_withdraws:'–ú–æ–∏ –∑–∞—è–≤–∫–∏',
        hero_bonus:'üéÅ –ë–û–ù–£–° 250%', hero_sub:'–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç',
        win_feed:'üî¥ LIVE', quest_header:'üìã –ó–∞–¥–∞–Ω–∏—è', vip_header:'üëë VIP –°—Ç–∞—Ç—É—Å',
      },
      pl: {
        nav_home:'G≈Ç√≥wna', nav_casino:'Kasyno', nav_cashier:'Kasa',
        nav_notif:'Powiad.', nav_profile:'Profil', nav_settings:'Ustaw.',
        nav_more:'Wiƒôcej', nav_sport:'Sport',
        home_popular:'üî• Popularne', home_all_games:'Wszystkie gry ‚û°',
        cashier_deposit:'üí≥ Wp≈Çata', cashier_withdraw:'üí∏ Wyp≈Çata', cashier_rates:'üìä Kursy',
        sport_title:'Zak≈Çady Sportowe', sport_refresh:'üîÑ Od≈õwie≈º',
        sport_loading:'≈Åadowanie mecz√≥w...',
        sport_my_bets:'üìã Moje zak≈Çady', sport_no_bets:'Brak zak≈Çad√≥w',
        bet_slip_title:'üéØ Kupon', bet_slip_odds:'Kurs',
        bet_slip_potential:'Potencjalna wygrana', bet_confirm:'‚úÖ POSTAW ZAK≈ÅAD',
        lobby_title:'üé∞ Gry', profile_title:'Profil',
        settings_title:'Ustawienia', settings_lang:'Jƒôzyk',
        settings_theme:'Motyw', settings_sound:'D≈∫wiƒôki',
        tab_top:'üèÜ RANKING GRACZY',
        live_view:'üî¥ NA ≈ªYWO', loading:'≈Åadowanie...',
        ai_pick:'ü§ñ AI:', odd_h:'1', odd_x:'X', odd_a:'2',
        back:'‚¨Ö Lobby', deposit_title:'Wp≈Çata przez Telegram',
        withdraw_title:'üí∏ Wyp≈Çata', my_withdraws:'Moje wnioski',
        hero_bonus:'üéÅ BONUS 250%', hero_sub:'Bonus powitalny na pierwszy depozyt',
        win_feed:'üî¥ NA ≈ªYWO', quest_header:'üìã Zadania', vip_header:'üëë Status VIP',
      },
    };
    let currentLang = 'uk';

    function setLang(lang, el) {
      currentLang = lang;
      saveSetting('lang', lang);
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      if(el) el.classList.add('active');
      applyLang(lang);
      notify(lang==='uk'?'üá∫üá¶ –ú–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞':lang==='en'?'üá∫üá∏ Language: English':lang==='ru'?'üá∑üá∫ –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π':'üáµüá± Jƒôzyk: Polski', 'info');
    }

    function t(key) {
      const T = TRANSLATIONS[currentLang] || TRANSLATIONS.uk;
      return T[key] || TRANSLATIONS.uk[key] || key;
    }

    function applyLang(lang) {
      currentLang = lang;
      const T = TRANSLATIONS[lang] || TRANSLATIONS.uk;
      // Navigation
      const navTexts = document.querySelectorAll('.nav-item span:last-child');
      const navKeys  = ['nav_home','nav_casino','nav_cashier','nav_notif','nav_profile','nav_settings','nav_sport','nav_more'];
      navTexts.forEach((el, i) => { if(navKeys[i] && T[navKeys[i]]) el.textContent = T[navKeys[i]]; });
      // Cashier sub-tabs
      const ctabDep  = document.getElementById('ctab-deposit');  if(ctabDep)  ctabDep.textContent  = T.cashier_deposit  || ctabDep.textContent;
      const ctabWith = document.getElementById('ctab-withdraw'); if(ctabWith) ctabWith.textContent = T.cashier_withdraw || ctabWith.textContent;
      const ctabRat  = document.getElementById('ctab-rates');    if(ctabRat)  ctabRat.textContent  = T.cashier_rates    || ctabRat.textContent;
      // Hero
      const heroTitle = document.querySelector('.hero-title'); if(heroTitle) heroTitle.textContent = T.hero_bonus;
      // Sports
      const spTitle = document.querySelector('#tab-sports .sport-title-text'); if(spTitle) spTitle.textContent = T.sport_title;
      const spMyBets = document.getElementById('sportMyBets'); if(spMyBets && !spMyBets.children.length) spMyBets.textContent = T.sport_no_bets;
      // Bet slip
      const bsTitle = document.querySelector('#betSlipModal .bs-title'); if(bsTitle) bsTitle.textContent = T.bet_slip_title;
      // Save lang for page reload
      try { localStorage.setItem('slotok_lang', lang); } catch(e) {}
    }

    function loadSavedLang() {
      try {
        const saved = getSetting('lang') || localStorage.getItem('slotok_lang') || 'uk';
        currentLang = saved;
        const langBtn = document.getElementById('lang-'+saved);
        if(langBtn) { document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active')); langBtn.classList.add('active'); }
        if(saved !== 'uk') applyLang(saved);
      } catch(e) {}
    }

    // –ó–≤—É–∫–∏ - –ø–æ–≤–∞–∂–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (–ø—Ä—è–º–∞ –∑–∞–º—ñ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—ó)
    // (patch applied below - playSound checks settings inline)

    // ============================================
    // ===== –°–ü–û–í–Ü–©–ï–ù–ù–Ø =====
    // ============================================
    let allNotifs = [];
    let notifFilter = 'all';

    function pushNotif(type, icon, title, text, colorClass) {
      const id = 'n_' + Date.now() + '_' + Math.random();
      const notif = { id, type, icon, title, text, colorClass: colorClass||'', time: Date.now(), read: false };
      allNotifs.unshift(notif);
      if(allNotifs.length > 100) allNotifs = allNotifs.slice(0, 100);
      try { localStorage.setItem('slotok_notifs', JSON.stringify(allNotifs.slice(0, 50))); } catch(e){}
      updateNotifBadge();
    }

    function loadNotifsFromStorage() {
      try {
        allNotifs = JSON.parse(localStorage.getItem('slotok_notifs') || '[]');
      } catch(e) { allNotifs = []; }
    }

    function updateNotifBadge() {
      const unread = allNotifs.filter(n => !n.read).length;
      const dot = document.getElementById('notifNavBadge');
      if(dot) dot.classList.toggle('hidden', unread === 0);
    }

    function filterNotifs(f, el) {
      notifFilter = f;
      document.querySelectorAll('.notif-filter-btn').forEach(b => b.classList.remove('active'));
      if(el) el.classList.add('active');
      renderNotifs();
    }

    function renderNotifs() {
      const list = document.getElementById('notifList');
      if(!list) return;
      const filtered = notifFilter === 'all' ? allNotifs : allNotifs.filter(n => n.type === notifFilter);
      if(!filtered.length) {
        list.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:30px 0;">–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div>';
        return;
      }
      list.innerHTML = filtered.map(n => {
        const t = timeAgo(n.time);
        return '<div class="notif-item ' + (n.read ? '' : 'unread ' + (n.colorClass||'')) + '" onclick="readNotif(\'' + n.id + '\')">' +
          '<div class="notif-icon">' + n.icon + '</div>' +
          '<div class="notif-body">' +
            '<div class="notif-title">' + n.title + '</div>' +
            '<div class="notif-text">' + n.text + '</div>' +
            '<div class="notif-time">' + t + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function readNotif(id) {
      const n = allNotifs.find(x => x.id === id);
      if(n) n.read = true;
      try { localStorage.setItem('slotok_notifs', JSON.stringify(allNotifs.slice(0, 50))); } catch(e){}
      updateNotifBadge();
      renderNotifs();
    }

    function markAllNotifsRead() {
      allNotifs.forEach(n => n.read = true);
      try { localStorage.setItem('slotok_notifs', JSON.stringify(allNotifs.slice(0, 50))); } catch(e){}
      updateNotifBadge();
      renderNotifs();
    }

    function timeAgo(ts) {
      const diff = Date.now() - ts;
      if(diff < 60000) return '—â–æ–π–Ω–æ';
      if(diff < 3600000) return Math.floor(diff/60000) + ' —Ö–≤ —Ç–æ–º—É';
      if(diff < 86400000) return Math.floor(diff/3600000) + ' –≥–æ–¥ —Ç–æ–º—É';
      return new Date(ts).toLocaleDateString('uk-UA');
    }

    // –•—É–∫–∏ –¥–ª—è –∞–≤—Ç–æ-—Å–ø–æ–≤—ñ—â–µ–Ω—å
    const _origNotify = notify;
    window.notify = function(msg, type) {
      _origNotify(msg, type);
      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∑—É—î–º–æ
      if(msg.includes('–±–æ–Ω—É—Å') || msg.includes('–ë–æ–Ω—É—Å') || msg.includes('—â–æ–¥–µ–Ω–Ω–∏–π') || msg.includes('–ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π')) {
        pushNotif('bonus', 'üéÅ', '–ë–æ–Ω—É—Å', msg, 'green-notif');
      } else if(msg.includes('–ü–æ–¥–∞—Ä—É–Ω–æ–∫') || msg.includes('–ø–æ–¥–∞—Ä—É–Ω–æ–∫')) {
        pushNotif('gift', 'üéÄ', '–ü–æ–¥–∞—Ä—É–Ω–æ–∫', msg, 'green-notif');
      } else if(msg.includes('WIN') || msg.includes('–í–∏–≥—Ä–∞—à') || msg.includes('–≤–∏–≥—Ä–∞—à') || msg.includes('–≤–∏–≥—Ä–∞–ª–∏') || msg.includes('–ü–µ—Ä–µ–º–æ–≥–∞')) {
        pushNotif('game', 'üèÜ', '–í–∏–≥—Ä–∞—à', msg, 'green-notif');
      } else if(msg.includes('–ü—Ä–æ–≥—Ä–∞—à') || msg.includes('–ø—Ä–æ–≥—Ä–∞–ª–∏') || msg.includes('–ö—Ä–∞—à') || msg.includes('–ö–†–ê–®')) {
        pushNotif('game', 'üòî', '–ì—Ä–∞', msg, 'red-notif');
      } else if(type === 'success') {
        pushNotif('system', '‚úÖ', '–£—Å–ø—ñ—Ö', msg, 'green-notif');
      } else if(type === 'error') {
        // –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–º–∏–ª–∫–∏
      }
    };

    // ============================================
    // ===== –ú–£–õ–¨–¢–ò–ü–õ–ï–Ñ–† –ú–û–ù–û–ü–û–õ–Ü–Ø =====
    // ============================================
    let mpRoomId  = null;
    let mpIsHost  = false;
    let mpState   = null;
    let mpListener = null;

    function createMpRoom() {
      const bet = parseInt(document.getElementById('mpBetInput').value) || 500;
      if(bet < 100) return notify('–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç–∞–≤–∫–∞ 100‚Ç¥', 'error');
      if(userData.balance < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/' + currentUser).update({ balance: userData.balance - bet });

      const roomId = 'mp_' + currentUser + '_' + Date.now();
      mpRoomId = roomId;
      mpIsHost = true;

      db.ref('mp_rooms/' + roomId).set({
        host: currentUser, guest: null, bet,
        status: 'waiting', created: Date.now(),
        state: {
          hostMoney: 3000, guestMoney: 3000,
          hostPos: 0, guestPos: 0,
          props: {}, turn: 'host',
          jailHost: 0, jailGuest: 0,
          gameOver: false
        }
      });

      showMpWaitScreen(roomId, bet);
      listenMpRoom(roomId);
    }

    function showMpWaitScreen(roomId, bet) {
      document.getElementById('mpLobbyScreen').classList.add('hidden');
      document.getElementById('mpWaitScreen').classList.remove('hidden');
      document.getElementById('mpWaitInfo').textContent = '–ö—ñ–º–Ω–∞—Ç–∞: ' + roomId + ' ‚Ä¢ –°—Ç–∞–≤–∫–∞: ' + bet + '‚Ç¥';
      document.getElementById('mpWaitPlayers').innerHTML =
        '<div class="mp-player-slot filled">üßë ' + currentUser + '<br><small>–•–æ—Å—Ç</small></div>' +
        '<div class="mp-player-slot empty">‚ùì –û—á—ñ–∫—É–≤–∞–Ω–Ω—è...<br><small>–ì—ñ—Å—Ç—å</small></div>';
    }

    function loadMpRooms() {
      db.ref('mp_rooms').orderByChild('status').equalTo('waiting').limitToLast(10).once('value', snap => {
        const list = document.getElementById('mpRoomsList');
        if(!list) return;
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:20px;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, r]) => {
          if(r.host === currentUser) return; // –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ —Å–≤–æ—é
          list.innerHTML += '<div class="mp-room-card waiting">' +
            '<div class="mp-room-header">' +
              '<span style="font-weight:bold;">üßë ' + r.host + '</span>' +
              '<span class="mp-status-badge mp-waiting">‚è≥ –ß–µ–∫–∞—î</span>' +
            '</div>' +
            '<div style="color:#777;font-size:12px;margin-bottom:8px;">–°—Ç–∞–≤–∫–∞: <b style="color:var(--accent);">' + r.bet + '‚Ç¥</b></div>' +
            '<button class="btn-gold" style="padding:10px;" onclick="joinMpRoom(\'' + id + '\',' + r.bet + ')">‚ûï –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>' +
          '</div>';
        });
        if(!list.innerHTML) list.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:20px;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>';
      });
    }

    function joinMpRoom(roomId, bet) {
      if(userData.balance < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤: –ø–æ—Ç—Ä—ñ–±–Ω–æ ' + bet + '‚Ç¥', 'error');
      db.ref('mp_rooms/' + roomId).once('value', snap => {
        const r = snap.val();
        if(!r || r.status !== 'waiting') return notify('–ö—ñ–º–Ω–∞—Ç–∞ –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞', 'error');
        db.ref('users/' + currentUser).update({ balance: userData.balance - bet });
        mpRoomId = roomId;
        mpIsHost = false;
        db.ref('mp_rooms/' + roomId).update({ guest: currentUser, status: 'playing' });
        listenMpRoom(roomId);
      });
    }

    function cancelMpRoom() {
      if(!mpRoomId) return;
      db.ref('mp_rooms/' + mpRoomId + '/state/hostMoney').once('value', snap => {
        // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Å—Ç–∞–≤–∫—É
        db.ref('mp_rooms/' + mpRoomId).once('value', s => {
          const r = s.val();
          if(r) db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(r.bet));
        });
      });
      db.ref('mp_rooms/' + mpRoomId).update({ status: 'cancelled' });
      if(mpListener) { db.ref('mp_rooms/' + mpRoomId).off('value', mpListener); mpListener = null; }
      mpRoomId = null;
      document.getElementById('mpWaitScreen').classList.add('hidden');
      document.getElementById('mpLobbyScreen').classList.remove('hidden');
    }

    function listenMpRoom(roomId) {
      if(mpListener) db.ref('mp_rooms/' + roomId).off('value', mpListener);
      mpListener = db.ref('mp_rooms/' + roomId).on('value', snap => {
        const r = snap.val();
        if(!r) return;
        if(r.status === 'cancelled') {
          notify('–ö—ñ–º–Ω–∞—Ç—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ', 'error');
          resetMpUI(); return;
        }
        if(r.status === 'playing' && document.getElementById('mpGameScreen').classList.contains('hidden')) {
          startMpGame(r);
        }
        if(r.status === 'playing') {
          mpState = r.state;
          renderMpBoard();
          updateMpInfo(r);
          updateMpTurnUI(r);
        }
        if(r.status === 'finished') {
          handleMpFinished(r);
        }
      });
    }

    function startMpGame(r) {
      document.getElementById('mpWaitScreen').classList.add('hidden');
      document.getElementById('mpLobbyScreen').classList.add('hidden');
      document.getElementById('mpGameScreen').classList.remove('hidden');
      const opponentName = mpIsHost ? r.guest : r.host;
      const lbl = document.getElementById('mpOpponentLabel');
      if(lbl) lbl.textContent = 'üë§ ' + opponentName;
      const mpLog = document.getElementById('mpLog');
      if(mpLog) mpLog.innerHTML = '<div class="mono-log-item info">üé© –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! ' + (mpIsHost ? '–í–∞—à —Ö—ñ–¥.' : '–•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞.') + '</div>';
    }

    function isMyMpTurn(r) {
      return (mpIsHost && r.state.turn === 'host') || (!mpIsHost && r.state.turn === 'guest');
    }

    function updateMpTurnUI(r) {
      const myTurn = isMyMpTurn(r);
      const rollBtn = document.getElementById('mpRollBtn');
      const infoEl  = document.getElementById('mpTurnInfo');
      if(rollBtn) rollBtn.disabled = !myTurn || r.state.gameOver;
      if(infoEl) {
        infoEl.textContent = myTurn ? '‚ö° –í–∞—à —Ö—ñ–¥!' : '‚è≥ –•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
        infoEl.style.color = myTurn ? 'var(--green)' : '#777';
      }
    }

    function updateMpInfo(r) {
      const s = r.state;
      const myMoney  = mpIsHost ? s.hostMoney  : s.guestMoney;
      const oppMoney = mpIsHost ? s.guestMoney : s.hostMoney;
      const pm = document.getElementById('mpPlayerMoney');
      const om = document.getElementById('mpOpponentMoney');
      if(pm) pm.textContent = myMoney + '‚Ç¥';
      if(om) om.textContent = oppMoney + '‚Ç¥';
    }

    function mpRoll() {
      if(!mpRoomId || !mpState) return;
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val();
        if(!r || !isMyMpTurn(r) || r.state.gameOver) return;

        const d1 = rollDice(), d2 = rollDice();
        const die1 = document.getElementById('mpDie1');
        const die2 = document.getElementById('mpDie2');
        if(die1) { die1.classList.add('rolling'); die1.textContent = DICE_EMOJI[d1]; }
        if(die2) { die2.classList.add('rolling'); die2.textContent = DICE_EMOJI[d2]; }
        setTimeout(() => { if(die1) die1.classList.remove('rolling'); if(die2) die2.classList.remove('rolling'); }, 500);

        const steps = d1 + d2;
        const st = Object.assign({}, r.state);
        const myKey  = mpIsHost ? 'hostPos'   : 'guestPos';
        const myMon  = mpIsHost ? 'hostMoney'  : 'guestMoney';
        const jailKey= mpIsHost ? 'jailHost'   : 'jailGuest';

        mpAddLog('üé≤ ' + (mpIsHost ? r.host : r.guest) + ' –∫–∏–¥–∞—î: ' + d1 + '+' + d2 + '=' + steps);

        if(st[jailKey] > 0) {
          st[jailKey]--;
          st.turn = mpIsHost ? 'guest' : 'host';
          db.ref('mp_rooms/' + mpRoomId + '/state').update(st);
          return;
        }

        const oldPos = st[myKey];
        st[myKey] = (st[myKey] + steps) % 40;
        if(st[myKey] < oldPos) { st[myMon] += 200; mpAddLog('üèÅ –ü—Ä–æ–π—à–æ–≤ GO +200‚Ç¥'); }

        // Landing logic
        const cell = MONO_CELLS[st[myKey]];
        if(cell) {
          if(cell.pos === 30) {
            st[myKey] = 10; st[jailKey] = 2;
            mpAddLog('üëÆ –£ –≤\'—è–∑–Ω–∏—Ü—é!');
            st.turn = mpIsHost ? 'guest' : 'host';
          } else if(cell.type === 'tax') {
            const tax = cell.pos === 4 ? 100 : 150;
            st[myMon] -= tax;
            mpAddLog('üí∏ –ü–æ–¥–∞—Ç–æ–∫ -' + tax + '‚Ç¥');
            if(st[myMon] <= 0) { finishMpGame(mpIsHost ? 'guest' : 'host', r.bet); return; }
            st.turn = mpIsHost ? 'guest' : 'host';
          } else if(cell.type === 'special') {
            const bonus = [100, -75, 50, 150, -50, 200][Math.floor(Math.random()*6)];
            st[myMon] += bonus;
            mpAddLog('üÉè –®–∞–Ω—Å: ' + (bonus>0?'+':'') + bonus + '‚Ç¥');
            if(st[myMon] <= 0) { finishMpGame(mpIsHost ? 'guest' : 'host', r.bet); return; }
            st.turn = mpIsHost ? 'guest' : 'host';
          } else if((cell.type === 'prop' || cell.type === 'station') && cell.price) {
            const propsObj = st.props || {};
            const owner = propsObj[cell.pos];
            if(!owner) {
              // –ì—Ä–∞–≤–µ—Ü—å –º–∞—î –≤–∏–±—ñ—Ä: –∫—É–ø–∏—Ç–∏ –∞–±–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ pendingBuy
              st.pendingBuy = { pos: cell.pos, price: cell.price, label: cell.label, buyer: mpIsHost ? 'host' : 'guest' };
              mpAddLog('üè† ' + cell.label.replace('\n',' ') + ' ‚Äî –≤—ñ–ª—å–Ω–∞ (' + cell.price + '‚Ç¥). –ö—É–ø–∏—Ç–∏ –∞–±–æ –ø–∞—Å.');
              const buyBtn = document.getElementById('mpBuyBtn');
              const passBtn = document.getElementById('mpPassBtn');
              if(buyBtn) { buyBtn.disabled = false; buyBtn.onclick = () => mpDoBuy(); }
              if(passBtn){ passBtn.disabled = false; passBtn.onclick = () => mpDoPass(); }
            } else {
              const oppKey = mpIsHost ? 'guest' : 'host';
              const oppMon = mpIsHost ? 'guestMoney' : 'hostMoney';
              const isOwnedByMe = (mpIsHost && owner === 'host') || (!mpIsHost && owner === 'guest');
              if(!isOwnedByMe) {
                const rent = cell.rent || 25;
                st[myMon] -= rent; st[oppMon] += rent;
                mpAddLog('üí∏ –†–µ–Ω—Ç–∞: -' + rent + '‚Ç¥');
                if(st[myMon] <= 0) { finishMpGame(owner, r.bet); return; }
              } else {
                mpAddLog('‚úÖ –í–∞—à–∞ –≤–ª–∞—Å–Ω—ñ—Å—Ç—å');
              }
              st.turn = mpIsHost ? 'guest' : 'host';
            }
          } else {
            st.turn = mpIsHost ? 'guest' : 'host';
          }
        } else {
          st.turn = mpIsHost ? 'guest' : 'host';
        }

        db.ref('mp_rooms/' + mpRoomId + '/state').update(st);
      });
    }

    function mpDoBuy() {
      db.ref('mp_rooms/' + mpRoomId + '/state').once('value', snap => {
        const st = Object.assign({}, snap.val());
        if(!st.pendingBuy) return;
        const pb = st.pendingBuy;
        const myMon = mpIsHost ? 'hostMoney' : 'guestMoney';
        if(st[myMon] < pb.price) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!', 'error'); mpDoPass(); return; }
        st[myMon] -= pb.price;
        if(!st.props) st.props = {};
        st.props[pb.pos] = mpIsHost ? 'host' : 'guest';
        st.pendingBuy = null;
        st.turn = mpIsHost ? 'guest' : 'host';
        mpAddLog('‚úÖ –ö—É–ø–ª–µ–Ω–æ: ' + pb.label.replace('\n',' '));
        document.getElementById('mpBuyBtn').disabled = true;
        document.getElementById('mpPassBtn').disabled = true;
        db.ref('mp_rooms/' + mpRoomId + '/state').update(st);
      });
    }

    function mpDoPass() {
      db.ref('mp_rooms/' + mpRoomId + '/state').once('value', snap => {
        const st = Object.assign({}, snap.val());
        st.pendingBuy = null;
        st.turn = mpIsHost ? 'guest' : 'host';
        mpAddLog('‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–æ');
        const buyBtn = document.getElementById('mpBuyBtn');
        const passBtn= document.getElementById('mpPassBtn');
        if(buyBtn)  buyBtn.disabled = true;
        if(passBtn) passBtn.disabled= true;
        db.ref('mp_rooms/' + mpRoomId + '/state').update(st);
      });
    }

    function mpPass() { mpDoPass(); }
    function mpBuy()  { mpDoBuy(); }

    function finishMpGame(winnerRole, bet) {
      const winnerName = winnerRole === 'host'
        ? db.ref('mp_rooms/' + mpRoomId).once('value', snap => snap.val().host)
        : null;
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val();
        const winner = winnerRole === 'host' ? r.host : r.guest;
        db.ref('mp_rooms/' + mpRoomId).update({ status: 'finished', winner });
        // –ù–∞—Ä–∞—Ö–æ–≤—É—î–º–æ –ø–µ—Ä–µ–º–æ–∂—Ü—é
        const prize = Math.floor(bet * 1.9);
        db.ref('users/' + winner + '/balance').set(firebase.database.ServerValue.increment(prize));
        addToHistory('–ú–ü –ú–æ–Ω–æ–ø–æ–ª—ñ—è ' + (winner===currentUser?'+'+prize:'-'+bet) + '‚Ç¥');
      });
    }

    function handleMpFinished(r) {
      const isWin = r.winner === currentUser;
      const prize = Math.floor(r.bet * 1.9);
      mpAddLog(isWin ? 'üèÜ –í–ò –ü–ï–†–ï–ú–û–ì–õ–ò! +' + prize + '‚Ç¥' : 'üíÄ ' + r.winner + ' –ø–µ—Ä–µ–º—ñ–≥', isWin ? 'good' : 'bad');
      if(isWin) { playSound('win'); notify('üé© –ú–ü –ú–æ–Ω–æ–ø–æ–ª—ñ—è: +' + prize + '‚Ç¥!', 'success'); }
      else { notify('üòî ' + r.winner + ' –ø–µ—Ä–µ–º—ñ–≥ —É –ú–ü –ú–æ–Ω–æ–ø–æ–ª—ñ—ó', 'error'); }
      const rollBtn = document.getElementById('mpRollBtn');
      if(rollBtn) rollBtn.disabled = true;
      if(mpListener) { db.ref('mp_rooms/' + mpRoomId).off('value', mpListener); mpListener = null; }
      setTimeout(resetMpUI, 3500);
    }

    function surrenderMp() {
      if(!mpRoomId) return;
      if(confirm('–ó–¥–∞—Ç–∏—Å—å? –í–∏ –ø—Ä–æ–≥—Ä–∞—î—Ç–µ —Å—Ç–∞–≤–∫—É.')) {
        db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
          const r = snap.val();
          const winner = mpIsHost ? r.guest : r.host;
          if(winner) finishMpGame(mpIsHost ? 'guest' : 'host', r.bet);
        });
      }
    }

    function resetMpUI() {
      mpRoomId = null; mpIsHost = false; mpState = null;
      document.getElementById('mpGameScreen').classList.add('hidden');
      document.getElementById('mpWaitScreen').classList.add('hidden');
      document.getElementById('mpLobbyScreen').classList.remove('hidden');
    }

    function mpAddLog(text, cls) {
      const log = document.getElementById('mpLog');
      if(!log) return;
      const item = document.createElement('div');
      item.className = 'mono-log-item ' + (cls||'');
      item.textContent = text;
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }

    function renderMpBoard() {
      if(!mpState) return;
      const board = document.getElementById('mpBoard');
      if(!board) return;

      // Build grid same as solo
      board.innerHTML = '';
      board.style.display = 'grid';
      board.style.gridTemplateColumns = '1fr repeat(9,1fr) 1fr';
      board.style.gridTemplateRows = '1fr repeat(9,1fr) 1fr';

      const grid = Array.from({length:11}, () => Array(11).fill(null));
      MONO_CELLS.forEach(cell => { const [c,r] = cellGridPos(cell.pos); grid[r][c] = cell; });

      for(let r = 0; r < 11; r++) {
        for(let c = 0; c < 11; c++) {
          if(r >= 1 && r <= 9 && c >= 1 && c <= 9) {
            if(r === 1 && c === 1) {
              const ctr = document.createElement('div');
              ctr.className = 'mono-center';
              ctr.style.gridColumn = '2 / 11';
              ctr.style.gridRow = '2 / 11';
              ctr.innerHTML = '<div style="font-size:14px;letter-spacing:1px;">–ú–û–ù–û–ü–û–õ–Ü–Ø</div><div style="font-size:30px;">üé©</div><div style="font-size:10px;color:#555;margin-top:5px;">–ú–ü —Ä–µ–∂–∏–º</div>';
              board.appendChild(ctr);
            }
            continue;
          }
          const cell = grid[r][c];
          const div = document.createElement('div');
          if(!cell) { div.style.cssText='background:transparent;border:none;'; board.appendChild(div); continue; }

          let stripeClass = '';
          if(cell.pos>=1&&cell.pos<=9)  stripeClass='prop-top';
          if(cell.pos>=11&&cell.pos<=19) stripeClass='prop-right';
          if(cell.pos>=21&&cell.pos<=29) stripeClass='prop-bottom';
          if(cell.pos>=31&&cell.pos<=39) stripeClass='prop-left';

          const propsObj = mpState.props || {};
          let ownerClass = '';
          if(propsObj[cell.pos] === 'host')  ownerClass = mpIsHost ? 'owned-me' : 'owned-ai';
          if(propsObj[cell.pos] === 'guest') ownerClass = mpIsHost ? 'owned-ai' : 'owned-me';

          div.className = 'mono-cell ' + (cell.type==='corner'?'corner':'') + ' ' + stripeClass + ' ' + ownerClass;
          if(cell.color) div.style.borderColor = MONO_COLORS[cell.color]||'#999';

          const cornerIcons = {0:'üèÅ',10:'‚õìÔ∏è',20:'üå≥',30:'üëÆ'};
          if(cell.type==='corner') div.innerHTML='<span style="font-size:12px;">'+(cornerIcons[cell.pos]||'')+'</span><span style="font-size:8px;white-space:pre-line;">'+cell.label+'</span>';
          else if(cell.type==='prop') div.innerHTML='<span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span><span class="cell-price">'+cell.price+'‚Ç¥</span>';
          else if(cell.type==='station') div.innerHTML='<span style="font-size:11px;">üöÇ</span><span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span>';
          else if(cell.type==='utility') div.innerHTML='<span style="font-size:13px;">'+(cell.icon||'')+'</span><span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span>';
          else if(cell.type==='special') div.innerHTML='<span style="font-size:15px;">'+(cell.icon||'?')+'</span>';
          else if(cell.type==='tax') div.innerHTML='<span style="font-size:11px;">'+(cell.icon||'')+'</span><span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span>';

          board.appendChild(div);
        }
      }
      placeMpPlayers();
    }

    function placeMpPlayers() {
      document.querySelectorAll('#mpBoardWrap .mono-player').forEach(e => e.remove());
      if(!mpState) return;
      const wrap = document.getElementById('mpBoardWrap');
      if(!wrap) return;
      const cellW = wrap.offsetWidth / 11;
      const myPos  = mpIsHost ? mpState.hostPos  : mpState.guestPos;
      const oppPos = mpIsHost ? mpState.guestPos : mpState.hostPos;
      [
        { pos: myPos,  color:'#4CD964', offset:0 },
        { pos: oppPos, color:'#FF3B30', offset:7 }
      ].forEach(p => {
        const [col, row] = cellGridPos(p.pos);
        const el = document.createElement('div');
        el.className = 'mono-player';
        el.style.background = p.color;
        el.style.left = (col * cellW + p.offset + 1) + 'px';
        el.style.top  = (row * cellW + 2) + 'px';
        wrap.appendChild(el);
      });
    }




    // ============================================
    // ===== CSS –î–õ–Ø MP SIZE –ö–ù–û–ü–û–ö (–¥–æ–¥–∞—î–º–æ inline) =====
    // ============================================
    (function addDynCSS(){
      const s = document.createElement('style');
      s.textContent = `
        .mp-size-btn { padding:10px 6px; background:#1a1a1a; border:1px solid #333; border-radius:10px;
          text-align:center; cursor:pointer; font-size:12px; font-weight:bold; color:#777; transition:all 0.2s; }
        .mp-size-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(212,175,55,0.1); }
        .mp-player-info { min-width:80px; flex:1; background:#111; border:2px solid #222; border-radius:10px;
          padding:8px; text-align:center; font-size:11px; }
        .mp-player-info.my-turn { border-color:var(--accent); animation:pulse 1s infinite; }
        .mp-player-info.bankrupt { opacity:0.4; text-decoration:line-through; }
        @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(212,175,55,0.4)} 50%{box-shadow:0 0 8px 4px rgba(212,175,55,0.15)} }
        .card { display:inline-flex; align-items:center; justify-content:center; width:48px; height:68px;
          background:#fff; border-radius:8px; font-size:18px; color:#000; font-weight:bold; cursor:pointer;
          border:2px solid transparent; transition:all 0.15s; flex-shrink:0; box-shadow:0 2px 6px rgba(0,0,0,0.4);
          flex-direction:column; line-height:1; }
        .card.red { color:#cc0000; }
        .card.selected { border-color:var(--accent); transform:translateY(-8px); }
        .card.face-down { background:#1a4a1a; color:#fff; font-size:24px; }
        .card.small { width:36px; height:50px; font-size:14px; }
        .cg-table-card { width:44px; height:62px; background:#fff; border-radius:6px; font-size:16px;
          display:inline-flex; flex-direction:column; align-items:center; justify-content:center;
          color:#000; margin:2px; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
        .cg-table-card.red { color:#cc0000; }
        .cg-table-card.covered { background:#fff; border:1px dashed #4cd964; }
        .cg-room-card { background:#111; border:1px solid #222; border-radius:10px; padding:12px; margin-bottom:8px; }
        .cg-room-card.waiting { border-color:#d4af37; }
        .vip-tab-btns { display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; padding-bottom:4px; margin-bottom:12px; }
        .vip-tab-btn { padding:6px 14px; border-radius:20px; font-size:12px; font-weight:bold; cursor:pointer;
          background:#1a1a1a; border:1px solid #333; color:#777; white-space:nowrap; }
        .vip-tab-btn.active { background:rgba(212,175,55,0.15); border-color:var(--accent); color:var(--accent); }
      `;
      document.head.appendChild(s);
    })();

    // ============================================
    // ===== –ß–ê–¢: ADMIN DELETE + AUTO-CLEAR =====
    // ============================================
    function adminDeleteMsg(key) {
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?')) return;
      db.ref('lobby_chat/' + key).remove()
        .then(() => notify('üóëÔ∏è –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ', 'info'))
        .catch(() => notify('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è', 'error'));
    }

    function adminDeleteComment(newsId, commentId) {
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä?')) return;
      db.ref('casino_news/' + newsId + '/comments/' + commentId).remove().then(() => {
        db.ref('casino_news/' + newsId + '/commentCount').transaction(v => Math.max(0,(v||1)-1));
        notify('üóëÔ∏è –ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
        loadComments(newsId);
      });
    }

    // –ü–∞—Ç—á loadComments ‚Äî –¥–æ–¥–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
    const _origLoadComments = loadComments;
    window.loadComments = function(newsId) {
      const list = document.getElementById('cmtlist-' + newsId);
      if(!list) return;
      list.innerHTML = '<div style="color:#555;font-size:12px;padding:5px 0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      db.ref('casino_news/' + newsId + '/comments').orderByChild('time').limitToLast(30).once('value', snap => {
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#555;font-size:12px;padding:8px 0;">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î!</div>'; return; }
        list.innerHTML = '';
        const isAdminUser = (currentUser.toLowerCase()==='theivankoo' || (userData && userData.isAdmin===true));
        Object.entries(data).forEach(([cid, c]) => {
          const t = timeAgo(c.time);
          const avHtml = c.avatarUrl
            ? '<div class="comment-avatar"><img src="' + c.avatarUrl + '"></div>'
            : '<div class="comment-avatar">' + (c.avatarEmoji||'üë§') + '</div>';
          const delBtn = isAdminUser ? '<button onclick="adminDeleteComment(\'' + newsId + '\',\'' + cid + '\')" style="background:none;border:none;color:#ff3b30;font-size:11px;cursor:pointer;padding:0 4px;opacity:0.6;" title="–í–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>' : '';
          const div = document.createElement('div');
          div.className = 'comment-item';
          div.innerHTML = avHtml +
            '<div style="flex:1;">' +
              '<div style="display:flex;align-items:center;gap:4px;">' +
                '<span class="comment-nick" onclick="openPublicProfile(\'' + c.author + '\')">' + c.author + '</span>' +
                delBtn +
              '</div>' +
              '<div class="comment-text">' + escapeHtml(c.text) + '</div>' +
              '<div class="comment-time">' + t + '</div>' +
            '</div>';
          list.appendChild(div);
        });
      });
    };

    // –ê–≤—Ç–æ-–æ—á–∏—â–µ–Ω–Ω—è —á–∞—Ç—É –∫–æ–∂–Ω—ñ 24 –≥–æ–¥ —á–µ—Ä–µ–∑ Firebase scheduled timestamp
    function initChatAutoClear() {
      // Auto-clear: only runs for admins, max once per 24h per server timestamp
      const isAdminUser = (currentUser.toLowerCase()==='theivankoo' || (userData && userData.isAdmin===true));
      if(!isAdminUser) return; // Non-admins skip
      db.ref('chat_meta/lastClear').once('value', snap => {
        const last = snap.val() || 0;
        const now = Date.now();
        if(now - last > 24 * 3600 * 1000) {
          // Use transaction to prevent multiple admins clearing at once
          db.ref('chat_meta/lastClear').transaction(current => {
            if(!current || now - current > 24 * 3600 * 1000) return now;
            return; // abort - someone else already cleared
          }, (err, committed) => {
            if(committed && !err) {
              db.ref('lobby_chat').remove();
              setTimeout(() => {
                db.ref('lobby_chat').push({ system: true, text: 'üßπ –ß–∞—Ç –æ—á–∏—â–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ', time: Date.now() });
              }, 500);
            }
          });
        }
      });
    }

    // ============================================
    // ===== –ú–û–ù–û–ü–û–õ–Ü–Ø –ú–ü: 2-4 –ì–†–ê–í–¶–Ü =====
    // ============================================
    let mpSelectedSize = 2;
    const MP_COLORS = ['#4CD964','#FF9500','#FF3B30','#007AFF'];
    const MP_TOKENS = ['üü¢','üü†','üî¥','üîµ'];

    function selectMpSize(n, el) {
      mpSelectedSize = n;
      document.querySelectorAll('.mp-size-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }

    // Override createMpRoom to support 2-4
    window.createMpRoom = function() {
      const bet = parseInt(document.getElementById('mpBetInput').value) || 500;
      if(bet < 100) return notify('–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç–∞–≤–∫–∞ 100‚Ç¥', 'error');
      if((userData.balance || 0) < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-bet));

      const roomId = 'mp_' + currentUser + '_' + Date.now();
      mpRoomId = roomId;
      mpIsHost = true;

      const players = {};
      players[currentUser] = { money: 3000, pos: 0, jail: 0, bankrupt: false, color: MP_COLORS[0], token: MP_TOKENS[0] };

      db.ref('mp_rooms/' + roomId).set({
        host: currentUser, bet, maxPlayers: mpSelectedSize, status: 'waiting',
        created: Date.now(),
        players,
        props: {},
        turn: currentUser,
        turnOrder: [currentUser],
        gameOver: false
      });

      showMpWaitScreen2(roomId, bet, mpSelectedSize);
      listenMpRoom2(roomId);
    };

    function showMpWaitScreen2(roomId, bet, maxPlayers) {
      document.getElementById('mpLobbyScreen').classList.add('hidden');
      document.getElementById('mpWaitScreen').classList.remove('hidden');
      document.getElementById('mpWaitInfo').textContent = '–°—Ç–∞–≤–∫–∞: ' + bet + '‚Ç¥ ‚Ä¢ ' + maxPlayers + ' –≥—Ä–∞–≤—Ü—ñ ‚Ä¢ ID: ' + roomId.slice(-8);
      renderWaitPlayers({ [currentUser]: { color: MP_COLORS[0], token: MP_TOKENS[0] } }, maxPlayers);
    }

    function renderWaitPlayers(players, maxPlayers) {
      const el = document.getElementById('mpWaitPlayers');
      if(!el) return;
      el.innerHTML = '';
      const filled = Object.keys(players);
      for(let i = 0; i < maxPlayers; i++) {
        const div = document.createElement('div');
        div.className = 'mp-player-slot ' + (filled[i] ? 'filled' : 'empty');
        div.innerHTML = filled[i]
          ? '<div style="font-size:16px;">' + (players[filled[i]].token||'üë§') + '</div><div style="font-size:11px;margin-top:3px;">' + filled[i] + '</div>'
          : '<div style="font-size:20px;color:#333;">+</div><div style="font-size:11px;color:#555;margin-top:3px;">–ß–µ–∫–∞—î–º–æ...</div>';
        el.appendChild(div);
      }
    }

    // Override loadMpRooms for new structure
    window.loadMpRooms = function() {
      db.ref('mp_rooms').orderByChild('status').equalTo('waiting').limitToLast(15).once('value', snap => {
        const list = document.getElementById('mpRoomsList');
        if(!list) return;
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:20px;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, r]) => {
          if(r.host === currentUser) return;
          const playerCount = r.players ? Object.keys(r.players).length : 1;
          const spotsLeft = (r.maxPlayers || 2) - playerCount;
          if(spotsLeft <= 0) return;
          list.innerHTML += '<div class="mp-room-card waiting">' +
            '<div class="mp-room-header">' +
              '<span style="font-weight:bold;">üßë ' + r.host + '</span>' +
              '<span class="mp-status-badge mp-waiting">' + playerCount + '/' + r.maxPlayers + ' üë•</span>' +
            '</div>' +
            '<div style="color:#777;font-size:12px;margin-bottom:8px;">–°—Ç–∞–≤–∫–∞: <b style="color:var(--accent);">' + r.bet + '‚Ç¥</b> ‚Ä¢ –í—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å: <b style="color:var(--green);">' + spotsLeft + '</b></div>' +
            '<button class="btn-gold" style="padding:10px;" onclick="joinMpRoom2(\'' + id + '\',' + r.bet + ')">‚ûï –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>' +
          '</div>';
        });
        if(!list.innerHTML) list.innerHTML = '<div style="color:#777;font-size:13px;text-align:center;padding:20px;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>';
      });
    };

    function joinMpRoom2(roomId, bet) {
      if((userData.balance||0) < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤: ' + bet + '‚Ç¥', 'error');
      db.ref('mp_rooms/' + roomId).once('value', snap => {
        const r = snap.val();
        if(!r || r.status !== 'waiting') return notify('–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        const playerCount = r.players ? Object.keys(r.players).length : 0;
        if(playerCount >= r.maxPlayers) return notify('–ö—ñ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞', 'error');
        if(r.players && r.players[currentUser]) return notify('–í–∏ –≤–∂–µ –≤ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ', 'error');

        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-bet));
        mpRoomId = roomId; mpIsHost = false;

        const colorIdx = playerCount % MP_COLORS.length;
        const playerData = { money: 3000, pos: 0, jail: 0, bankrupt: false, color: MP_COLORS[colorIdx], token: MP_TOKENS[colorIdx] };
        db.ref('mp_rooms/' + roomId + '/players/' + currentUser).set(playerData);

        const newCount = playerCount + 1;
        if(newCount >= r.maxPlayers) {
          const allPlayers = Object.keys(r.players || {}).concat([currentUser]);
          db.ref('mp_rooms/' + roomId).update({ status: 'playing', turnOrder: allPlayers, turn: allPlayers[0] });
        }

        listenMpRoom2(roomId);
        document.getElementById('mpLobbyScreen').classList.add('hidden');
        document.getElementById('mpWaitScreen').classList.remove('hidden');
      });
    }

    function listenMpRoom2(roomId) {
      if(mpListener) { try { db.ref('mp_rooms/' + roomId).off('value', mpListener); } catch(e){} }
      mpListener = db.ref('mp_rooms/' + roomId).on('value', snap => {
        const r = snap.val(); if(!r) return;
        if(r.status === 'cancelled') { notify('–ö—ñ–º–Ω–∞—Ç—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ', 'error'); resetMpUI(); return; }
        if(r.status === 'waiting' && r.players) {
          renderWaitPlayers(r.players, r.maxPlayers || 2);
        }
        if(r.status === 'playing') {
          const gsc = document.getElementById('mpGameScreen');
          if(gsc && gsc.classList.contains('hidden')) {
            document.getElementById('mpWaitScreen').classList.add('hidden');
            gsc.classList.remove('hidden');
            mpAddLog2('üé© –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –ì—Ä–∞–≤—Ü—ñ: ' + Object.keys(r.players).join(', '));
          }
          renderMpGame2(r);
        }
        if(r.status === 'finished') handleMpFinished2(r);
      });
    }

    function renderMpGame2(r) {
      // Info bar
      const bar = document.getElementById('mpPlayersInfoBar');
      if(bar) {
        bar.innerHTML = '';
        (r.turnOrder || Object.keys(r.players)).forEach(name => {
          const p = r.players[name];
          const isCurrent = r.turn === name;
          const isMe = name === currentUser;
          const div = document.createElement('div');
          div.className = 'mp-player-info' + (isCurrent ? ' my-turn' : '') + (p.bankrupt ? ' bankrupt' : '');
          div.innerHTML =
            '<div style="font-size:18px;">' + (p.token||'üë§') + '</div>' +
            '<div style="font-size:10px;font-weight:bold;color:' + (isMe?'var(--accent)':'#ccc') + ';overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80px;">' + name + (isMe?' (—è)':'') + '</div>' +
            '<div style="font-size:11px;color:' + (p.bankrupt?'#ff3b30':'var(--green)') + ';font-weight:bold;">' + (p.bankrupt?'–ë–ê–ù–ö–†–£–¢':formatNumber(p.money||0)+'‚Ç¥') + '</div>';
          if(p.bankrupt) div.style.opacity = '0.4';
          bar.appendChild(div);
        });
      }

      // Turn info
      const myTurn = r.turn === currentUser;
      const turnEl = document.getElementById('mpTurnInfo');
      if(turnEl) {
        if(r.gameOver) { turnEl.textContent = 'üèÅ –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'; turnEl.style.color = '#777'; }
        else if(myTurn) { turnEl.textContent = '‚ö° –í–∞—à —Ö—ñ–¥!'; turnEl.style.color = 'var(--green)'; }
        else { turnEl.textContent = '‚è≥ –•—ñ–¥ –≥—Ä–∞–≤—Ü—è ' + r.turn; turnEl.style.color = '#777'; }
      }

      // Buttons
      const rollBtn = document.getElementById('mpRollBtn');
      const buyBtn  = document.getElementById('mpBuyBtn');
      const passBtn = document.getElementById('mpPassBtn');
      if(rollBtn) rollBtn.disabled = !myTurn || r.gameOver || !!(r.pendingBuy);
      if(buyBtn)  { buyBtn.disabled  = !myTurn || !r.pendingBuy; }
      if(passBtn) { passBtn.disabled = !myTurn || !r.pendingBuy; }

      // Board
      renderMpBoard2(r);
    }

    function renderMpBoard2(r) {
      const board = document.getElementById('mpBoard');
      if(!board) return;
      board.innerHTML = '';
      board.style.display = 'grid';
      board.style.gridTemplateColumns = '1fr repeat(9,1fr) 1fr';
      board.style.gridTemplateRows = '1fr repeat(9,1fr) 1fr';

      const grid = Array.from({length:11}, () => Array(11).fill(null));
      MONO_CELLS.forEach(cell => { const [c,ro] = cellGridPos(cell.pos); grid[ro][c] = cell; });

      for(let ro = 0; ro < 11; ro++) {
        for(let c = 0; c < 11; c++) {
          if(ro >= 1 && ro <= 9 && c >= 1 && c <= 9) {
            if(ro === 1 && c === 1) {
              const ctr = document.createElement('div');
              ctr.className = 'mono-center';
              ctr.style.gridColumn = '2 / 11'; ctr.style.gridRow = '2 / 11';
              ctr.innerHTML = '<div style="font-size:12px;letter-spacing:1px;">–ú–û–ù–û–ü–û–õ–Ü–Ø</div><div style="font-size:28px;">üé©</div>';
              board.appendChild(ctr);
            }
            continue;
          }
          const cell = grid[ro][c];
          const div = document.createElement('div');
          if(!cell) { div.style.cssText='background:transparent;border:none;'; board.appendChild(div); continue; }

          let stripeClass = '';
          if(cell.pos>=1&&cell.pos<=9)  stripeClass='prop-top';
          if(cell.pos>=11&&cell.pos<=19) stripeClass='prop-right';
          if(cell.pos>=21&&cell.pos<=29) stripeClass='prop-bottom';
          if(cell.pos>=31&&cell.pos<=39) stripeClass='prop-left';

          const propsObj = r.props || {};
          const owner = propsObj[cell.pos];
          let ownerClass = '';
          if(owner === currentUser) ownerClass = 'owned-me';
          else if(owner) ownerClass = 'owned-ai';

          div.className = 'mono-cell ' + (cell.type==='corner'?'corner':'') + ' ' + stripeClass + ' ' + ownerClass;
          if(cell.color && MONO_COLORS) div.style.borderColor = MONO_COLORS[cell.color]||'#999';

          const cornerIcons = {0:'üèÅ',10:'‚õìÔ∏è',20:'üå≥',30:'üëÆ'};
          if(cell.type==='corner') div.innerHTML='<span style="font-size:11px;">'+(cornerIcons[cell.pos]||'')+'</span><span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span>';
          else if(cell.type==='prop') div.innerHTML='<span style="font-size:7px;white-space:pre-line;">'+cell.label+'</span><span class="cell-price">'+cell.price+'‚Ç¥</span>';
          else if(cell.type==='station') div.innerHTML='<span style="font-size:10px;">üöÇ</span><span style="font-size:7px;">'+cell.label+'</span>';
          else if(cell.type==='utility') div.innerHTML='<span style="font-size:12px;">'+(cell.icon||'')+'</span>';
          else if(cell.type==='special') div.innerHTML='<span style="font-size:13px;">'+(cell.icon||'‚ùì')+'</span>';
          else if(cell.type==='tax') div.innerHTML='<span style="font-size:10px;">'+(cell.icon||'üí∏')+'</span>';
          board.appendChild(div);
        }
      }
      placeMpPlayers2(r);
    }

    function placeMpPlayers2(r) {
      document.querySelectorAll('#mpBoardWrap .mono-player').forEach(e => e.remove());
      const wrap = document.getElementById('mpBoardWrap');
      if(!wrap || !r.players) return;
      const cellW = wrap.offsetWidth / 11;
      Object.entries(r.players).forEach(([name, p], i) => {
        if(p.bankrupt) return;
        const [col, row] = cellGridPos(p.pos || 0);
        const el = document.createElement('div');
        el.className = 'mono-player';
        el.style.background = p.color || MP_COLORS[i % MP_COLORS.length];
        el.style.left = (col * cellW + 2 + i * 8) + 'px';
        el.style.top  = (row * cellW + 2) + 'px';
        el.title = name;
        wrap.appendChild(el);
      });
    }

    // Override mpRoll for multi-player
    window.mpRoll = function() {
      if(!mpRoomId) return;
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val(); if(!r) return;
        if(r.turn !== currentUser || r.gameOver || r.pendingBuy) return;

        const d1 = rollDice(), d2 = rollDice();
        const die1 = document.getElementById('mpDie1'), die2 = document.getElementById('mpDie2');
        if(die1) { die1.classList.add('rolling'); die1.textContent = DICE_EMOJI[d1]; }
        if(die2) { die2.classList.add('rolling'); die2.textContent = DICE_EMOJI[d2]; }
        setTimeout(() => { if(die1) die1.classList.remove('rolling'); if(die2) die2.classList.remove('rolling'); }, 500);

        const steps = d1 + d2;
        const players = JSON.parse(JSON.stringify(r.players));
        const p = players[currentUser];
        mpAddLog2('üé≤ ' + currentUser + ' –∫–∏–¥–∞—î: ' + d1 + '+' + d2 + '=' + steps);

        if(p.jail > 0) { p.jail--; mpAddLog2('‚õìÔ∏è ' + currentUser + ' —É –≤\'—è–∑–Ω–∏—Ü—ñ'); mpNextTurn2(r, players, {}); return; }

        const oldPos = p.pos;
        p.pos = (p.pos + steps) % 40;
        if(p.pos < oldPos) { p.money += 200; mpAddLog2('üèÅ ' + currentUser + ' –ø—Ä–æ–π—à–æ–≤ GO +200‚Ç¥'); }

        const cell = MONO_CELLS.find(c => c.pos === p.pos);
        const props = r.props || {};
        let pendingBuy = null;

        if(cell) {
          if(cell.pos === 30) { p.pos = 10; p.jail = 2; mpAddLog2('üëÆ ' + currentUser + ' —ñ–¥–µ —É –≤\'—è–∑–Ω–∏—Ü—é!'); }
          else if(cell.type === 'tax') { const tax = cell.pos===4?100:150; p.money -= tax; mpAddLog2('üí∏ –ü–æ–¥–∞—Ç–æ–∫ -' + tax + '‚Ç¥'); }
          else if(cell.type === 'special') { const bonus = [100,-75,50,150,-50,200][Math.floor(Math.random()*6)]; p.money += bonus; mpAddLog2('üÉè ' + currentUser + ': ' + (bonus>0?'+':'') + bonus + '‚Ç¥'); }
          else if((cell.type==='prop'||cell.type==='station'||cell.type==='utility') && cell.price) {
            const owner = props[cell.pos];
            if(!owner) {
              pendingBuy = { pos: cell.pos, price: cell.price, label: cell.label, buyer: currentUser };
              mpAddLog2('üè† ' + cell.label.replace('\n',' ') + ' –≤—ñ–ª—å–Ω–∞ ‚Äî –∫—É–ø–∏—Ç–∏?');
            } else if(owner !== currentUser) {
              const rent = cell.rent || 25;
              p.money -= rent;
              players[owner] = players[owner] || {}; players[owner].money = (players[owner].money||0) + rent;
              mpAddLog2('üí∏ ' + currentUser + ' –ø–ª–∞—Ç–∏—Ç—å —Ä–µ–Ω—Ç—É ' + rent + '‚Ç¥ ‚Üí ' + owner);
              if(p.money <= 0) { p.bankrupt = true; mpAddLog2('üíÄ ' + currentUser + ' –±–∞–Ω–∫—Ä—É—Ç!'); }
            } else { mpAddLog2('‚úÖ ' + currentUser + ' –Ω–∞ —Å–≤–æ—ó–π –¥—ñ–ª—è–Ω—Ü—ñ'); }
          }
        }

        // Check game over
        const activePlayers = Object.entries(players).filter(([,v]) => !v.bankrupt);
        if(activePlayers.length === 1) { finishMpGame2(activePlayers[0][0], r.bet, r.turnOrder); return; }

        if(pendingBuy) {
          db.ref('mp_rooms/' + mpRoomId).update({ players, pendingBuy, props });
        } else {
          mpNextTurn2(r, players, props);
        }
      });
    };

    function mpNextTurn2(r, players, props) {
      const order = r.turnOrder || Object.keys(r.players);
      const activePlayers = order.filter(n => players[n] && !players[n].bankrupt);
      if(!activePlayers.length) return;
      const curIdx = activePlayers.indexOf(r.turn);
      const nextTurn = activePlayers[(curIdx + 1) % activePlayers.length];
      db.ref('mp_rooms/' + mpRoomId).update({ players, props: props||r.props, turn: nextTurn, pendingBuy: null });
    }

    window.mpBuy = function() {
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val(); if(!r || !r.pendingBuy || r.pendingBuy.buyer !== currentUser) return;
        const pb = r.pendingBuy;
        const players = JSON.parse(JSON.stringify(r.players));
        const p = players[currentUser];
        if(p.money < pb.price) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!', 'error'); mpDoPass2(r); return; }
        p.money -= pb.price;
        const props = Object.assign({}, r.props, { [pb.pos]: currentUser });
        mpAddLog2('‚úÖ ' + currentUser + ' –∫—É–ø–∏–≤ ' + pb.label.replace('\n',' '));
        mpNextTurn2(r, players, props);
      });
    };

    window.mpPass = function() {
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val(); if(!r) return;
        mpAddLog2('‚è≠ ' + currentUser + ' –ø—Ä–æ–ø—É—Å—Ç–∏–≤');
        mpNextTurn2(r, JSON.parse(JSON.stringify(r.players)), r.props||{});
      });
    };

    function mpDoPass2(r) { mpNextTurn2(r, JSON.parse(JSON.stringify(r.players)), r.props||{}); }

    function finishMpGame2(winnerName, bet, turnOrder) {
      const prize = Math.floor(bet * (turnOrder ? turnOrder.length : 2) * 0.9);
      db.ref('mp_rooms/' + mpRoomId).update({ status: 'finished', winner: winnerName, prize });
      db.ref('users/' + winnerName + '/balance').set(firebase.database.ServerValue.increment(prize));
    }

    function handleMpFinished2(r) {
      const isWin = r.winner === currentUser;
      mpAddLog2(isWin ? 'üèÜ –í–ò –ü–ï–†–ï–ú–û–ì–õ–ò! +' + r.prize + '‚Ç¥' : 'üòî –ü–µ—Ä–µ–º—ñ–≥ ' + r.winner, isWin?'good':'bad');
      if(isWin) { playSound('win'); notify('üé© –ú–æ–Ω–æ–ø–æ–ª—ñ—è: +' + r.prize + '‚Ç¥!', 'success'); }
      if(mpListener) { db.ref('mp_rooms/' + mpRoomId).off('value', mpListener); mpListener = null; }
      setTimeout(resetMpUI, 4000);
    }

    window.cancelMpRoom = function() {
      if(!mpRoomId) return;
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val(); if(!r) return;
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(r.bet));
        db.ref('mp_rooms/' + mpRoomId).update({ status: 'cancelled' });
      });
      if(mpListener) { db.ref('mp_rooms/' + mpRoomId).off('value', mpListener); mpListener = null; }
      mpRoomId = null; resetMpUI();
    };

    window.surrenderMp = function() {
      if(!mpRoomId || !confirm('–ó–¥–∞—Ç–∏—Å—å? –í–∏ –ø—Ä–æ–≥—Ä–∞—î—Ç–µ.')) return;
      db.ref('mp_rooms/' + mpRoomId).once('value', snap => {
        const r = snap.val(); if(!r) return;
        const players = JSON.parse(JSON.stringify(r.players));
        players[currentUser].bankrupt = true;
        const active = (r.turnOrder||Object.keys(r.players)).filter(n => !players[n].bankrupt);
        if(active.length === 1) finishMpGame2(active[0], r.bet, r.turnOrder);
        else db.ref('mp_rooms/' + mpRoomId + '/players/' + currentUser).update({ bankrupt: true });
      });
    };

    function mpAddLog2(text, cls) {
      const log = document.getElementById('mpLog'); if(!log) return;
      const item = document.createElement('div');
      item.className = 'mono-log-item ' + (cls||'');
      item.textContent = text;
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }

    // ============================================
    // ===== –ì–†–ê –í –ö–ê–†–¢–ò: –î–£–†–ï–ù–¨ =====
    // ============================================
    const SUITS = ['‚ô†','‚ô£','‚ô•','‚ô¶'];
    const RANKS = ['6','7','8','9','10','J','Q','K','A'];
    const RED_SUITS = new Set(['‚ô•','‚ô¶']);

    let cgState = null; // { deck, playerHand, aiHand, table, trump, trumpSuit, isPlayerAttacking, selectedCard, aiMode, gameOver }
    let cgRoomId = null;
    let cgListener = null;
    let cgSelectedCards = [];

    function makeCardDeck() {
      const deck = [];
      for(const s of SUITS) for(const r of RANKS) deck.push({ suit:s, rank:r, id:r+s });
      return deck.sort(() => Math.random()-0.5);
    }

    function cardValue(rank) { return RANKS.indexOf(rank); }
    function beats(attacker, defender, trumpSuit) {
      if(defender.suit === attacker.suit) return cardValue(defender.rank) > cardValue(attacker.rank);
      if(defender.suit === trumpSuit && attacker.suit !== trumpSuit) return true;
      return false;
    }
    function cardHtml(card, small, selected) {
      const isRed = RED_SUITS.has(card.suit);
      return '<div class="card' + (small?' small':'') + (selected?' selected':'') + (isRed?' red':'') +
        '" data-id="' + card.id + '">' +
        '<span>' + card.rank + '</span><span>' + card.suit + '</span></div>';
    }
    function tableCardHtml(card, isCover) {
      if(!card) return '<div class="cg-table-card covered" style="border:2px dashed #4cd964;background:transparent;width:44px;height:62px;border-radius:6px;"></div>';
      const isRed = RED_SUITS.has(card.suit);
      return '<div class="cg-table-card' + (isRed?' red':'') + '"><span>' + card.rank + '</span><span>' + card.suit + '</span></div>';
    }

    function startCardGame(mode) {
      const bet = parseInt(document.getElementById('cgBet').value) || 200;
      if(bet < 10) return notify('–ú—ñ–Ω—ñ–º—É–º 10‚Ç¥', 'error');
      if((userData.balance||0) < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');

      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-bet));
      addWager(bet);

      const deck = makeCardDeck();
      const playerHand = deck.splice(0, 6);
      const aiHand = deck.splice(0, 6);
      const trumpCard = deck[deck.length - 1];
      const trumpSuit = trumpCard.suit;

      cgState = {
        bet, deck, playerHand, aiHand, table: [], trump: trumpCard, trumpSuit,
        isPlayerAttacking: true, // player attacks first
        gameOver: false, aiMode: mode === 'ai'
      };
      cgSelectedCards = [];

      document.getElementById('cgStartScreen').classList.add('hidden');
      document.getElementById('cgGameScreen').classList.remove('hidden');
      document.getElementById('cgPhaseInfo').textContent = '‚öîÔ∏è –í–∞—à —Ö—ñ–¥ ‚Äî –∞—Ç–∞–∫—É–π—Ç–µ!';
      renderCgBoard();
      cgLog('üÉè –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –ö–æ–∑–∏—Ä: ' + trumpCard.rank + trumpCard.suit);
    }

    function renderCgBoard() {
      if(!cgState) return;
      const { playerHand, aiHand, table, trump, trumpSuit, isPlayerAttacking } = cgState;

      // Trump card
      const tc = document.getElementById('cgTrumpCard');
      if(tc) { const isRed = RED_SUITS.has(trump.suit); tc.innerHTML = '<span style="color:' + (isRed?'#cc0000':'#000') + ';font-size:18px;">' + trump.rank + trump.suit + '</span>'; }

      // Deck count
      const dc = document.getElementById('cgDeckCount');
      if(dc) dc.textContent = cgState.deck.length;

      // Opponent hand (face down)
      const opp = document.getElementById('cgOpponentHand');
      if(opp) {
        opp.innerHTML = '';
        for(let i = 0; i < aiHand.length; i++) {
          opp.innerHTML += '<div class="card face-down small">üÇ†</div>';
        }
      }
      const oppCnt = document.getElementById('cgOpponentCards');
      if(oppCnt) oppCnt.textContent = aiHand.length + ' –∫–∞—Ä—Ç';

      // Player hand
      const ph = document.getElementById('cgPlayerHand');
      if(ph) {
        ph.innerHTML = playerHand.map(c => cardHtml(c, false, cgSelectedCards.includes(c.id))).join('');
        ph.querySelectorAll('.card').forEach((el, i) => {
          el.onclick = () => { cgSelectCard(playerHand[i]); };
        });
      }
      const pcc = document.getElementById('cgPlayerCardsCount');
      if(pcc) pcc.textContent = playerHand.length;

      // Battle field
      const bf = document.getElementById('cgBattleField');
      if(bf) {
        if(!table.length) { bf.innerHTML = '<div style="color:#333;font-size:12px;font-style:italic;width:100%;text-align:center;">–ü–æ–ª–µ –ø–æ—Ä–æ–∂–Ω—î</div>'; }
        else {
          bf.innerHTML = '';
          table.forEach(pair => {
            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex;flex-direction:column;gap:2px;align-items:center;';
            wrap.innerHTML = tableCardHtml(pair.attack) + (pair.defend ? tableCardHtml(pair.defend) : '<div class="cg-table-card" style="border:2px dashed #555;background:transparent;"></div>');
            bf.appendChild(wrap);
          });
        }
      }

      // Phase
      const pi = document.getElementById('cgPhaseInfo');
      if(pi) pi.textContent = isPlayerAttacking ? '‚öîÔ∏è –ê—Ç–∞–∫—É–π—Ç–µ!' : 'üõ°Ô∏è –í—ñ–¥–±–∏–π—Ç–µ—Å—å!';

      // Buttons
      const attackBtn = document.getElementById('cgAttackBtn');
      const passBtn   = document.getElementById('cgPassBtn');
      if(attackBtn) attackBtn.textContent = isPlayerAttacking ? '‚öîÔ∏è –ê—Ç–∞–∫—É–≤–∞—Ç–∏' : 'üõ°Ô∏è –í—ñ–¥–±–∏—Ç–∏';
      if(passBtn)   passBtn.textContent   = isPlayerAttacking ? '‚è≠ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –∞—Ç–∞–∫—É' : 'üò© –í–∑—è—Ç–∏ –∫–∞—Ä—Ç–∏';
    }

    function cgSelectCard(card) {
      if(cgState && cgState.gameOver) return;
      const idx = cgSelectedCards.indexOf(card.id);
      if(idx >= 0) cgSelectedCards.splice(idx, 1); else cgSelectedCards.push(card.id);
      renderCgBoard();
    }

    function cgAttack() {
      if(!cgState || cgState.gameOver) return;
      const { isPlayerAttacking, playerHand, aiHand, table, trumpSuit } = cgState;

      if(isPlayerAttacking) {
        // Player attacks
        const cards = playerHand.filter(c => cgSelectedCards.includes(c.id));
        if(!cards.length) return notify('–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –∞—Ç–∞–∫–∏', 'error');
        const card = cards[0];

        // Validate: must match rank of table cards if table not empty
        if(table.length && !table.some(p => p.attack.rank === card.rank || (p.defend && p.defend.rank === card.rank))) {
          return notify('–ú–æ–∂–Ω–∞ –ø—ñ–¥–∫–∏–¥–∞—Ç–∏ –ª–∏—à–µ –∫–∞—Ä—Ç–∏ —Ç–∞–∫–æ–≥–æ –∂ –Ω–æ–º—ñ–Ω–∞–ª—É!', 'error');
        }

        cgState.playerHand = playerHand.filter(c => c.id !== card.id);
        table.push({ attack: card, defend: null });
        cgSelectedCards = [];
        cgLog('‚öîÔ∏è –í–∏ –∞—Ç–∞–∫—É—î—Ç–µ: ' + card.rank + card.suit);
        renderCgBoard();
        // AI defends
        setTimeout(cgAiDefend, 700);

      } else {
        // Player defends
        if(!cgSelectedCards.length) return notify('–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É', 'error');
        const openAttack = table.find(p => !p.defend);
        if(!openAttack) return notify('–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∞—Ç–∞–∫', 'error');
        const card = playerHand.find(c => c.id === cgSelectedCards[0]);
        if(!card) return;
        if(!beats(openAttack.attack, card, trumpSuit)) return notify('–¶—è –∫–∞—Ä—Ç–∞ –Ω–µ –º–æ–∂–µ –≤—ñ–¥–±–∏—Ç–∏ ' + openAttack.attack.rank + openAttack.attack.suit, 'error');
        openAttack.defend = card;
        cgState.playerHand = playerHand.filter(c => c.id !== card.id);
        cgSelectedCards = [];
        cgLog('üõ°Ô∏è –í–∏ –≤—ñ–¥–±–∏–ª–∏: ' + card.rank + card.suit);
        renderCgBoard();
        // Check if all attacks defended
        if(!table.some(p => !p.defend)) {
          cgLog('‚úÖ –í—Å—ñ –∞—Ç–∞–∫–∏ –≤—ñ–¥–±–∏—Ç—ñ!');
          setTimeout(() => cgEndRound(false), 800);
        }
      }
    }

    function cgPass() {
      if(!cgState || cgState.gameOver) return;
      if(cgState.isPlayerAttacking) {
        // End attack
        if(!cgState.table.some(p => p.defend === null)) {
          cgLog('‚è≠ –ê—Ç–∞–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
          cgEndRound(false);
        } else notify('AI —â–µ –Ω–µ –≤—ñ–¥–±–∏–≤ –≤—Å—ñ –∫–∞—Ä—Ç–∏!', 'error');
      } else {
        // Player takes all table cards
        const allCards = cgState.table.flatMap(p => [p.attack, p.defend].filter(Boolean));
        cgState.playerHand.push(...allCards);
        cgState.table = [];
        cgLog('üò© –í–∏ –≤–∑—è–ª–∏ ' + allCards.length + ' –∫–∞—Ä—Ç');
        cgRefill();
        cgState.isPlayerAttacking = false; // AI attacks again
        renderCgBoard();
        setTimeout(cgAiAttack, 1000);
      }
    }

    function cgAiDefend() {
      if(!cgState) return;
      const openAttack = cgState.table.find(p => !p.defend);
      if(!openAttack) { cgEndRound(false); return; }

      // Find best defending card
      const defenders = cgState.aiHand.filter(c => beats(openAttack.attack, c, cgState.trumpSuit));
      if(!defenders.length) {
        // AI takes
        cgLog('ü§ñ AI –Ω–µ –º–æ–∂–µ –≤—ñ–¥–±–∏—Ç–∏, –±–µ—Ä–µ –∫–∞—Ä—Ç–∏!');
        const allCards = cgState.table.flatMap(p => [p.attack, p.defend].filter(Boolean));
        cgState.aiHand.push(...allCards);
        cgState.table = [];
        cgRefill();
        cgState.isPlayerAttacking = true;
        renderCgBoard();
        cgCheckWin();
        return;
      }
      const defCard = defenders.sort((a,b) => cardValue(a.rank)-cardValue(b.rank))[0];
      cgState.aiHand = cgState.aiHand.filter(c => c.id !== defCard.id);
      openAttack.defend = defCard;
      cgLog('ü§ñ AI –≤—ñ–¥–±–∏–≤–∞—î: ' + defCard.rank + defCard.suit);
      renderCgBoard();
      // All attacks defended?
      if(!cgState.table.some(p => !p.defend)) {
        setTimeout(() => cgEndRound(false), 600);
      }
    }

    function cgAiAttack() {
      if(!cgState || cgState.gameOver) return;
      const { aiHand, playerHand, table, trumpSuit } = cgState;
      if(!aiHand.length) { cgEndRound(false); return; }

      // Play lowest non-trump or trump if must
      const nonTrump = aiHand.filter(c => c.suit !== trumpSuit).sort((a,b) => cardValue(a.rank)-cardValue(b.rank));
      const attack = nonTrump.length ? nonTrump[0] : aiHand.sort((a,b) => cardValue(a.rank)-cardValue(b.rank))[0];
      cgState.aiHand = aiHand.filter(c => c.id !== attack.id);
      table.push({ attack, defend: null });
      cgLog('ü§ñ AI –∞—Ç–∞–∫—É—î: ' + attack.rank + attack.suit);
      cgState.isPlayerAttacking = false;
      renderCgBoard();
    }

    function cgEndRound(playerTook) {
      if(!cgState) return;
      cgState.table = [];
      cgRefill();
      cgState.isPlayerAttacking = !playerTook;
      renderCgBoard();
      cgCheckWin();
      if(!cgState.gameOver) {
        if(!cgState.isPlayerAttacking) setTimeout(cgAiAttack, 800);
        else cgLog('‚öîÔ∏è –í–∞—à —Ö—ñ–¥!');
      }
    }

    function cgRefill() {
      if(!cgState) return;
      // Refill to 6 cards each
      while(cgState.playerHand.length < 6 && cgState.deck.length) cgState.playerHand.push(cgState.deck.pop());
      while(cgState.aiHand.length < 6 && cgState.deck.length) cgState.aiHand.push(cgState.deck.pop());
    }

    function cgCheckWin() {
      if(!cgState) return;
      if(!cgState.playerHand.length && !cgState.deck.length) {
        cgState.gameOver = true;
        const prize = Math.floor(cgState.bet * 1.85);
        db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(prize));
        playSound('win');
        notify('üÉè –í–∏ –ø–µ—Ä–µ–º–æ–≥–ª–∏! +' + prize + '‚Ç¥', 'success');
        cgLog('üèÜ –í–ò –í–ò–ì–†–ê–õ–ò! +' + prize + '‚Ç¥');
        addToHistory('–ö–∞—Ä—Ç–∏: +' + prize);
        addToWinFeed('–ö–∞—Ä—Ç–∏', prize, (prize/cgState.bet).toFixed(1));
        renderCgBoard();
        setTimeout(cgReset, 3000);
      } else if(!cgState.aiHand.length && !cgState.deck.length) {
        cgState.gameOver = true;
        cgLog('üòî AI –≤–∏–≥—Ä–∞–≤ ‚Äî –≤–∏ "–î—É—Ä–µ–Ω—å"!');
        notify('üòî –ü—Ä–æ–≥—Ä–∞—à —É –î—É—Ä–Ω—è', 'error');
        addToHistory('–ö–∞—Ä—Ç–∏: -' + cgState.bet);
        renderCgBoard();
        setTimeout(cgReset, 3000);
      }
    }

    function cgReset() {
      cgState = null; cgSelectedCards = [];
      document.getElementById('cgGameScreen').classList.add('hidden');
      document.getElementById('cgStartScreen').classList.remove('hidden');
    }

    function cgLog(text) {
      const log = document.getElementById('cgLog'); if(!log) return;
      const item = document.createElement('div');
      item.className = 'mono-log-item info';
      item.textContent = text;
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }

    // –û–Ω–ª–∞–π–Ω –ª–æ–±—ñ –¥–ª—è –∫–∞—Ä—Ç
    function openCardLobby() {
      document.getElementById('cgStartScreen').classList.add('hidden');
      document.getElementById('cgOnlineLobby').classList.remove('hidden');
      loadCardRooms();
    }

    function createCardRoom() {
      const bet = parseInt(document.getElementById('cgBet').value) || 200;
      if(bet < 10) return notify('–ú—ñ–Ω—ñ–º—É–º 10‚Ç¥', 'error');
      if((userData.balance||0) < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤: –ø–æ—Ç—Ä—ñ–±–Ω–æ ' + bet + '‚Ç¥', 'error');
      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-bet));
      addWager(bet);
      const roomId = 'cg_' + currentUser + '_' + Date.now();
      cgRoomId = roomId;
      // Generate deck and hands on creation
      const deck = makeCardDeck();
      const p1Hand = deck.splice(0,6), p2Hand = deck.splice(0,6);
      const trumpCard = deck[deck.length-1];
      db.ref('card_rooms/' + roomId).set({
        host: currentUser, guest: null, bet, status: 'waiting', created: Date.now(),
        deckIds: deck.map(c=>c.id),
        p1HandIds: p1Hand.map(c=>c.id),
        p2HandIds: p2Hand.map(c=>c.id),
        trumpId: trumpCard.id, trumpSuit: trumpCard.suit,
        table: [], turn: currentUser, attacker: currentUser
      }).then(() => {
        notify('üÉè –ö—ñ–º–Ω–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ö–æ–¥: ' + roomId.slice(-6), 'success');
        // Show waiting screen in online lobby
        const roomsList = document.getElementById('cgRoomsList');
        if(roomsList) roomsList.innerHTML = '<div style="background:linear-gradient(135deg,#0d2a0d,#051505);border:1px solid var(--green);border-radius:10px;padding:15px;text-align:center;">' +
          '<div style="font-size:28px;margin-bottom:8px;">‚è≥</div>' +
          '<div style="color:var(--green);font-weight:bold;margin-bottom:4px;">–ö—ñ–º–Ω–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞!</div>' +
          '<div style="color:#777;font-size:12px;margin-bottom:12px;">–°—Ç–∞–≤–∫–∞: ' + bet + '‚Ç¥ ‚Ä¢ –ß–µ–∫–∞—î–º–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...</div>' +
          '<button class="btn-red" onclick="cancelCardRoom(\'' + roomId + '\',' + bet + ')" style="padding:10px;">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>' +
          '</div>';
        listenCardRoom(roomId);
      }).catch(e => { notify('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error'); });
    }

    function cancelCardRoom(roomId, bet) {
      db.ref('card_rooms/' + roomId).update({ status: 'cancelled' });
      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(bet));
      if(cgListener) { try { db.ref('card_rooms/'+roomId).off('value', cgListener); } catch(e){} cgListener = null; }
      cgRoomId = null;
      notify('‚ùå –ö—ñ–º–Ω–∞—Ç—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ, —Å—Ç–∞–≤–∫—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–æ', 'info');
      loadCardRooms();
    }

    function loadCardRooms() {
      db.ref('card_rooms').orderByChild('status').equalTo('waiting').limitToLast(10).once('value', snap => {
        const list = document.getElementById('cgRoomsList'); if(!list) return;
        const data = snap.val();
        if(!data) { list.innerHTML = '<div style="color:#555;font-size:12px;padding:10px 0;">–ù–µ–º–∞—î –∫—ñ–º–Ω–∞—Ç</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, r]) => {
          if(r.host === currentUser) return;
          list.innerHTML += '<div class="cg-room-card waiting"><div style="display:flex;justify-content:space-between;align-items:center;">' +
            '<span style="font-weight:bold;">üßë ' + r.host + '</span><span style="color:var(--accent);font-weight:bold;">' + r.bet + '‚Ç¥</span>' +
            '</div><button class="btn-gold" style="margin-top:8px;" onclick="joinCardRoom(\'' + id + '\',' + r.bet + ')">‚ûï –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button></div>';
        });
        if(!list.innerHTML) list.innerHTML = '<div style="color:#555;font-size:12px;padding:10px 0;">–ù–µ–º–∞—î –∫—ñ–º–Ω–∞—Ç</div>';
      });
    }

    function joinCardRoom(roomId, bet) {
      if((userData.balance||0) < bet) return notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤', 'error');
      db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(-bet));
      cgRoomId = roomId;
      db.ref('card_rooms/' + roomId).update({ guest: currentUser, status: 'playing' });
      listenCardRoom(roomId);
      document.getElementById('cgOnlineLobby').classList.add('hidden');
      document.getElementById('cgGameScreen').classList.remove('hidden');
    }

    function listenCardRoom(roomId) {
      if(cgListener) { try { db.ref('card_rooms/'+roomId).off('value', cgListener); } catch(e){} cgListener = null; }
      cgListener = db.ref('card_rooms/'+roomId).on('value', snap => {
        const r = snap.val(); if(!r) return;
        if(r.status === 'cancelled') {
          notify('‚ùå –ö—ñ–º–Ω–∞—Ç—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ', 'error');
          if(cgListener) { db.ref('card_rooms/'+roomId).off('value',cgListener); cgListener=null; }
          cgReset(); return;
        }
        if(r.status === 'playing' && r.guest) {
          document.getElementById('cgOnlineLobby').classList.add('hidden');
          document.getElementById('cgStartScreen').classList.add('hidden');
          document.getElementById('cgGameScreen').classList.remove('hidden');
          // Setup local cgState for this player
          if(!cgState) {
            const allCards = {}; // rebuild card objects from IDs
            for(const s of SUITS) for(const rk of RANKS) { const id=rk+s; allCards[id]={suit:s,rank:rk,id}; }
            const isHost = r.host === currentUser;
            const myHandIds = isHost ? r.p1HandIds : r.p2HandIds;
            cgState = {
              bet: r.bet, deck: [], table: [], trump: allCards[r.trumpId],
              trumpSuit: r.trumpSuit, gameOver: false, aiMode: false,
              playerHand: (myHandIds||[]).map(id=>allCards[id]).filter(Boolean),
              aiHand: [] // opponent's hand tracked server-side
            };
          }
          cgLog('üÉè –ì—Ä–∞ –∑ ' + (r.host===currentUser?r.guest:r.host) + ' –ø–æ—á–∞–ª–∞—Å—å!');
          renderCgBoard();
        }
        if(r.status === 'finished') {
          const isWin = r.winner === currentUser;
          const prize = Math.floor(r.bet * 1.85);
          if(isWin) { playSound('bonus'); notify('üÉè –í–∏ –≤–∏–≥—Ä–∞–ª–∏! +'+formatNumber(prize)+'‚Ç¥','success'); cgLog('üèÜ –í–ò –í–ò–ì–†–ê–õ–ò! +'+formatNumber(prize)+'‚Ç¥'); }
          else { playSound('loss'); notify('üòî –ü—Ä–æ–≥—Ä–∞—à —É –î—É—Ä–Ω—è','error'); cgLog('üòî –°—É–ø–µ—Ä–Ω–∏–∫ –ø–µ—Ä–µ–º—ñ–≥...'); }
          if(cgListener) { db.ref('card_rooms/'+roomId).off('value',cgListener); cgListener=null; }
          setTimeout(cgReset, 3000);
        }
      });
    }




    // ============================================================
    // ===== –°–ò–°–¢–ï–ú–ê –í–ê–õ–Æ–¢ ‚Äî –†–ï–ê–õ–¨–ù–ò–ô –ö–£–†–° =====
    // ============================================================

    const CURRENCIES = {
      UAH: { code:'UAH', symbol:'‚Ç¥',   flag:'üá∫üá¶', name:'–ì—Ä–∏–≤–Ω—è',      decimals:0,    isCrypto:false },
      USD: { code:'USD', symbol:'$',   flag:'üá∫üá∏', name:'–î–æ–ª–∞—Ä –°–®–ê',   decimals:2,    isCrypto:false },
      EUR: { code:'EUR', symbol:'‚Ç¨',   flag:'üá™üá∫', name:'–Ñ–≤—Ä–æ',         decimals:2,    isCrypto:false },
      PLN: { code:'PLN', symbol:'z≈Ç',  flag:'üáµüá±', name:'–ó–ª–æ—Ç–∏–π',       decimals:2,    isCrypto:false },
      GBP: { code:'GBP', symbol:'¬£',   flag:'üá¨üáß', name:'–§—É–Ω—Ç —Å—Ç–µ—Ä–ª.', decimals:2,    isCrypto:false },
      BTC: { code:'BTC', symbol:'‚Çø',   flag:'üü†', name:'Bitcoin',       decimals:8,    isCrypto:true  },
      ETH: { code:'ETH', symbol:'Œû',   flag:'üî∑', name:'Ethereum',      decimals:6,    isCrypto:true  },
      USDT:{ code:'USDT',symbol:'‚ÇÆ',   flag:'üíö', name:'Tether USDT',   decimals:2,    isCrypto:true  },
      BNB: { code:'BNB', symbol:'BNB', flag:'üü°', name:'BNB',           decimals:4,    isCrypto:true  },
      SOL: { code:'SOL', symbol:'‚óé',   flag:'üü£', name:'Solana',        decimals:4,    isCrypto:true  },
    };

    // Rates: UAH ‚Üí other currency (1 UAH = X currency)
    // Populated by fetchRates()
    let currencyRates   = { UAH:1 };
    let currentCurrency = 'UAH';
    let ratesLastFetch  = 0;
    let ratesFetching   = false;

    async function fetchRates() {
      if(ratesFetching) return;
      ratesFetching = true;
      try {
        // ---- –§—ñ–∞—Ç–Ω—ñ –≤–∞–ª—é—Ç–∏ (exchangerate-api, –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π) ----
        const fiatRes = await fetch(
          'https://api.exchangerate-api.com/v4/latest/UAH',
          { signal: AbortSignal.timeout(8000) }
        );
        if(fiatRes.ok) {
          const fiatData = await fiatRes.json();
          const r = fiatData.rates;
          currencyRates.USD = r.USD || currencyRates.USD;
          currencyRates.EUR = r.EUR || currencyRates.EUR;
          currencyRates.PLN = r.PLN || currencyRates.PLN;
          currencyRates.GBP = r.GBP || currencyRates.GBP;
        }
      } catch(e) {
        // Fallback rates (approximate)
        currencyRates.USD = 0.024;
        currencyRates.EUR = 0.022;
        currencyRates.PLN = 0.098;
        currencyRates.GBP = 0.019;
        console.log('[Currency] Fiat API failed, using fallback rates');
      }

      try {
        // ---- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏ (CoinGecko, –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π) ----
        const cryptoRes = await fetch(
          'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether,binancecoin,solana&vs_currencies=uah',
          { signal: AbortSignal.timeout(8000) }
        );
        if(cryptoRes.ok) {
          const cd = await cryptoRes.json();
          // 1 UAH = 1/price BTC
          if(cd.bitcoin?.uah)    currencyRates.BTC  = 1 / cd.bitcoin.uah;
          if(cd.ethereum?.uah)   currencyRates.ETH  = 1 / cd.ethereum.uah;
          if(cd.tether?.uah)     currencyRates.USDT = 1 / cd.tether.uah;
          if(cd.binancecoin?.uah) currencyRates.BNB = 1 / cd.binancecoin.uah;
          if(cd.solana?.uah)     currencyRates.SOL  = 1 / cd.solana.uah;
        }
      } catch(e) {
        // Fallback crypto rates
        currencyRates.BTC  = 0.0000006;
        currencyRates.ETH  = 0.0000092;
        currencyRates.USDT = 0.024;
        currencyRates.BNB  = 0.000033;
        currencyRates.SOL  = 0.00026;
        console.log('[Currency] Crypto API failed, using fallback rates');
      }

      ratesLastFetch = Date.now();
      ratesFetching  = false;
      updateCurrencyDisplay();

      // Save rates to localStorage as cache
      try { localStorage.setItem('slotok_rates', JSON.stringify({ rates: currencyRates, ts: ratesLastFetch })); } catch(e){}
    }

    function loadCachedRates() {
      try {
        const cached = JSON.parse(localStorage.getItem('slotok_rates') || '{}');
        if(cached.rates && Date.now() - (cached.ts||0) < 3600000) {
          Object.assign(currencyRates, cached.rates);
          return true;
        }
      } catch(e){}
      return false;
    }

    function initCurrencySystem() {
      // Load saved currency preference
      currentCurrency = localStorage.getItem('slotok_currency') || 'UAH';
      // Load cached rates instantly
      loadCachedRates();
      // Then fetch fresh rates
      fetchRates();
      // Refresh every 5 min
      setInterval(() => { if(Date.now() - ratesLastFetch > 300000) fetchRates(); }, 60000);
    }

    // Convert UAH amount to display currency
    function toDisplayCurrency(uahAmount) {
      const rate = currencyRates[currentCurrency] || 1;
      return uahAmount * rate;
    }

    // Format number in selected currency
    function formatCurrency(uahAmount) {
      const cur = CURRENCIES[currentCurrency] || CURRENCIES.UAH;
      const val = toDisplayCurrency(uahAmount);
      let formatted;
      if(cur.isCrypto) {
        if(val >= 1)          formatted = val.toFixed(2);
        else if(val >= 0.001) formatted = val.toFixed(4);
        else if(val >= 0.000001) formatted = val.toFixed(6);
        else formatted = val.toExponential(3);
      } else {
        if(val >= 1e9)       formatted = (val/1e9).toFixed(2) + 'B';
        else if(val >= 1e6)  formatted = (val/1e6).toFixed(2) + 'M';
        else if(val >= 1000) formatted = val.toLocaleString('uk-UA', {minimumFractionDigits:0, maximumFractionDigits:cur.decimals});
        else                 formatted = val.toFixed(cur.decimals);
      }
      return cur.symbol + ' ' + formatted;
    }

    // Update all balance displays on the page
    function updateCurrencyDisplay() {
      if(!userData || userData.balance === undefined) return;
      const balVal = formatCurrency(userData.balance);
      document.querySelectorAll('.bal').forEach(el => { el.textContent = balVal; });
      const curEl = document.getElementById('headerCurrencyCode');
      if(curEl) {
        const cur = CURRENCIES[currentCurrency] || CURRENCIES.UAH;
        curEl.textContent = cur.flag + ' ' + currentCurrency;
      }
      updateRateTicker();
      buildMiniRatesList();
      // Update settings currency name too
      const flagEl = document.getElementById('settingCurrencyFlag');
      const nameEl = document.getElementById('settingCurrencyName');
      if(flagEl) flagEl.textContent = (CURRENCIES[currentCurrency]||CURRENCIES.UAH).flag;
      if(nameEl) nameEl.textContent = (CURRENCIES[currentCurrency]||CURRENCIES.UAH).name + ' (' + currentCurrency + ')';
    }

    function updateRateTicker() {
      const headerLine = document.getElementById('currencyRateLine');
      const tickerInner = document.getElementById('rateTickerInner');

      const allCodes = ['USD','EUR','PLN','GBP','BTC','ETH','USDT','BNB','SOL'];
      const items = allCodes.map(code => {
        const cur = CURRENCIES[code]; if(!cur) return null;
        const rate = currencyRates[code]; if(!rate) return null;
        const uahPer1 = 1/rate;
        let rateStr;
        if(uahPer1 >= 10000)     rateStr = uahPer1.toLocaleString('uk-UA',{maximumFractionDigits:0});
        else if(uahPer1 >= 1)    rateStr = uahPer1.toLocaleString('uk-UA',{maximumFractionDigits:2});
        else                     rateStr = uahPer1.toFixed(6);
        return { flag:cur.flag, code, rateStr };
      }).filter(Boolean);

      // Header mini line (first 4)
      if(headerLine) {
        headerLine.textContent = items.slice(0,4).map(i=>`${i.flag} ${i.code} = ${i.rateStr}‚Ç¥`).join('  ‚Ä¢  ');
      }

      // Scrolling ticker
      if(tickerInner) {
        tickerInner.innerHTML = '<span style="color:#555;font-size:10px;margin-right:8px;">üìä</span>' +
          items.map(i =>
            `<span style="font-size:10px;color:#${i.code==='BTC'?'f7931a':i.code==='ETH'?'627eea':i.code.match(/USD|USDT/)?'26a17b':'aaa'};">` +
            `${i.flag} <b>${i.code}</b> = ${i.rateStr}‚Ç¥</span>`
          ).join('<span style="color:#222;margin:0 8px;">‚îÇ</span>') +
          // Duplicate for seamless loop
          '<span style="color:#222;margin:0 24px;">‚îÇ</span>' +
          items.map(i =>
            `<span style="font-size:10px;color:#${i.code==='BTC'?'f7931a':i.code==='ETH'?'627eea':i.code.match(/USD|USDT/)?'26a17b':'aaa'};">` +
            `${i.flag} <b>${i.code}</b> = ${i.rateStr}‚Ç¥</span>`
          ).join('<span style="color:#222;margin:0 8px;">‚îÇ</span>');
      }
    }

    function setCurrency(code) {
      if(!CURRENCIES[code]) return;
      currentCurrency = code;
      localStorage.setItem('slotok_currency', code);
      // Update selector UI
      document.querySelectorAll('.currency-btn').forEach(b => b.classList.toggle('active', b.dataset.code === code));
      updateCurrencyDisplay();
      notify(CURRENCIES[code].flag + ' –í–∞–ª—é—Ç–∞: ' + CURRENCIES[code].name, 'info');
      // Close picker
      const picker = document.getElementById('currencyPickerModal');
      if(picker) picker.classList.add('hidden');
    }

    function openCurrencyPicker() {
      let modal = document.getElementById('currencyPickerModal');
      if(!modal) {
        modal = document.createElement('div');
        modal.id = 'currencyPickerModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:9000;display:flex;align-items:flex-end;backdrop-filter:blur(4px);';
        modal.innerHTML = `
          <div style="width:100%;background:var(--box);border-radius:24px 24px 0 0;padding:0;max-height:90vh;overflow:hidden;box-shadow:0 -8px 40px rgba(0,0,0,0.8);box-sizing:border-box;">
            <!-- Header -->
            <div style="padding:20px 20px 0;display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div style="font-size:20px;font-weight:900;color:var(--accent);">üí± –í–∞–ª—é—Ç–∞</div>
                <div style="font-size:11px;color:#555;margin-top:2px;">–ë–∞–ª–∞–Ω—Å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —É –≤–∏–±—Ä–∞–Ω—ñ–π –≤–∞–ª—é—Ç—ñ</div>
              </div>
              <button onclick="document.getElementById('currencyPickerModal').classList.add('hidden')"
                style="width:36px;height:36px;border-radius:50%;background:#1a1a1a;border:1px solid #333;font-size:16px;color:#777;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
            </div>
            <!-- Content (scrollable) -->
            <div style="overflow-y:auto;max-height:calc(90vh - 80px);padding:16px 20px 30px;">
              <div style="font-size:10px;color:#555;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;font-weight:bold;">üíµ –§—ñ–∞—Ç–Ω—ñ –≤–∞–ª—é—Ç–∏</div>
              <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px;" id="fiatCurrencyGrid"></div>

              <div style="font-size:10px;color:#555;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;font-weight:bold;">ü™ô –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏</div>
              <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px;" id="cryptoCurrencyGrid"></div>

              <!-- Live rates table -->
              <div style="background:#080808;border-radius:16px;border:1px solid #1a1a1a;overflow:hidden;">
                <div style="padding:12px 16px;border-bottom:1px solid #111;display:flex;justify-content:space-between;align-items:center;">
                  <div style="font-size:13px;font-weight:bold;">üìä –ö—É—Ä—Å –¥–æ –≥—Ä–∏–≤–Ω—ñ</div>
                  <button onclick="fetchRates().then(()=>{buildRatesList();buildCurrencyGrid();})" style="background:#1a1a1a;border:1px solid #333;color:#aaa;border-radius:8px;padding:4px 10px;font-size:11px;cursor:pointer;">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
                </div>
                <div id="ratesList" style="padding:4px 0;"></div>
                <div id="ratesTimestamp" style="font-size:10px;color:#333;padding:6px 16px 10px;text-align:right;"></div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', e => { if(e.target===modal) modal.classList.add('hidden'); });
      }
      modal.classList.remove('hidden');
      buildCurrencyGrid();
      buildRatesList();
    }

    function buildCurrencyGrid() {
      const fiatGrid   = document.getElementById('fiatCurrencyGrid');
      const cryptoGrid = document.getElementById('cryptoCurrencyGrid');
      if(!fiatGrid || !cryptoGrid) return;
      fiatGrid.innerHTML = '';
      cryptoGrid.innerHTML = '';
      Object.values(CURRENCIES).forEach(cur => {
        const rate = currencyRates[cur.code];
        const uahRate = rate ? (1/rate) : null;
        let rateStr = '';
        if(uahRate && cur.code !== 'UAH') {
          if(uahRate >= 1) rateStr = (uahRate).toLocaleString('uk-UA',{maximumFractionDigits:2}) + '‚Ç¥';
          else rateStr = uahRate.toFixed(4) + '‚Ç¥';
        } else if(cur.code === 'UAH') rateStr = '1 ‚Ç¥';
        const btn = document.createElement('div');
        btn.className = 'currency-btn' + (cur.code === currentCurrency ? ' active' : '');
        btn.dataset.code = cur.code;
        btn.style.cssText = 'padding:12px;background:var(--input);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.15s;text-align:center;';
        btn.innerHTML =
          '<div style="font-size:22px;margin-bottom:4px;">' + cur.flag + '</div>' +
          '<div style="font-size:13px;font-weight:bold;">' + cur.symbol + ' ' + cur.code + '</div>' +
          '<div style="font-size:10px;color:#777;margin-top:2px;">' + rateStr + '</div>';
        if(cur.code === currentCurrency) { btn.style.borderColor='var(--accent)'; btn.style.background='rgba(212,175,55,0.12)'; }
        btn.onclick = () => setCurrency(cur.code);
        (cur.isCrypto ? cryptoGrid : fiatGrid).appendChild(btn);
      });
    }

    function buildRatesList() {
      const list = document.getElementById('ratesList'); if(!list) return;
      const ts   = document.getElementById('ratesTimestamp');
      list.innerHTML = '';
      const cryptoColors = {BTC:'#f7931a',ETH:'#627eea',USDT:'#26a17b',BNB:'#f3ba2f',SOL:'#9945ff'};
      Object.values(CURRENCIES).filter(c=>c.code!=='UAH').forEach((cur, i) => {
        const rate = currencyRates[cur.code];
        if(!rate) return;
        const uahPer1 = 1/rate;
        let fmt;
        if(uahPer1 >= 10000)     fmt = uahPer1.toLocaleString('uk-UA',{maximumFractionDigits:0});
        else if(uahPer1 >= 1)    fmt = uahPer1.toLocaleString('uk-UA',{maximumFractionDigits:2});
        else                     fmt = uahPer1.toFixed(8);

        const accentColor = cryptoColors[cur.code] || 'var(--accent)';
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px 16px;' +
          (i%2===0 ? 'background:#0a0a0a;' : 'background:#080808;');
        row.innerHTML =
          '<div style="display:flex;align-items:center;gap:10px;">' +
            '<span style="font-size:20px;">' + cur.flag + '</span>' +
            '<div><div style="font-size:13px;font-weight:bold;color:#ddd;">1 ' + cur.code + '</div>' +
              '<div style="font-size:10px;color:#555;">' + cur.name + '</div></div>' +
          '</div>' +
          '<div style="text-align:right;">' +
            '<div style="font-size:15px;font-weight:900;color:' + accentColor + ';">' + fmt + ' ‚Ç¥</div>' +
            (cur.isCrypto ? '<div style="font-size:10px;color:#555;">‚âà ' + (uahPer1/42).toFixed(2) + ' $</div>' : '') +
          '</div>';
        list.appendChild(row);
      });
      if(ts && ratesLastFetch) ts.textContent = 'üïí –û–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date(ratesLastFetch).toLocaleTimeString('uk-UA');
      else if(ts) ts.textContent = '‚ö†Ô∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø—Ä–∏–±–ª–∏–∑–Ω—ñ –∫—É—Ä—Å–∏';
    }

    // Override formatNumber to use currency system
    window.formatNumber = function(num) {
      if(currentCurrency === 'UAH' || !currencyRates[currentCurrency]) {
        // Original formatting for UAH
        if(num >= 1e9) return (num/1e9).toFixed(1) + 'B';
        if(num >= 1e6) return (num/1e6).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return Math.floor(num).toLocaleString();
      }
      return formatCurrency(num);
    };



    // ============================================================
    // ===== CASHIER SUB-TABS =====
    // ============================================================
    function switchCashierTab(tab, el) {
      if(tab === 'cashback') updateCashierCashbackUI();
      document.querySelectorAll('.cashier-tab-btn').forEach(b => b.classList.remove('active'));
      if(el) el.classList.add('active');
      ['deposit','withdraw','markets'].forEach(t => {
        const p = document.getElementById('cashier-panel-' + t);
        if(p) p.classList.toggle('hidden', t !== tab);
      });
      if(tab === 'markets') buildMarketsPage();
    }

    function buildMarketsPage() {
      // Currency mini-grid
      const fiatGrid   = document.getElementById('marketsMiniFiatGrid');
      const cryptoGrid = document.getElementById('marketsMinicryptoGrid');
      [fiatGrid, cryptoGrid].forEach(g => { if(g) g.innerHTML = ''; });

      Object.values(CURRENCIES).forEach(cur => {
        const rate = currencyRates[cur.code];
        const uahRate = rate ? (1/rate) : null;
        let rStr = cur.code === 'UAH' ? '‚Ç¥1.00' : uahRate
          ? (uahRate >= 1 ? uahRate.toFixed(2)+'‚Ç¥' : uahRate.toFixed(6)+'‚Ç¥') : '...';
        const isActive = cur.code === currentCurrency;
        const btn = document.createElement('div');
        btn.style.cssText = 'padding:8px 4px;background:' + (isActive?'rgba(212,175,55,0.15)':'var(--input)') +
          ';border:2px solid '+(isActive?'var(--accent)':'var(--border)')+';border-radius:10px;text-align:center;cursor:pointer;transition:all 0.15s;';
        btn.innerHTML = '<div style="font-size:18px;">' + cur.flag + '</div>' +
          '<div style="font-size:10px;font-weight:bold;color:'+(isActive?'var(--accent)':'#bbb')+';">' + cur.code + '</div>' +
          '<div style="font-size:9px;color:#555;">' + rStr + '</div>';
        btn.onclick = () => { setCurrency(cur.code); buildMarketsPage(); };
        (cur.isCrypto ? cryptoGrid : fiatGrid)?.appendChild(btn);
      });

      // Rate table
      buildMarketsRateTable();

      // Chart selector
      buildChartSelector();

      // Load default chart (BTC)
      if(!window._chartCurrency) window._chartCurrency = 'BTC';
      loadCurrencyChart(window._chartCurrency, window._chartPeriod || '7D');
    }

    function buildMarketsRateTable() {
      const tbl = document.getElementById('marketsRateTable');
      const ts  = document.getElementById('marketsRateTs');
      if(!tbl) return;
      tbl.innerHTML = '';
      const cryptoColors = {BTC:'#f7931a',ETH:'#627eea',USDT:'#26a17b',BNB:'#f3ba2f',SOL:'#9945ff'};
      Object.values(CURRENCIES).filter(c=>c.code!=='UAH').forEach((cur, i) => {
        const rate = currencyRates[cur.code]; if(!rate) return;
        const uahPer1 = 1/rate;
        const fmt = uahPer1 >= 10000 ? Math.round(uahPer1).toLocaleString('uk-UA')
          : uahPer1 >= 1 ? uahPer1.toFixed(2)
          : uahPer1.toFixed(6);
        const color = cryptoColors[cur.code] || 'var(--accent)';
        // Mock 24h change (in real life you'd store prev price)
        const change = ((Math.random()-0.48)*6).toFixed(2);
        const changeColor = parseFloat(change) >= 0 ? 'var(--green)' : 'var(--red)';
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;padding:10px 14px;' + (i%2?'background:#080808;':'background:#0a0a0a;');
        row.innerHTML =
          '<span style="font-size:22px;margin-right:10px;">' + cur.flag + '</span>' +
          '<div style="flex:1;"><div style="font-size:13px;font-weight:bold;">' + cur.code + '</div><div style="font-size:10px;color:#555;">' + cur.name + '</div></div>' +
          '<div style="text-align:right;">' +
            '<div style="font-size:15px;font-weight:900;color:' + color + ';">' + fmt + ' ‚Ç¥</div>' +
            '<div style="font-size:10px;color:' + changeColor + ';">' + (parseFloat(change)>=0?'+':'') + change + '%</div>' +
          '</div>';
        tbl.appendChild(row);
      });
      if(ts && ratesLastFetch) ts.textContent = 'üïí ' + new Date(ratesLastFetch).toLocaleTimeString('uk-UA');
    }

    function buildChartSelector() {
      const el = document.getElementById('chartCurrencySelector'); if(!el) return;
      el.innerHTML = '';
      ['BTC','ETH','SOL','BNB','USD','EUR'].forEach(code => {
        const cur = CURRENCIES[code]; if(!cur) return;
        const active = (window._chartCurrency || 'BTC') === code;
        const btn = document.createElement('button');
        btn.style.cssText = 'padding:6px 12px;background:' + (active?'var(--accent)':'var(--input)') +
          ';border:1px solid '+(active?'var(--accent)':'var(--border)')+';color:'+(active?'#000':'#aaa')+
          ';border-radius:20px;font-size:12px;font-weight:bold;cursor:pointer;';
        btn.textContent = cur.flag + ' ' + code;
        btn.onclick = () => {
          window._chartCurrency = code;
          buildChartSelector();
          loadCurrencyChart(code, window._chartPeriod || '7D');
        };
        el.appendChild(btn);
      });
    }

    function setChartPeriod(period, el) {
      window._chartPeriod = period;
      document.querySelectorAll('.chart-period-btn').forEach(b => b.classList.remove('active'));
      if(el) el.classList.add('active');
      loadCurrencyChart(window._chartCurrency || 'BTC', period);
    }

    async function loadCurrencyChart(code, period='7D') {
      const canvas = document.getElementById('currencyChartCanvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const symbolEl = document.getElementById('chartSymbol');
      if(symbolEl) symbolEl.textContent = code + '/UAH';

      // Show loading
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#444'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...', canvas.width/2, canvas.height/2);

      try {
        const coinIds = {BTC:'bitcoin',ETH:'ethereum',SOL:'solana',BNB:'binancecoin',USDT:'tether'};
        const days = {['1D']:1,['7D']:7,['30D']:30}[period] || 7;
        const isFiat = !coinIds[code];

        let pricesUAH = [];

        if(!isFiat && coinIds[code]) {
          const url = `https://api.coingecko.com/api/v3/coins/${coinIds[code]}/market_chart?vs_currency=uah&days=${days}`;
          const res = await fetch(url, {signal: AbortSignal.timeout(8000)});
          if(res.ok) {
            const data = await res.json();
            pricesUAH = (data.prices || []).map(([ts,p]) => ({ts, p}));
          }
        }

        // Fallback: generate realistic-looking synthetic data
        if(!pricesUAH.length) {
          const rate = currencyRates[code] ? (1/currencyRates[code]) : 1;
          const pts = 48;
          let p = rate;
          for(let i=0;i<pts;i++) {
            p *= 1 + (Math.random()-0.48)*0.03;
            pricesUAH.push({ts: Date.now() - (pts-i)*3600000*24/pts*days, p});
          }
        }

        drawCurrencyChart(ctx, canvas, pricesUAH, code);
      } catch(e) {
        console.warn('Chart load failed:', e);
        // Draw synthetic chart
        const rate = currencyRates[code] ? (1/currencyRates[code]) : 1;
        const pts = []; let p = rate;
        for(let i=0;i<50;i++) { p *= 1+(Math.random()-0.47)*0.025; pts.push({ts:i, p}); }
        drawCurrencyChart(ctx, canvas, pts, code);
      }
    }

    function drawCurrencyChart(ctx, canvas, data, code) {
      if(!data.length) return;
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // Background
      ctx.fillStyle = '#080808'; ctx.fillRect(0,0,W,H);

      const prices = data.map(d=>d.p);
      const minP = Math.min(...prices), maxP = Math.max(...prices);
      const range = maxP - minP || 1;

      const pad = {top:20, right:10, bottom:30, left:10};
      const chartW = W - pad.left - pad.right;
      const chartH = H - pad.top - pad.bottom;

      const toX = i => pad.left + (i/(data.length-1))*chartW;
      const toY = p => pad.top + chartH - ((p-minP)/range)*chartH;

      const cryptoColors = {BTC:'#f7931a',ETH:'#627eea',SOL:'#9945ff',BNB:'#f3ba2f',USDT:'#26a17b',USD:'#4a90e2',EUR:'#2ecc71'};
      const lineColor = cryptoColors[code] || '#d4af37';

      // Grid lines
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 1;
      for(let i=0;i<=4;i++) {
        const y = pad.top + (i/4)*chartH;
        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W-pad.right, y); ctx.stroke();
      }

      // Gradient fill
      const grad = ctx.createLinearGradient(0, pad.top, 0, H-pad.bottom);
      grad.addColorStop(0, lineColor + '44');
      grad.addColorStop(1, lineColor + '00');
      ctx.beginPath();
      ctx.moveTo(toX(0), toY(prices[0]));
      prices.forEach((p,i) => ctx.lineTo(toX(i), toY(p)));
      ctx.lineTo(toX(prices.length-1), H-pad.bottom);
      ctx.lineTo(toX(0), H-pad.bottom);
      ctx.closePath(); ctx.fillStyle = grad; ctx.fill();

      // Line
      ctx.beginPath(); ctx.strokeStyle = lineColor; ctx.lineWidth = 2.5;
      prices.forEach((p,i) => i===0 ? ctx.moveTo(toX(i),toY(p)) : ctx.lineTo(toX(i),toY(p)));
      ctx.stroke();

      // Last point dot
      const lastX = toX(prices.length-1), lastY = toY(prices[prices.length-1]);
      ctx.beginPath(); ctx.arc(lastX, lastY, 4, 0, Math.PI*2);
      ctx.fillStyle = lineColor; ctx.fill();

      // Price labels
      const fmt = p => p >= 1000 ? Math.round(p).toLocaleString('uk-UA') : p >= 1 ? p.toFixed(2) : p.toFixed(6);
      ctx.fillStyle = '#555'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
      ctx.fillText(fmt(maxP)+'‚Ç¥', W-pad.right, pad.top+10);
      ctx.fillText(fmt(minP)+'‚Ç¥', W-pad.right, H-pad.bottom-4);

      const lowEl = document.getElementById('chartLow');
      const highEl = document.getElementById('chartHigh');
      if(lowEl)  lowEl.textContent  = 'Min: '+fmt(minP)+'‚Ç¥';
      if(highEl) highEl.textContent = 'Max: '+fmt(maxP)+'‚Ç¥';
    }

    // ============================================================
    // ===== TOWER CLIMB GAME =====
    // ============================================================
    let towerState = null;

    function startTower() {
      const bet = validateBet(document.getElementById('towerBet').value);
      if(!bet) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - bet});
      addWager(bet);
      playSound('click');
      const diff = parseInt(document.getElementById('towerDiff').value) || 2;
      const cols = 4;
      towerState = { bet, diff, cols, level:0, multiplier:1.0, active:true };
      document.getElementById('towerStartArea').classList.add('hidden');
      document.getElementById('towerGameArea').classList.remove('hidden');
      document.getElementById('towerCashoutBtn').style.display = 'none';
      renderTowerGrid();
    }

    function renderTowerGrid() {
      if(!towerState) return;
      const grid = document.getElementById('towerGrid'); if(!grid) return;
      grid.innerHTML = '';
      const TOTAL_LEVELS = 10;
      for(let lv=0;lv<TOTAL_LEVELS;lv++) {
        const row = document.createElement('div');
        row.className = 'tower-row';
        row.id = 'tower-row-' + lv;
        for(let c=0;c<towerState.cols;c++) {
          const cell = document.createElement('div');
          cell.className = 'tower-cell';
          cell.id = `tower-cell-${lv}-${c}`;
          if(lv < towerState.level) { cell.classList.add('disabled'); cell.innerHTML = '‚¨ú'; }
          else if(lv > towerState.level) { cell.classList.add('disabled'); cell.innerHTML = 'üîí'; }
          else { cell.innerHTML = 'üü¶'; cell.onclick = () => towerClick(c); }
          row.appendChild(cell);
        }
        // Multiplier badge
        const mult = getTowerMult(lv);
        const badge = document.createElement('div');
        badge.style.cssText = 'font-size:10px;color:#555;min-width:36px;text-align:center;display:flex;align-items:center;';
        badge.textContent = 'x'+mult.toFixed(2);
        row.appendChild(badge);
        grid.appendChild(row);
      }
      updateTowerUI();
    }

    function getTowerMult(level) {
      const diff = towerState ? towerState.diff : 2;
      const safe = towerState.cols - diff;
      const total = towerState.cols;
      const prob = safe/total;
      return parseFloat((Math.pow(1/prob, level+1) * 0.97).toFixed(2));
    }

    function towerClick(col) {
      if(!towerState || !towerState.active) return;
      const lv = towerState.level;
      const diff = towerState.diff;
      const cols = towerState.cols;

      // Place mines randomly
      const mines = [];
      while(mines.length < diff) {
        const m = Math.floor(Math.random()*cols);
        if(!mines.includes(m)) mines.push(m);
      }

      const isMine = mines.includes(col);

      // Reveal all cells on this row
      for(let c=0;c<cols;c++) {
        const cell = document.getElementById(`tower-cell-${lv}-${c}`);
        if(!cell) continue;
        cell.onclick = null;
        cell.classList.add('disabled');
        if(mines.includes(c)) { cell.classList.add('mine'); cell.innerHTML = 'üí£'; }
        else { cell.classList.add('safe'); cell.innerHTML = '‚úÖ'; }
      }

      if(isMine) {
        // BOOM
        towerState.active = false;
        playSound('loss');
        notify('üí• –ú–Ü–ù–ê! –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏ ' + towerState.bet + '‚Ç¥', 'error');
        document.getElementById('towerCashoutBtn').style.display = 'none';
        addToHistory('Tower: -' + towerState.bet);
        setTimeout(() => towerReset(), 2500);
      } else {
        towerState.level++;
        towerState.multiplier = getTowerMult(lv);
        updateTowerUI();
        if(towerState.level >= 10) {
          // Max level!
          towerCashout();
        } else {
          document.getElementById('towerCashoutBtn').style.display = 'block';
          playSound('win');
          renderTowerGrid();
        }
      }
    }

    function updateTowerUI() {
      if(!towerState) return;
      const mult = getTowerMult(Math.max(0, towerState.level-1));
      const win = Math.floor(towerState.bet * mult);
      document.getElementById('towerLevel').textContent = towerState.level;
      document.getElementById('towerMult').textContent = 'x' + mult.toFixed(2);
      document.getElementById('towerWin').textContent = formatNumber(win) + ' ‚Ç¥';
    }

    function towerCashout() {
      if(!towerState || !towerState.active) return;
      towerState.active = false;
      const mult = getTowerMult(Math.max(0, towerState.level-1));
      const win = Math.floor(towerState.bet * mult);
      db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
      playSound('bonus');
      notify('üèÜ –ö–µ—à–∞—É—Ç! +' + formatNumber(win) + '‚Ç¥ (x'+mult.toFixed(2)+')', 'success');
      addToHistory('Tower x'+mult.toFixed(2)+': +'+win);
      if(win >= 500) addToWinFeed('Tower', win, mult);
      document.getElementById('towerCashoutBtn').style.display = 'none';
      setTimeout(towerReset, 2500);
    }

    function towerReset() {
      towerState = null;
      document.getElementById('towerStartArea').classList.remove('hidden');
      document.getElementById('towerGameArea').classList.add('hidden');
      document.getElementById('towerGrid').innerHTML = '';
    }

    // ============================================================
    // ===== HI-LO CARDS GAME =====
    // ============================================================
    let hiloState = null;

    function startHilo() {
      const bet = validateBet(document.getElementById('hiloBet').value);
      if(!bet) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - bet});
      addWager(bet);
      playSound('deal');
      const deck = [];
      for(const r of RANKS) for(const s of SUITS) deck.push({rank:r, suit:s});
      deck.sort(()=>Math.random()-0.5);
      hiloState = { bet, deck, streak:0, multiplier:1.0, currentCard: deck.pop() };
      document.getElementById('hiloGameArea').classList.remove('hidden');
      renderHiloCard(hiloState.currentCard);
      updateHiloUI();
    }

    function renderHiloCard(card) {
      const el = document.getElementById('hiloCurrentCard'); if(!el) return;
      const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
      const rank = card.rank;
      el.style.color = isRed ? '#e74c3c' : '#111';
      el.textContent = rank + card.suit;
    }

    function hiloGuess(dir) {
      if(!hiloState || !hiloState.deck.length) return;
      playSound('deal');
      const next = hiloState.deck.pop();
      const curVal = cardValue(hiloState.currentCard.rank);
      const nextVal = cardValue(next.rank);
      let correct;
      if(dir==='high') correct = nextVal > curVal;
      else             correct = nextVal < curVal;
      // Equal: re-draw
      if(nextVal === curVal) { hiloState.currentCard = next; renderHiloCard(next); notify('üîÑ –ù—ñ—á–∏—è! –ü–µ—Ä–µ—Ç—è–≥—É—î–º–æ.','info'); return; }

      if(correct) {
        hiloState.streak++;
        hiloState.multiplier = parseFloat((hiloState.multiplier * 1.5).toFixed(2));
        hiloState.currentCard = next;
        renderHiloCard(next);
        playSound('win');
        notify('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –°–µ—Ä—ñ—è: ' + hiloState.streak, 'success');
        updateHiloUI();
        document.getElementById('hiloCashoutBtn').classList.remove('hidden');
      } else {
        hiloState.currentCard = next;
        renderHiloCard(next);
        playSound('loss');
        notify('‚ùå –ù–µ–≤—ñ—Ä–Ω–æ! –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏ ' + hiloState.bet + '‚Ç¥', 'error');
        addToHistory('Hi-Lo: -' + hiloState.bet);
        hiloState = null;
        setTimeout(() => {
          document.getElementById('hiloGameArea').classList.add('hidden');
          document.getElementById('hiloCashoutBtn').classList.add('hidden');
        }, 1500);
      }
    }

    function hiloCashout() {
      if(!hiloState) return;
      const win = Math.floor(hiloState.bet * hiloState.multiplier);
      db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(win));
      playSound('bonus');
      notify('üí∞ –ö–µ—à–∞—É—Ç! +' + formatNumber(win) + '‚Ç¥', 'success');
      addToHistory('Hi-Lo x'+hiloState.multiplier+': +'+win);
      if(win >= 500) addToWinFeed('Hi-Lo', win, hiloState.multiplier);
      hiloState = null;
      document.getElementById('hiloGameArea').classList.add('hidden');
      document.getElementById('hiloCashoutBtn').classList.add('hidden');
    }

    function updateHiloUI() {
      if(!hiloState) return;
      const win = Math.floor(hiloState.bet * hiloState.multiplier);
      document.getElementById('hiloStreak').textContent = hiloState.streak;
      document.getElementById('hiloMult').textContent = 'x' + hiloState.multiplier;
      document.getElementById('hiloWin').textContent = formatNumber(win) + ' ‚Ç¥';
    }

    // ============================================================
    // ===== DICE ROLL =====
    // ============================================================
    function updateDiceUI() {
      const val = parseInt(document.getElementById('diceSlider').value);
      document.getElementById('diceNumLabel').textContent = val;
      document.getElementById('diceOverNum').textContent = val;
      document.getElementById('diceUnderNum').textContent = val;
      const overChance = (99 - val) / 99;
      const underChance = (val - 1) / 99;
      // Show for over
      document.getElementById('diceChance').textContent = Math.round(overChance*100) + '% / ' + Math.round(underChance*100) + '%';
      const mult = parseFloat((0.97 / Math.max(overChance, underChance)).toFixed(2));
      document.getElementById('diceMult').textContent = 'x' + mult.toFixed(2);
    }

    function rollDice(dir) {
      const bet = validateBet(document.getElementById('diceBet').value);
      if(!bet) return;
      const target = parseInt(document.getElementById('diceSlider').value);
      const result = Math.floor(Math.random()*99)+1;
      const win = (dir==='over') ? result > target : result < target;
      const chance = dir==='over' ? (99-target)/99 : (target-1)/99;
      const mult = parseFloat((0.97/chance).toFixed(2));
      const winAmt = Math.floor(bet * mult);

      db.ref('users/'+currentUser).update({balance: userData.balance - bet});
      addWager(bet);
      playSound('spin');

      const resEl = document.getElementById('diceResult');
      const histEl = document.getElementById('diceHistory');
      resEl.innerHTML = '';

      setTimeout(() => {
        if(win) {
          db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(winAmt));
          playSound('win');
          resEl.innerHTML = `<span style="color:var(--green);font-weight:900;">üé≤ ${result} ‚Äî –í–ò–ì–†–ê–®! +${formatNumber(winAmt)} ‚Ç¥</span>`;
          notify('üé≤ ' + result + ' ‚Üí +' + formatNumber(winAmt) + '‚Ç¥', 'success');
          addToHistory('Dice '+result+': +'+winAmt);
          if(winAmt >= 500) addToWinFeed('Dice', winAmt, mult);
        } else {
          playSound('loss');
          resEl.innerHTML = `<span style="color:var(--red);font-weight:900;">üé≤ ${result} ‚Äî –ü—Ä–æ–≥—Ä–∞—à -${formatNumber(bet)} ‚Ç¥</span>`;
          notify('üé≤ ' + result + ' ‚Äî –ü—Ä–æ–≥—Ä–∞—à', 'error');
          addToHistory('Dice '+result+': -'+bet);
        }
        // History dot
        const dot = document.createElement('div');
        dot.className = 'dice-result-dot';
        dot.style.background = win ? 'var(--green)' : 'var(--red)';
        dot.textContent = result;
        histEl.insertBefore(dot, histEl.firstChild);
        if(histEl.children.length > 20) histEl.removeChild(histEl.lastChild);
      }, 600);
    }

    // ============================================================
    // ===== DOUBLE GAME =====
    // ============================================================
    let doubleSpinning = false;
    const DOUBLE_HISTORY = [];

    function betDouble(color) {
      if(doubleSpinning) return;
      const bet = validateBet(document.getElementById('doubleBet').value);
      if(!bet) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - bet});
      addWager(bet);
      doubleSpinning = true;
      playSound('spin');

      // Result: 48.5% red, 48.5% black, 3% green
      const r = Math.random();
      const result = r < 0.485 ? 'red' : r < 0.97 ? 'black' : 'green';
      const mult = result === 'green' ? 14 : 2;
      const win = color === result;

      // Spin wheel animation
      const wheel = document.getElementById('doubleWheel');
      const spinAngle = 720 + Math.floor(Math.random()*360);
      wheel.style.transform = `rotate(${spinAngle}deg)`;

      setTimeout(() => {
        doubleSpinning = false;
        const resultEl = document.getElementById('doubleResult');
        const emoji = result==='red'?'üî¥':result==='black'?'‚ö´':'üü¢';
        const resColor = result==='red'?'#e74c3c':result==='black'?'#777':'#2ecc71';

        if(win) {
          const winAmt = Math.floor(bet * mult);
          db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(winAmt));
          playSound(mult>=14 ? 'bonus' : 'win');
          resultEl.innerHTML = `<span style="color:${resColor}">${emoji} ${result.toUpperCase()} ‚Äî +${formatNumber(winAmt)} ‚Ç¥ (x${mult})</span>`;
          notify(emoji + ' ' + result + ' ‚Üí +' + formatNumber(winAmt) + '‚Ç¥', 'success');
          addToHistory('Double '+result+' x'+mult+': +'+winAmt);
          if(winAmt>=500) addToWinFeed('Double', winAmt, mult);
        } else {
          playSound('loss');
          resultEl.innerHTML = `<span style="color:${resColor}">${emoji} ${result.toUpperCase()} ‚Äî –ü—Ä–æ–≥—Ä–∞—à -${formatNumber(bet)} ‚Ç¥</span>`;
          notify(emoji + ' ' + result + ' ‚Äî –ü—Ä–æ–≥—Ä–∞—à', 'error');
          addToHistory('Double '+result+': -'+bet);
        }

        // History
        DOUBLE_HISTORY.unshift(result);
        const histEl = document.getElementById('doubleHistory');
        if(histEl) {
          histEl.innerHTML = DOUBLE_HISTORY.slice(0,15).map(c =>
            '<div style="width:28px;height:28px;border-radius:50%;background:' +
            (c==='red'?'#c0392b':c==='black'?'#2c3e50':'#16a085') +
            ';display:flex;align-items:center;justify-content:center;font-size:12px;">' +
            (c==='red'?'üî¥':c==='black'?'‚ö´':'üü¢') + '</div>'
          ).join('');
        }
      }, 3000);
    }

    // ============================================================
    // ===== –°–ü–û–†–¢ V2 ‚Äî ESPN PUBLIC API (–±–µ–∑ –∫–ª—é—á–∞) =====
    // ============================================================
    let realMatches       = {};
    let liveTrackerTimer  = null;
    let activeLiveMatchId = null;
    let sportsCurrentSport = 'soccer';
    let currentBetSlip    = null;

    const SPORT_META = {
      soccer:     { icon:'‚öΩ', name:'–§—É—Ç–±–æ–ª',    espnUrl:'https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/scoreboard', league:'Premier League' },
      ucl:        { icon:'üèÜ', name:'UCL',       espnUrl:'https://site.api.espn.com/apis/site/v2/sports/soccer/uefa.champions/scoreboard', league:'Champions League' },
      laliga:     { icon:'üá™üá∏', name:'La Liga',  espnUrl:'https://site.api.espn.com/apis/site/v2/sports/soccer/esp.1/scoreboard', league:'La Liga' },
      bundesliga: { icon:'üá©üá™', name:'–ë—É–Ω–¥–µ—Å–ª—ñ–≥–∞',espnUrl:'https://site.api.espn.com/apis/site/v2/sports/soccer/ger.1/scoreboard', league:'Bundesliga' },
      basketball: { icon:'üèÄ', name:'NBA',        espnUrl:'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard', league:'NBA' },
      hockey:     { icon:'üèí', name:'NHL',        espnUrl:'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard', league:'NHL' },
      tennis:     { icon:'üéæ', name:'–¢–µ–Ω—ñ—Å',      espnUrl:'https://site.api.espn.com/apis/site/v2/sports/tennis/scoreboard', league:'ATP/WTA' },
      mma:        { icon:'ü•ä', name:'UFC/MMA',    espnUrl:'https://site.api.espn.com/apis/site/v2/sports/mma/ufc/scoreboard', league:'UFC' },
      baseball:   { icon:'‚öæ', name:'MLB',        espnUrl:'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard', league:'MLB' },
      football:   { icon:'üèà', name:'NFL',        espnUrl:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard', league:'NFL' },
      // ESPORTS ‚Äî –Ω–µ–º–∞—î ESPN API, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback
      csgo:       { icon:'üéÆ', name:'CS2',        espnUrl: null, league:'BLAST Premier / ESL' },
      dota2:      { icon:'‚öîÔ∏è', name:'Dota 2',     espnUrl: null, league:'Dota Pro Circuit' },
      lol:        { icon:'üèÜ', name:'LoL',         espnUrl: null, league:'LEC / LCK / LPL' },
      valorant:   { icon:'üî´', name:'Valorant',    espnUrl: null, league:'VCT Champions' },
      efootball:  { icon:'‚ö°', name:'eFootball',   espnUrl: null, league:'eFootball League' },
    };

    // –•–æ—Ä–æ—à—ñ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ –º–∞—Ç—á—ñ —è–∫ fallback (—Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ)
    const FALLBACK_MATCHES = {
      soccer: [
        { id:'epl1', home:'Arsenal',         away:'Liverpool',        league:'Premier League', homeOdds:2.40, drawOdds:3.20, awayOdds:2.90, matchTime:null, isLive:false },
        { id:'epl2', home:'Manchester City', away:'Chelsea',          league:'Premier League', homeOdds:1.75, drawOdds:3.60, awayOdds:4.50, matchTime:null, isLive:false },
        { id:'epl3', home:'Tottenham',       away:'Manchester Utd',   league:'Premier League', homeOdds:2.10, drawOdds:3.30, awayOdds:3.40, matchTime:null, isLive:false },
        { id:'ucl1', home:'Real Madrid',     away:'Bayern M√ºnchen',   league:'Champions League', homeOdds:1.95, drawOdds:3.50, awayOdds:3.80, matchTime:null, isLive:false },
        { id:'ucl2', home:'PSG',             away:'Inter Milan',      league:'Champions League', homeOdds:2.20, drawOdds:3.40, awayOdds:3.10, matchTime:null, isLive:false },
      ],
      ucl: [
        { id:'ucl1', home:'Real Madrid',   away:'Bayern M√ºnchen', league:'Champions League', homeOdds:1.95, drawOdds:3.50, awayOdds:3.80, matchTime:null, isLive:false },
        { id:'ucl2', home:'PSG',           away:'Inter Milan',    league:'Champions League', homeOdds:2.20, drawOdds:3.40, awayOdds:3.10, matchTime:null, isLive:false },
        { id:'ucl3', home:'Barcelona',     away:'Arsenal',        league:'Champions League', homeOdds:2.05, drawOdds:3.25, awayOdds:3.50, matchTime:null, isLive:false },
        { id:'ucl4', home:'Atl√©tico',      away:'Dortmund',       league:'Champions League', homeOdds:2.30, drawOdds:3.20, awayOdds:3.00, matchTime:null, isLive:false },
        { id:'ucl5', home:'Man City',      away:'Benfica',        league:'Champions League', homeOdds:1.50, drawOdds:4.00, awayOdds:5.50, matchTime:null, isLive:false },
      ],
      laliga: [
        { id:'ll1', home:'Real Madrid',  away:'Barcelona',   league:'La Liga', homeOdds:2.20, drawOdds:3.30, awayOdds:3.10, matchTime:null, isLive:false },
        { id:'ll2', home:'Atletico',     away:'Sevilla',     league:'La Liga', homeOdds:1.90, drawOdds:3.40, awayOdds:3.80, matchTime:null, isLive:false },
        { id:'ll3', home:'Villarreal',   away:'Valencia',    league:'La Liga', homeOdds:2.10, drawOdds:3.20, awayOdds:3.30, matchTime:null, isLive:false },
      ],
      bundesliga: [
        { id:'bl1', home:'Bayern M√ºnchen', away:'Borussia Dortmund', league:'Bundesliga', homeOdds:1.70, drawOdds:3.80, awayOdds:4.50, matchTime:null, isLive:false },
        { id:'bl2', home:'Bayer Leverkusen', away:'RB Leipzig',      league:'Bundesliga', homeOdds:2.00, drawOdds:3.30, awayOdds:3.50, matchTime:null, isLive:false },
        { id:'bl3', home:'Borussia M√∂nchengladbach', away:'Wolfsburg',league:'Bundesliga', homeOdds:2.20, drawOdds:3.20, awayOdds:3.10, matchTime:null, isLive:false },
      ],
      basketball: [
        { id:'nba1', home:'Boston Celtics',      away:'Golden State Warriors', league:'NBA', homeOdds:1.80, drawOdds:null, awayOdds:2.00, matchTime:null, isLive:false },
        { id:'nba2', home:'Los Angeles Lakers',   away:'Miami Heat',           league:'NBA', homeOdds:1.95, drawOdds:null, awayOdds:1.85, matchTime:null, isLive:false },
        { id:'nba3', home:'Milwaukee Bucks',      away:'Philadelphia 76ers',   league:'NBA', homeOdds:1.70, drawOdds:null, awayOdds:2.20, matchTime:null, isLive:false },
        { id:'nba4', home:'Phoenix Suns',         away:'Dallas Mavericks',     league:'NBA', homeOdds:2.00, drawOdds:null, awayOdds:1.80, matchTime:null, isLive:false },
        { id:'nba5', home:'Denver Nuggets',       away:'Memphis Grizzlies',    league:'NBA', homeOdds:1.60, drawOdds:null, awayOdds:2.40, matchTime:null, isLive:false },
      ],
      hockey: [
        { id:'nhl1', home:'Toronto Maple Leafs', away:'Montreal Canadiens',  league:'NHL', homeOdds:1.85, drawOdds:null, awayOdds:1.95, matchTime:null, isLive:false },
        { id:'nhl2', home:'Colorado Avalanche',  away:'Vegas Golden Knights', league:'NHL', homeOdds:2.00, drawOdds:null, awayOdds:1.80, matchTime:null, isLive:false },
        { id:'nhl3', home:'New York Rangers',    away:'Boston Bruins',        league:'NHL', homeOdds:2.10, drawOdds:null, awayOdds:1.75, matchTime:null, isLive:false },
        { id:'nhl4', home:'Florida Panthers',    away:'Tampa Bay Lightning',  league:'NHL', homeOdds:1.90, drawOdds:null, awayOdds:1.90, matchTime:null, isLive:false },
      ],
      tennis: [
        { id:'ten1', home:'Novak Djokovic', away:'Carlos Alcaraz',    league:'ATP Masters', homeOdds:1.95, drawOdds:null, awayOdds:1.85, matchTime:null, isLive:false },
        { id:'ten2', home:'Jannik Sinner',  away:'Daniil Medvedev',   league:'ATP 500',     homeOdds:1.75, drawOdds:null, awayOdds:2.10, matchTime:null, isLive:false },
        { id:'ten3', home:'Aryna Sabalenka',away:'Iga Swiatek',       league:'WTA 1000',    homeOdds:2.20, drawOdds:null, awayOdds:1.70, matchTime:null, isLive:false },
        { id:'ten4', home:'Andrey Rublev',  away:'Casper Ruud',       league:'ATP 500',     homeOdds:1.90, drawOdds:null, awayOdds:1.90, matchTime:null, isLive:false },
      ],
      mma: [
        { id:'ufc1', home:'Islam Makhachev',   away:'Charles Oliveira', league:'UFC LW Champ', homeOdds:1.55, drawOdds:null, awayOdds:2.55, matchTime:null, isLive:false },
        { id:'ufc2', home:'Jon Jones',         away:'Stipe Miocic',     league:'UFC HW',       homeOdds:1.45, drawOdds:null, awayOdds:2.80, matchTime:null, isLive:false },
        { id:'ufc3', home:'Alex Pereira',      away:'Magomed Ankalaev', league:'UFC LHW',      homeOdds:1.70, drawOdds:null, awayOdds:2.20, matchTime:null, isLive:false },
        { id:'ufc4', home:'Leon Edwards',      away:'Belal Muhammad',   league:'UFC WW',       homeOdds:2.05, drawOdds:null, awayOdds:1.80, matchTime:null, isLive:false },
      ],
      baseball: [
        { id:'mlb1', home:'New York Yankees',  away:'Boston Red Sox',   league:'MLB', homeOdds:1.80, drawOdds:null, awayOdds:2.00, matchTime:null, isLive:false },
        { id:'mlb2', home:'Los Angeles Dodgers',away:'San Francisco Giants',league:'MLB',homeOdds:1.60, drawOdds:null, awayOdds:2.40, matchTime:null, isLive:false },
        { id:'mlb3', home:'Houston Astros',    away:'Atlanta Braves',   league:'MLB', homeOdds:1.90, drawOdds:null, awayOdds:1.90, matchTime:null, isLive:false },
      ],
      football: [
        { id:'nfl1', home:'Kansas City Chiefs',  away:'San Francisco 49ers',league:'NFL Playoffs',homeOdds:1.75, drawOdds:null, awayOdds:2.10, matchTime:null, isLive:false },
        { id:'nfl2', home:'Dallas Cowboys',      away:'Philadelphia Eagles', league:'NFL',         homeOdds:2.00, drawOdds:null, awayOdds:1.80, matchTime:null, isLive:false },
        { id:'nfl3', home:'Baltimore Ravens',    away:'Cincinnati Bengals',  league:'NFL',         homeOdds:1.85, drawOdds:null, awayOdds:1.95, matchTime:null, isLive:false },
      ],
      // ===== ESPORTS =====
      csgo: [
        { id:'cs1', home:'Natus Vincere',  away:'FaZe Clan',       league:'BLAST Premier',      homeOdds:2.10, drawOdds:null, awayOdds:1.75, matchTime:null, isLive:false },
        { id:'cs2', home:'Team Vitality',  away:'G2 Esports',      league:'ESL Pro League',     homeOdds:1.85, drawOdds:null, awayOdds:1.95, matchTime:null, isLive:false },
        { id:'cs3', home:'Liquid',         away:'Cloud9',           league:'BLAST Premier',      homeOdds:1.70, drawOdds:null, awayOdds:2.20, matchTime:null, isLive:false },
        { id:'cs4', home:'MOUZ',           away:'Heroic',           league:'ESL Pro League',     homeOdds:2.00, drawOdds:null, awayOdds:1.82, matchTime:null, isLive:false },
        { id:'cs5', home:'Spirit',         away:'Virtus.pro',       league:'ESL One',            homeOdds:1.60, drawOdds:null, awayOdds:2.35, matchTime:null, isLive:false },
      ],
      dota2: [
        { id:'d1', home:'Team Spirit',    away:'OG',               league:'ESL One Bangkok',     homeOdds:1.65, drawOdds:null, awayOdds:2.25, matchTime:null, isLive:false },
        { id:'d2', home:'Gaimin Gladiators',away:'Nigma Galaxy',   league:'DPC WEU',            homeOdds:1.80, drawOdds:null, awayOdds:2.00, matchTime:null, isLive:false },
        { id:'d3', home:'Team Liquid',    away:'Alliance',          league:'DPC League',          homeOdds:1.55, drawOdds:null, awayOdds:2.50, matchTime:null, isLive:false },
        { id:'d4', home:'Tundra Esports', away:'Entity',            league:'DPC WEU',            homeOdds:1.90, drawOdds:null, awayOdds:1.90, matchTime:null, isLive:false },
      ],
      lol: [
        { id:'l1', home:'G2 Esports',    away:'Fnatic',            league:'LEC Spring',          homeOdds:1.75, drawOdds:null, awayOdds:2.10, matchTime:null, isLive:false },
        { id:'l2', home:'T1',            away:'Gen.G',             league:'LCK Spring',          homeOdds:2.00, drawOdds:null, awayOdds:1.80, matchTime:null, isLive:false },
        { id:'l3', home:'BLG',           away:'JDG',               league:'LPL Spring',          homeOdds:1.85, drawOdds:null, awayOdds:1.95, matchTime:null, isLive:false },
        { id:'l4', home:'Cloud9',        away:'100 Thieves',        league:'LCS Spring',          homeOdds:1.90, drawOdds:null, awayOdds:1.90, matchTime:null, isLive:false },
      ],
      valorant: [
        { id:'v1', home:'Sentinels',      away:'NRG Esports',       league:'VCT Americas',       homeOdds:1.95, drawOdds:null, awayOdds:1.85, matchTime:null, isLive:false },
        { id:'v2', home:'Fnatic',         away:'Team Liquid',        league:'VCT EMEA',           homeOdds:2.10, drawOdds:null, awayOdds:1.74, matchTime:null, isLive:false },
        { id:'v3', home:'Paper Rex',      away:'DRX',                league:'VCT Pacific',        homeOdds:1.80, drawOdds:null, awayOdds:2.00, matchTime:null, isLive:false },
        { id:'v4', home:'Evil Geniuses',  away:'LOUD',               league:'VCT Americas',       homeOdds:2.20, drawOdds:null, awayOdds:1.68, matchTime:null, isLive:false },
      ],
      efootball: [
        { id:'ef1', home:'FC Barcelona eS', away:'Real Madrid eS',  league:'eFootball League',   homeOdds:2.00, drawOdds:null, awayOdds:1.82, matchTime:null, isLive:false },
        { id:'ef2', home:'Man City eS',     away:'Chelsea eS',       league:'eFootball Cup',      homeOdds:1.75, drawOdds:null, awayOdds:2.10, matchTime:null, isLive:false },
        { id:'ef3', home:'PSG eS',          away:'Bayern eS',        league:'eFootball Champions',homeOdds:2.15, drawOdds:null, awayOdds:1.72, matchTime:null, isLive:false },
      ],
    };

    // AI –∞–Ω–∞–ª—ñ–∑ –ø–æ –ø—Ä–∞–≤–∏–ª–∞—Ö (–±–µ–∑ API)
    function generateAiAnalysis(match) {
      const homeOdds = parseFloat(match.homeOdds);
      const awayOdds = parseFloat(match.awayOdds);
      const fav = homeOdds < awayOdds ? match.home : match.away;
      const conf = Math.floor(52 + Math.random()*32);
      const reasons = [
        `${fav} –º–∞—é—Ç—å –Ω–∞–π–∫—Ä–∞—â—É —Ñ–æ—Ä–º—É –≤ ${match.league} ‚Äî ${conf}% —à–∞–Ω—Å –ø–µ—Ä–µ–º–æ–≥–∏ –∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é xG.`,
        `–ê–Ω–∞–ª—ñ–∑ 10 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –º–∞—Ç—á—ñ–≤: ${fav} –≤–∏–≥—Ä–∞–ª–∏ 7. –û—á—ñ–∫—É—é –ø–µ—Ä–µ–º–æ–≥—É –∑ ${conf}% –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—é.`,
        `${fav} –¥–æ–º—ñ–Ω—É—é—Ç—å —É –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫–∞—Ö: —É–¥–∞—Ä–∏ –≤ —Ü—ñ–ª—å, –ø–æ–∑–∏—Ü—ñ—è —ñ xG. –ü—Ä–æ–≥–Ω–æ–∑: ${conf}%.`,
        `–ü–æ—Ç–æ—á–Ω–∞ —Å–µ—Ä—ñ—è –ø–µ—Ä–µ–º–æ–≥ —Ç–∞ —Ç—Ä–∞–≤–º–æ–≤–∞–Ω—ñ –≥—Ä–∞–≤—Ü—ñ —Å—É–ø–µ—Ä–Ω–∏–∫–∞ –¥–∞—é—Ç—å ${fav} –ø–µ—Ä–µ–≤–∞–≥—É ‚Äî ${conf}%.`,
        `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–Ω–∏—Ö –∑—É—Å—Ç—Ä—ñ—á–µ–π: ${fav} –≤–∏–≥—Ä–∞–ª–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 3 –º–∞—Ç—á—ñ. AI –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å: ${conf}%.`,
      ];
      return { analysis: reasons[Math.floor(Math.random()*reasons.length)], confidence: conf, aiPick: homeOdds < awayOdds ? 'home' : 'away' };
    }

    // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ ESPN API, fallback –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω—ñ –º–∞—Ç—á—ñ
    async function loadRealSportMatches(sport, btnEl) {
      sportsCurrentSport = sport;
      document.querySelectorAll('.sport-tab-btn').forEach(b => b.classList.remove('active'));
      if(btnEl) btnEl.classList.add('active');

      const listEl = document.getElementById('sportMatchesList');
      const loadEl = document.getElementById('sportsLoadingEl');
      if(listEl) listEl.innerHTML = '';
      if(loadEl) { loadEl.classList.remove('hidden'); loadEl.innerHTML = '<div style="text-align:center;padding:30px;color:#555;font-size:13px;">üì° –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤...</div>'; }

      const meta = SPORT_META[sport];
      let matches = [];

      // Try ESPN API
      if(meta && meta.espnUrl) {
        try {
          const res = await fetch(meta.espnUrl + '?limit=10', { signal: AbortSignal.timeout(8000) });
          if(res.ok) {
            const data = await res.json();
            matches = parseESPNScoreboard(data, sport);
          }
        } catch(e) {
          console.log('ESPN API failed:', e.message);
        }
      }

      // Fallback to static matches
      if(!matches.length) {
        matches = (FALLBACK_MATCHES[sport] || FALLBACK_MATCHES.soccer).map(m => ({
          ...m,
          sport,
          ...generateAiAnalysis(m),
          matchTime: randomFutureMatchTime(),
        }));
      }

      // Store
      matches.forEach(m => { realMatches[m.id] = m; });
      if(loadEl) loadEl.classList.add('hidden');
      renderRealMatches(matches);

      // Start live tracker for live ones
      const liveOnes = matches.filter(m => m.isLive);
      if(liveOnes.length && !liveTrackerTimer) startLiveTracker(liveOnes[0]);

      // Load bets
      loadSportMyBets();
    }

    function randomFutureMatchTime() {
      const now = Date.now();
      const hours = 1 + Math.floor(Math.random() * 72);
      return new Date(now + hours * 3600000).toISOString();
    }

    function parseESPNScoreboard(data, sport) {
      const events = data.events || [];
      return events.slice(0, 6).map(ev => {
        const comp = ev.competitions?.[0];
        const comps = comp?.competitors || [];
        const home = comps.find(c => c.homeAway==='home') || comps[0] || {};
        const away = comps.find(c => c.homeAway==='away') || comps[1] || {};
        const statusType = ev.status?.type?.name || '';
        const isLive  = statusType === 'STATUS_IN_PROGRESS';
        const isFinal = statusType === 'STATUS_FINAL';
        const minute  = isLive ? (ev.status?.displayClock || '') : null;
        const homeScore = isLive||isFinal ? parseInt(home.score||0) : null;
        const awayScore = isLive||isFinal ? parseInt(away.score||0) : null;

        // Generate odds based on records
        const homeRec = home.records?.[0]?.summary || '';
        const awayRec = away.records?.[0]?.summary || '';
        const homeW = parseInt(homeRec.split('-')[0]) || 8;
        const awayW = parseInt(awayRec.split('-')[0]) || 6;
        const total = homeW + awayW + 4;
        const homeOdds = parseFloat((0.93 / (homeW / total) * 1.1).toFixed(2));
        const awayOdds = parseFloat((0.93 / (awayW / total) * 1.1).toFixed(2));

        const matchObj = {
          id:        'espn_' + ev.id,
          sport,
          home:      home.team?.shortDisplayName || home.team?.displayName || 'Home',
          away:      away.team?.shortDisplayName || away.team?.displayName || 'Away',
          league:    SPORT_META[sport]?.league || sport,
          matchTime: ev.date,
          isLive,
          isFinal,
          liveMinute: minute,
          liveScore: (homeScore!==null) ? { home: homeScore, away: awayScore } : null,
          homeOdds:  Math.max(1.10, Math.min(10, homeOdds)),
          drawOdds:  sport==='soccer' ? parseFloat((2.8+Math.random()*1.2).toFixed(2)) : null,
          awayOdds:  Math.max(1.10, Math.min(10, awayOdds)),
          homeLogo:  home.team?.logo || null,
          awayLogo:  away.team?.logo || null,
        };
        const ai = generateAiAnalysis(matchObj);
        return { ...matchObj, ...ai };
      }).filter(m => m.home !== 'Home');
    }

    function renderRealMatches(matches) {
      const listEl = document.getElementById('sportMatchesList');
      if(!listEl) return;
      if(!matches.length) {
        listEl.innerHTML = '<div style="text-align:center;color:#555;padding:40px 0;font-size:13px;">–ú–∞—Ç—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –≤–∏–¥ —Å–ø–æ—Ä—Ç—É.</div>';
        return;
      }
      listEl.innerHTML = '';
      matches.forEach(m => {
        const card = document.createElement('div');
        card.className = 'match-card' + (m.isLive ? ' live' : '');
        card.id = 'match-card-' + m.id;
        card.innerHTML = buildMatchCardHTML(m);
        listEl.appendChild(card);
      });
    }

    function buildMatchCardHTML(m) {
      const isLive     = m.isLive;
      const isFinal    = m.isFinal || m.status === 'finished';
      const sport      = SPORT_META[m.sport] || SPORT_META.soccer;
      const hasDraw    = m.drawOdds !== null && m.drawOdds !== undefined;
      const confColor  = m.confidence >= 70 ? 'var(--green)' : m.confidence >= 55 ? '#f39c12' : '#e74c3c';
      const aiTeam     = m.aiPick==='home' ? shortName2(m.home) : m.aiPick==='away' ? shortName2(m.away) : '–ù—ñ—á–∏—è';

      const timeStr = isFinal ? 'üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' :
        isLive ? `<span style="color:#e74c3c;font-weight:bold;animation:pulse2 1s infinite;">üî¥ LIVE ${m.liveMinute||''}</span>` :
        m.matchTime ? 'üïê ' + new Date(m.matchTime).toLocaleString('uk-UA',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'üìÖ –ù–µ–∑–∞–±–∞—Ä–æ–º';

      const scoreHtml = (isLive || isFinal) && m.liveScore
        ? `<div class="live-score-badge">${m.liveScore.home} : ${m.liveScore.away}</div>`
        : `<div style="padding:8px 14px;color:#555;font-size:12px;">vs</div>`;

      // Team logos (if from ESPN)
      const homeLogo = m.homeLogo ? `<img src="${m.homeLogo}" style="width:28px;height:28px;object-fit:contain;border-radius:4px;" onerror="this.style.display='none'">` : '';
      const awayLogo = m.awayLogo ? `<img src="${m.awayLogo}" style="width:28px;height:28px;object-fit:contain;border-radius:4px;" onerror="this.style.display='none'">` : '';

      const disabled = isFinal ? 'pointer-events:none;opacity:0.5;' : '';

      return `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:11px;color:#555;font-weight:bold;">${sport.icon} ${m.league}</span>
          <span style="font-size:11px;">${timeStr}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;margin-bottom:10px;">
          <div style="text-align:center;">
            ${homeLogo}
            <div style="font-size:13px;font-weight:bold;margin-top:${homeLogo?'4px':'0'};">${m.home}</div>
          </div>
          <div style="text-align:center;">${scoreHtml}</div>
          <div style="text-align:center;">
            ${awayLogo}
            <div style="font-size:13px;font-weight:bold;margin-top:${awayLogo?'4px':'0'};">${m.away}</div>
          </div>
        </div>
        <div class="match-odds-row" style="${disabled}">
          <div class="odds-btn" onclick="openBetSlip('${m.id}','home','${m.home.replace(/'/g,"\\'")}')">
            <div class="odds-label">${shortName2(m.home)}</div><div class="odds-val">${parseFloat(m.homeOdds).toFixed(2)}</div>
          </div>
          ${hasDraw ? `<div class="odds-btn" onclick="openBetSlip('${m.id}','draw','–ù—ñ—á–∏—è')">
            <div class="odds-label">–ù—ñ—á–∏—è</div><div class="odds-val">${parseFloat(m.drawOdds).toFixed(2)}</div>
          </div>` : ''}
          <div class="odds-btn" onclick="openBetSlip('${m.id}','away','${m.away.replace(/'/g,"\\'")}')">
            <div class="odds-label">${shortName2(m.away)}</div><div class="odds-val">${parseFloat(m.awayOdds).toFixed(2)}</div>
          </div>
        </div>
        <div style="background:#0a0a0a;border-left:3px solid ${confColor};border-radius:0 8px 8px 0;padding:8px 10px;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
            <span style="font-size:11px;font-weight:bold;color:${confColor};">ü§ñ –®–Ü: ${aiTeam}</span>
            <span style="font-size:11px;font-weight:bold;color:${confColor};">${m.confidence||65}%</span>
          </div>
          <div style="font-size:10px;color:#666;">${m.analysis||m.aiAnalysis||''}</div>
          <div style="background:#111;border-radius:4px;height:4px;margin-top:6px;overflow:hidden;">
            <div style="height:100%;background:${confColor};width:${m.confidence||65}%;transition:width 1s;"></div>
          </div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          ${isLive ? `<button onclick="openLiveView('${m.id}')" style="flex:1;padding:8px;background:rgba(231,76,60,0.12);border:1px solid #e74c3c;border-radius:8px;color:#e74c3c;font-size:11px;font-weight:bold;cursor:pointer;">üî¥ LIVE</button>` : ''}
          <button onclick="openStreamViewer('${m.sport}','${m.home.replace(/'/g,"\'")} vs ${m.away.replace(/'/g,"\'")} ')" style="${isLive?'flex:1;':'width:100%;'}padding:8px;background:#1a0a2e;border:1px solid #5a20c0;border-radius:8px;color:#c9a0ff;font-size:11px;font-weight:bold;cursor:pointer;">üì∫ –°–¢–†–Ü–ú</button>
        </div>
        ${isFinal ? `<div style="text-align:center;margin-top:6px;font-size:11px;color:#555;">üèÅ –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>` : ''}
      `;
    }

    function shortName2(n) { return n && n.length > 12 ? n.slice(0,11)+'‚Ä¶' : (n||''); }

    // ---- Live Tracker (ESPN API –æ–Ω–æ–≤–ª–µ–Ω–Ω—è) ----
    function startLiveTracker(match) {
      if(liveTrackerTimer) clearInterval(liveTrackerTimer);
      liveTrackerTimer = setInterval(async () => {
        try {
          const meta = SPORT_META[match.sport];
          if(!meta?.espnUrl) return;
          const res = await fetch(meta.espnUrl + '?limit=20', { signal: AbortSignal.timeout(6000) });
          if(!res.ok) return;
          const data = await res.json();
          const events = data.events || [];
          const ev = events.find(e => ('espn_'+e.id) === match.id);
          if(!ev) return;
          const comp = ev.competitions?.[0];
          const comps = comp?.competitors || [];
          const home  = comps.find(c=>c.homeAway==='home')||comps[0]||{};
          const away  = comps.find(c=>c.homeAway==='away')||comps[1]||{};
          const statusType = ev.status?.type?.name||'';
          const isLive   = statusType==='STATUS_IN_PROGRESS';
          const isFinal  = statusType==='STATUS_FINAL';
          match.isLive   = isLive;
          match.isFinal  = isFinal;
          match.liveMinute = ev.status?.displayClock||'';
          if(isLive||isFinal) match.liveScore = { home: parseInt(home.score||0), away: parseInt(away.score||0) };
          realMatches[match.id] = match;
          const card = document.getElementById('match-card-'+match.id);
          if(card) card.innerHTML = buildMatchCardHTML(match);
          if(activeLiveMatchId===match.id && match.liveScore) updateLiveView(match, { homeScore:match.liveScore.home, awayScore:match.liveScore.away, minute:match.liveMinute, isFinished:isFinal, events:[] });
          if(isFinal) {
            clearInterval(liveTrackerTimer);
            settleMatchBets(match, { homeScore:match.liveScore?.home||0, awayScore:match.liveScore?.away||0, isFinished:true });
          }
        } catch(e) {}
      }, 60000);
    }

    // ---- Settle bets ----
    async function settleMatchBets(match, finalScore) {
      const snap = await db.ref('sport_bets').orderByChild('matchId').equalTo(match.id).once('value');
      const bets = snap.val(); if(!bets) return;
      const homeS = finalScore.homeScore, awayS = finalScore.awayScore;
      const winner = homeS > awayS ? 'home' : awayS > homeS ? 'away' : 'draw';
      for(const [betId, bet] of Object.entries(bets)) {
        if(bet.status !== 'pending') continue;
        const won = bet.outcome === winner;
        const payout = won ? Math.floor(bet.amount * bet.odds) : 0;
        await db.ref('sport_bets/'+betId).update({ status: won?'won':'lost', settledAt: Date.now(), finalScore: homeS+':'+awayS });
        if(bet.userId === currentUser) {
          if(won) {
            db.ref('users/'+currentUser+'/balance').set(firebase.database.ServerValue.increment(payout));
            playSound('bonus'); notify(`‚öΩ ${match.home} ${homeS}:${awayS} ${match.away} ‚Äî +${formatNumber(payout)}‚Ç¥!`, 'success');
            if(payout>=500) addToWinFeed('–°–ø–æ—Ä—Ç', payout, bet.odds);
          } else { playSound('loss'); notify(`‚öΩ ${match.home} ${homeS}:${awayS} ${match.away} ‚Äî –ü—Ä–æ–≥—Ä–∞—à`, 'error'); }
          addToHistory(`–°–ø–æ—Ä—Ç: ${won?'+'+payout:'-'+bet.amount}`);
        }
      }
      db.ref('sport_matches/'+match.id).update({ status:'finished', finalScore: homeS+':'+awayS });
    }

    // ---- Live View ----
    function openLiveView(matchId) {
      const match = realMatches[matchId]; if(!match) return;
      activeLiveMatchId = matchId;
      let modal = document.getElementById('liveViewModal');
      if(!modal) { modal = document.createElement('div'); modal.id='liveViewModal'; modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:#030303;z-index:9500;overflow-y:auto;'; document.body.appendChild(modal); }
      modal.innerHTML = buildLiveViewHTML(match);
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function buildLiveViewHTML(m) {
      const h = m.liveScore?.home ?? 0, a = m.liveScore?.away ?? 0;
      const sport = SPORT_META[m.sport] || SPORT_META.soccer;
      return `<div style="background:#030303;min-height:100vh;padding:16px;padding-bottom:100px;box-sizing:border-box;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <button onclick="closeLiveView()" style="background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:8px 14px;color:#aaa;font-size:13px;cursor:pointer;">‚¨Ö –ù–∞–∑–∞–¥</button>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:8px;height:8px;background:#e74c3c;border-radius:50%;animation:pulse2 1s infinite;"></div><span style="color:#e74c3c;font-size:12px;font-weight:bold;">LIVE</span></div>
          <div style="font-size:11px;color:#555;">${sport.icon} ${m.league}</div>
        </div>
        <div style="background:linear-gradient(180deg,#0d1a14,#000);border:1px solid #1a3a1a;border-radius:20px;padding:24px 16px;text-align:center;margin-bottom:16px;">
          <div style="font-size:11px;color:#555;margin-bottom:12px;" id="liveMatchMinute">‚è± ${m.liveMinute||'0'}'</div>
          <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;margin-bottom:16px;">
            <div><div style="font-size:14px;font-weight:bold;">${m.home}</div></div>
            <div id="liveScoreBoard" style="background:#000;border:2px solid #1a3a1a;border-radius:16px;padding:12px 20px;">
              <div style="font-size:44px;font-weight:900;font-family:monospace;letter-spacing:4px;">${h}<span style="color:#333;margin:0 4px;">:</span>${a}</div>
            </div>
            <div><div style="font-size:14px;font-weight:bold;">${m.away}</div></div>
          </div>
          <div id="liveStatsBar" style="display:flex;height:6px;border-radius:3px;overflow:hidden;margin-bottom:8px;">
            <div style="background:var(--green);flex:${50};transition:flex 1s;"></div>
            <div style="background:#e74c3c;flex:${50};transition:flex 1s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:10px;color:#555;"><span id="liveHomePoss">50%</span><span>–ü–æ–∑–∏—Ü—ñ—è</span><span id="liveAwayPoss">50%</span></div>
        </div>
        <div style="background:#0d0d0d;border-radius:16px;padding:14px;margin-bottom:14px;">
          <div style="font-size:13px;font-weight:bold;margin-bottom:8px;">üìã –ü–æ–¥—ñ—ó –º–∞—Ç—á—É</div>
          <div id="liveEventsList"><div style="color:#555;font-size:12px;text-align:center;padding:20px;">‚è≥ –û—á—ñ–∫—É—î–º–æ –ø–æ–¥—ñ—ó...</div></div>
        </div>
        <div style="background:#0a1a0a;border:1px solid #1a3a1a;border-radius:16px;padding:14px;">
          <div style="font-size:13px;font-weight:bold;color:var(--accent);margin-bottom:10px;">‚ö° –®–≤–∏–¥–∫–∞ —Å—Ç–∞–≤–∫–∞</div>
          <div class="match-odds-row" style="gap:6px;">
            <div class="odds-btn" onclick="openBetSlip('${m.id}','home','${m.home.replace(/'/g,"\\'")}')"><div class="odds-label">${shortName2(m.home)}</div><div class="odds-val">${m.homeOdds}</div></div>
            ${m.drawOdds?`<div class="odds-btn" onclick="openBetSlip('${m.id}','draw','–ù—ñ—á–∏—è')"><div class="odds-label">X</div><div class="odds-val">${m.drawOdds}</div></div>`:''}
            <div class="odds-btn" onclick="openBetSlip('${m.id}','away','${m.away.replace(/'/g,"\\'")}')"><div class="odds-label">${shortName2(m.away)}</div><div class="odds-val">${m.awayOdds}</div></div>
          </div>
        </div>
      </div>`;
    }

    function updateLiveView(match, score) {
      const minEl = document.getElementById('liveMatchMinute');
      const sbEl  = document.getElementById('liveScoreBoard');
      const evEl  = document.getElementById('liveEventsList');
      const statEl= document.getElementById('liveStatsBar');
      const hpEl  = document.getElementById('liveHomePoss');
      const apEl  = document.getElementById('liveAwayPoss');
      if(minEl) minEl.textContent = `‚è± ${score.minute||match.liveMinute||0}'`;
      if(sbEl) sbEl.innerHTML = `<div style="font-size:44px;font-weight:900;font-family:monospace;letter-spacing:4px;">${score.homeScore}<span style="color:#333;margin:0 4px;">:</span>${score.awayScore}</div>`;
      if(evEl && score.events?.length) {
        const icons = {goal:'‚öΩ',yellowCard:'üü®',redCard:'üü•',substitution:'üîÑ',penalty:'‚ö°'};
        evEl.innerHTML = [...score.events].reverse().map(ev => `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #111;"><div style="min-width:28px;font-size:10px;color:#555;">${ev.minute}'</div><div style="font-size:16px;">${icons[ev.type]||'üìå'}</div><div><div style="font-size:12px;font-weight:bold;">${ev.player||''}</div><div style="font-size:10px;color:#555;">${ev.team==='home'?match.home:match.away}</div></div></div>`).join('');
      }
      const hP = score.homeScore > score.awayScore ? 55 : score.awayScore > score.homeScore ? 45 : 50;
      if(statEl) statEl.innerHTML = `<div style="background:var(--green);flex:${hP};transition:flex 1s;"></div><div style="background:#e74c3c;flex:${100-hP};transition:flex 1s;"></div>`;
      if(hpEl) hpEl.textContent = hP+'%'; if(apEl) apEl.textContent = (100-hP)+'%';
    }

    function closeLiveView() {
      const m = document.getElementById('liveViewModal');
      if(m) m.classList.add('hidden');
      document.body.style.overflow = '';
      activeLiveMatchId = null;
    }

    // ---- Bet Slip ----
    function openBetSlip(matchId, outcome, team) {
      const match = realMatches[matchId]; if(!match) return;
      const odds = outcome==='home' ? match.homeOdds : outcome==='away' ? match.awayOdds : (match.drawOdds||3.40);
      currentBetSlip = { matchId, outcome, team, odds: parseFloat(odds), match };
      const modal = document.getElementById('betSlipModal');
      document.getElementById('betSlipMatchInfo').innerHTML =
        `<div style="font-size:11px;color:#555;margin-bottom:4px;">${SPORT_META[match.sport]?.icon||'üèÜ'} ${match.league}</div>
         <div style="font-weight:bold;">${match.home} vs ${match.away}</div>
         <div style="color:var(--green);margin-top:4px;font-size:13px;">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <b>${team}</b></div>`;
      document.getElementById('betSlipOdds').textContent = '√ó' + parseFloat(odds).toFixed(2);
      const tipEl = document.getElementById('betSlipAiTip');
      if(tipEl) tipEl.textContent = 'ü§ñ ' + (match.analysis || match.aiAnalysis || '–®–Ü –∞–Ω–∞–ª—ñ–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
      updateBetSlipPotential();
      modal.classList.remove('hidden');
    }

    function updateBetSlipPotential() {
      if(!currentBetSlip) return;
      const amt = parseInt(document.getElementById('betSlipAmount')?.value)||0;
      const el = document.getElementById('betSlipPotential');
      if(el) el.textContent = formatNumber(Math.floor(amt * currentBetSlip.odds)) + ' ‚Ç¥';
    }

    function closeBetSlip() {
      const m = document.getElementById('betSlipModal'); if(m) m.classList.add('hidden');
      currentBetSlip = null;
    }

    function confirmRealSportBet() {
      if(!currentBetSlip) return;
      const bet = validateBet(document.getElementById('betSlipAmount').value); if(!bet) return;
      db.ref('users/'+currentUser).update({balance: userData.balance - bet});
      addWager(bet);
      const betRecord = {
        userId: currentUser, matchId: currentBetSlip.matchId,
        outcome: currentBetSlip.outcome, team: currentBetSlip.team,
        odds: currentBetSlip.odds, amount: bet,
        potential: Math.floor(bet * currentBetSlip.odds),
        status: 'pending',
        matchTitle: `${currentBetSlip.match.home} vs ${currentBetSlip.match.away}`,
        sport: currentBetSlip.match.sport, placedAt: Date.now()
      };
      db.ref('sport_bets').push(betRecord).then(() => {
        playSound('click');
        notify(`üé´ –°—Ç–∞–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ: ${bet}‚Ç¥ –Ω–∞ ${currentBetSlip.team} (√ó${currentBetSlip.odds.toFixed(2)})`, 'success');
        closeBetSlip();
        loadSportMyBets();
        if(currentBetSlip?.match && !liveTrackerTimer) startLiveTracker(currentBetSlip.match);
      });
    }

    function loadSportMyBets() {
      const el = document.getElementById('sportMyBets'); if(!el) return;
      db.ref('sport_bets').orderByChild('userId').equalTo(currentUser).limitToLast(10).once('value', snap => {
        const bets = snap.val();
        if(!bets) { el.innerHTML = '<div style="color:#555;font-size:12px;padding:8px 0;">–ù–µ–º–∞—î —Å—Ç–∞–≤–æ–∫</div>'; return; }
        const sorted = Object.values(bets).sort((a,b) => b.placedAt - a.placedAt);
        el.innerHTML = sorted.map(b => {
          const sc = b.status==='won'?'var(--green)':b.status==='lost'?'var(--red)':'var(--accent)';
          const st = b.status==='won'?`‚úÖ +${formatNumber(b.potential)}‚Ç¥`:b.status==='lost'?`‚ùå -${formatNumber(b.amount)}‚Ç¥`:'‚è≥ –û—á—ñ–∫—É—î';
          return `<div style="background:var(--input);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
            <div><div style="font-size:12px;font-weight:bold;">${(SPORT_META[b.sport]?.icon||'üèÜ')} ${b.team} <span style="font-size:10px;color:#555;">√ó${b.odds}</span></div>
            <div style="font-size:10px;color:#555;">${b.matchTitle||''}</div></div>
            <div style="text-align:right;"><div style="font-size:13px;font-weight:bold;color:${sc};">${st}</div><div style="font-size:10px;color:#555;">${b.amount}‚Ç¥</div></div>
          </div>`;
        }).join('');
      });
    }

    function checkPendingBetsOnStartup() {
      if(!currentUser) return;
      db.ref('sport_bets').orderByChild('userId').equalTo(currentUser).once('value', snap => {
        const bets = snap.val()||{};
        const pending = Object.values(bets).filter(b=>b.status==='pending');
        if(pending.length) notify(`‚è≥ –£ –≤–∞—Å ${pending.length} –Ω–µ–∑–∞–∫—Ä–∏—Ç–∏—Ö —Å—Ç–∞–≤–æ–∫`, 'info');
      });
    }

    // Override old references
    window.loadSportMatches = function(sport, btnEl) { loadRealSportMatches(sport, btnEl); };
    window.confirmSportBet  = confirmRealSportBet;


        // ============================================================
    // ===== AI SUPPORT CHAT =====
    // ============================================================
    let supportChatListener = null;
    let adminOnlineStatus = false;

    function initAiSupport() {
      // Monitor admin online status
      db.ref('online').on('value', snap => {
        const onlineUsers = snap.val() || {};
        adminOnlineStatus = Object.keys(onlineUsers).some(u => u.toLowerCase() === 'theivankoo');
      });
    }

    // Patch openSupportModal to init AI support
    const _origOpenSupport = window.openSupportModal || function(){};
    window.openSupportModal = function() {
      openModal('support-modal');
      initSupportChat();
    };

    function initSupportChat() {
      const box = document.getElementById('supportChatBox');
      if(!box) return;

      if(!supportChatListener) {
        supportChatListener = db.ref('support_chats/'+currentUser).limitToLast(30).on('child_added', snap => {
          const m = snap.val(); if(!m) return;
          const isMe = m.sender === 'user';
          const isAI = m.sender === 'ai';
          const div = document.createElement('div');
          div.style.cssText = 'margin-bottom:10px;display:flex;flex-direction:' + (isMe?'row-reverse':'row') + ';gap:8px;align-items:flex-end;';
          const bubble = document.createElement('div');
          bubble.style.cssText = 'max-width:80%;padding:10px 14px;border-radius:' + (isMe?'16px 16px 4px 16px':'16px 16px 16px 4px') + ';' +
            'background:' + (isMe?'var(--accent)':isAI?'#0d1a2e':'#1a1a1a') + ';' +
            'color:' + (isMe?'#000':'#fff') + ';font-size:13px;';
          const name = document.createElement('div');
          name.style.cssText = 'font-size:9px;margin-bottom:4px;color:' + (isAI?'#4a90e2':'#777') + ';font-weight:bold;';
          name.textContent = isMe ? '–í–∏' : isAI ? 'ü§ñ AI –ü—ñ–¥—Ç—Ä–∏–º–∫–∞' : 'üë®‚Äçüíº –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä';
          bubble.appendChild(name);
          bubble.appendChild(document.createTextNode(m.text));
          div.appendChild(bubble);
          box.appendChild(div);
          box.scrollTop = box.scrollHeight;
        });
      }

      // Show admin status
      const statusEl = document.getElementById('supportAdminStatus');
      if(statusEl) {
        statusEl.textContent = adminOnlineStatus ? 'üü¢ –ê–¥–º—ñ–Ω –æ–Ω–ª–∞–π–Ω' : 'ü§ñ AI –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞';
        statusEl.style.color = adminOnlineStatus ? 'var(--green)' : '#4a90e2';
      }
    }

    // Override sendSupportMsg with AI auto-reply
    window.sendSupportMsg = function() {
      const inp = document.getElementById('supportMsg');
      const t = inp ? inp.value.trim() : '';
      if(!t) return;
      inp.value = '';
      db.ref('support_chats/'+currentUser).push({text:t, sender:'user', time:Date.now()});

      // If admin offline ‚Üí AI responds
      if(!adminOnlineStatus) {
        setTimeout(() => aiSupportReply(t), 1200 + Math.random()*1500);
      }
    };

    async function aiSupportReply(userMsg) {
      // Show typing indicator
      const box = document.getElementById('supportChatBox');
      const typing = document.createElement('div');
      typing.id = 'aiTyping';
      typing.style.cssText = 'display:flex;gap:4px;padding:8px 14px;background:#0d1a2e;border-radius:12px;width:fit-content;margin-bottom:8px;';
      typing.innerHTML = '<span style="animation:blink 1s infinite">‚Ä¢</span><span style="animation:blink 1s 0.3s infinite">‚Ä¢</span><span style="animation:blink 1s 0.6s infinite">‚Ä¢</span>';
      if(box) { box.appendChild(typing); box.scrollTop = box.scrollHeight; }

      try {
        const systemPrompt = `–¢–∏ AI-–ø–æ–º—ñ—á–Ω–∏–∫ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–∞–∑–∏–Ω–æ SlotOK. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ (2-4 —Ä–µ—á–µ–Ω–Ω—è), –¥—Ä—É–∂–Ω—å–æ, —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.
–ö–∞–∑–∏–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: —ñ–≥—Ä–∏ (—Å–ª–æ—Ç–∏, –∫—Ä–∞—à, —Ä—É–ª–µ—Ç–∫–∞, –±–ª–µ–∫–¥–∂–µ–∫, –ø–æ–∫–µ—Ä, –º—ñ–Ω–∏, –ø–ª—ñ–Ω–æ, —Ç–∞ —ñ–Ω—à—ñ), VIP —Å–∏—Å—Ç–µ–º–∞ (Iron –¥–æ Supreme), –¥–µ–ø–æ–∑–∏—Ç–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç, –≤–∏–≤–æ–¥–∏ –Ω–∞ –∫–∞—Ä—Ç–∫—É/USDT.
–Ø–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–µ –∞–±–æ –ø–æ—Ç—Ä–µ–±—É—î –∞–¥–º—ñ–Ω–∞ ‚Äî —Å–∫–∞–∂–∏ —â–æ –ø–µ—Ä–µ–¥–∞—Å–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.
–ù—ñ–∫–æ—ó –Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª—è–π –ª—ñ–º—ñ—Ç–∏, –±–æ–Ω—É—Å–∏ –∞–±–æ –∞–∫—Ü—ñ—ó —è–∫–∏—Ö –Ω–µ–º–∞—î. –ë—É–¥—å —á–µ—Å–Ω–∏–º.`;

        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 300,
            system: systemPrompt,
            messages: [{ role:'user', content: userMsg }]
          })
        });

        const data = await res.json();
        const reply = data.content?.[0]?.text || '–ó–∞—á–µ–∫–∞–π—Ç–µ, –∞–¥–º—ñ–Ω —Å–∫–æ—Ä–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å!';

        if(box) { const t2 = document.getElementById('aiTyping'); if(t2) t2.remove(); }
        db.ref('support_chats/'+currentUser).push({text: reply, sender:'ai', time:Date.now()});

      } catch(e) {
        if(box) { const t2 = document.getElementById('aiTyping'); if(t2) t2.remove(); }
        const fallbacks = [
          '–î—è–∫—É—é –∑–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è! –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ–∑–∞–±–∞—Ä–æ–º –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å.',
          '–í–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ. –ó–∞–∑–≤–∏—á–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω.',
          '–Ø –ø–µ—Ä–µ–¥–∞–º –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û—á—ñ–∫—É–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ!',
        ];
        const reply = fallbacks[Math.floor(Math.random()*fallbacks.length)];
        db.ref('support_chats/'+currentUser).push({text: reply, sender:'ai', time:Date.now()});
      }
    }



    // ========================
    // HOME STATS + JACKPOT
    // ========================
    function updateHomeStats() {
      if(!currentUser) return;
      const statBets = document.getElementById('homeStatBets');
      const statWins = document.getElementById('homeStatWins');
      const statVip  = document.getElementById('homeStatVip');
      const jackEl   = document.getElementById('homeJackpot');
      if(statBets && userData) {
        statBets.textContent = userData.totalBets ? formatNumber(userData.totalBets) : '0';
        statWins.textContent = userData.totalWins ? formatNumber(userData.totalWins) : '0';
      }
      // VIP level
      if(statVip && userData) {
        const wager = userData.totalWager || 0;
        const VIP_LEVELS = ['Iron','Bronze','Silver','Gold','Platinum','Diamond','Master','Supreme'];
        const VIP_REQ    = [0,1000,5000,20000,50000,100000,250000,500000];
        let vipLevel = 0;
        for(let i=VIP_LEVELS.length-1;i>=0;i--) { if(wager>=VIP_REQ[i]){vipLevel=i;break;} }
        statVip.textContent = VIP_LEVELS[vipLevel];
      }
      // Random jackpot
      if(jackEl) {
        const base = 50000 + Math.floor(Math.random()*200000);
        jackEl.textContent = formatNumber(base) + '‚Ç¥';
      }
    }


    // ============================================================
    // DAILY CLEANUP: —á–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ + —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (—Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å)
    // ============================================================
    function runDailyCleanup() {
      const CLEANUP_KEY = 'slotok_last_cleanup';
      const now = Date.now();
      const lastClean = parseInt(localStorage.getItem(CLEANUP_KEY)||'0');
      const ONE_DAY = 24*60*60*1000;
      if(now - lastClean < ONE_DAY) return; // Already cleaned today

      // Clear all support chats (admin-level: each user's chat)
      db.ref('support_chats').once('value', snap => {
        const all = snap.val() || {};
        const promises = Object.keys(all).map(uid => db.ref('support_chats/'+uid).remove());
        Promise.all(promises).then(() => console.log('Support chats cleared'));
      });

      // Clear notifications from Firebase
      db.ref('notifications').remove();

      // Clear local notifications
      try {
        localStorage.removeItem('slotok_notifs');
        allNotifs = [];
        updateNotifBadge();
      } catch(e) {}

      localStorage.setItem(CLEANUP_KEY, String(now));
      console.log('Daily cleanup done');
    }


    // ============================================================
    // ===== STREAM VIEWER =====
    // ============================================================
    const STREAM_SOURCES = {
      soccer: [
        { name:'Footbal TV', icon:'üì∫', url:'https://www.youtube.com/embed/live_stream?channel=UCqZQlzSHbVJrwrn5XvzrzcA&autoplay=1', type:'youtube' },
        { name:'ESPN Goals', icon:'‚öΩ', url:'https://www.twitch.tv/embed/espnfc/chat', type:'twitch' },
        { name:'Sky Sports', icon:'üåê', url:'https://www.bbc.co.uk/sport/football', type:'web' },
      ],
      csgo: [
        { name:'ESL CS2', icon:'üéÆ', url:'https://player.twitch.tv/?channel=ESL_CSGO&parent=' + location.hostname, type:'twitch' },
        { name:'BLAST CS2', icon:'üí•', url:'https://player.twitch.tv/?channel=BLASTPremier&parent=' + location.hostname, type:'twitch' },
        { name:'cs2 Clips', icon:'üéØ', url:'https://www.youtube.com/embed?listType=search&list=CS2+match+live&autoplay=1', type:'youtube' },
      ],
      dota2: [
        { name:'DPC League', icon:'‚öîÔ∏è', url:'https://player.twitch.tv/?channel=dota2&parent=' + location.hostname, type:'twitch' },
        { name:'Twitch Dota', icon:'üü£', url:'https://player.twitch.tv/?channel=BeyondTheSummit&parent=' + location.hostname, type:'twitch' },
      ],
      lol: [
        { name:'LoL Esports', icon:'üèÜ', url:'https://player.twitch.tv/?channel=lolesports&parent=' + location.hostname, type:'twitch' },
        { name:'LEC Live', icon:'‚ö°', url:'https://player.twitch.tv/?channel=LEC&parent=' + location.hostname, type:'twitch' },
      ],
      valorant: [
        { name:'VCT', icon:'üî´', url:'https://player.twitch.tv/?channel=valorant&parent=' + location.hostname, type:'twitch' },
        { name:'Valorant Live', icon:'üéØ', url:'https://player.twitch.tv/?channel=valorant_jpn&parent=' + location.hostname, type:'twitch' },
      ],
      basketball: [
        { name:'NBA TV', icon:'üèÄ', url:'https://www.youtube.com/embed?listType=search&list=NBA+highlights+live&autoplay=1', type:'youtube' },
      ],
      hockey: [
        { name:'NHL Network', icon:'üèí', url:'https://www.youtube.com/embed?listType=search&list=NHL+game+live&autoplay=1', type:'youtube' },
      ],
      default: [
        { name:'YouTube Live', icon:'üì∫', url:'https://www.youtube.com/embed?listType=search&list=sports+live&autoplay=1', type:'youtube' },
        { name:'Twitch Sports', icon:'üü£', url:'https://player.twitch.tv/?channel=nba&parent=' + location.hostname, type:'twitch' },
      ]
    };

    function openStreamViewer(sport, matchTitle) {
      const modal = document.getElementById('streamViewerModal');
      const titleEl = document.getElementById('streamTitle');
      const sourcesEl = document.getElementById('streamSourcesList');
      const icon = (typeof SPORT_META !== 'undefined' && SPORT_META[sport]) ? SPORT_META[sport].icon : 'üéÆ';

      if(titleEl) titleEl.textContent = icon + ' ' + (matchTitle || 'Live —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è');

      const sources = STREAM_SOURCES[sport] || STREAM_SOURCES.default;

      // Build source buttons
      if(sourcesEl) {
        sourcesEl.innerHTML = sources.map((s,i) =>
          `<button onclick="loadStreamSource(${i},'${sport}')" style="flex-shrink:0;background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:8px 12px;color:#ccc;font-size:12px;cursor:pointer;white-space:nowrap;" id="streamBtn_${i}">
            ${s.icon} ${s.name}
          </button>`
        ).join('');
      }

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Auto-load first source
      if(sources.length) loadStreamSource(0, sport);
    }

    function loadStreamSource(idx, sport) {
      const sources = STREAM_SOURCES[sport] || STREAM_SOURCES.default;
      const s = sources[idx];
      if(!s) return;

      // Highlight active button
      document.querySelectorAll('[id^="streamBtn_"]').forEach((b,i) => {
        b.style.borderColor = i === idx ? 'var(--accent)' : '#333';
        b.style.color = i === idx ? 'var(--accent)' : '#ccc';
      });

      const area = document.getElementById('streamEmbedArea');
      if(!area) return;

      if(s.type === 'twitch' || s.type === 'youtube') {
        area.innerHTML = `
          <iframe src="${s.url}" style="width:100%;height:100%;border:none;" allowfullscreen allow="autoplay; fullscreen" sandbox="allow-scripts allow-same-origin allow-popups allow-forms" onerror="this.parentElement.innerHTML='<div style=\'text-align:center;color:#555;padding:40px;\'>üì∫<br><br>–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.<br><a href=\'${s.url.replace('embed/','watch?v=').replace('player.','').replace('?channel=','/')}\' target=\'_blank\' style=\'color:var(--accent);\'>–í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ñ ‚Üó</a></div>'">
          </iframe>`;
      } else {
        area.innerHTML = `
          <div style="text-align:center;padding:30px;">
            <div style="font-size:36px;margin-bottom:12px;">${s.icon}</div>
            <div style="font-size:14px;color:#ccc;margin-bottom:16px;">${s.name}</div>
            <a href="${s.url}" target="_blank" style="display:inline-block;background:var(--accent);color:#000;font-weight:bold;padding:12px 24px;border-radius:12px;font-size:14px;text-decoration:none;">
              üì∫ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é ‚Üó
            </a>
          </div>`;
      }
    }

    function closeStreamViewer() {
      const modal = document.getElementById('streamViewerModal');
      if(modal) {
        modal.classList.add('hidden');
        // Stop stream
        const area = document.getElementById('streamEmbedArea');
        if(area) area.innerHTML = '';
      }
      document.body.style.overflow = '';
    }



    // ============================================================
    // ===== –°–õ–û–¢–Ü–ö–ò ‚Äî –≤–Ω—É—Ç—Ä—ñ—à–Ω—è –≤–∞–ª—é—Ç–∞ =====
    // ============================================================
    const SLOTIKY_PRICE = 10000000; // 10M UAH per 1 slotik

    const SLOTIKY_SHOP_ITEMS = [
      { id:'avatar_gold',    name:'–ó–æ–ª–æ—Ç–∏–π –∞–≤–∞—Ç–∞—Ä',      icon:'üëë', price:2,  desc:'–ï–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞ –∑–æ–ª–æ—Ç–∞ —Ä–∞–º–∫–∞',   type:'cosmetic' },
      { id:'avatar_diamond', name:'Diamond –∞–≤–∞—Ç–∞—Ä',      icon:'üíé', price:5,  desc:'–ê–ª–º–∞–∑–Ω–∞ —Ä–∞–º–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é',       type:'cosmetic' },
      { id:'username_color', name:'–ö–æ–ª—å–æ—Ä–æ–≤–∏–π –Ω—ñ–∫',       icon:'üåà', price:3,  desc:'–í–µ—Å–µ–ª–∫–∞ —É —á–∞—Ç—ñ',              type:'cosmetic' },
      { id:'chat_emoji_x2',  name:'–ü–æ–¥–≤—ñ–π–Ω—ñ –µ–º–æ–¥–∑—ñ —á–∞—Ç—É', icon:'üòé', price:1,  desc:'+20 –¥–æ–ø. –µ–º–æ–¥–∑—ñ –≤ —á–∞—Ç—ñ',     type:'feature'  },
      { id:'vip_boost',      name:'VIP –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è',      icon:'üöÄ', price:8,  desc:'2x –≤–∞–≥–µ—Ä —Ä–∞—Ö—É—î—Ç—å—Å—è 7 –¥–Ω—ñ–≤',  type:'boost'    },
      { id:'cashback_boost', name:'–ö–µ—à–±–µ–∫ x2',            icon:'üí∞', price:4,  desc:'–ü–æ–¥–≤–æ—î–Ω–∏–π –∫–µ—à–±–µ–∫ 3 –¥–Ω—ñ',     type:'boost'    },
      { id:'badge_whale',    name:'–ó–Ω–∞—á–æ–∫ "–ö–∏—Ç"',          icon:'üêã', price:10, desc:'–†—ñ–¥–∫—ñ—Å–Ω–∏–π –∑–Ω–∞—á–æ–∫ —É –ø—Ä–æ—Ñ—ñ–ª—ñ', type:'cosmetic' },
      { id:'daily_x3',       name:'–©–æ–¥–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å x3',    icon:'üéÅ', price:3,  desc:'–£—Ç—Ä–∏—á—ñ –±—ñ–ª—å—à–µ —â–æ–¥–Ω—è 7 –¥–Ω—ñ–≤', type:'boost'    },
      { id:'lootbox_ultra',  name:'Ultra –õ—É—Ç-–±–æ–∫—Å',        icon:'üì¶', price:2,  desc:'–ï–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏–π –ª—É—Ç-–±–æ–∫—Å',      type:'item'     },
      { id:'name_frame',     name:'–†–∞–º–∫–∞ "Supreme"',       icon:'üî±', price:15, desc:'Supreme —Ä–∞–º–∫–∞ –¥–ª—è —ñ–º–µ–Ω—ñ',    type:'cosmetic' },
    ];

    function initSlotiky() {
      const bal = document.getElementById('slotikyBalance');
      if(bal) bal.textContent = formatNumber(userData.slotiky || 0);
      renderSlotikyShop();
    }

    function buySlotiky(amount) {
      const prices = { 1: 10000000, 5: 50000000, 10: 95000000, 50: 450000000 };
      const cost = prices[amount] || amount * SLOTIKY_PRICE;
      const bal = userData.balance || 0;
      if(bal < cost) {
        notify(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${formatNumber(cost)} ‚Ç¥`, 'error');
        return;
      }
      // Confirm
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9900;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
      modal.innerHTML = `
        <div style="background:#111;border:1px solid #5a20c0;border-radius:20px;padding:24px;max-width:320px;width:100%;text-align:center;">
          <div style="font-size:40px;margin-bottom:12px;">ü™ô</div>
          <div style="font-size:18px;font-weight:bold;color:#c9a0ff;margin-bottom:8px;">–ö—É–ø–∏—Ç–∏ ${amount} –°–ª–æ—Ç—ñ–∫${amount>1?'—ñ–≤':''}?</div>
          <div style="font-size:14px;color:#888;margin-bottom:20px;">–í–∞—Ä—Ç—ñ—Å—Ç—å: <b style="color:#fff;">${formatNumber(cost)} ‚Ç¥</b></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:10px;color:#aaa;cursor:pointer;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button onclick="confirmBuySlotiky(${amount},${cost});this.closest('div[style*=fixed]').remove();" style="padding:12px;background:linear-gradient(135deg,#5a20c0,#8040e0);border:none;border-radius:10px;color:#fff;font-weight:bold;cursor:pointer;">‚úÖ –ö—É–ø–∏—Ç–∏</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    function confirmBuySlotiky(amount, cost) {
      db.ref('users/'+currentUser).update({
        balance:  (userData.balance  || 0) - cost,
        slotiky:  (userData.slotiky  || 0) + amount,
      });
      playSound('bonus');
      notify(`ü™ô –ö—É–ø–ª–µ–Ω–æ ${amount} –°–ª–æ—Ç—ñ–∫${amount>1?'—ñ–≤':''}!`, 'success');
      addToHistory(`–ö—É–ø–ª–µ–Ω–æ ${amount} –°–ª–æ—Ç—ñ–∫${amount>1?'—ñ–≤':''}: -${formatNumber(cost)}‚Ç¥`);
      setTimeout(()=>{ const b=document.getElementById('slotikyBalance'); if(b) b.textContent=formatNumber((userData.slotiky||0)+amount); }, 300);
    }

    function renderSlotikyShop() {
      const grid = document.getElementById('slotikyShopGrid'); if(!grid) return;
      const owned = userData.slotikyItems || {};
      grid.innerHTML = SLOTIKY_SHOP_ITEMS.map(item => {
        const isOwned = owned[item.id];
        const typeColor = item.type==='boost'?'#f39c12':item.type==='cosmetic'?'#c9a0ff':item.type==='feature'?'#27ae60':'#4a90e2';
        return `<div style="background:linear-gradient(180deg,#0d0520,#050010);border:1px solid ${isOwned?'#27ae60':'#3a1080'};border-radius:14px;padding:14px;position:relative;">
          ${isOwned?'<div style="position:absolute;top:6px;right:8px;font-size:10px;color:#27ae60;font-weight:bold;">‚úÖ –Ñ</div>':''}
          <div style="font-size:28px;margin-bottom:6px;">${item.icon}</div>
          <div style="font-size:12px;font-weight:bold;color:#fff;margin-bottom:3px;">${item.name}</div>
          <div style="font-size:10px;color:#666;margin-bottom:8px;">${item.desc}</div>
          <div style="font-size:11px;color:#c9a0ff;font-weight:bold;margin-bottom:8px;">ü™ô ${item.price} –°–ª–æ—Ç—ñ–∫${item.price>1?'—ñ–≤':''}</div>
          <button onclick="buyShopItem('${item.id}',${item.price})" ${isOwned?'disabled':''} style="width:100%;padding:7px;background:${isOwned?'#1a1a1a':'linear-gradient(135deg,#5a20c0,#8040e0)'};border:none;border-radius:8px;color:${isOwned?'#555':'#fff'};font-size:11px;font-weight:bold;cursor:${isOwned?'default':'pointer'};">${isOwned?'–ü—Ä–∏–¥–±–∞–Ω–æ':'–ö—É–ø–∏—Ç–∏'}</button>
        </div>`;
      }).join('');
    }

    function buyShopItem(itemId, price) {
      const currentSlotiky = userData.slotiky || 0;
      if(currentSlotiky < price) { notify(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Å–ª–æ—Ç—ñ–∫—ñ–≤! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${price} ü™ô`, 'error'); return; }
      const item = SLOTIKY_SHOP_ITEMS.find(i=>i.id===itemId); if(!item) return;
      const owned = userData.slotikyItems || {};
      owned[itemId] = true;
      db.ref('users/'+currentUser).update({ slotiky: currentSlotiky - price, slotikyItems: owned });
      playSound('win');
      notify(`üéâ –ü—Ä–∏–¥–±–∞–Ω–æ: ${item.icon} ${item.name}!`, 'success');
      setTimeout(renderSlotikyShop, 300);
    }

    // ============================================================
    // ===== –¢–£–†–ù–Ü–† ‚Äî –ü–û–í–ù–ê –°–ò–°–¢–ï–ú–ê =====
    // ============================================================
    let activeTournament = null; // tournament the user joined

    const TOURNEY_GAMES = [
      { id:'t_crash',   name:'–¢—É—Ä–Ω—ñ—Ä –ö—Ä–∞—à',   icon:'üöÄ', desc:'–ú–Ω–æ–∂–Ω–∏–∫ √ó —Ç–æ—á–∫–∏',    game:'crash',   pointMult: 1    },
      { id:'t_slots',   name:'–¢—É—Ä–Ω—ñ—Ä –°–ª–æ—Ç–∏',  icon:'üé∞', desc:'–í–∏–≥—Ä–∞—à ‚Üí –æ—á–∫–∏',      game:'slots',   pointMult: 0.5  },
      { id:'t_mines',   name:'–¢—É—Ä–Ω—ñ—Ä –ú—ñ–Ω–∏',   icon:'üí£', desc:'–í—ñ–¥–∫—Ä–∏–π –∫–ª—ñ—Ç–∏–Ω–∫–∏',   game:'mines',   pointMult: 2    },
      { id:'t_plinko',  name:'–¢—É—Ä–Ω—ñ—Ä –ü–ª—ñ–Ω–∫–æ', icon:'üîª', desc:'–ú–Ω–æ–∂–Ω–∏–∫ √ó —Å—Ç–∞–≤–∫—É',   game:'plinko',  pointMult: 1.5  },
      { id:'t_tower',   name:'–¢—É—Ä–Ω—ñ—Ä –í–µ–∂–∞',   icon:'üóº', desc:'–†—ñ–≤–µ–Ω—å √ó —Å—Ç–∞–≤–∫—É',    game:'tower',   pointMult: 3    },
      { id:'t_limbo',   name:'–¢—É—Ä–Ω—ñ—Ä –õ—ñ–º–±–æ',  icon:'üéØ', desc:'–ú–µ—Ç–∞ √ó —Ç–æ—á–∫–∏',       game:'limbo',   pointMult: 1    },
      { id:'t_dice',    name:'–¢—É—Ä–Ω—ñ—Ä –ö—É–±–∏–∫',  icon:'üé≤', desc:'–í–∏–≥—Ä–∞—à ‚Üí –æ—á–∫–∏',      game:'dice',    pointMult: 1    },
      { id:'t_hilo',    name:'–¢—É—Ä–Ω—ñ—Ä Hi-Lo',  icon:'üÉè', desc:'–°–µ—Ä—ñ—è ‚Üí –æ—á–∫–∏',       game:'hilo',    pointMult: 2    },
    ];

    function switchTourneyTab(tab, el) {
      document.querySelectorAll('#tab-tournaments .cashier-tab-btn').forEach(b=>b.classList.remove('active'));
      if(el) el.classList.add('active');
      ['active','mine','games'].forEach(t => {
        const p = document.getElementById('tourney-panel-'+t);
        if(p) p.classList.toggle('hidden', t!==tab);
      });
      if(tab==='active') loadTournamentsV2();
      if(tab==='mine')   loadMyTournaments();
      if(tab==='games')  renderTourneyGames();
    }

    function loadTournamentsV2() {
      db.ref('tournaments').once('value', snap => {
        const data = snap.val();
        const list = document.getElementById('tournamentsList');
        if(!list) return;
        if(!data) { list.innerHTML = '<div style="color:#555;padding:30px;text-align:center;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—É—Ä–Ω—ñ—Ä—ñ–≤</div>'; return; }
        list.innerHTML = '';
        Object.entries(data).forEach(([id, t]) => {
          const endTime = t.startTime + t.duration * 3600000;
          const msLeft = endTime - Date.now();
          const hoursLeft = Math.max(0, Math.floor(msLeft / 3600000));
          const minsLeft  = Math.max(0, Math.floor((msLeft % 3600000) / 60000));
          const isActive  = msLeft > 0;
          const card = document.createElement('div');
          card.className = 'tournament-card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div style="font-size:16px;font-weight:bold;">${t.icon||'üèÜ'} ${t.name}</div>
              <span style="font-size:10px;background:${isActive?'rgba(76,217,100,0.2)':'rgba(255,59,48,0.2)'};color:${isActive?'var(--green)':'var(--red)'};padding:3px 8px;border-radius:10px;font-weight:bold;">${isActive?'üü¢ LIVE':'üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–æ'}</span>
            </div>
            <div style="background:linear-gradient(135deg,#1a1200,#0d0800);border-radius:10px;padding:12px;margin-bottom:10px;">
              <div style="font-size:24px;font-weight:900;color:var(--accent);text-align:center;">üèÜ ${formatNumber(t.prize)} ‚Ç¥</div>
              <div style="font-size:10px;color:#555;text-align:center;margin-top:2px;">–ü–µ—Ä—à–µ –º—ñ—Å—Ü–µ</div>
            </div>
            <div style="font-size:11px;color:#777;margin-bottom:10px;">
              ‚è± ${isActive ? `–ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${hoursLeft}–≥–æ–¥ ${minsLeft}—Ö–≤` : '–¢—É—Ä–Ω—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ'} ‚Ä¢
              üë• –Ü–≥—Ä–∏: ${(t.allowedGames||['crash','slots','mines']).join(', ')}
            </div>
            <div id="t-lb-${id}" style="margin-bottom:10px;"></div>
            ${isActive ? `<button class="btn-gold" style="padding:10px;" onclick="joinTournamentV2('${id}','${t.name}',${t.prize})">üéØ –í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å</button>` : ''}
          `;
          list.appendChild(card);
          loadTournamentLeaderboard(id);
        });
      });
    }

    function loadMyTournaments() {
      const el = document.getElementById('myTournamentsList'); if(!el) return;
      db.ref('tournament_scores').once('value', snap => {
        const all = snap.val() || {};
        const mine = Object.entries(all).filter(([tid,scores]) => scores && scores[currentUser] !== undefined);
        if(!mine.length) { el.innerHTML = '<div style="color:#555;padding:30px;text-align:center;">–í–∏ –Ω–µ –±–µ—Ä–µ—Ç–µ —É—á–∞—Å—Ç—ñ –≤ –∂–æ–¥–Ω–æ–º—É —Ç—É—Ä–Ω—ñ—Ä—ñ</div>'; return; }
        el.innerHTML = mine.map(([tid, scores]) => {
          const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
          const myPos  = sorted.findIndex(([u])=>u===currentUser)+1;
          const myScore= scores[currentUser]||0;
          return `<div class="tournament-card">
            <div style="font-size:13px;font-weight:bold;margin-bottom:6px;">–¢—É—Ä–Ω—ñ—Ä: ${tid}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><div style="font-size:11px;color:#555;">–í–∞—à—ñ –æ—á–∫–∏</div><div style="font-size:22px;font-weight:900;color:var(--accent);">${formatNumber(myScore)}</div></div>
              <div><div style="font-size:11px;color:#555;">–ü–æ–∑–∏—Ü—ñ—è</div><div style="font-size:22px;font-weight:900;color:${myPos===1?'var(--accent)':'#aaa'};">#${myPos}</div></div>
              <div><div style="font-size:11px;color:#555;">–£—á–∞—Å–Ω–∏–∫—ñ–≤</div><div style="font-size:22px;font-weight:900;color:#777;">${sorted.length}</div></div>
            </div>
          </div>`;
        }).join('');
      });
    }

    // Add tournament points after any win
    function addTournamentPoints(gameId, winAmount, multiplier) {
      if(!currentUser) return;
      db.ref('tournament_scores').once('value', snap => {
        const all = snap.val() || {};
        Object.entries(all).forEach(([tid, scores]) => {
          if(scores && scores[currentUser] !== undefined) {
            // Check if game is allowed for this tournament
            const tGame = TOURNEY_GAMES.find(g=>g.game===gameId);
            const pts = tGame ? Math.floor((winAmount || 0) * tGame.pointMult / 100) : Math.floor((winAmount||0)/100);
            if(pts > 0) {
              db.ref('tournament_scores/'+tid+'/'+currentUser).set(firebase.database.ServerValue.increment(pts));
              // Brief notification
              const t = document.createElement('div');
              t.className = 'toast success';
              t.innerHTML = `<span>üèÜ +${pts} –æ—á–∫—ñ–≤ —Ç—É—Ä–Ω—ñ—Ä—É!</span>`;
              document.getElementById('toast-container').appendChild(t);
              setTimeout(()=>t.remove(), 2000);
            }
          }
        });
      });
    }

    function renderTourneyGames() {
      const grid = document.getElementById('tourneyGamesGrid'); if(!grid) return;
      // Check if user is in any active tournament
      db.ref('tournament_scores').once('value', snap => {
        const all = snap.val() || {};
        const inTournament = Object.values(all).some(scores => scores && scores[currentUser] !== undefined);
        if(!inTournament) {
          grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#555;padding:30px;">
            <div style="font-size:36px;margin-bottom:12px;">üîí</div>
            <div style="font-size:13px;color:#777;margin-bottom:8px;">–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—î–¥–Ω–∞–π—Å—è –¥–æ —Ç—É—Ä–Ω—ñ—Ä—É</div>
            <button class="btn-gold" onclick="switchTourneyTab('active',document.getElementById('ttb-active'))">üèÜ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ç—É—Ä–Ω—ñ—Ä–∏</button>
          </div>`;
          return;
        }
        grid.innerHTML = TOURNEY_GAMES.map(g => `
          <div onclick="openTourneyGame('${g.game}')" style="background:linear-gradient(135deg,#1a1200,#0d0800);border:1px solid #3a2800;border-radius:14px;padding:14px;cursor:pointer;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-10px;right:-10px;font-size:50px;opacity:0.08;">${g.icon}</div>
            <div style="font-size:28px;margin-bottom:6px;">${g.icon}</div>
            <div style="font-size:12px;font-weight:bold;color:#fff;margin-bottom:2px;">${g.name}</div>
            <div style="font-size:10px;color:#777;margin-bottom:6px;">${g.desc}</div>
            <div style="font-size:9px;background:rgba(212,175,55,0.2);color:var(--accent);border-radius:6px;padding:2px 6px;display:inline-block;">√ó${g.pointMult} –æ—á–∫–∏</div>
          </div>`).join('');
      });
    }

    function openTourneyGame(gameId) {
      // Check if user is in tournament
      db.ref('tournament_scores').once('value', snap => {
        const all = snap.val() || {};
        const inT = Object.values(all).some(s => s && s[currentUser] !== undefined);
        if(!inT) { notify('‚ùå –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—î–¥–Ω–∞–π—Å—è –¥–æ —Ç—É—Ä–Ω—ñ—Ä—É!', 'error'); return; }
        openGame(gameId);
        notify(`üèÜ –¢—É—Ä–Ω—ñ—Ä–Ω–∏–π —Ä–µ–∂–∏–º! –í–∏–≥—Ä–∞—à ‚Üí –æ—á–∫–∏`, 'info');
        activeTournament = 'active';
      });
    }

    function joinTournamentV2(id, name, prize) {
      db.ref('tournament_scores/'+id+'/'+currentUser).once('value', snap => {
        if(!snap.exists()) {
          db.ref('tournament_scores/'+id+'/'+currentUser).set(0);
          notify(`üèÜ –í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ "${name}"! –ì—Ä–∞–π —ñ –∑–∞—Ä–æ–±–ª—è–π –æ—á–∫–∏!`, 'success');
          activeTournament = id;
        } else {
          notify(`–í–∏ –≤–∂–µ –≤ —Ç—É—Ä–Ω—ñ—Ä—ñ "${name}"`, 'info');
        }
      });
    }

    function loadTourneyStatsBar() {
      const el = document.getElementById('myTourneyStats'); if(!el) return;
      db.ref('tournament_scores').once('value', snap => {
        const all = snap.val() || {};
        let totalPoints = 0, bestPos = 999, tourCount = 0;
        Object.entries(all).forEach(([tid, scores]) => {
          if(!scores || scores[currentUser] === undefined) return;
          tourCount++;
          totalPoints += scores[currentUser]||0;
          const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
          const pos = sorted.findIndex(([u])=>u===currentUser)+1;
          if(pos < bestPos) bestPos = pos;
        });
        el.innerHTML = tourCount ? `
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <div style="text-align:center;"><div style="font-size:9px;color:#555;margin-bottom:2px;">–¢—É—Ä–Ω—ñ—Ä—ñ–≤</div><div style="font-size:20px;font-weight:900;color:var(--accent);">${tourCount}</div></div>
            <div style="text-align:center;"><div style="font-size:9px;color:#555;margin-bottom:2px;">–í—Å—å–æ–≥–æ –æ—á–∫—ñ–≤</div><div style="font-size:20px;font-weight:900;color:var(--green);">${formatNumber(totalPoints)}</div></div>
            <div style="text-align:center;"><div style="font-size:9px;color:#555;margin-bottom:2px;">–ö—Ä–∞—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div><div style="font-size:20px;font-weight:900;color:#f39c12;">#${bestPos===999?'‚Äî':bestPos}</div></div>
          </div>` : '<div style="font-size:11px;color:#555;text-align:center;">–©–µ –Ω–µ –±—Ä–∞–ª–∏ —É—á–∞—Å—Ç—ñ –≤ —Ç—É—Ä–Ω—ñ—Ä–∞—Ö</div>';
      });
    }


    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    checkRefParam();
    setTimeout(loadSavedLang, 500);

  </script>
</body