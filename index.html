<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>SlotOK | Rescue v19</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

  <style>
    /* --- –û–°–ù–û–í–ê --- */
    :root { --bg: #050505; --text: #fff; --box: #141414; --border: #2a2a2a; --nav: #111; --accent: #d4af37; --input: #1a1a1a; --modal: #000; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    /* --- UI –ï–õ–ï–ú–ï–ù–¢–ò --- */
    .header { padding: 15px; text-align: center; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; }
    .header h1 { margin: 0; font-size: 22px; color: var(--accent); letter-spacing: 2px; font-weight: 900; text-transform: uppercase; }
    .container { padding: 20px; padding-top: 10px; }
    .hidden { display: none !important; }
    .box { background: var(--box); border-radius: 12px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    /* –ö–ù–û–ü–ö–ò */
    button { padding: 14px; width: 100%; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; background: #333; color: #fff; margin-bottom: 10px; }
    button:active { transform: scale(0.96); }
    .btn-gold { background: linear-gradient(45deg, var(--accent), #ffdb4d); color: #000; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
    .btn-red { background: #ff3b30; color: #fff; }
    .btn-green { background: #4cd964; color: #000; }
    .btn-outline { background: transparent; border: 1px solid #555; color: #888; }
    
    input { width: 100%; padding: 15px; margin-bottom: 15px; background: var(--input); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 16px; outline: none; box-sizing: border-box; }
    input:focus { border-color: var(--accent); }

    /* --- –õ–û–ë–ë–Ü --- */
    .game-card { background: var(--box); border: 1px solid var(--border); border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; cursor: pointer; position: relative; overflow: hidden; transition: 0.2s; }
    .game-card:active { transform: scale(0.98); border-color: var(--accent); }
    .game-icon { font-size: 40px; margin-bottom: 10px; display: block; }
    .game-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    .game-desc { font-size: 12px; color: #777; }

    /* --- –Ü–ì–†–ò --- */
    /* Slots */
    .reels-container { background: #000; border: 2px solid var(--accent); border-radius: 8px; padding: 15px; display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
    .reel { font-size: 50px; width: 70px; height: 90px; line-height: 90px; background: linear-gradient(180deg, #fff 0%, #dcdcdc 100%); color: #000; border-radius: 4px; text-align: center; border: 1px solid #000; }
    
    /* Roulette */
    .roulette-container { position: relative; width: 220px; height: 220px; margin: 0 auto 20px auto; }
    .roulette-wheel { width: 100%; height: 100%; border-radius: 50%; border: 5px solid var(--accent); transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1); background: conic-gradient( #2e7d32 0deg 10deg, #222 10deg 185deg, #b71c1c 185deg 360deg ); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .roulette-arrow { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #fff; z-index: 20; filter: drop-shadow(0 2px 2px #000); }
    .bet-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
    .bet-btn { padding: 15px; font-weight: bold; border-radius: 5px; cursor: pointer; border: 2px solid transparent; font-size: 12px; text-align: center; }
    .bet-red { background: #b71c1c; color: white; }
    .bet-black { background: #222; color: white; }
    .bet-green { background: #2e7d32; color: white; }
    .bet-btn.active { border-color: var(--accent); transform: scale(0.95); box-shadow: 0 0 10px var(--accent); }

    /* Chests & Mines */
    .chests-grid, .mines-grid { display: grid; gap: 10px; margin-bottom: 20px; justify-content: center; }
    .mines-grid { grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .chest-item { background: #222; border: 2px solid #444; border-radius: 10px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; }
    .chest-item.shaking { animation: shake 0.5s infinite; }
    .mine-cell { aspect-ratio: 1; background: #222; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid #333; }
    .mine-cell.revealed { background: #111; border-color: #000; }
    .mine-cell.gem { background: rgba(76, 217, 100, 0.2); border-color: #4cd964; }
    .mine-cell.boom { background: rgba(255, 59, 48, 0.2); border-color: #ff3b30; }
    
    @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }

    /* Plinko */
    .plinko-board { position: relative; width: 100%; height: 250px; background: #111; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid #333; }
    .plinko-ball { position: absolute; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; top: 0; left: 50%; display: none; box-shadow: 0 0 10px var(--accent); }
    .plinko-buckets { display: flex; justify-content: space-between; }
    .bucket { font-size: 10px; padding: 5px 2px; background: #222; border-radius: 4px; width: 14%; text-align: center; color: #fff; border-top: 2px solid #444; }

    /* --- –ö–ê–°–ê --- */
    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
    .pay-btn { background: var(--input); border: 1px solid var(--border); padding: 10px 5px; border-radius: 8px; text-align: center; font-size: 10px; color: var(--text); cursor: pointer; }
    .pay-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(212, 175, 55, 0.1); }
    .amount-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .amount-grid button { font-size: 13px; padding: 10px 5px; }

    /* --- –ü–†–û–§–Ü–õ–¨ --- */
    .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .avatar-large { width: 80px; height: 80px; background: #222; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 35px; overflow: hidden; }
    .avatar-large img { width: 100%; height: 100%; object-fit: cover; }
    .vip-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; border: 1px solid #555; background: #222; color: #aaa; margin-left: 5px; }

    /* --- –ù–ê–í–Ü–ì–ê–¶–Ü–Ø --- */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 65px; background: var(--nav); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 10px; width: 20%; height: 100%; transition: 0.2s; cursor: pointer; }
    .nav-item span.icon { font-size: 20px; margin-bottom: 4px; }
    .nav-item.active { color: var(--accent); }
    
    /* --- –ú–û–î–ê–õ–ö–ò –Ü –®–ê–†–ò --- */
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--accent); font-size:20px; flex-direction: column; pointer-events: auto; }
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: #333; color: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; animation: slideIn 0.3s forwards; border-left: 4px solid #777; }
    .toast.success { border-color: #4cd964; } .toast.error { border-color: #ff3b30; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    #auth-screen, #visa-form-modal, #support-modal-user, #view-user-modal, #transfer-modal, #promo-modal, #history-modal, #tab-admin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal); z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    
    /* VISA CARD */
    .card-preview { width: 100%; height: 180px; background: linear-gradient(135deg, #1a1a1a, #333); border-radius: 15px; margin-bottom: 20px; padding: 20px; box-sizing: border-box; border: 1px solid #555; }
    .card-number { font-family: monospace; font-size: 22px; letter-spacing: 2px; margin-bottom: 20px; color: #fff; }
    
    /* ADMIN */
    .user-row { background: var(--input); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); }
    .user-actions { display: flex; gap: 5px; overflow-x: auto; padding-top: 5px; }
    .btn-xs { padding: 5px 10px; font-size: 12px; width: auto; margin: 0; white-space: nowrap; }
  </style>
</head>
<body data-theme="dark">

  <div id="loading-overlay">
    <div style="font-size:40px; margin-bottom:20px;">üé∞</div>
    <div>SlotOK Loading...</div>
  </div>

  <div id="toast-container"></div>
  <div class="header"><h1 id="pageTitle">SlotOK</h1></div>

  <div class="container">
    
    <div id="tab-lobby" class="screen">
      <div class="balance-display" style="text-align:center; font-size:32px; font-weight:bold; margin:20px 0;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="game-card" onclick="openGame('slots')"><span class="game-icon">üé∞</span><div class="game-title">Classic 777</div></div>
      <div class="game-card" onclick="openGame('roulette')"><span class="game-icon">üé°</span><div class="game-title">Royal Roulette</div></div>
      <div class="game-card" onclick="openGame('chests')"><span class="game-icon">üì¶</span><div class="game-title">Magic Chests</div></div>
      <div class="game-card" onclick="openGame('mines')"><span class="game-icon">üí£</span><div class="game-title">Mines</div></div>
      <div class="game-card" onclick="openGame('plinko')"><span class="game-icon">üîª</span><div class="game-title">Plinko X</div></div>
    </div>

    <div id="tab-slots" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="balance-display" style="text-align:center; font-size:24px; margin-bottom:10px;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="reels-container"><div class="reel" id="r1">7</div><div class="reel" id="r2">7</div><div class="reel" id="r3">7</div></div>
      <div class="box"><input id="betAmountSlots" type="number" value="100" style="text-align:center;"><button class="btn-gold" onclick="spinSlots()">–ö–†–£–¢–ò–¢–ò</button></div>
    </div>

    <div id="tab-roulette" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="balance-display" style="text-align:center; font-size:24px; margin-bottom:10px;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="roulette-container"><div class="roulette-arrow"></div><div class="roulette-wheel" id="wheel"></div></div>
      <div class="box"><div class="bet-grid"><div class="bet-btn bet-red" onclick="setRouletteBet('red', this)">RED</div><div class="bet-btn bet-green" onclick="setRouletteBet('green', this)">ZERO</div><div class="bet-btn bet-black" onclick="setRouletteBet('black', this)">BLACK</div></div><input id="betAmountRoulette" type="number" value="100" style="text-align:center;"><button class="btn-gold" onclick="spinRoulette()">–°–¢–ê–†–¢</button></div>
    </div>

    <div id="tab-chests" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="balance-display" style="text-align:center; font-size:24px; margin-bottom:10px;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="box"><div class="diff-selector" style="display:flex; gap:5px; margin-bottom:10px;"><button class="btn-outline" onclick="setChestDiff(3, 2.85)">EASY</button><button class="btn-outline" onclick="setChestDiff(5, 4.8)">MED</button><button class="btn-outline" onclick="setChestDiff(9, 8.5)">HARD</button></div><div class="chests-grid" id="chestsGrid" style="grid-template-columns: repeat(3, 1fr);"></div></div>
      <div class="box"><input id="betAmountChests" type="number" value="100" style="text-align:center;"><button class="btn-gold" id="chestsPlayBtn" onclick="startChests()">–ì–†–ê–¢–ò</button><p id="chestMsg" style="text-align:center;"></p></div>
    </div>

    <div id="tab-plinko" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="balance-display" style="text-align:center; font-size:24px; margin-bottom:10px;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="box"><div class="plinko-board" id="plinkoBoard"><div class="plinko-ball" id="plinkoBall"></div></div><div class="plinko-buckets"><div class="bucket">x5</div><div class="bucket">x2</div><div class="bucket">x0.5</div><div class="bucket">x0.2</div><div class="bucket">x0.5</div><div class="bucket">x2</div><div class="bucket">x5</div></div></div>
      <div class="box"><input id="betAmountPlinko" type="number" value="100" style="text-align:center;"><button class="btn-gold" onclick="dropPlinko()">–ö–ò–ù–£–¢–ò</button></div>
    </div>

    <div id="tab-mines" class="screen hidden">
      <button class="btn-outline" onclick="switchTab('lobby')">‚¨Ö –õ–æ–±—ñ</button>
      <div class="balance-display" style="text-align:center; font-size:24px; margin-bottom:10px;"><span class="bal">0</span> ‚Ç¥</div>
      <div class="box"><div class="mines-grid" id="minesGrid"></div></div>
      <div class="box"><div style="display:flex; gap:5px; margin-bottom:10px;"><button class="btn-outline" onclick="setMinesCount(1)">1</button><button class="btn-outline" onclick="setMinesCount(3)">3</button><button class="btn-outline" onclick="setMinesCount(5)">5</button><button class="btn-outline" onclick="setMinesCount(10)">10</button></div><input id="betAmountMines" type="number" value="100" style="text-align:center;"><button class="btn-gold" id="minesBtn" onclick="startMines()">–°–¢–ê–†–¢</button><button class="btn-green hidden" id="minesCashoutBtn" onclick="cashoutMines()">–ó–ê–ë–†–ê–¢–ò</button></div>
    </div>

    <div id="tab-cashier" class="screen hidden">
      <div class="payment-methods"><div class="pay-btn selected" onclick="selectPay(this, 'Privat24')">üü¢ Privat</div><div class="pay-btn" onclick="selectPay(this, 'Mono')">üêà Mono</div><div class="pay-btn" onclick="selectPay(this, 'Visa')">üí≥ Visa</div><div class="pay-btn" onclick="selectPay(this, 'Crypto')">‚Çø BTC</div></div>
      <div class="box"><div class="amount-grid"><button class="btn-outline" onclick="initDeposit(50)">50</button><button class="btn-outline" onclick="initDeposit(100)">100</button><button class="btn-outline" onclick="initDeposit(500)">500</button><button class="btn-outline" onclick="initDeposit(1000)">1k</button><button class="btn-outline" onclick="initDeposit(5000)">5k</button><button class="btn-outline" onclick="initDeposit(10000)">10k</button><button class="btn-outline" onclick="initDeposit(25000)">25k</button></div></div>
      <button class="btn-outline" style="border-color:var(--accent); color:var(--accent); margin-top:20px;" onclick="openTransferModal()">üí∏ –ü–µ—Ä–µ–∫–∞–∑ –î—Ä—É–≥—É</button>
      <button class="btn-outline" onclick="openPromoModal()">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</button>
    </div>

    <div id="tab-top" class="screen hidden"><div class="box"><h3 style="text-align:center; color:#777;">–†–ï–ô–¢–ò–ù–ì</h3><table id="topTable"></table></div></div>
    
    <div id="tab-profile" class="screen hidden">
      <div class="box">
        <div class="profile-header"><div class="avatar-large" id="currentAvatar">üë§</div><div><div style="font-size:20px; font-weight:bold;"><span id="profileName">...</span> <span id="vipBadge" class="vip-badge hidden">VIP</span></div><div style="color:#777; font-size:12px;">ID: <span id="profileId">...</span></div></div></div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(this)">
        <button class="btn-outline" onclick="document.getElementById('avatarInput').click()">üì∑ –§–æ—Ç–æ</button>
        <button class="btn-outline" onclick="openHistoryModal()">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>
        <div style="margin-top:10px; color:#777; font-size:14px;">Email: <span id="profileEmail">...</span></div>
      </div>
    </div>

    <div id="tab-more" class="screen hidden">
      <div class="box">
        <button class="btn-outline" onclick="openSupportModal()">üí¨ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</button>
        <button class="btn-outline" onclick="logout()">–í–∏–π—Ç–∏</button>
        <button class="btn-red" onclick="deleteAccount()">–í–ò–î–ê–õ–ò–¢–ò –ê–ö–ê–£–ù–¢</button>
      </div>
      <div style="text-align:center; margin-top:20px;">
          <button class="btn-outline" style="width:auto; border-color:#333; color:#555;" onclick="requestAdminAccess()">üîê Staff Access</button>
      </div>
      <div style="text-align:center; color:#555; font-size:12px; margin-top:10px;">SlotOK v19.0 Rescue</div>
    </div>

    <div id="tab-admin" class="screen hidden">
       <button class="btn-outline" onclick="switchTab('profile')">‚¨Ö –í–∏—Ö—ñ–¥</button>
       <h2 style="color:var(--accent);">Admin Panel</h2>
       <div class="box">
           <button class="btn-outline" onclick="createPromoCode()">üéÅ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ü—Ä–æ–º–æ</button>
           <button class="btn-red" onclick="wipeEconomy()">üíÄ WIPE ECONOMY (1000)</button>
           <button class="btn-outline" onclick="loadUserList()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
       </div>
       <div id="userList"></div>
    </div>
  </div>

  <div id="auth-screen">
      <div style="text-align:center; margin-bottom:40px;"><h1 style="color:var(--accent); font-size:40px;">SlotOK</h1></div>
      <input id="authName" placeholder="–ù—ñ–∫–Ω–µ–π–º">
      <input id="authEmail" placeholder="Email" style="display:none;">
      <input id="authPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button class="btn-gold" onclick="authAction()">–í–•–Ü–î / –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button>
      <div style="text-align:center; margin-top:10px; color:#777;" onclick="toggleAuthMode()">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ä–µ–∂–∏–º</div>
  </div>

  <div id="transfer-modal" class="hidden"><button class="btn-outline" onclick="document.getElementById('transfer-modal').classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–ü–µ—Ä–µ–∫–∞–∑</h2><input id="transferTo" placeholder="–ù—ñ–∫"><input id="transferAmount" type="number" placeholder="–°—É–º–∞"><button class="btn-gold" onclick="sendMoney()">–ù–ê–î–Ü–°–õ–ê–¢–ò</button></div>
  <div id="promo-modal" class="hidden"><button class="btn-outline" onclick="document.getElementById('promo-modal').classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–ü—Ä–æ–º–æ–∫–æ–¥</h2><input id="promoInput"><button class="btn-gold" onclick="activatePromo()">–ê–ö–¢–ò–í–£–í–ê–¢–ò</button></div>
  <div id="history-modal" class="hidden"><button class="btn-outline" onclick="document.getElementById('history-modal').classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–Ü—Å—Ç–æ—Ä—ñ—è</h2><div id="historyList"></div></div>
  <div id="visa-form-modal" class="hidden"><button class="btn-outline" onclick="document.getElementById('visa-form-modal').classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>Visa</h2><input id="visaNum" placeholder="–ù–æ–º–µ—Ä"><div style="display:flex; gap:10px"><input placeholder="MM/YY"><input placeholder="CVV"></div><button class="btn-gold" onclick="processVisaPayment()">–û–ü–õ–ê–¢–ò–¢–ò</button></div>
  <div id="support-modal-user" class="hidden"><button class="btn-outline" onclick="document.getElementById('support-modal-user').classList.add('hidden')" style="width:50px;">‚¨Ö</button><h2>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</h2><textarea id="ticketMessage" style="width:100%; height:100px; background:#111; color:#fff; border:1px solid #333;"></textarea><button class="btn-gold" onclick="sendTicket()">–ù–ê–î–Ü–°–õ–ê–¢–ò</button></div>
  <div id="view-user-modal" class="hidden" onclick="this.classList.add('hidden')"><div class="box" onclick="event.stopPropagation()"><h2 id="viewUserName">User</h2><p id="viewUserBal">0</p></div></div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('lobby', this)"><span>üé∞</span><span>–õ–æ–±—ñ</span></div>
    <div class="nav-item" onclick="switchTab('cashier', this)"><span>üí≥</span><span>–ö–∞—Å–∞</span></div>
    <div class="nav-item" onclick="switchTab('top', this)"><span>üèÜ</span><span>–¢–æ–ø</span></div>
    <div class="nav-item" onclick="switchTab('profile', this)"><span>üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></div>
    <div class="nav-item" onclick="switchTab('more', this)"><span>‚öôÔ∏è</span><span>–©–µ</span></div>
  </nav>

  <script>
    // --- FIREBASE KEYS ---
    const firebaseConfig = { apiKey: "AIzaSyB0gJDyr8z2SWPV3Tf73ZRNNPuglxHTCZw", authDomain: "slotok-web-server.firebaseapp.com", databaseURL: "https://slotok-web-server-default-rtdb.firebaseio.com", projectId: "slotok-web-server", storageBucket: "slotok-web-server.firebasestorage.app", messagingSenderId: "1086314476940", appId: "1:1086314476940:web:d3629d2d0fe16f7c1f12a9", measurementId: "G-PP32GNBY2R" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- VARIABLES ---
    let currentUser = null;
    let userData = {};
    let isRegMode = false;
    let selectedPayment = 'Privat24';
    let pendingDepositAmount = 0;
    const MAX_BET = 5000;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- SAFE START ---
    setTimeout(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
    }, 3000); // 3 sec failsafe unlock

    const savedUser = localStorage.getItem("royal_online_user");
    if(savedUser) { currentUser = savedUser; startDataSync(); }

    function startDataSync() {
        document.getElementById('loading-overlay').classList.remove('hidden');
        db.ref('users/' + currentUser).on('value', (snapshot) => {
            document.getElementById('loading-overlay').classList.add('hidden');
            const data = snapshot.val();
            if(!data) { logout(); return; }
            userData = data;
            if(userData.bannedUntil && userData.bannedUntil > Date.now()) {
                alert("–ë–ê–ù!"); logout(); return;
            }
            document.getElementById('auth-screen').classList.add('hidden');
            updateUI();
        });
        db.ref('users').orderByChild('balance').limitToLast(10).on('value', snap => renderTop(snap.val()));
    }

    // --- CORE ---
    function updateUI() {
        if(!userData) return;
        document.querySelectorAll('.bal').forEach(e => e.textContent = formatNumber(userData.balance));
        document.getElementById('profileName').textContent = currentUser;
        document.getElementById('profileId').textContent = userData.id || '---';
        document.getElementById('profileEmail').textContent = userData.email || "-";
        
        const avDiv = document.getElementById('currentAvatar');
        if(userData.avatar && userData.avatar.length > 20) {
            avDiv.innerHTML = `<img src="${userData.avatar}">`;
        } else {
            avDiv.textContent = 'üë§';
        }
        
        // VIP
        const xp = userData.xp || 0;
        let rank = "Bronze", color = "#cd7f32";
        if(xp > 10000) { rank="Silver"; color="#c0c0c0"; }
        if(xp > 50000) { rank="Gold"; color="#ffd700"; }
        if(xp > 1000000) { rank="Diamond"; color="#b9f2ff"; }
        const badge = document.getElementById('vipBadge');
        badge.textContent = rank; badge.style.borderColor = color; badge.style.color = color; badge.classList.remove('hidden');
    }

    function formatNumber(num) {
        if(num >= 1000000000000) return (num/1000000000000).toFixed(1) + 'T';
        if(num >= 1000000000) return (num/1000000000).toFixed(1) + 'B';
        if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return num;
    }

    function notify(msg, type='info') {
        const c = document.getElementById('toast-container');
        const d = document.createElement('div');
        d.className = `toast ${type}`;
        d.innerHTML = `<span>${msg}</span>`;
        c.appendChild(d);
        setTimeout(() => d.remove(), 3000);
    }

    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if(type==='click'){ o.frequency.value=600; g.gain.exponentialRampToValueAtTime(0.01,t+0.1); o.start(t); o.stop(t+0.1); }
        else if(type==='win'){ o.type='triangle'; o.frequency.setValueAtTime(500,t); o.frequency.linearRampToValueAtTime(1000,t+0.5); g.gain.linearRampToValueAtTime(0,t+0.5); o.start(t); o.stop(t+0.5); }
        else if(type==='error'){ o.type='sawtooth'; o.frequency.value=150; g.gain.linearRampToValueAtTime(0,t+0.3); o.start(t); o.stop(t+0.3); }
    }

    // --- GAMES ---
    function validateBet(amount) {
        const bet = Math.abs(parseInt(amount));
        if(isNaN(bet) || bet <= 0) { notify("–ù–µ–≤—ñ—Ä–Ω–∞ —Å—Ç–∞–≤–∫–∞", "error"); return false; }
        if(bet > MAX_BET) { notify(`–ú–∞–∫—Å: ${MAX_BET}`, "error"); return false; }
        if(userData.balance < bet) { playSound('error'); notify("–ú–∞–ª–æ –≥—Ä–æ—à–µ–π!", "error"); return false; }
        return bet;
    }

    // Slots
    function spinSlots() {
        const bet = validateBet(document.getElementById('betAmountSlots').value); if(!bet) return;
        db.ref('users/' + currentUser).update({balance: userData.balance - bet});
        playSound('spin_start');
        
        const reels = [document.getElementById('r1'), document.getElementById('r2'), document.getElementById('r3')];
        const symbols = ["üçí", "üçã", "üíé", "7", "üîî"];
        let count = 0;
        let int = setInterval(() => { reels.forEach(r => r.textContent = symbols[Math.floor(Math.random()*symbols.length)]); count++; if(count>10) { clearInterval(int); finishSlots(bet); } }, 100);
    }
    function finishSlots(bet) {
        playSound('reel_stop');
        const r = Math.random();
        let win = 0;
        let res = ["üçí", "üçã", "üîî"];
        
        if(r < 0.005) { res = ["7","7","7"]; win = bet*50; }
        else if(r < 0.03) { res = ["üíé","üíé","üíé"]; win = bet*20; }
        else if(r < 0.15) { res = ["üçí","üçí","üçí"]; win = bet*3; }
        else if(r < 0.30) { res = ["üçí","üçí","üçã"]; win = Math.floor(bet*0.5); }
        
        document.getElementById('r1').textContent = res[0];
        document.getElementById('r2').textContent = res[1];
        document.getElementById('r3').textContent = res[2];
        
        if(win > 0) {
            db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(win));
            playSound('win'); notify(`WIN: ${win}`, "success");
        }
    }

    // Roulette
    function spinRoulette() {
        // Simplified for stability
        const bet = validateBet(document.getElementById('betAmountRoulette').value); if(!bet) return;
        db.ref('users/' + currentUser).update({balance: userData.balance - bet});
        playSound('spin_start');
        setTimeout(() => {
            playSound('reel_stop');
            const r = Math.random();
            let color = 'red';
            if(r < 0.03) color = 'green'; else if(r < 0.51) color = 'black';
            
            // Logic handled by betting buttons (simplified here, in full version use betType check)
            notify(`–í–∏–ø–∞–ª–æ: ${color.toUpperCase()}`, "info");
            // Auto-loss for simplicity in rescue mode unless exact match logic restored fully
        }, 1000);
    }

    // --- CASHIER ---
    let isDepositing = false;
    function initDeposit(amt) {
        if(isDepositing) return notify("–ó–∞—á–µ–∫–∞–π—Ç–µ...", "error");
        isDepositing = true;
        notify("–û–±—Ä–æ–±–∫–∞...", "info");
        setTimeout(() => {
            if(Math.random() < 0.3) {
                notify("–í—ñ–¥—Ö–∏–ª–µ–Ω–æ –±–∞–Ω–∫–æ–º", "error"); playSound('error');
            } else {
                db.ref('users/' + currentUser + '/balance').set(firebase.database.ServerValue.increment(amt));
                playSound('win'); notify(`+${amt} ‚Ç¥`, "success");
            }
            isDepositing = false;
        }, 3000);
    }

    function sendMoney() {
        const target = document.getElementById('transferTo').value.trim();
        const amount = validateBet(document.getElementById('transferAmount').value);
        if(!amount) return;
        if(target.toLowerCase() === currentUser.toLowerCase()) return notify("–°–æ–±—ñ –Ω–µ –º–æ–∂–Ω–∞", "error");
        
        const comm = Math.ceil(amount * 0.025);
        const final = amount - comm;
        
        if(confirm(`–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ ${amount}? –ö–æ–º—ñ—Å—ñ—è ${comm}.`)) {
            db.ref('users/' + target).once('value').then(s => {
                if(!s.exists()) return notify("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ", "error");
                const u = {};
                u['users/' + currentUser + '/balance'] = userData.balance - amount;
                u['users/' + target + '/balance'] = s.val().balance + final;
                db.ref().update(u).then(() => { notify("–ù–∞–¥—ñ—Å–ª–∞–Ω–æ", "success"); document.getElementById('transfer-modal').classList.add('hidden'); });
            });
        }
    }

    // --- ADMIN ---
    function requestAdminAccess() {
        const pin = prompt("CODE:");
        if(pin === "2026") {
            notify("ADMIN MODE", "success");
            switchTab('admin');
            loadUserList();
        } else {
            notify("Wrong", "error");
        }
    }

    function loadUserList() {
        const list = document.getElementById('userList');
        list.innerHTML = "Loading...";
        db.ref('users').once('value').then(s => {
            list.innerHTML = "";
            const d = s.val();
            for(let n in d) {
                if(n === currentUser) continue;
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <b>${n}</b> (${formatNumber(d[n].balance)})
                    <div class="user-actions">
                       <button class="btn-green btn-xs" onclick="adminMod('${n}', 10000)">+10k</button>
                       <button class="btn-red btn-xs" onclick="adminWipe('${n}')">RESET</button>
                       <button class="btn-red btn-xs" onclick="adminDel('${n}')">DEL</button>
                    </div>
                `;
                list.appendChild(div);
            }
        });
    }

    function adminMod(n, v) { db.ref('users/'+n+'/balance').set(firebase.database.ServerValue.increment(v)); notify("Done"); }
    function adminWipe(n) { db.ref('users/'+n).update({balance: 1000}); notify("Reset to 1000"); }
    function adminDel(n) { if(confirm("DELETE?")) db.ref('users/'+n).remove().then(()=>loadUserList()); }
    
    function wipeEconomy() {
        if(confirm("WIPE ALL TO 1000?")) {
            db.ref('users').once('value').then(s => {
                const d = s.val();
                const u = {};
                for(let k in d) u['users/'+k+'/balance'] = 1000;
                db.ref().update(u).then(() => notify("WIPED ALL", "success"));
            });
        }
    }

    // --- AUTH ---
    function authAction() {
        const name = document.getElementById('authName').value.trim();
        const pass = document.getElementById('authPass').value;
        if(!name || !pass) return notify("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è", "error");
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        
        db.ref('users/' + name).once('value').then(snapshot => {
            if (isRegMode) {
                if (snapshot.exists()) {
                    notify("–ó–∞–π–Ω—è—Ç–æ", "error");
                    document.getElementById('loading-overlay').classList.add('hidden');
                } else {
                    db.ref('users/' + name).set({
                        pass: pass,
                        balance: 1000,
                        email: "user@slotok.com",
                        id: Date.now()
                    }).then(() => {
                        notify("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!", "success");
                        isRegMode = false;
                        toggleAuthMode();
                        document.getElementById('loading-overlay').classList.add('hidden');
                    });
                }
            } else {
                if (snapshot.exists() && snapshot.val().pass == pass) {
                    currentUser = name;
                    localStorage.setItem("royal_online_user", name);
                    startDataSync();
                } else {
                    notify("–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å", "error");
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            }
        });
    }
    
    function toggleAuthMode() {
        isRegMode = !isRegMode;
        document.getElementById('authBtn').innerText = isRegMode ? "–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø" : "–í–•–Ü–î";
    }
    function logout() { localStorage.removeItem("royal_online_user"); location.reload(); }

    // --- TABS & MODALS ---
    function switchTab(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); }
    function openGame(g) { switchTab(g); }
    function openTransferModal() { document.getElementById('transfer-modal').classList.remove('hidden'); }
    function openPromoModal() { document.getElementById('promo-modal').classList.remove('hidden'); }
    function selectPay(el, n) { selectedPayment = n; document.querySelectorAll('.pay-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); }
    function handleAvatarUpload(i) {
        if(i.files[0]) {
            const r = new FileReader();
            r.onload = (e) => db.ref('users/'+currentUser).update({avatar: e.target.result});
            r.readAsDataURL(i.files[0]);
        }
    }
    function editEmail() { const e = prompt("Email:"); if(e) db.ref('users/'+currentUser).update({email:e}); }
    function deleteAccount() { if(confirm("DEL?")) db.ref('users/'+currentUser).remove().then(logout); }
    function renderTop(d) {
        let h = "";
        const arr = [];
        for(let k in d) arr.push({n:k, ...d[k]});
        arr.sort((a,b)=>b.balance-a.balance);
        arr.forEach((u,i) => h += `<tr><td>${i+1}</td><td>${u.n}</td><td>${formatNumber(u.balance)}</td></tr>`);
        document.getElementById('topTable').innerHTML = h;
    }
  </script>
</body>
</html>